<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>language-server-extension-guide</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <h1 id="language-server-extension-guide">Language Server Extension Guide</h1>
    <p>
      As you have seen in the
      <a href="/api/language-extensions/programmatic-language-features"
        >Programmatic Language Features</a
      >
      topic, it’s possible to implement Language Features by directly using
      <code>languages.*</code> API. Language Server Extension, however, provides an
      alternative way of implementing such language support.
    </p>
    <p>This topic:</p>
    <ul>
      <li>Explains the benefits of Language Server Extension.</li>
      <li>
        Walks you through building a Language Server using the
        <a href="https://github.com/microsoft/vscode-languageserver-node"
          ><code>Microsoft/vscode-languageserver-node</code></a
        >
        library. You can also jump directly to the code in
        <a href="https://github.com/microsoft/vscode-extension-samples/tree/main/lsp-sample"
          >lsp-sample</a
        >.
      </li>
    </ul>
    <h2 id="why-language-server">Why Language Server?</h2>
    <p>
      Language Server is a special kind of Visual Studio Code extension that powers the
      editing experience for many programming languages. With Language Servers, you can
      implement autocomplete, error-checking (diagnostics), jump-to-definition, and many
      other
      <a href="/api/language-extensions/programmatic-language-features"
        >language features</a
      >
      supported in VS Code.
    </p>
    <p>
      However, while implementing support for language features in VS Code, we found three
      common problems:
    </p>
    <p>
      First, Language Servers are usually implemented in their native programming languages,
      and that presents a challenge in integrating them with VS Code, which has a Node.js
      runtime.
    </p>
    <p>
      Additionally, language features can be resource intensive. For example, to correctly
      validate a file, Language Server needs to parse a large amount of files, build up
      Abstract Syntax Trees for them and perform static program analysis. Those operations
      could incur significant CPU and memory usage and we need to ensure that VS Code’s
      performance remains unaffected.
    </p>
    <p>
      Finally, integrating multiple language toolings with multiple code editors could
      involve significant effort. From language toolings’ perspective, they need to adapt to
      code editors with different APIs. From code editors’ perspective, they cannot expect
      any uniform API from language toolings. This makes implementing language support for
      <code>M</code> languages in <code>N</code> code editors the work of
      <code>M * N</code>.
    </p>
    <p>
      To solve those problems, Microsoft specified
      <a href="https://microsoft.github.io/language-server-protocol"
        >Language Server Protocol</a
      >, which standardizes the communication between language tooling and code editor. This
      way, Language Servers can be implemented in any language and run in their own process
      to avoid performance cost, as they communicate with the code editor through the
      Language Server Protocol. Furthermore, any LSP-compliant language toolings can
      integrate with multiple LSP-compliant code editors, and any LSP-compliant code editors
      can easily pick up multiple LSP-compliant language toolings. LSP is a win for both
      language tooling providers and code editor vendors!
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/lsp-languages-editors.png"
        alt="LSP Languages and Editors"
      />
      <figcaption>LSP Languages and Editors</figcaption>
    </figure>
    <p>In this guide, we will:</p>
    <ul>
      <li>
        Explain how to build a Language Server extension in VS Code using the provided
        <a href="https://github.com/microsoft/vscode-languageserver-node">Node SDK</a>.
      </li>
      <li>Explain how to run, debug, log, and test the Language Server extension.</li>
      <li>Point you to some advanced topics on Language Servers.</li>
    </ul>
    <h2 id="implementing-a-language-server">Implementing a Language Server</h2>
    <h3 id="overview">Overview</h3>
    <p>In VS Code, a language server has two parts:</p>
    <ul>
      <li>
        Language Client: A normal VS Code extension written in JavaScript / TypeScript. This
        extension has access to all
        <a href="/api/references/vscode-api">VS Code Namespace API</a>.
      </li>
      <li>Language Server: A language analysis tool running in a separate process.</li>
    </ul>
    <p>
      As briefly stated above there are two benefits of running the Language Server in a
      separate process:
    </p>
    <ul>
      <li>
        The analysis tool can be implemented in any languages, as long as it can communicate
        with the Language Client following the Language Server Protocol.
      </li>
      <li>
        As language analysis tools are often heavy on CPU and Memory usage, running them in
        separate process avoids performance cost.
      </li>
    </ul>
    <p>
      Here is an illustration of VS Code running two Language Server extensions. The HTML
      Language Client and PHP Language Client are normal VS Code extensions written in
      TypeScript. Each of them instantiates a corresponding Language Server and communicates
      with them through LSP. Although the PHP Language Server is written in PHP, it can
      still communicate with the PHP Language Client through LSP.
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/lsp-illustration.png"
        alt="LSP Illustration"
      />
      <figcaption>LSP Illustration</figcaption>
    </figure>
    <p>
      This guide will teach you how to build a Language Client / Server using our
      <a href="https://github.com/microsoft/vscode-languageserver-node">Node SDK</a>. The
      remaining document assumes that you are familiar with VS Code
      <a href="/api">Extension API</a>.
    </p>
    <h3 id="lsp-sample---a-simple-language-server-for-plain-text-files">
      LSP Sample - A simple Language Server for plain text files
    </h3>
    <p>
      Let’s build a simple Language Server extension that implements autocomplete and
      diagnostics for plain text files. We will also cover the syncing of configurations
      between Client / Server.
    </p>
    <p>If you prefer to jump right into the code:</p>
    <ul>
      <li>
        <strong
          ><a
            href="https://github.com/microsoft/vscode-extension-samples/tree/main/lsp-sample"
            >lsp-sample</a
          ></strong
        >: Heavily documented source code for this guide.
      </li>
      <li>
        <strong
          ><a
            href="https://github.com/microsoft/vscode-extension-samples/tree/main/lsp-multi-server-sample"
            >lsp-multi-server-sample</a
          ></strong
        >: A heavily documented, advanced version of <strong>lsp-sample</strong> that starts
        a different server instance per workspace folder to support the
        <a href="/docs/editor/multi-root-workspaces">multi-root workspace</a> feature in VS
        Code.
      </li>
    </ul>
    <p>
      Clone the repository
      <a href="https://github.com/microsoft/vscode-extension-samples"
        >Microsoft/vscode-extension-samples</a
      >
      and open the sample:
    </p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="op">&gt;</span> <span class="fu">git</span> clone https://github.com/microsoft/vscode-extension-samples.git</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="op">&gt;</span> <span class="bu">cd</span> vscode-extension-samples/lsp-sample</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="op">&gt;</span> <span class="ex">npm</span> install</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="op">&gt;</span> <span class="ex">npm</span> run compile</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="op">&gt;</span> <span class="ex">code</span> .</a></code></pre>
    </div>
    <p>
      The above installs all dependencies and opens the
      <strong>lsp-sample</strong> workspace containing both the client and server code. Here
      is a rough overview of the structure of <strong>lsp-sample</strong>:
    </p>
    <pre><code>.
├── client // Language Client
│   ├── src
│   │   ├── test // End to End tests for Language Client / Server
│   │   └── extension.ts // Language Client entry point
├── package.json // The extension manifest
└── server // Language Server
    └── src
        └── server.ts // Language Server entry point</code></pre>
    <h3 id="explaining-the-language-client">Explaining the ‘Language Client’</h3>
    <p>
      Let’s first take a look at <code>/package.json</code>, which describes the
      capabilities of the Language Client. There are three interesting sections:
    </p>
    <p>
      First look the
      <a href="/api/references/activation-events"><code>activationEvents</code></a
      >:
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb3-1" title="1"><span class="er">&quot;activationEvents&quot;:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb3-2" title="2">    <span class="st">&quot;onLanguage:plaintext&quot;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">]</span></a></code></pre>
    </div>
    <p>
      This section tells VS Code to activate the extension as soon as a plain text file is
      opened (for example a file with the extension <code>.txt</code>).
    </p>
    <p>
      Next look at the
      <a href="/api/references/contribution-points#contributes.configuration"
        ><code>configuration</code></a
      >
      section:
    </p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb4-1" title="1"><span class="er">&quot;configuration&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;object&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Example configuration&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="dt">&quot;languageServerExample.maxNumberOfProblems&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">            <span class="dt">&quot;scope&quot;</span><span class="fu">:</span> <span class="st">&quot;resource&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-7" title="7">            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;number&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-8" title="8">            <span class="dt">&quot;default&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-9" title="9">            <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Controls the maximum number of problems produced by the server.&quot;</span></a>
<a class="sourceLine" id="cb4-10" title="10">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="fu">}</span></a></code></pre>
    </div>
    <p>
      This section contributes <code>configuration</code> settings to VS Code. The example
      will explain how these settings are sent over to the language server on startup and on
      every change of the settings.
    </p>
    <p>
      The actual Language Client source code and the corresponding
      <code>package.json</code> are in the <code>/client</code> folder. The interesting part
      in the <code>/client/package.json</code> file is that it references the
      <code>vscode</code> extension host API through the <code>engines</code> field and adds
      a dependency to the <code>vscode-languageclient</code> library:
    </p>
    <div class="sourceCode" id="cb5">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb5-1" title="1"><span class="er">&quot;engines&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">&quot;vscode&quot;</span><span class="fu">:</span> <span class="st">&quot;^1.52.0&quot;</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="fu">}</span><span class="er">,</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="er">&quot;dependencies&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">&quot;vscode-languageclient&quot;</span><span class="fu">:</span> <span class="st">&quot;^7.0.0&quot;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="fu">}</span></a></code></pre>
    </div>
    <p>
      As mentioned, the client is implemented as a normal VS Code extension, and it has
      access to all VS Code namespace API.
    </p>
    <p>
      Below is the content of the corresponding extension.ts file, which is the entry of the
      <strong>lsp-sample</strong> extension:
    </p>
    <div class="sourceCode" id="cb6">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb6-1" title="1"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> path <span class="im">from</span> <span class="st">&#39;path&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="im">import</span> <span class="op">{</span> workspace<span class="op">,</span> ExtensionContext <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;vscode&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="im">import</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">  LanguageClient<span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">  LanguageClientOptions<span class="op">,</span></a>
<a class="sourceLine" id="cb6-7" title="7">  ServerOptions<span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" title="8">  TransportKind</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="op">}</span> <span class="im">from</span> <span class="st">&#39;vscode-languageclient/node&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-10" title="10"></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="kw">let</span> client<span class="op">:</span> LanguageClient<span class="op">;</span></a>
<a class="sourceLine" id="cb6-12" title="12"></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="im">export</span> <span class="kw">function</span> <span class="fu">activate</span>(context<span class="op">:</span> ExtensionContext) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="co">// The server is implemented in node</span></a>
<a class="sourceLine" id="cb6-15" title="15">  <span class="kw">let</span> serverModule <span class="op">=</span> <span class="va">context</span><span class="op">.</span><span class="fu">asAbsolutePath</span>(<span class="va">path</span><span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;server&#39;</span><span class="op">,</span> <span class="st">&#39;out&#39;</span><span class="op">,</span> <span class="st">&#39;server.js&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb6-16" title="16">  <span class="co">// The debug options for the server</span></a>
<a class="sourceLine" id="cb6-17" title="17">  <span class="co">// --inspect=6009: runs the server in Node&#39;s Inspector mode so VS Code can attach to the server for debugging</span></a>
<a class="sourceLine" id="cb6-18" title="18">  <span class="kw">let</span> debugOptions <span class="op">=</span> <span class="op">{</span> execArgv<span class="op">:</span> <span class="op">[</span><span class="st">&#39;--nolazy&#39;</span><span class="op">,</span> <span class="st">&#39;--inspect=6009&#39;</span><span class="op">]</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb6-19" title="19"></a>
<a class="sourceLine" id="cb6-20" title="20">  <span class="co">// If the extension is launched in debug mode then the debug server options are used</span></a>
<a class="sourceLine" id="cb6-21" title="21">  <span class="co">// Otherwise the run options are used</span></a>
<a class="sourceLine" id="cb6-22" title="22">  <span class="kw">let</span> serverOptions<span class="op">:</span> ServerOptions <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-23" title="23">    run<span class="op">:</span> <span class="op">{</span> <span class="im">module</span>: <span class="dt">serverModule</span>, <span class="dt">transport</span>: <span class="dt">TransportKind</span>.<span class="dt">ipc</span> },</a>
<a class="sourceLine" id="cb6-24" title="24">    debug<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-25" title="25">      <span class="im">module</span>: <span class="dt">serverModule</span>,</a>
<a class="sourceLine" id="cb6-26" title="26">      transport<span class="op">:</span> <span class="va">TransportKind</span><span class="op">.</span><span class="at">ipc</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-27" title="27">      options<span class="op">:</span> debugOptions</a>
<a class="sourceLine" id="cb6-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-29" title="29">  <span class="op">};</span></a>
<a class="sourceLine" id="cb6-30" title="30"></a>
<a class="sourceLine" id="cb6-31" title="31">  <span class="co">// Options to control the language client</span></a>
<a class="sourceLine" id="cb6-32" title="32">  <span class="kw">let</span> clientOptions<span class="op">:</span> LanguageClientOptions <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-33" title="33">    <span class="co">// Register the server for plain text documents</span></a>
<a class="sourceLine" id="cb6-34" title="34">    documentSelector<span class="op">:</span> <span class="op">[{</span> scheme<span class="op">:</span> <span class="st">&#39;file&#39;</span><span class="op">,</span> language<span class="op">:</span> <span class="st">&#39;plaintext&#39;</span> <span class="op">}],</span></a>
<a class="sourceLine" id="cb6-35" title="35">    synchronize<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-36" title="36">      <span class="co">// Notify the server about file changes to &#39;.clientrc files contained in the workspace</span></a>
<a class="sourceLine" id="cb6-37" title="37">      fileEvents<span class="op">:</span> <span class="va">workspace</span><span class="op">.</span><span class="fu">createFileSystemWatcher</span>(<span class="st">&#39;**/.clientrc&#39;</span>)</a>
<a class="sourceLine" id="cb6-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-39" title="39">  <span class="op">};</span></a>
<a class="sourceLine" id="cb6-40" title="40"></a>
<a class="sourceLine" id="cb6-41" title="41">  <span class="co">// Create the language client and start the client.</span></a>
<a class="sourceLine" id="cb6-42" title="42">  client <span class="op">=</span> <span class="kw">new</span> <span class="fu">LanguageClient</span>(</a>
<a class="sourceLine" id="cb6-43" title="43">    <span class="st">&#39;languageServerExample&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-44" title="44">    <span class="st">&#39;Language Server Example&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-45" title="45">    serverOptions<span class="op">,</span></a>
<a class="sourceLine" id="cb6-46" title="46">    clientOptions</a>
<a class="sourceLine" id="cb6-47" title="47">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb6-48" title="48"></a>
<a class="sourceLine" id="cb6-49" title="49">  <span class="co">// Start the client. This will also launch the server</span></a>
<a class="sourceLine" id="cb6-50" title="50">  <span class="va">client</span><span class="op">.</span><span class="fu">start</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb6-51" title="51"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-52" title="52"></a>
<a class="sourceLine" id="cb6-53" title="53"><span class="im">export</span> <span class="kw">function</span> <span class="fu">deactivate</span>()<span class="op">:</span> Thenable<span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">|</span> <span class="dt">undefined</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-54" title="54">  <span class="fu">if</span> (<span class="op">!</span>client) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-55" title="55">    <span class="cf">return</span> <span class="kw">undefined</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-56" title="56">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-57" title="57">  <span class="cf">return</span> <span class="va">client</span><span class="op">.</span><span class="fu">stop</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb6-58" title="58"><span class="op">}</span></a></code></pre>
    </div>
    <h3 id="explaining-the-language-server">Explaining the ‘Language Server’</h3>
    <blockquote>
      <p>
        <strong>Note:</strong> The ‘Server’ implementation cloned from the GitHub repository
        has the final walkthrough implementation. To follow the walkthrough, you can create
        a new <code>server.ts</code> or modify the contents of the cloned version.
      </p>
    </blockquote>
    <p>
      In the example, the server is also implemented in TypeScript and executed using
      Node.js. Since VS Code already ships with a Node.js runtime, there is no need to
      provide your own, unless you have specific requirements for the runtime.
    </p>
    <p>
      The source code for the Language Server is at <code>/server</code>. The interesting
      section in the server’s <code>package.json</code> file is:
    </p>
    <div class="sourceCode" id="cb7">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb7-1" title="1"><span class="er">&quot;dependencies&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="dt">&quot;vscode-languageserver&quot;</span><span class="fu">:</span> <span class="st">&quot;^7.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="dt">&quot;vscode-languageserver-textdocument&quot;</span><span class="fu">:</span> <span class="st">&quot;^1.0.1&quot;</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="fu">}</span></a></code></pre>
    </div>
    <p>This pulls in the <code>vscode-languageserver</code> libraries.</p>
    <p>
      Below is a server implementation that uses the provided simple text document manager
      that synchronizes text documents by always sending the file’s full content from VS
      Code to the server.
    </p>
    <div class="sourceCode" id="cb8">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  createConnection<span class="op">,</span></a>
<a class="sourceLine" id="cb8-3" title="3">  TextDocuments<span class="op">,</span></a>
<a class="sourceLine" id="cb8-4" title="4">  Diagnostic<span class="op">,</span></a>
<a class="sourceLine" id="cb8-5" title="5">  DiagnosticSeverity<span class="op">,</span></a>
<a class="sourceLine" id="cb8-6" title="6">  ProposedFeatures<span class="op">,</span></a>
<a class="sourceLine" id="cb8-7" title="7">  InitializeParams<span class="op">,</span></a>
<a class="sourceLine" id="cb8-8" title="8">  DidChangeConfigurationNotification<span class="op">,</span></a>
<a class="sourceLine" id="cb8-9" title="9">  CompletionItem<span class="op">,</span></a>
<a class="sourceLine" id="cb8-10" title="10">  CompletionItemKind<span class="op">,</span></a>
<a class="sourceLine" id="cb8-11" title="11">  TextDocumentPositionParams<span class="op">,</span></a>
<a class="sourceLine" id="cb8-12" title="12">  TextDocumentSyncKind<span class="op">,</span></a>
<a class="sourceLine" id="cb8-13" title="13">  InitializeResult</a>
<a class="sourceLine" id="cb8-14" title="14"><span class="op">}</span> <span class="im">from</span> <span class="st">&#39;vscode-languageserver/node&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-15" title="15"></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="im">import</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-17" title="17">  TextDocument</a>
<a class="sourceLine" id="cb8-18" title="18"><span class="op">}</span> <span class="im">from</span> <span class="st">&#39;vscode-languageserver-textdocument&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-19" title="19"></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co">// Create a connection for the server, using Node&#39;s IPC as a transport.</span></a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co">// Also include all preview / proposed LSP features.</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="kw">let</span> connection <span class="op">=</span> <span class="fu">createConnection</span>(<span class="va">ProposedFeatures</span><span class="op">.</span><span class="at">all</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-23" title="23"></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co">// Create a simple text document manager.</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="kw">let</span> documents<span class="op">:</span> TextDocuments<span class="op">&lt;</span>TextDocument<span class="op">&gt;</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">TextDocuments</span>(TextDocument)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-26" title="26"></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="kw">let</span> hasConfigurationCapability<span class="op">:</span> <span class="dt">boolean</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="kw">let</span> hasWorkspaceFolderCapability<span class="op">:</span> <span class="dt">boolean</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="kw">let</span> hasDiagnosticRelatedInformationCapability<span class="op">:</span> <span class="dt">boolean</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-30" title="30"></a>
<a class="sourceLine" id="cb8-31" title="31"><span class="va">connection</span><span class="op">.</span><span class="fu">onInitialize</span>((params<span class="op">:</span> InitializeParams) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-32" title="32">  <span class="kw">let</span> capabilities <span class="op">=</span> <span class="va">params</span><span class="op">.</span><span class="at">capabilities</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-33" title="33"></a>
<a class="sourceLine" id="cb8-34" title="34">  <span class="co">// Does the client support the `workspace/configuration` request?</span></a>
<a class="sourceLine" id="cb8-35" title="35">  <span class="co">// If not, we fall back using global settings.</span></a>
<a class="sourceLine" id="cb8-36" title="36">  hasConfigurationCapability <span class="op">=</span> <span class="op">!!</span>(</a>
<a class="sourceLine" id="cb8-37" title="37">    <span class="va">capabilities</span><span class="op">.</span><span class="at">workspace</span> <span class="op">&amp;&amp;</span> <span class="op">!!</span><span class="va">capabilities</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="at">configuration</span></a>
<a class="sourceLine" id="cb8-38" title="38">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-39" title="39">  hasWorkspaceFolderCapability <span class="op">=</span> <span class="op">!!</span>(</a>
<a class="sourceLine" id="cb8-40" title="40">    <span class="va">capabilities</span><span class="op">.</span><span class="at">workspace</span> <span class="op">&amp;&amp;</span> <span class="op">!!</span><span class="va">capabilities</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="at">workspaceFolders</span></a>
<a class="sourceLine" id="cb8-41" title="41">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-42" title="42">  hasDiagnosticRelatedInformationCapability <span class="op">=</span> <span class="op">!!</span>(</a>
<a class="sourceLine" id="cb8-43" title="43">    <span class="va">capabilities</span><span class="op">.</span><span class="at">textDocument</span> <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb8-44" title="44">    <span class="va">capabilities</span><span class="op">.</span><span class="va">textDocument</span><span class="op">.</span><span class="at">publishDiagnostics</span> <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb8-45" title="45">    <span class="va">capabilities</span><span class="op">.</span><span class="va">textDocument</span><span class="op">.</span><span class="va">publishDiagnostics</span><span class="op">.</span><span class="at">relatedInformation</span></a>
<a class="sourceLine" id="cb8-46" title="46">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-47" title="47"></a>
<a class="sourceLine" id="cb8-48" title="48">  <span class="kw">const</span> result<span class="op">:</span> InitializeResult <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-49" title="49">    capabilities<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-50" title="50">      textDocumentSync<span class="op">:</span> <span class="va">TextDocumentSyncKind</span><span class="op">.</span><span class="at">Incremental</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-51" title="51">      <span class="co">// Tell the client that this server supports code completion.</span></a>
<a class="sourceLine" id="cb8-52" title="52">      completionProvider<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-53" title="53">        resolveProvider<span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb8-54" title="54">      <span class="op">}</span></a>
<a class="sourceLine" id="cb8-55" title="55">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-56" title="56">  <span class="op">};</span></a>
<a class="sourceLine" id="cb8-57" title="57">  <span class="fu">if</span> (hasWorkspaceFolderCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-58" title="58">    <span class="va">result</span><span class="op">.</span><span class="va">capabilities</span><span class="op">.</span><span class="at">workspace</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-59" title="59">      workspaceFolders<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-60" title="60">        supported<span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb8-61" title="61">      <span class="op">}</span></a>
<a class="sourceLine" id="cb8-62" title="62">    <span class="op">};</span></a>
<a class="sourceLine" id="cb8-63" title="63">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-64" title="64">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb8-65" title="65"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-66" title="66"></a>
<a class="sourceLine" id="cb8-67" title="67"><span class="va">connection</span><span class="op">.</span><span class="fu">onInitialized</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-68" title="68">  <span class="fu">if</span> (hasConfigurationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-69" title="69">    <span class="co">// Register for all configuration changes.</span></a>
<a class="sourceLine" id="cb8-70" title="70">    <span class="va">connection</span><span class="op">.</span><span class="va">client</span><span class="op">.</span><span class="fu">register</span>(<span class="va">DidChangeConfigurationNotification</span><span class="op">.</span><span class="at">type</span><span class="op">,</span> <span class="kw">undefined</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-71" title="71">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-72" title="72">  <span class="fu">if</span> (hasWorkspaceFolderCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-73" title="73">    <span class="va">connection</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="fu">onDidChangeWorkspaceFolders</span>(_event <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-74" title="74">      <span class="va">connection</span><span class="op">.</span><span class="va">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Workspace folder change event received.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-75" title="75">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-76" title="76">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-77" title="77"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-78" title="78"></a>
<a class="sourceLine" id="cb8-79" title="79"><span class="co">// The example settings</span></a>
<a class="sourceLine" id="cb8-80" title="80"><span class="kw">interface</span> ExampleSettings <span class="op">{</span></a>
<a class="sourceLine" id="cb8-81" title="81">  maxNumberOfProblems<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-82" title="82"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-83" title="83"></a>
<a class="sourceLine" id="cb8-84" title="84"><span class="co">// The global settings, used when the `workspace/configuration` request is not supported by the client.</span></a>
<a class="sourceLine" id="cb8-85" title="85"><span class="co">// Please note that this is not the case when using this server with the client provided in this example</span></a>
<a class="sourceLine" id="cb8-86" title="86"><span class="co">// but could happen with other clients.</span></a>
<a class="sourceLine" id="cb8-87" title="87"><span class="kw">const</span> defaultSettings<span class="op">:</span> ExampleSettings <span class="op">=</span> <span class="op">{</span> maxNumberOfProblems<span class="op">:</span> <span class="dv">1000</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb8-88" title="88"><span class="kw">let</span> globalSettings<span class="op">:</span> ExampleSettings <span class="op">=</span> defaultSettings<span class="op">;</span></a>
<a class="sourceLine" id="cb8-89" title="89"></a>
<a class="sourceLine" id="cb8-90" title="90"><span class="co">// Cache the settings of all open documents</span></a>
<a class="sourceLine" id="cb8-91" title="91"><span class="kw">let</span> documentSettings<span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> Thenable<span class="op">&lt;</span>ExampleSettings<span class="op">&gt;&gt;</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-92" title="92"></a>
<a class="sourceLine" id="cb8-93" title="93"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidChangeConfiguration</span>(change <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-94" title="94">  <span class="fu">if</span> (hasConfigurationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-95" title="95">    <span class="co">// Reset all cached document settings</span></a>
<a class="sourceLine" id="cb8-96" title="96">    <span class="va">documentSettings</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-97" title="97">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-98" title="98">    globalSettings <span class="op">=</span> <span class="op">&lt;</span>ExampleSettings<span class="op">&gt;</span>(</a>
<a class="sourceLine" id="cb8-99" title="99">      (<span class="va">change</span><span class="op">.</span><span class="va">settings</span><span class="op">.</span><span class="at">languageServerExample</span> <span class="op">||</span> defaultSettings)</a>
<a class="sourceLine" id="cb8-100" title="100">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-101" title="101">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-102" title="102"></a>
<a class="sourceLine" id="cb8-103" title="103">  <span class="co">// Revalidate all open text documents</span></a>
<a class="sourceLine" id="cb8-104" title="104">  <span class="va">documents</span><span class="op">.</span><span class="fu">all</span>().<span class="fu">forEach</span>(validateTextDocument)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-105" title="105"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-106" title="106"></a>
<a class="sourceLine" id="cb8-107" title="107"><span class="kw">function</span> <span class="fu">getDocumentSettings</span>(resource<span class="op">:</span> <span class="dt">string</span>)<span class="op">:</span> Thenable<span class="op">&lt;</span>ExampleSettings<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-108" title="108">  <span class="fu">if</span> (<span class="op">!</span>hasConfigurationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-109" title="109">    <span class="cf">return</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>(globalSettings)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-110" title="110">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-111" title="111">  <span class="kw">let</span> result <span class="op">=</span> <span class="va">documentSettings</span><span class="op">.</span><span class="fu">get</span>(resource)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-112" title="112">  <span class="fu">if</span> (<span class="op">!</span>result) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-113" title="113">    result <span class="op">=</span> <span class="va">connection</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="fu">getConfiguration</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb8-114" title="114">      scopeUri<span class="op">:</span> resource<span class="op">,</span></a>
<a class="sourceLine" id="cb8-115" title="115">      section<span class="op">:</span> <span class="st">&#39;languageServerExample&#39;</span></a>
<a class="sourceLine" id="cb8-116" title="116">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-117" title="117">    <span class="va">documentSettings</span><span class="op">.</span><span class="fu">set</span>(resource<span class="op">,</span> result)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-118" title="118">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-119" title="119">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb8-120" title="120"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-121" title="121"></a>
<a class="sourceLine" id="cb8-122" title="122"><span class="co">// Only keep settings for open documents</span></a>
<a class="sourceLine" id="cb8-123" title="123"><span class="va">documents</span><span class="op">.</span><span class="fu">onDidClose</span>(e <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-124" title="124">  <span class="va">documentSettings</span><span class="op">.</span><span class="fu">delete</span>(<span class="va">e</span><span class="op">.</span><span class="va">document</span><span class="op">.</span><span class="at">uri</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-125" title="125"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-126" title="126"></a>
<a class="sourceLine" id="cb8-127" title="127"><span class="co">// The content of a text document has changed. This event is emitted</span></a>
<a class="sourceLine" id="cb8-128" title="128"><span class="co">// when the text document first opened or when its content has changed.</span></a>
<a class="sourceLine" id="cb8-129" title="129"><span class="va">documents</span><span class="op">.</span><span class="fu">onDidChangeContent</span>(change <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-130" title="130">  <span class="fu">validateTextDocument</span>(<span class="va">change</span><span class="op">.</span><span class="at">document</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-131" title="131"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-132" title="132"></a>
<a class="sourceLine" id="cb8-133" title="133"><span class="kw">async</span> <span class="kw">function</span> <span class="fu">validateTextDocument</span>(textDocument<span class="op">:</span> TextDocument)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-134" title="134">  <span class="co">// In this simple example we get the settings for every validate run.</span></a>
<a class="sourceLine" id="cb8-135" title="135">  <span class="kw">let</span> settings <span class="op">=</span> <span class="cf">await</span> <span class="fu">getDocumentSettings</span>(<span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-136" title="136"></a>
<a class="sourceLine" id="cb8-137" title="137">  <span class="co">// The validator creates diagnostics for all uppercase words length 2 and more</span></a>
<a class="sourceLine" id="cb8-138" title="138">  <span class="kw">let</span> text <span class="op">=</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">getText</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-139" title="139">  <span class="kw">let</span> pattern <span class="op">=</span> <span class="ss">/</span><span class="sc">\b[A-Z]{2,}\b</span><span class="ss">/g</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-140" title="140">  <span class="kw">let</span> m<span class="op">:</span> RegExpExecArray <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-141" title="141"></a>
<a class="sourceLine" id="cb8-142" title="142">  <span class="kw">let</span> problems <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-143" title="143">  <span class="kw">let</span> diagnostics<span class="op">:</span> Diagnostic<span class="op">[]</span> <span class="op">=</span> <span class="op">[];</span></a>
<a class="sourceLine" id="cb8-144" title="144">  <span class="fu">while</span> ((m <span class="op">=</span> <span class="va">pattern</span><span class="op">.</span><span class="fu">exec</span>(text)) <span class="op">&amp;&amp;</span> problems <span class="op">&lt;</span> <span class="va">settings</span><span class="op">.</span><span class="at">maxNumberOfProblems</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-145" title="145">    problems<span class="op">++;</span></a>
<a class="sourceLine" id="cb8-146" title="146">    <span class="kw">let</span> diagnostic<span class="op">:</span> Diagnostic <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-147" title="147">      severity<span class="op">:</span> <span class="va">DiagnosticSeverity</span><span class="op">.</span><span class="at">Warning</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-148" title="148">      range<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-149" title="149">        start<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb8-150" title="150">        end<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span> <span class="op">+</span> m<span class="op">[</span><span class="dv">0</span><span class="op">]</span>.<span class="at">length</span>)</a>
<a class="sourceLine" id="cb8-151" title="151">      <span class="op">},</span></a>
<a class="sourceLine" id="cb8-152" title="152">      message<span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="sc">}</span><span class="vs"> is all uppercase.`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-153" title="153">      source<span class="op">:</span> <span class="st">&#39;ex&#39;</span></a>
<a class="sourceLine" id="cb8-154" title="154">    <span class="op">};</span></a>
<a class="sourceLine" id="cb8-155" title="155">    <span class="fu">if</span> (hasDiagnosticRelatedInformationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-156" title="156">      <span class="va">diagnostic</span><span class="op">.</span><span class="at">relatedInformation</span> <span class="op">=</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb8-157" title="157">        <span class="op">{</span></a>
<a class="sourceLine" id="cb8-158" title="158">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-159" title="159">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-160" title="160">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb8-161" title="161">          <span class="op">},</span></a>
<a class="sourceLine" id="cb8-162" title="162">          message<span class="op">:</span> <span class="st">&#39;Spelling matters&#39;</span></a>
<a class="sourceLine" id="cb8-163" title="163">        <span class="op">},</span></a>
<a class="sourceLine" id="cb8-164" title="164">        <span class="op">{</span></a>
<a class="sourceLine" id="cb8-165" title="165">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-166" title="166">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-167" title="167">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb8-168" title="168">          <span class="op">},</span></a>
<a class="sourceLine" id="cb8-169" title="169">          message<span class="op">:</span> <span class="st">&#39;Particularly for names&#39;</span></a>
<a class="sourceLine" id="cb8-170" title="170">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-171" title="171">      <span class="op">];</span></a>
<a class="sourceLine" id="cb8-172" title="172">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-173" title="173">    <span class="va">diagnostics</span><span class="op">.</span><span class="fu">push</span>(diagnostic)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-174" title="174">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-175" title="175"></a>
<a class="sourceLine" id="cb8-176" title="176">  <span class="co">// Send the computed diagnostics to VS Code.</span></a>
<a class="sourceLine" id="cb8-177" title="177">  <span class="va">connection</span><span class="op">.</span><span class="fu">sendDiagnostics</span>(<span class="op">{</span> uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span> diagnostics <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-178" title="178"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-179" title="179"></a>
<a class="sourceLine" id="cb8-180" title="180"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidChangeWatchedFiles</span>(_change <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-181" title="181">  <span class="co">// Monitored files have change in VS Code</span></a>
<a class="sourceLine" id="cb8-182" title="182">  <span class="va">connection</span><span class="op">.</span><span class="va">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;We received a file change event&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-183" title="183"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-184" title="184"></a>
<a class="sourceLine" id="cb8-185" title="185"><span class="co">// This handler provides the initial list of the completion items.</span></a>
<a class="sourceLine" id="cb8-186" title="186"><span class="va">connection</span><span class="op">.</span><span class="fu">onCompletion</span>(</a>
<a class="sourceLine" id="cb8-187" title="187">  (_textDocumentPosition<span class="op">:</span> TextDocumentPositionParams)<span class="op">:</span> CompletionItem<span class="op">[]</span> <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-188" title="188">    <span class="co">// The pass parameter contains the position of the text document in</span></a>
<a class="sourceLine" id="cb8-189" title="189">    <span class="co">// which code complete got requested. For the example we ignore this</span></a>
<a class="sourceLine" id="cb8-190" title="190">    <span class="co">// info and always provide the same completion items.</span></a>
<a class="sourceLine" id="cb8-191" title="191">    <span class="cf">return</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb8-192" title="192">      <span class="op">{</span></a>
<a class="sourceLine" id="cb8-193" title="193">        label<span class="op">:</span> <span class="st">&#39;TypeScript&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-194" title="194">        kind<span class="op">:</span> <span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-195" title="195">        data<span class="op">:</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-196" title="196">      <span class="op">},</span></a>
<a class="sourceLine" id="cb8-197" title="197">      <span class="op">{</span></a>
<a class="sourceLine" id="cb8-198" title="198">        label<span class="op">:</span> <span class="st">&#39;JavaScript&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-199" title="199">        kind<span class="op">:</span> <span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-200" title="200">        data<span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb8-201" title="201">      <span class="op">}</span></a>
<a class="sourceLine" id="cb8-202" title="202">    <span class="op">];</span></a>
<a class="sourceLine" id="cb8-203" title="203">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-204" title="204">)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-205" title="205"></a>
<a class="sourceLine" id="cb8-206" title="206"><span class="co">// This handler resolves additional information for the item selected in</span></a>
<a class="sourceLine" id="cb8-207" title="207"><span class="co">// the completion list.</span></a>
<a class="sourceLine" id="cb8-208" title="208"><span class="va">connection</span><span class="op">.</span><span class="fu">onCompletionResolve</span>(</a>
<a class="sourceLine" id="cb8-209" title="209">  (item<span class="op">:</span> CompletionItem)<span class="op">:</span> CompletionItem <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-210" title="210">    <span class="fu">if</span> (<span class="va">item</span><span class="op">.</span><span class="at">data</span> <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-211" title="211">      <span class="va">item</span><span class="op">.</span><span class="at">detail</span> <span class="op">=</span> <span class="st">&#39;TypeScript details&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-212" title="212">      <span class="va">item</span><span class="op">.</span><span class="at">documentation</span> <span class="op">=</span> <span class="st">&#39;TypeScript documentation&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-213" title="213">    <span class="op">}</span> <span class="cf">else</span> <span class="fu">if</span> (<span class="va">item</span><span class="op">.</span><span class="at">data</span> <span class="op">===</span> <span class="dv">2</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-214" title="214">      <span class="va">item</span><span class="op">.</span><span class="at">detail</span> <span class="op">=</span> <span class="st">&#39;JavaScript details&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-215" title="215">      <span class="va">item</span><span class="op">.</span><span class="at">documentation</span> <span class="op">=</span> <span class="st">&#39;JavaScript documentation&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-216" title="216">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-217" title="217">    <span class="cf">return</span> item<span class="op">;</span></a>
<a class="sourceLine" id="cb8-218" title="218">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-219" title="219">)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-220" title="220"></a>
<a class="sourceLine" id="cb8-221" title="221"><span class="co">// Make the text document manager listen on the connection</span></a>
<a class="sourceLine" id="cb8-222" title="222"><span class="co">// for open, change and close text document events</span></a>
<a class="sourceLine" id="cb8-223" title="223"><span class="va">documents</span><span class="op">.</span><span class="fu">listen</span>(connection)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-224" title="224"></a>
<a class="sourceLine" id="cb8-225" title="225"><span class="co">// Listen on the connection</span></a>
<a class="sourceLine" id="cb8-226" title="226"><span class="va">connection</span><span class="op">.</span><span class="fu">listen</span>()<span class="op">;</span></a></code></pre>
    </div>
    <h3 id="adding-a-simple-validation">Adding a Simple Validation</h3>
    <p>
      To add document validation to the server, we add a listener to the text document
      manager that gets called whenever the content of a text document changes. It is then
      up to the server to decide when the best time is to validate a document. In the
      example implementation, the server validates the plain text document and flags all
      occurrences of words that use ALL CAPS. The corresponding code snippet looks like
      this:
    </p>
    <div class="sourceCode" id="cb9">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// The content of a text document has changed. This event is emitted</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">// when the text document first opened or when its content has changed.</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="va">documents</span><span class="op">.</span><span class="fu">onDidChangeContent</span>(<span class="fu">async</span>(change) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="kw">let</span> textDocument <span class="op">=</span> <span class="va">change</span><span class="op">.</span><span class="at">document</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" title="5">  <span class="co">// In this simple example we get the settings for every validate run.</span></a>
<a class="sourceLine" id="cb9-6" title="6">  <span class="kw">let</span> settings <span class="op">=</span> <span class="cf">await</span> <span class="fu">getDocumentSettings</span>(<span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8">  <span class="co">// The validator creates diagnostics for all uppercase words length 2 and more</span></a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="kw">let</span> text <span class="op">=</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">getText</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-10" title="10">  <span class="kw">let</span> pattern <span class="op">=</span> <span class="ss">/</span><span class="sc">\b[A-Z]{2,}\b</span><span class="ss">/g</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-11" title="11">  <span class="kw">let</span> m<span class="op">:</span> RegExpExecArray <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-12" title="12"></a>
<a class="sourceLine" id="cb9-13" title="13">  <span class="kw">let</span> problems <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-14" title="14">  <span class="kw">let</span> diagnostics<span class="op">:</span> Diagnostic<span class="op">[]</span> <span class="op">=</span> <span class="op">[];</span></a>
<a class="sourceLine" id="cb9-15" title="15">  <span class="fu">while</span> ((m <span class="op">=</span> <span class="va">pattern</span><span class="op">.</span><span class="fu">exec</span>(text)) <span class="op">&amp;&amp;</span> problems <span class="op">&lt;</span> <span class="va">settings</span><span class="op">.</span><span class="at">maxNumberOfProblems</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-16" title="16">    problems<span class="op">++;</span></a>
<a class="sourceLine" id="cb9-17" title="17">    <span class="kw">let</span> diagnostic<span class="op">:</span> Diagnostic <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-18" title="18">      severity<span class="op">:</span> <span class="va">DiagnosticSeverity</span><span class="op">.</span><span class="at">Warning</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-19" title="19">      range<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-20" title="20">        start<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb9-21" title="21">        end<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span> <span class="op">+</span> m<span class="op">[</span><span class="dv">0</span><span class="op">]</span>.<span class="at">length</span>)</a>
<a class="sourceLine" id="cb9-22" title="22">      <span class="op">},</span></a>
<a class="sourceLine" id="cb9-23" title="23">      message<span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="sc">}</span><span class="vs"> is all uppercase.`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-24" title="24">      source<span class="op">:</span> <span class="st">&#39;ex&#39;</span></a>
<a class="sourceLine" id="cb9-25" title="25">    <span class="op">};</span></a>
<a class="sourceLine" id="cb9-26" title="26">    <span class="fu">if</span> (hasDiagnosticRelatedInformationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-27" title="27">      <span class="va">diagnostic</span><span class="op">.</span><span class="at">relatedInformation</span> <span class="op">=</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb9-28" title="28">        <span class="op">{</span></a>
<a class="sourceLine" id="cb9-29" title="29">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-30" title="30">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-31" title="31">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb9-32" title="32">          <span class="op">},</span></a>
<a class="sourceLine" id="cb9-33" title="33">          message<span class="op">:</span> <span class="st">&#39;Spelling matters&#39;</span></a>
<a class="sourceLine" id="cb9-34" title="34">        <span class="op">},</span></a>
<a class="sourceLine" id="cb9-35" title="35">        <span class="op">{</span></a>
<a class="sourceLine" id="cb9-36" title="36">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-37" title="37">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-38" title="38">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb9-39" title="39">          <span class="op">},</span></a>
<a class="sourceLine" id="cb9-40" title="40">          message<span class="op">:</span> <span class="st">&#39;Particularly for names&#39;</span></a>
<a class="sourceLine" id="cb9-41" title="41">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-42" title="42">      <span class="op">];</span></a>
<a class="sourceLine" id="cb9-43" title="43">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-44" title="44">    <span class="va">diagnostics</span><span class="op">.</span><span class="fu">push</span>(diagnostic)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-45" title="45">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-46" title="46"></a>
<a class="sourceLine" id="cb9-47" title="47">  <span class="co">// Send the computed diagnostics to VS Code.</span></a>
<a class="sourceLine" id="cb9-48" title="48">  <span class="va">connection</span><span class="op">.</span><span class="fu">sendDiagnostics</span>(<span class="op">{</span> uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span> diagnostics <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-49" title="49"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <h3 id="diagnostics-tips-and-tricks">Diagnostics Tips and Tricks</h3>
    <ul>
      <li>
        If the start and end positions are the same, VS Code will underline with a squiggle
        the word at that position.
      </li>
      <li>
        If you want to underline with a squiggle until the end of the line, then set the
        character of the end position to Number.MAX_VALUE.
      </li>
    </ul>
    <p>To run the Language Server, do the following steps:</p>
    <ul>
      <li>
        Press <code>kb(workbench.action.tasks.build)</code> to start the build task. The
        task compiles both the client and the server.
      </li>
      <li>
        Open the <strong>Run</strong> view, select the <strong>Launch Client</strong> launch
        configuration, and press the <strong>Start Debugging</strong> button to launch an
        additional <strong>Extension Development Host</strong> instance of VS Code that
        executes the extension code.
      </li>
      <li>
        Create a <code>test.txt</code> file in the root folder and paste the following
        content:
      </li>
    </ul>
    <pre><code>TypeScript lets you write JavaScript the way you really want to.
TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.
ANY browser. ANY host. ANY OS. Open Source.</code></pre>
    <p>
      The <strong>Extension Development Host</strong> instance will then look like this:
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/validation.png"
        alt="Validating a text file"
      />
      <figcaption>Validating a text file</figcaption>
    </figure>
    <h3 id="debugging-both-client-and-server">Debugging both Client and Server</h3>
    <p>
      Debugging the client code is as easy as debugging a normal extension. Set a breakpoint
      in the client code and debug the extension by pressing
      <code>kb(workbench.action.debug.start)</code>.
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/debugging-client.png"
        alt="Debugging the client"
      />
      <figcaption>Debugging the client</figcaption>
    </figure>
    <p>
      Since the server is started by the <code>LanguageClient</code> running in the
      extension (client), we need to attach a debugger to the running server. To do so,
      switch to the Run view and select the launch configuration
      <strong>Attach to Server</strong> and press
      <code>kb(workbench.action.debug.start)</code>. This will attach the debugger to the
      server.
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/debugging-server.png"
        alt="Debugging the server"
      />
      <figcaption>Debugging the server</figcaption>
    </figure>
    <h3 id="logging-support-for-language-server">Logging Support for Language Server</h3>
    <p>
      If you are using <code>vscode-languageclient</code> to implement the client, you can
      specify a setting <code>[langId].trace.server</code> that instructs the Client to log
      communications between Language Client / Server to a channel of the Language Client’s
      <code>name</code>.
    </p>
    <p>
      For <strong>lsp-sample</strong>, you can set this setting:
      <code>"languageServerExample.trace.server": "verbose"</code>. Now head to the channel
      “Language Server Example”. You should see the logs:
    </p>
    <figure>
      <img src="images/language-server-extension-guide/lsp-log.png" alt="LSP Log" />
      <figcaption>LSP Log</figcaption>
    </figure>
    <h3 id="using-configuration-settings-in-the-server">
      Using Configuration Settings in the Server
    </h3>
    <p>
      When writing the client part of the extension, we already defined a setting to control
      the maximum numbers of problems reported. We also wrote code on the server side to
      read these settings from the client:
    </p>
    <div class="sourceCode" id="cb11">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">function</span> <span class="fu">getDocumentSettings</span>(resource<span class="op">:</span> <span class="dt">string</span>)<span class="op">:</span> Thenable<span class="op">&lt;</span>ExampleSettings<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="fu">if</span> (<span class="op">!</span>hasConfigurationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="cf">return</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>(globalSettings)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="kw">let</span> result <span class="op">=</span> <span class="va">documentSettings</span><span class="op">.</span><span class="fu">get</span>(resource)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6">  <span class="fu">if</span> (<span class="op">!</span>result) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">    result <span class="op">=</span> <span class="va">connection</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="fu">getConfiguration</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb11-8" title="8">      scopeUri<span class="op">:</span> resource<span class="op">,</span></a>
<a class="sourceLine" id="cb11-9" title="9">      section<span class="op">:</span> <span class="st">&#39;languageServerExample&#39;</span></a>
<a class="sourceLine" id="cb11-10" title="10">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-11" title="11">    <span class="va">documentSettings</span><span class="op">.</span><span class="fu">set</span>(resource<span class="op">,</span> result)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-13" title="13">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="op">}</span></a></code></pre>
    </div>
    <p>
      The only thing we need to do now is to listen to configuration changes on the server
      side and if a setting changes, revalidate the open text documents. To be able to reuse
      the validate logic of the document change event handling, we extract the code into a
      <code>validateTextDocument</code> function and modify the code to honor a
      <code>maxNumberOfProblems</code> variable:
    </p>
    <div class="sourceCode" id="cb12">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="fu">validateTextDocument</span>(textDocument<span class="op">:</span> TextDocument)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="co">// In this simple example we get the settings for every validate run.</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="kw">let</span> settings <span class="op">=</span> <span class="cf">await</span> <span class="fu">getDocumentSettings</span>(<span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-4" title="4"></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="co">// The validator creates diagnostics for all uppercase words length 2 and more</span></a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="kw">let</span> text <span class="op">=</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">getText</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb12-7" title="7">  <span class="kw">let</span> pattern <span class="op">=</span> <span class="ss">/</span><span class="sc">\b[A-Z]{2,}\b</span><span class="ss">/g</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-8" title="8">  <span class="kw">let</span> m<span class="op">:</span> RegExpExecArray <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-9" title="9"></a>
<a class="sourceLine" id="cb12-10" title="10">  <span class="kw">let</span> problems <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-11" title="11">  <span class="kw">let</span> diagnostics<span class="op">:</span> Diagnostic<span class="op">[]</span> <span class="op">=</span> <span class="op">[];</span></a>
<a class="sourceLine" id="cb12-12" title="12">  <span class="fu">while</span> ((m <span class="op">=</span> <span class="va">pattern</span><span class="op">.</span><span class="fu">exec</span>(text)) <span class="op">&amp;&amp;</span> problems <span class="op">&lt;</span> <span class="va">settings</span><span class="op">.</span><span class="at">maxNumberOfProblems</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-13" title="13">    problems<span class="op">++;</span></a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="kw">let</span> diagnostic<span class="op">:</span> Diagnostic <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-15" title="15">      severity<span class="op">:</span> <span class="va">DiagnosticSeverity</span><span class="op">.</span><span class="at">Warning</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-16" title="16">      range<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-17" title="17">        start<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-18" title="18">        end<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="fu">positionAt</span>(<span class="va">m</span><span class="op">.</span><span class="at">index</span> <span class="op">+</span> m<span class="op">[</span><span class="dv">0</span><span class="op">]</span>.<span class="at">length</span>)</a>
<a class="sourceLine" id="cb12-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb12-20" title="20">      message<span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="sc">}</span><span class="vs"> is all uppercase.`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-21" title="21">      source<span class="op">:</span> <span class="st">&#39;ex&#39;</span></a>
<a class="sourceLine" id="cb12-22" title="22">    <span class="op">};</span></a>
<a class="sourceLine" id="cb12-23" title="23">    <span class="fu">if</span> (hasDiagnosticRelatedInformationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-24" title="24">      <span class="va">diagnostic</span><span class="op">.</span><span class="at">relatedInformation</span> <span class="op">=</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb12-25" title="25">        <span class="op">{</span></a>
<a class="sourceLine" id="cb12-26" title="26">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-27" title="27">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-28" title="28">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb12-29" title="29">          <span class="op">},</span></a>
<a class="sourceLine" id="cb12-30" title="30">          message<span class="op">:</span> <span class="st">&#39;Spelling matters&#39;</span></a>
<a class="sourceLine" id="cb12-31" title="31">        <span class="op">},</span></a>
<a class="sourceLine" id="cb12-32" title="32">        <span class="op">{</span></a>
<a class="sourceLine" id="cb12-33" title="33">          location<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-34" title="34">            uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-35" title="35">            range<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">assign</span>(<span class="op">{},</span> <span class="va">diagnostic</span><span class="op">.</span><span class="at">range</span>)</a>
<a class="sourceLine" id="cb12-36" title="36">          <span class="op">},</span></a>
<a class="sourceLine" id="cb12-37" title="37">          message<span class="op">:</span> <span class="st">&#39;Particularly for names&#39;</span></a>
<a class="sourceLine" id="cb12-38" title="38">        <span class="op">}</span></a>
<a class="sourceLine" id="cb12-39" title="39">      <span class="op">];</span></a>
<a class="sourceLine" id="cb12-40" title="40">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-41" title="41">    <span class="va">diagnostics</span><span class="op">.</span><span class="fu">push</span>(diagnostic)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb12-43" title="43"></a>
<a class="sourceLine" id="cb12-44" title="44">  <span class="co">// Send the computed diagnostics to VS Code.</span></a>
<a class="sourceLine" id="cb12-45" title="45">  <span class="va">connection</span><span class="op">.</span><span class="fu">sendDiagnostics</span>(<span class="op">{</span> uri<span class="op">:</span> <span class="va">textDocument</span><span class="op">.</span><span class="at">uri</span><span class="op">,</span> diagnostics <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-46" title="46"><span class="op">}</span></a></code></pre>
    </div>
    <p>
      The handling of the configuration change is done by adding a notification handler for
      configuration changes to the connection. The corresponding code looks like this:
    </p>
    <div class="sourceCode" id="cb13">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb13-1" title="1"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidChangeConfiguration</span>(change <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="fu">if</span> (hasConfigurationCapability) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="co">// Reset all cached document settings</span></a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="va">documentSettings</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-6" title="6">    globalSettings <span class="op">=</span> <span class="op">&lt;</span>ExampleSettings<span class="op">&gt;</span>(</a>
<a class="sourceLine" id="cb13-7" title="7">      (<span class="va">change</span><span class="op">.</span><span class="va">settings</span><span class="op">.</span><span class="at">languageServerExample</span> <span class="op">||</span> defaultSettings)</a>
<a class="sourceLine" id="cb13-8" title="8">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb13-9" title="9">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-10" title="10"></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="co">// Revalidate all open text documents</span></a>
<a class="sourceLine" id="cb13-12" title="12">  <span class="va">documents</span><span class="op">.</span><span class="fu">all</span>().<span class="fu">forEach</span>(validateTextDocument)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      Starting the client again and changing the setting to maximum report 1 problem results
      in the following validation:
    </p>
    <figure>
      <img
        src="images/language-server-extension-guide/validationOneProblem.png"
        alt="Maximum One Problem"
      />
      <figcaption>Maximum One Problem</figcaption>
    </figure>
    <h3 id="adding-additional-language-features">Adding additional Language Features</h3>
    <p>
      The first interesting feature a language server usually implements is validation of
      documents. In that sense, even a linter counts as a language server and in VS Code
      linters are usually implemented as language servers (see
      <a href="https://github.com/microsoft/vscode-eslint">eslint</a> and
      <a href="https://github.com/microsoft/vscode-jshint">jshint</a> for examples). But
      there is more to language servers. They can provide code completion, Find All
      References, or Go To Definition. The example code below adds code completion to the
      server. It proposes the two words ‘TypeScript’ and ‘JavaScript’.
    </p>
    <div class="sourceCode" id="cb14">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb14-1" title="1"><span class="co">// This handler provides the initial list of the completion items.</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="va">connection</span><span class="op">.</span><span class="fu">onCompletion</span>(</a>
<a class="sourceLine" id="cb14-3" title="3">  (_textDocumentPosition<span class="op">:</span> TextDocumentPositionParams)<span class="op">:</span> CompletionItem<span class="op">[]</span> <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-4" title="4">    <span class="co">// The pass parameter contains the position of the text document in</span></a>
<a class="sourceLine" id="cb14-5" title="5">    <span class="co">// which code complete got requested. For the example we ignore this</span></a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="co">// info and always provide the same completion items.</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="cf">return</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb14-8" title="8">      <span class="op">{</span></a>
<a class="sourceLine" id="cb14-9" title="9">        label<span class="op">:</span> <span class="st">&#39;TypeScript&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-10" title="10">        kind<span class="op">:</span> <span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-11" title="11">        data<span class="op">:</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb14-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb14-13" title="13">      <span class="op">{</span></a>
<a class="sourceLine" id="cb14-14" title="14">        label<span class="op">:</span> <span class="st">&#39;JavaScript&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-15" title="15">        kind<span class="op">:</span> <span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-16" title="16">        data<span class="op">:</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb14-17" title="17">      <span class="op">}</span></a>
<a class="sourceLine" id="cb14-18" title="18">    <span class="op">];</span></a>
<a class="sourceLine" id="cb14-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-20" title="20">)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-21" title="21"></a>
<a class="sourceLine" id="cb14-22" title="22"><span class="co">// This handler resolves additional information for the item selected in</span></a>
<a class="sourceLine" id="cb14-23" title="23"><span class="co">// the completion list.</span></a>
<a class="sourceLine" id="cb14-24" title="24"><span class="va">connection</span><span class="op">.</span><span class="fu">onCompletionResolve</span>(</a>
<a class="sourceLine" id="cb14-25" title="25">  (item<span class="op">:</span> CompletionItem)<span class="op">:</span> CompletionItem <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-26" title="26">    <span class="fu">if</span> (<span class="va">item</span><span class="op">.</span><span class="at">data</span> <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-27" title="27">      <span class="va">item</span><span class="op">.</span><span class="at">detail</span> <span class="op">=</span> <span class="st">&#39;TypeScript details&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-28" title="28">      <span class="va">item</span><span class="op">.</span><span class="at">documentation</span> <span class="op">=</span> <span class="st">&#39;TypeScript documentation&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-29" title="29">    <span class="op">}</span> <span class="cf">else</span> <span class="fu">if</span> (<span class="va">item</span><span class="op">.</span><span class="at">data</span> <span class="op">===</span> <span class="dv">2</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-30" title="30">      <span class="va">item</span><span class="op">.</span><span class="at">detail</span> <span class="op">=</span> <span class="st">&#39;JavaScript details&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-31" title="31">      <span class="va">item</span><span class="op">.</span><span class="at">documentation</span> <span class="op">=</span> <span class="st">&#39;JavaScript documentation&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb14-33" title="33">    <span class="cf">return</span> item<span class="op">;</span></a>
<a class="sourceLine" id="cb14-34" title="34">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-35" title="35">)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      The <code>data</code> fields are used to uniquely identify a completion item in the
      resolve handler. The data property is transparent for the protocol. Since the
      underlying message passing protocol is JSON-based, the data field should only hold
      data that is serializable to and from JSON.
    </p>
    <p>
      All that is missing is to tell VS Code that the server supports code completion
      requests. To do so, flag the corresponding capability in the initialize handler:
    </p>
    <div class="sourceCode" id="cb15">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb15-1" title="1"><span class="va">connection</span><span class="op">.</span><span class="fu">onInitialize</span>((params)<span class="op">:</span> InitializeResult <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">    <span class="op">...</span></a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-4" title="4">        capabilities<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-5" title="5">            <span class="op">...</span></a>
<a class="sourceLine" id="cb15-6" title="6">            <span class="co">// Tell the client that the server supports code completion</span></a>
<a class="sourceLine" id="cb15-7" title="7">            completionProvider<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-8" title="8">                resolveProvider<span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb15-9" title="9">            <span class="op">}</span></a>
<a class="sourceLine" id="cb15-10" title="10">        <span class="op">}</span></a>
<a class="sourceLine" id="cb15-11" title="11">    <span class="op">};</span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>The screenshot below shows the completed code running on a plain text file:</p>
    <figure>
      <img
        src="images/language-server-extension-guide/codeComplete.png"
        alt="Code Complete"
      />
      <figcaption>Code Complete</figcaption>
    </figure>
    <h3 id="testing-the-language-server">Testing The Language Server</h3>
    <p>
      To create a high-quality Language Server, we need to build a good test suite covering
      its functionalities. There are two common ways of testing Language Servers:
    </p>
    <ul>
      <li>
        Unit Test: This is useful if you want to test specific functionalities in Language
        Servers by mocking up all the information being sent to it. VS Code’s
        <a href="https://github.com/microsoft/vscode-html-languageservice">HTML</a> /
        <a href="https://github.com/microsoft/vscode-css-languageservice">CSS</a> /
        <a href="https://github.com/microsoft/vscode-json-languageservice">JSON</a> Language
        Servers take this approach to testing. The LSP npm modules also use this approach.
        See
        <a
          href="https://github.com/microsoft/vscode-languageserver-node/blob/main/protocol/src/node/test/connection.test.ts"
          >here</a
        >
        for some unit test written using the npm protocol module.
      </li>
      <li>
        End-to-End Test: This is similar to
        <a href="/api/working-with-extensions/testing-extension">VS Code extension test</a>.
        The benefit of this approach is that it runs the test by instantiating a VS Code
        instance with a workspace, opening the file, activating the Language Client /
        Server, and running <a href="/api/references/commands">VS Code commands</a>. This
        approach is superior if you have files, settings, or dependencies (such as
        <code>node_modules</code>) which are hard or impossible to mock. The popular
        <a href="https://github.com/microsoft/vscode-python">Python</a> extension takes this
        approach to testing.
      </li>
    </ul>
    <p>
      It is possible to do Unit Test in any testing framework of your choice. Here we
      describe how to do End-to-End testing for Language Server Extension.
    </p>
    <p>
      Open <code>.vscode/launch.json</code>, and you can find a <code>E2E</code> test
      target:
    </p>
    <div class="sourceCode" id="cb16">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb16-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Language Server E2E Test&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;extensionHost&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="dt">&quot;request&quot;</span><span class="fu">:</span> <span class="st">&quot;launch&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="dt">&quot;runtimeExecutable&quot;</span><span class="fu">:</span> <span class="st">&quot;${execPath}&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb16-6" title="6">  <span class="dt">&quot;args&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb16-7" title="7">    <span class="st">&quot;--extensionDevelopmentPath=${workspaceRoot}&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb16-8" title="8">    <span class="st">&quot;--extensionTestsPath=${workspaceRoot}/client/out/test/index&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb16-9" title="9">    <span class="st">&quot;${workspaceRoot}/client/testFixture&quot;</span></a>
<a class="sourceLine" id="cb16-10" title="10">  <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb16-11" title="11">  <span class="dt">&quot;outFiles&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;${workspaceRoot}/client/out/test/**/*.js&quot;</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="fu">}</span></a></code></pre>
    </div>
    <p>
      If you run this debug target, it will launch a VS Code instance with
      <code>client/testFixture</code> as the active workspace. VS Code will then proceed to
      execute all tests in <code>client/src/test</code>. As a debugging tip, you can set
      breakpoints in TypeScript files in <code>client/src/test</code> and they will be hit.
    </p>
    <p>Let’s take a look at the <code>completion.test.ts</code> file:</p>
    <div class="sourceCode" id="cb17">
      <pre
        class="sourceCode ts"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb17-1" title="1"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> vscode <span class="im">from</span> <span class="st">&#39;vscode&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> assert <span class="im">from</span> <span class="st">&#39;assert&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="im">import</span> <span class="op">{</span> getDocUri<span class="op">,</span> activate <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;./helper&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-4" title="4"></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="fu">suite</span>(<span class="st">&#39;Should do completion&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-6" title="6">  <span class="kw">const</span> docUri <span class="op">=</span> <span class="fu">getDocUri</span>(<span class="st">&#39;completion.txt&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8">  <span class="fu">test</span>(<span class="st">&#39;Completes JS/TS in txt file&#39;</span><span class="op">,</span> <span class="fu">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-9" title="9">    <span class="cf">await</span> <span class="fu">testCompletion</span>(docUri<span class="op">,</span> <span class="kw">new</span> <span class="va">vscode</span><span class="op">.</span><span class="fu">Position</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-10" title="10">      items<span class="op">:</span> <span class="op">[</span></a>
<a class="sourceLine" id="cb17-11" title="11">        <span class="op">{</span> label<span class="op">:</span> <span class="st">&#39;JavaScript&#39;</span><span class="op">,</span> kind<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb17-12" title="12">        <span class="op">{</span> label<span class="op">:</span> <span class="st">&#39;TypeScript&#39;</span><span class="op">,</span> kind<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="va">CompletionItemKind</span><span class="op">.</span><span class="at">Text</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb17-13" title="13">      <span class="op">]</span></a>
<a class="sourceLine" id="cb17-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-15" title="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-17" title="17"></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="kw">async</span> <span class="kw">function</span> <span class="fu">testCompletion</span>(</a>
<a class="sourceLine" id="cb17-19" title="19">  docUri<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">Uri</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-20" title="20">  position<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">Position</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-21" title="21">  expectedCompletionList<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">CompletionList</span></a>
<a class="sourceLine" id="cb17-22" title="22">) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-23" title="23">  <span class="cf">await</span> <span class="fu">activate</span>(docUri)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-24" title="24"></a>
<a class="sourceLine" id="cb17-25" title="25">  <span class="co">// Executing the command `vscode.executeCompletionItemProvider` to simulate triggering completion</span></a>
<a class="sourceLine" id="cb17-26" title="26">  <span class="kw">const</span> actualCompletionList <span class="op">=</span> (<span class="cf">await</span> <span class="va">vscode</span><span class="op">.</span><span class="va">commands</span><span class="op">.</span><span class="fu">executeCommand</span>(</a>
<a class="sourceLine" id="cb17-27" title="27">    <span class="st">&#39;vscode.executeCompletionItemProvider&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-28" title="28">    docUri<span class="op">,</span></a>
<a class="sourceLine" id="cb17-29" title="29">    position</a>
<a class="sourceLine" id="cb17-30" title="30">  )) <span class="im">as</span> <span class="va">vscode</span><span class="op">.</span><span class="at">CompletionList</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-31" title="31"></a>
<a class="sourceLine" id="cb17-32" title="32">  <span class="va">assert</span><span class="op">.</span><span class="fu">ok</span>(<span class="va">actualCompletionList</span><span class="op">.</span><span class="va">items</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-33" title="33">  <span class="va">expectedCompletionList</span><span class="op">.</span><span class="va">items</span><span class="op">.</span><span class="fu">forEach</span>((expectedItem<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-34" title="34">    <span class="kw">const</span> actualItem <span class="op">=</span> <span class="va">actualCompletionList</span><span class="op">.</span><span class="at">items</span><span class="op">[</span>i<span class="op">];</span></a>
<a class="sourceLine" id="cb17-35" title="35">    <span class="va">assert</span><span class="op">.</span><span class="fu">equal</span>(<span class="va">actualItem</span><span class="op">.</span><span class="at">label</span><span class="op">,</span> <span class="va">expectedItem</span><span class="op">.</span><span class="at">label</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-36" title="36">    <span class="va">assert</span><span class="op">.</span><span class="fu">equal</span>(<span class="va">actualItem</span><span class="op">.</span><span class="at">kind</span><span class="op">,</span> <span class="va">expectedItem</span><span class="op">.</span><span class="at">kind</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-37" title="37">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-38" title="38"><span class="op">}</span></a></code></pre>
    </div>
    <p>In this test, we:</p>
    <ul>
      <li>Activate the extension.</li>
      <li>
        Run the command <code>vscode.executeCompletionItemProvider</code> with a URI and a
        position to simulate completion trigger.
      </li>
      <li>Assert the returned completion items against our expected completion items.</li>
    </ul>
    <p>
      Let’s dive a bit deeper into the <code>activate(docURI)</code> function. It is defined
      in <code>client/src/test/helper.ts</code>:
    </p>
    <div class="sourceCode" id="cb18">
      <pre
        class="sourceCode ts"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb18-1" title="1"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> vscode <span class="im">from</span> <span class="st">&#39;vscode&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> path <span class="im">from</span> <span class="st">&#39;path&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="im">export</span> <span class="kw">let</span> doc<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">TextDocument</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="im">export</span> <span class="kw">let</span> editor<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">TextEditor</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="im">export</span> <span class="kw">let</span> documentEol<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="im">export</span> <span class="kw">let</span> platformEol<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-8" title="8"></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">/**</span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co"> * Activates the vscode.lsp-sample extension</span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co"> */</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="im">export</span> <span class="kw">async</span> <span class="kw">function</span> <span class="fu">activate</span>(docUri<span class="op">:</span> <span class="va">vscode</span><span class="op">.</span><span class="at">Uri</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-13" title="13">  <span class="co">// The extensionId is `publisher.name` from package.json</span></a>
<a class="sourceLine" id="cb18-14" title="14">  <span class="kw">const</span> ext <span class="op">=</span> <span class="va">vscode</span><span class="op">.</span><span class="va">extensions</span><span class="op">.</span><span class="fu">getExtension</span>(<span class="st">&#39;vscode-samples.lsp-sample&#39;</span>)<span class="op">!;</span></a>
<a class="sourceLine" id="cb18-15" title="15">  <span class="cf">await</span> <span class="va">ext</span><span class="op">.</span><span class="fu">activate</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-16" title="16">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-17" title="17">    doc <span class="op">=</span> <span class="cf">await</span> <span class="va">vscode</span><span class="op">.</span><span class="va">workspace</span><span class="op">.</span><span class="fu">openTextDocument</span>(docUri)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-18" title="18">    editor <span class="op">=</span> <span class="cf">await</span> <span class="va">vscode</span><span class="op">.</span><span class="va">window</span><span class="op">.</span><span class="fu">showTextDocument</span>(doc)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-19" title="19">    <span class="cf">await</span> <span class="fu">sleep</span>(<span class="dv">2000</span>)<span class="op">;</span> <span class="co">// Wait for server activation</span></a>
<a class="sourceLine" id="cb18-20" title="20">  <span class="op">}</span> <span class="fu">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-21" title="21">    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-22" title="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-23" title="23"><span class="op">}</span></a>
<a class="sourceLine" id="cb18-24" title="24"></a>
<a class="sourceLine" id="cb18-25" title="25"><span class="kw">async</span> <span class="kw">function</span> <span class="fu">sleep</span>(ms<span class="op">:</span> <span class="dt">number</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-26" title="26">  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="fu">setTimeout</span>(resolve<span class="op">,</span> ms))<span class="op">;</span></a>
<a class="sourceLine" id="cb18-27" title="27"><span class="op">}</span></a></code></pre>
    </div>
    <p>In the activation part, we:</p>
    <ul>
      <li>
        Get the extension using the <code>{publisher.name}.{extensionId}</code>, as defined
        in <code>package.json</code>.
      </li>
      <li>Open the specified document, and show it in the active text editor.</li>
      <li>Sleep for 2 seconds, so we are sure the Language Server is instantiated.</li>
    </ul>
    <p>
      After the preparation, we can run the
      <a href="/api/references/commands">VS Code Commands</a> corresponding to each language
      feature, and assert against the returned result.
    </p>
    <p>
      There is one more test that covers the diagnostics feature that we just implemented.
      Check it out at <code>client/src/test/diagnostics.test.ts</code>.
    </p>
    <h2 id="advanced-topics">Advanced Topics</h2>
    <p>So far, this guide covered:</p>
    <ul>
      <li>A brief overview of Language Server and Language Server Protocol.</li>
      <li>Architecture of a Language Server extension in VS Code</li>
      <li>
        The <strong>lsp-sample</strong> extension, and how to develop/debug/inspect/test it.
      </li>
    </ul>
    <p>
      There are some more advanced topics we could not fit in to this guide. We will include
      links to these resources for further studying of Language Server development.
    </p>
    <h3 id="additional-language-server-features">Additional Language Server features</h3>
    <p>
      The following language features are currently supported in a language server along
      with code completions:
    </p>
    <ul>
      <li>
        <em>Document Highlights</em>: highlights all ‘equal’ symbols in a text document.
      </li>
      <li>
        <em>Hover</em>: provides hover information for a symbol selected in a text document.
      </li>
      <li>
        <em>Signature Help</em>: provides signature help for a symbol selected in a text
        document.
      </li>
      <li>
        <em>Goto Definition</em>: provides go to definition support for a symbol selected in
        a text document.
      </li>
      <li>
        <em>Goto Type Definition</em>: provides go to type/interface definition support for
        a symbol selected in a text document.
      </li>
      <li>
        <em>Goto Implementation</em>: provides go to implementation definition support for a
        symbol selected in a text document.
      </li>
      <li>
        <em>Find References</em>: finds all project-wide references for a symbol selected in
        a text document.
      </li>
      <li><em>List Document Symbols</em>: lists all symbols defined in a text document.</li>
      <li><em>List Workspace Symbols</em>: lists all project-wide symbols.</li>
      <li>
        <em>Code Actions</em>: compute commands to run (typically beautify/refactor) for a
        given text document and range.
      </li>
      <li><em>CodeLens</em>: compute CodeLens statistics for a given text document.</li>
      <li>
        <em>Document Formatting</em>: this includes formatting of whole documents, document
        ranges and formatting on type.
      </li>
      <li><em>Rename</em>: project-wide rename of a symbol.</li>
      <li><em>Document Links</em>: compute and resolve links inside a document.</li>
      <li>
        <em>Document Colors</em>: compute and resolve colors inside a document to provide
        color picker in editor.
      </li>
    </ul>
    <p>
      The
      <a href="/api/language-extensions/programmatic-language-features"
        >Programmatic Language Features</a
      >
      topic describes each of the language features above and provides guidance on how to
      implement them either through the language server protocol or by using the
      extensibility API directly from your extension.
    </p>
    <h3 id="incremental-text-document-synchronization">
      Incremental Text Document Synchronization
    </h3>
    <p>
      The example uses the simple text document manager provided by the
      <code>vscode-languageserver</code> module to synchronize documents between VS Code and
      the language server.
    </p>
    <p>This has two drawbacks:</p>
    <ul>
      <li>
        Lots of data is transferred since the whole content of a text document is sent to
        the server repeatedly.
      </li>
      <li>
        If an existing language library is used, such libraries usually support incremental
        document updates to avoid unnecessary parsing and abstract syntax tree creation.
      </li>
    </ul>
    <p>The protocol therefore supports incremental document synchronization as well.</p>
    <p>
      To make use of incremental document synchronization, a server needs to install three
      notification handlers:
    </p>
    <ul>
      <li>
        <em>onDidOpenTextDocument</em>: is called when a text document is opened in VS Code.
      </li>
      <li>
        <em>onDidChangeTextDocument</em>: is called when the content of a text document
        changes in VS Code.
      </li>
      <li>
        <em>onDidCloseTextDocument</em>: is called when a text document is closed in VS
        Code.
      </li>
    </ul>
    <p>
      Below is a code snippet that illustrates how to hook these notification handlers on a
      connection and how to return the right capability on initialize:
    </p>
    <div class="sourceCode" id="cb19">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><a class="sourceLine" id="cb19-1" title="1"><span class="va">connection</span><span class="op">.</span><span class="fu">onInitialize</span>((params)<span class="op">:</span> InitializeResult <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">    <span class="op">...</span></a>
<a class="sourceLine" id="cb19-3" title="3">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-4" title="4">        capabilities<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-5" title="5">            <span class="co">// Enable incremental document sync</span></a>
<a class="sourceLine" id="cb19-6" title="6">            textDocumentSync<span class="op">:</span> <span class="va">TextDocumentSyncKind</span><span class="op">.</span><span class="at">Incremental</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-7" title="7">            <span class="op">...</span></a>
<a class="sourceLine" id="cb19-8" title="8">        <span class="op">}</span></a>
<a class="sourceLine" id="cb19-9" title="9">    <span class="op">};</span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-11" title="11"></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidOpenTextDocument</span>((params) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-13" title="13">    <span class="co">// A text document was opened in VS Code.</span></a>
<a class="sourceLine" id="cb19-14" title="14">    <span class="co">// params.uri uniquely identifies the document. For documents stored on disk, this is a file URI.</span></a>
<a class="sourceLine" id="cb19-15" title="15">    <span class="co">// params.text the initial full content of the document.</span></a>
<a class="sourceLine" id="cb19-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-17" title="17"></a>
<a class="sourceLine" id="cb19-18" title="18"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidChangeTextDocument</span>((params) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-19" title="19">    <span class="co">// The content of a text document has change in VS Code.</span></a>
<a class="sourceLine" id="cb19-20" title="20">    <span class="co">// params.uri uniquely identifies the document.</span></a>
<a class="sourceLine" id="cb19-21" title="21">    <span class="co">// params.contentChanges describe the content changes to the document.</span></a>
<a class="sourceLine" id="cb19-22" title="22"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-23" title="23"></a>
<a class="sourceLine" id="cb19-24" title="24"><span class="va">connection</span><span class="op">.</span><span class="fu">onDidCloseTextDocument</span>((params) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-25" title="25">    <span class="co">// A text document was closed in VS Code.</span></a>
<a class="sourceLine" id="cb19-26" title="26">    <span class="co">// params.uri uniquely identifies the document.</span></a>
<a class="sourceLine" id="cb19-27" title="27"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <h3 id="using-vs-code-api-directly-to-implement-language-features">
      Using VS Code API directly to implement Language Features
    </h3>
    <p>
      While Language Servers have many benefits, they are not the only option for extending
      the editing capabilities of VS Code. In the cases when you want to add some simple
      language features for a type of document, consider using
      <code>vscode.languages.register[LANGUAGE_FEATURE]Provider</code> as an option.
    </p>
    <p>
      Here is a
      <a
        href="https://github.com/microsoft/vscode-extension-samples/tree/main/completions-sample"
        ><code>completions-sample</code></a
      >
      using <code>vscode.languages.registerCompletionItemProvider</code> to add a few
      snippets as completions for plain text files.
    </p>
    <p>
      More samples illustrating the usage of VS Code API can be found at
      <a href="https://github.com/microsoft/vscode-extension-samples"
        >https://github.com/microsoft/vscode-extension-samples</a
      >.
    </p>
    <h3 id="error-tolerant-parser-for-language-server">
      Error Tolerant Parser for Language Server
    </h3>
    <p>
      Most of the time, the code in the editor is incomplete and syntactically incorrect,
      but developers would still expect autocomplete and other language features to work.
      Therefore, an error tolerant parser is necessary for a Language Server: The parser
      generates meaningful AST from partially complete code, and the Language Server
      provides language features based on the AST.
    </p>
    <p>
      When we were improving PHP support in VS Code, we realized the official PHP parser is
      not error tolerant and cannot be reused directly in the Language Server. Therefore, we
      worked on
      <a href="https://github.com/microsoft/tolerant-php-parser"
        >Microsoft/tolerant-php-parser</a
      >
      and left detailed
      <a
        href="https://github.com/microsoft/tolerant-php-parser/blob/master/docs/HowItWorks.md"
        >notes</a
      >
      that might help Language Server authors who need to implement an error tolerant
      parser.
    </p>
    <h2 id="common-questions">Common questions</h2>
    <h3
      id="when-i-try-to-attach-to-the-server-i-get-cannot-connect-to-runtime-process-timeout-after-5000-ms"
    >
      When I try to attach to the server, I get “cannot connect to runtime process (timeout
      after 5000 ms)”?
    </h3>
    <p>
      You will see this timeout error if the server isn’t running when you try to attach the
      debugger. The client starts the language server so make sure you have started the
      client in order to have a running server. You may also need to disable your client
      breakpoints if they are interfering with starting the server.
    </p>
    <h3
      id="i-have-read-through-this-guide-and-the-lsp-specification-but-i-still-have-unresolved-questions.-where-can-i-get-help"
    >
      I have read through this guide and the
      <a href="https://microsoft.github.io/language-server-protocol/">LSP Specification</a>,
      but I still have unresolved questions. Where can I get help?
    </h3>
    <p>
      Please open an issue at
      <a href="https://github.com/microsoft/language-server-protocol"
        >https://github.com/microsoft/language-server-protocol</a
      >.
    </p>
  </body>
</html>
