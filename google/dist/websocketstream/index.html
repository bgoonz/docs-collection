
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
    
    <link rel="stylesheet" href="/css/main.css?v=f709e33d42ec6">
  

  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>WebSocketStream: integrating streams with the WebSocket API </title>
<meta name="description" content="WebSocketStream integrates streams with the WebSocket API. This allows your app to apply backpressure to received messages. " />

<link rel="canonical" href="https://web.dev/websocketstream/" />

<meta itemprop="name" content="WebSocketStream: integrating streams with the WebSocket API " />
<meta itemprop="description" content="WebSocketStream integrates streams with the WebSocket API. This allows your app to apply backpressure to received messages. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/websocketstream/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="WebSocketStream: integrating streams with the WebSocket API " />
<meta property="og:description" content="WebSocketStream integrates streams with the WebSocket API. This allows your app to apply backpressure to received messages. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="A fire hose with water dripping out of it." />
<meta property="tag" content="backpressure" />
<meta property="tag" content="websocket" />
<meta property="tag" content="websocketstream" />
<meta property="tag" content="capabilities" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="WebSocketStream: integrating streams with the WebSocket API " />
<meta name="twitter:description" content="WebSocketStream integrates streams with the WebSocket API. This allows your app to apply backpressure to received messages. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>








<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=cf3b8979345b7', 'module');




  loadScript('/js/content.js?v=dfe5a3fffca11', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    



<web-header class="header-default" role="navigation">
  <button data-open-drawer-button class="w-button--svg w-button--round" aria-label="Open menu">
    








  










  <svg class="icon " role="img" aria-label="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>


    <span class="w-tooltip w-tooltip--left">Open menu</span>
  </button>

  <a
    href="/"
    class="header-default__logo-link gc-analytics-event"
    data-category="Site-Wide Custom Events"
    data-label="Site logo"
  >
    <img class="header-default__logo" width="125" height="30" src="/images/lockup.svg" alt="web.dev" />
  </a>

  <div class="header-default__middle">
    <div class="header-default__links">
      <a
        href="/learn/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
      >
        Learn
      </a>

      <a
        href="/measure/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
      >
        Measure
      </a>

      <a
        href="/blog/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
      >
        Blog
      </a>

      <a
        href="/about/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About"
      >
        About
      </a>
    </div>
    <web-search results-id="search-main-results"></web-search>
    <web-search-results id="search-main-results"></web-search-results>
  </div>

  <web-profile-switcher-container></web-profile-switcher-container>
</web-header>



<web-navigation-drawer class="drawer-default" type="modal">
  <nav data-drawer-container>
    <div class="drawer-default__contents">
      <div class="drawer-default__header">
        <button
          data-drawer-close-button
          class="drawer-default__hide w-button--svg w-button--round"
          aria-label="Close"
        >
          








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


          <span class="w-tooltip">Close</span>
        </button>
        <a
          href="/"
          class="gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Site logo"
        >
          <img
            width="125"
            height="30"
            class="drawer-default__logo"
            src="/images/lockup.svg"
            alt="web.dev"
          />
        </a>
      </div>
      <a
        href="/learn/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Learn"
      >
        Learn
      </a>
      <a
        href="/measure/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Measure"
      >
        Measure
      </a>
      <a
        href="/blog/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Blog"
      >
        Blog
      </a>
      <a
        href="/about/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: About"
      >
        About
      </a>
    </div>
  </nav>
</web-navigation-drawer>

<main>
  <div id="content">
    
      
    
    


<div class="guide-landing-page">
  
  

  
    <img     alt="A fire hose with water dripping out of it."     class="w-hero w-hero--cover"     decoding="auto"     height="480"               sizes="100vw"     src="https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/admin/8SrIq5at2bH6i98stCgs.jpg?auto=format&w=1600 1600w"          width="1600"   />
  

  <web-table-of-contents>
    <h2 class="w-toc__header">
      <a href="#websocketstream:-integrating-streams-with-the-websocket-api" class="w-toc__header--link">
        WebSocketStream: integrating streams with the WebSocket API
      </a>
    </h2>
    <div class="w-toc__list">
        <ul><li><a href="#background">Background</a></li><li><a href="#the-websocket-api">The WebSocket API</a></li><li><a href="#the-streams-api">The Streams API</a></li><li><a href="#the-problem-with-the-current-websocket-api">The Problem with the current WebSocket API</a></li><li><a href="#what">What is the WebSocketStream API?</a></li><li><a href="#use-cases">Suggested use cases for the WebSocketStream API</a></li><li><a href="#status">Current status</a></li><li><a href="#use">How to use the WebSocketStream API</a></li><li><a href="#introductory-example">Introductory example</a></li><li><a href="#advanced-examples">Advanced examples</a></li><li><a href="#information-about-closed-websocketstream-connection">Information about closed WebSocketStream connection</a></li><li><a href="#closing-a-websocketstream-connection">Closing a WebSocketStream connection</a></li><li><a href="#progressive-enhancement-and-interoperability">Progressive enhancement and interoperability</a></li><li><a href="#demo">Demo</a></li><li><a href="#feedback">Feedback</a></li><li><a href="#tell-us-about-the-api-design">Tell us about the API design</a></li><li><a href="#report-a-problem-with-the-implementation">Report a problem with the implementation</a></li><li><a href="#show-support-for-the-api">Show support for the API</a></li><li><a href="#helpful">Helpful links</a></li><li><a href="#acknowledgements">Acknowledgements</a></li></ul></div>
  </web-table-of-contents>
  <web-table-of-contents-button></web-table-of-contents-button>

  
  <div class="w-actions">
    <share-action authors="@tomayac"
      class="gc-analytics-event w-actions__fab w-actions__fab--share"
      data-category="web.dev"
      data-label="share"
      data-action="click"
      data-icon="share"
      tabindex="0"
      role="button"
    >
      <span>Share</span>
    </share-action>
    <a class="w-actions__fab w-actions__fab--subscribe gc-analytics-event" data-category="web.dev" data-label="view-subscribe" data-action="click" href="/newsletter/">
  <span>subscribe</span>
</a>

  </div>

  <div class="w-layout-container--narrow w-post-content">
    <header class="w-article-header">
      
        <div class="w-post-breadcrumbs">
          <ul class="w-breadcrumbs">
  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link w-breadcrumbs__link--left-justify gc-analytics-event"
      data-category="web.dev"
      data-label="post, home breadcrumb"
      data-action="click"
      href="/"
    >
      Home
    </a>
  </li>

  <svg
    class="w-breadcrumbs__icon"
    xmlns="http://www.w3.org/2000/svg"
    height="24"
    viewBox="0 0 24 24"
    width="24"
    aria-hidden="true"
  >
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
  </svg>

  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link gc-analytics-event"
      data-category="web.dev"
      data-label="post, path breadcrumb"
      data-action="click"
      href=/blog
    >
      All articles
    </a>
  </li>
</ul>
        </div>
      

      <h1 id="websocketstream:-integrating-streams-with-the-websocket-api" class="w-article-header__headline">WebSocketStream: integrating streams with the WebSocket API</h1>
      
        <p class="w-article-header__subhead w-mb--non">
          <p>Prevent your app from getting drowned in WebSocket messages
or flooding a WebSocket server with messages by applying backpressure.</p>

        </p>
      

      
        <div class="w-author__published">
          <time>Mar 27, 2020</time>
           <span class="w-author__separator">â€¢</span> Updated <time>Feb 23, 2021</time> 
        </div>
      
      

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <a href="/authors/thomassteiner/"><img     alt="Thomas Steiner"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/thomassteiner/">Thomas Steiner</a>
    </cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/tomayac"
          >Twitter</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/tomayac">GitHub</a>
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://glitch.com/@tomayac"
          >Glitch</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://blog.tomayac.com/">Blog</a>
      </li>
    </ul>
  </div>
</div>
          
        </div>
      
    </header>

    

    <h2 id="background">Background <a class="w-headline-link" href="#background">#</a></h2>
<h3 id="the-websocket-api">The WebSocket API <a class="w-headline-link" href="#the-websocket-api">#</a></h3>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" rel="noopener">WebSocket API</a>
provides a JavaScript interface to the <a href="https://tools.ietf.org/html/rfc6455" rel="noopener">WebSocket protocol</a>,
which makes it possible to open a two-way interactive communication session
between the user's browser and a server.
With this API, you can send messages to a server and receive event-driven responses
without polling the server for a reply.</p>
<h3 id="the-streams-api">The Streams API <a class="w-headline-link" href="#the-streams-api">#</a></h3>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API" rel="noopener">Streams API</a>
allows JavaScript to programmatically access streams of data chunks received over the network
and process them as desired.
An important concept in the context of streams is
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API/Concepts#Backpressure" rel="noopener">backpressure</a>.
This is the process by which a single stream or a pipe chain
regulates the speed of reading or writing.
When the stream itself or a stream later in the pipe chain is still busy
and isn't yet ready to accept more chunks,
it sends a signal backwards through the chain to slow delivery as appropriate.</p>
<h3 id="the-problem-with-the-current-websocket-api">The Problem with the current WebSocket API <a class="w-headline-link" href="#the-problem-with-the-current-websocket-api">#</a></h3>
<h4 id="applying-backpressure-to-received-messages-is-impossible">Applying backpressure to received messages is impossible <a class="w-headline-link" href="#applying-backpressure-to-received-messages-is-impossible">#</a></h4>
<p>With the current WebSocket API, reacting to a message happens in
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/onmessage" rel="noopener"><code>WebSocket.onmessage</code></a>,
an <code>EventHandler</code> called when a message is received from the server.</p>
<p>Let's assume you had an application that needs to perform heavy data crunching operations
whenever a new message is received.
You would probably set up the flow similar to the code below,
and since you <code>await</code> the result of the <code>process()</code> call, you should be good, right?</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">// A heavy data crunching operation.</span><br><span class="token keyword">const</span> <span class="token function-variable function">process</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket message processed:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>webSocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>  <span class="token comment">// Await the result of the processing step in the message handler.</span><br>  <span class="token keyword">await</span> <span class="token function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>Wrong! The problem with the current WebSocket API is that there is no way to apply backpressure.
When messages arrive faster than the <code>process()</code> method can handle them,
the render process will either fill up memory by buffering those messages,
become unresponsive due to 100% CPU usage, or both.</p>
<h4 id="applying-backpressure-to-sent-messages-is-non-ergonomic">Applying backpressure to sent messages is non-ergonomic <a class="w-headline-link" href="#applying-backpressure-to-sent-messages-is-non-ergonomic">#</a></h4>
<p>Applying backpressure to sent messages is possible, but involves polling the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/bufferedAmount" rel="noopener"><code>WebSocket.bufferedAmount</code></a>
property, which is inefficient and non-ergonomic.
This read-only property returns the number of bytes of data that have been queued
using calls to
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/send" rel="noopener"><code>WebSocket.send()</code></a>,
but not yet transmitted to the network.
This value resets to zero once all queued data has been sent,
but if you keep calling <code>WebSocket.send()</code>,
it will continue to climb.</p>
<h2 id="what">What is the WebSocketStream API? <a class="w-headline-link" href="#what">#</a></h2>
<p>The WebSocketStream API deals with the problem of non-existent or non-ergonomic backpressure
by integrating streams with the WebSocket API.
This means backpressure can be applied &quot;for free&quot;, without any extra cost.</p>
<h3 id="use-cases">Suggested use cases for the WebSocketStream API <a class="w-headline-link" href="#use-cases">#</a></h3>
<p>Examples of sites that can use this API include:</p>
<ul>
<li>High-bandwidth WebSocket applications that need to retain interactivity,
in particular video and screen-sharing.</li>
<li>Similarly, video capture and other applications that generate a lot of data in the browser
that needs to be uploaded to the server.
With backpressure, the client can stop producing data rather than accumulating data in memory.</li>
</ul>
<h2 id="status">Current status <a class="w-headline-link" href="#status">#</a></h2>
<div class="w-table-wrapper">
<div class="w-table-wrapper">
<table>
<thead>
<tr>
<th>Step</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. Create explainer</td>
<td><a href="https://github.com/ricea/websocketstream-explainer/blob/master/README.md" rel="noopener">Complete</a></td>
</tr>
<tr>
<td>2. Create initial draft of specification</td>
<td><a href="https://github.com/ricea/websocketstream-explainer/blob/master/README.md" rel="noopener">In progress</a></td>
</tr>
<tr>
<td>3. Gather feedback &amp; iterate on design</td>
<td><a href="#feedback">In progress</a></td>
</tr>
<tr>
<td>4. Origin trial</td>
<td><a href="https://developers.chrome.com/origintrials/#/view_trial/1977080236415647745" rel="noopener">Complete</a></td>
</tr>
<tr>
<td>5. Launch</td>
<td>Not started</td>
</tr>
</tbody>
</table>
</div></div>
<h2 id="use">How to use the WebSocketStream API <a class="w-headline-link" href="#use">#</a></h2>
<h3 id="introductory-example">Introductory example <a class="w-headline-link" href="#introductory-example">#</a></h3>
<p>The WebSocketStream API is promise-based, which makes dealing with it feel natural
in a modern JavaScript world.
You start by constructing a new <code>WebSocketStream</code> and passing it the URL of the WebSocket server.
Next, you wait for the <code>connection</code> to be established,
which results in a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream/ReadableStream" rel="noopener"><code>ReadableStream</code></a>
and/or a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStream/WritableStream" rel="noopener"><code>WritableStream</code></a>.</p>
<p>By calling the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream/getReader" rel="noopener"><code>ReadableStream.getReader()</code></a>
method, you finally obtain a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader" rel="noopener"><code>ReadableStreamDefaultReader</code></a>,
which you can then <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader/read" rel="noopener"><code>read()</code></a>
data from until the stream is done, that is, until it returns an object of the form
<code>{value: undefined, done: true}</code>.</p>
<p>Accordingly, by calling the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStream/getWriter" rel="noopener"><code>WritableStream.getWriter()</code></a>
method, you finally obtain a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter" rel="noopener"><code>WritableStreamDefaultWriter</code></a>,
which you can then <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter/write" rel="noopener"><code>write()</code></a>
data to.</p>
<web-copy-code><pre class="language-js"><code class="language-js">  <span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketStream</span><span class="token punctuation">(</span><span class="token constant">WSS_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span>readable<span class="token punctuation">,</span> writable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wss<span class="token punctuation">.</span>connection<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> readable<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> writer <span class="token operator">=</span> writable<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span>value<span class="token punctuation">,</span> done<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">process</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span></code></pre>
</web-copy-code><h4 id="backpressure">Backpressure <a class="w-headline-link" href="#backpressure">#</a></h4>
<p>What about the promised backpressure feature?
As I wrote above, you get it &quot;for free&quot;, no extra steps needed.
If <code>process()</code> takes extra time, the next message will only be consumed once the pipeline is ready.
Likewise the <code>WritableStreamDefaultWriter.write()</code> step
will only proceed if it is safe to do so.</p>
<h3 id="advanced-examples">Advanced examples <a class="w-headline-link" href="#advanced-examples">#</a></h3>
<p>The second argument to WebSocketStream is an option bag to allow for future extension.
Currently the only option is <code>protocols</code>,
which behaves the same as the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/WebSocket#Parameters:~:text=respond.-,protocols" rel="noopener">second argument to the WebSocket constructor</a>:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> chatWSS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketStream</span><span class="token punctuation">(</span><span class="token constant">CHAT_URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>protocols<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'chat'</span><span class="token punctuation">,</span> <span class="token string">'chatv2'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span>protocol<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> chatWSS<span class="token punctuation">.</span>connection<span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The selected <code>protocol</code> as well as potential <code>extensions</code> are part of the dictionary
available via the <code>WebSocketStream.connection</code> promise.
All the information about the live connection is provided by this promise,
since it is not relevant if the connection fails.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>readable<span class="token punctuation">,</span> writable<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> extensions<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> chatWSS<span class="token punctuation">.</span>connection<span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="information-about-closed-websocketstream-connection">Information about closed WebSocketStream connection <a class="w-headline-link" href="#information-about-closed-websocketstream-connection">#</a></h3>
<p>The information that was available from the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/onclose" rel="noopener"><code>WebSocket.onclose</code></a> and
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/onerror" rel="noopener"><code>WebSocket.onerror</code></a> events
in the WebSocket API is now available via the <code>WebSocketStream.closed</code> promise.
The promise rejects in the event of an unclean close,
otherwise it resolves to the code and reason sent by the server.</p>
<p>All possible status codes and their meaning is explained in the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent#Status_codes" rel="noopener">list of <code>CloseEvent</code> status codes</a>.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span> reason<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> chatWSS<span class="token punctuation">.</span>closed<span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="closing-a-websocketstream-connection">Closing a WebSocketStream connection <a class="w-headline-link" href="#closing-a-websocketstream-connection">#</a></h3>
<p>A WebSocketStream can be closed with an
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController" rel="noopener"><code>AbortController</code></a>.
Therefore, pass an <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal" rel="noopener"><code>AbortSignal</code></a>
to the <code>WebSocketStream</code> constructor.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketStream</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>signal<span class="token operator">:</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>As an alternative, you can also use the <code>WebSocketStream.close()</code> method,
but its main purpose is to permit specifying the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent#Status_codes" rel="noopener">code</a>
and reason which is sent to the server.</p>
<web-copy-code><pre class="language-js"><code class="language-js">wss<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">{</span>code<span class="token operator">:</span> <span class="token number">4000</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> <span class="token string">'Game over'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="progressive-enhancement-and-interoperability">Progressive enhancement and interoperability <a class="w-headline-link" href="#progressive-enhancement-and-interoperability">#</a></h3>
<p>Chrome is currently the only browser to implement the WebSocketStream API.
For interoperability with the classic WebSocket API,
applying backpressure to received messages is not possible.
Applying backpressure to sent messages is possible, but involves polling the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/bufferedAmount" rel="noopener"><code>WebSocket.bufferedAmount</code></a>
property, which is inefficient and non-ergonomic.</p>
<h4 id="feature-detection">Feature detection <a class="w-headline-link" href="#feature-detection">#</a></h4>
<p>To check if the WebSocketStream API is supported, use:</p>
<web-copy-code><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'WebSocketStream'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// `WebSocketStream` is supported!</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h2 id="demo">Demo <a class="w-headline-link" href="#demo">#</a></h2>
<p>On supporting browsers, you can see the WebSocketStream API in action in the embedded iframe,
or <a href="https://websocketstream-demo.glitch.me/" rel="noopener">directly on Glitch</a>.</p>
<div class="glitch-embed-wrap" style="height: 420px; width: 100%;">
  <iframe
    allow="camera; clipboard-read; clipboard-write; encrypted-media; geolocation; microphone; midi"
    loading="lazy"
    src="https://glitch.com/embed/#!/embed/websocketstream-demo?attributionHidden=true&sidebarCollapsed=true&path=public%2Findex.html&previewSize=100"
    style="height: 100%; width: 100%; border: 0;"
    title="websocketstream-demo on Glitch"
  ></iframe>
</div>
<h2 id="feedback">Feedback <a class="w-headline-link" href="#feedback">#</a></h2>
<p>The Chrome team wants to hear about your experiences with the WebSocketStream API.</p>
<h3 id="tell-us-about-the-api-design">Tell us about the API design <a class="w-headline-link" href="#tell-us-about-the-api-design">#</a></h3>
<p>Is there something about the API that doesn't work like you expected?
Or are there missing methods or properties that you need to implement your idea?
Have a question or comment on the security model?
File a spec issue on the corresponding <a href="https://github.com/ricea/websocketstream-explainer/issues" rel="noopener">GitHub repo</a>,
or add your thoughts to an existing issue.</p>
<h3 id="report-a-problem-with-the-implementation">Report a problem with the implementation <a class="w-headline-link" href="#report-a-problem-with-the-implementation">#</a></h3>
<p>Did you find a bug with Chrome's implementation?
Or is the implementation different from the spec?
File a bug at <a href="https://new.crbug.com" rel="noopener">new.crbug.com</a>.
Be sure to include as much detail as you can, simple instructions for reproducing,
and enter <code>Blink&gt;Network&gt;WebSockets</code> in the <strong>Components</strong> box.
<a href="https://glitch.com/" rel="noopener">Glitch</a> works great for sharing quick and easy reproduction cases.</p>
<h3 id="show-support-for-the-api">Show support for the API <a class="w-headline-link" href="#show-support-for-the-api">#</a></h3>
<p>Are you planning to use the WebSocketStream API?
Your public support helps the Chrome team to prioritize features
and shows other browser vendors how critical it is to support them.</p>
<p>Send a tweet to <a href="https://twitter.com/ChromiumDev" rel="noopener">@ChromiumDev</a> using the hashtag
<a href="https://twitter.com/search?q=%23WebSocketStream&amp;src=typed_query&amp;f=live" rel="noopener"><code>#WebSocketStream</code></a>
and let us know where and how you're using it.</p>
<h2 id="helpful">Helpful links <a class="w-headline-link" href="#helpful">#</a></h2>
<ul>
<li><a href="https://github.com/ricea/websocketstream-explainer/blob/master/README.md" rel="noopener">Public explainer</a></li>
<li><a href="https://websocketstream-demo.glitch.me/" rel="noopener">WebSocketStream API Demo</a> | <a href="https://glitch.com/edit/#!/websocketstream-demo" rel="noopener">WebSocketStream API Demo source</a></li>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=983030" rel="noopener">Tracking bug</a></li>
<li><a href="https://chromestatus.com/feature/5189728691290112" rel="noopener">ChromeStatus.com entry</a></li>
<li>Blink Component: <a href="https://bugs.chromium.org/p/chromium/issues/list?q=component:Blink%3ENetwork%3EWebSockets" rel="noopener"><code>Blink&gt;Network&gt;WebSockets</code></a></li>
</ul>
<h2 id="acknowledgements">Acknowledgements <a class="w-headline-link" href="#acknowledgements">#</a></h2>
<p>The WebSocketStream API was implemented by <a href="https://github.com/ricea" rel="noopener">Adam Rice</a> and
<a href="https://github.com/yutakahirano" rel="noopener">Yutaka Hirano</a>.
Hero image by <a href="https://unsplash.com/@daanmooij" rel="noopener">Daan Mooij</a> on
<a href="https://unsplash.com/photos/91LGCVN5SAI" rel="noopener">Unsplash</a>.</p>


    

    
  <div class="w-chips ">
    
      
    
      
    
      
    
      
    
      
    
      
        
        <a class="w-chip" href="/tags/capabilities/">Capabilities</a>
      
    
  </div>


    <div class="w-post-github-link w-mt--l w-mb--l">
      <span class="w-mr--sm">
        
        Last updated: <time>Feb 23, 2021</time>
        
      </span>
      <a
        href="https://github.com/GoogleChrome/web.dev/blob/master/src/site/content/en/blog/websocketstream/index.md"
      >
        Improve article
      </a>
       
    </div>

    
    <web-feedback additional-questions="api"></web-feedback>
  </div>

  
    
    <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back
      w-article-navigation__link--single gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/blog"
  >
    Return to all articles
  </a>
</nav>
  
</div>

  </div>
</main>
<footer class="w-footer">
  <nav class="w-footer__linkboxes">
    <ul class="w-footer__linkboxes-list">
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Contribute</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
              class="w-footer__linkbox-link" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              File a bug
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/googlechrome/web.dev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              View source
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Related content</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://blog.chromium.org/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Chrome updates
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              Web Fundamentals
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/showcase/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
              Case studies
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://devwebfeed.appspot.com/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">
              DevWeb Content Firehose
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/podcasts/" class="w-footer__linkbox-link"
              data-category="Podcasts" data-label="Footer Link (index 5)">
              Podcasts
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/shows/" class="w-footer__linkbox-link"
              data-category="Shows" data-label="Footer Link (index 6)">
              Shows
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Connect</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://www.twitter.com/@ChromiumDev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Twitter
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://www.youtube.com/user/ChromeDevelopers" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              YouTube
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="w-footer__utility">
    <nav class="w-footer__utility-nav">
      <a href="https://developers.google.com/" class="w-footer__utility-logo-link"
        data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
        <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
          alt="Google Developers" />
      </a>
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developer.chrome.com/home"
            data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
            Chrome
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Firebase Link">
            Firebase
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Google Cloud Platform Link">
            Google Cloud Platform
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developers.google.com/products"
            data-category="Site-Wide Custom Events" data-label="Footer All products Link">
            All products
          </a>
        </li>
      </ul>
      <web-language-select current="en"></web-language-select>
    </nav>
    <nav class="w-footer__utility-nav">
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://policies.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Terms and Privacy link">
            Terms &amp; Privacy
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="/community-guidelines/" data-category="Site-Wide Custom Events"
            data-label="Footer Community Guidelines link">
            Community Guidelines
          </a>
        </li>
      </ul>
      <div class="w-footer__license">
        <p>
          Except as otherwise noted, the content of this page is licensed
          under the
          <a href="https://creativecommons.org/licenses/by/4.0/">
          Creative Commons Attribution 4.0 License</a>,
          and code samples are licensed under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">
          Apache 2.0 License</a>. For details, see the
          <a href="https://developers.google.com/site-policies">
          Google Developers Site Policies</a>.
        </p>
      </div>
    </nav>
  </div>
</footer>

  </body>
</html>
