<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>v8</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="v8">V8</h1>
<!--introduced_in=v4.0.0-->
<!-- source_link=lib/v8.js -->
<p>The <code>v8</code> module exposes APIs that are specific to the version of <a href="https://developers.google.com/v8/">V8</a> built into the Node.js binary. It can be accessed using:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">const</span> v8 <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;v8&#39;</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="v8.cacheddataversiontag"><code>v8.cachedDataVersionTag()</code></h2>
<!-- YAML
added: v8.0.0
-->
<ul>
<li>Returns: {integer}</li>
</ul>
<p>Returns an integer representing a version tag derived from the V8 version, command-line flags, and detected CPU features. This is useful for determining whether a <a href="vm.md#vm_new_vm_script_code_options"><code>vm.Script</code></a> <code>cachedData</code> buffer is compatible with this instance of V8.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">console</span>.<span class="at">log</span>(<span class="va">v8</span>.<span class="at">cachedDataVersionTag</span>())<span class="op">;</span> <span class="co">// 3947234607</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// The value returned by v8.cachedDataVersionTag() is derived from the V8</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">// version, command-line flags, and detected CPU features. Test that the value</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">// does indeed update when flags are toggled.</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="va">v8</span>.<span class="at">setFlagsFromString</span>(<span class="st">&#39;--allow_natives_syntax&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">v8</span>.<span class="at">cachedDataVersionTag</span>())<span class="op">;</span> <span class="co">// 183726201</span></a></code></pre></div>
<h2 id="v8.getheapcodestatistics"><code>v8.getHeapCodeStatistics()</code></h2>
<!-- YAML
added: v12.8.0
-->
<ul>
<li>Returns: {Object}</li>
</ul>
<p>Returns an object with the following properties:</p>
<ul>
<li><code>code_and_metadata_size</code> {number}</li>
<li><code>bytecode_and_metadata_size</code> {number}</li>
<li><code>external_script_source_size</code> {number}</li>
</ul>
<!-- eslint-skip -->
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="dt">code_and_metadata_size</span><span class="op">:</span> <span class="dv">212208</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="dt">bytecode_and_metadata_size</span><span class="op">:</span> <span class="dv">161368</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">external_script_source_size</span><span class="op">:</span> <span class="dv">1410794</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="op">}</span></a></code></pre></div>
<h2 id="v8.getheapsnapshot"><code>v8.getHeapSnapshot()</code></h2>
<!-- YAML
added: v11.13.0
-->
<ul>
<li>Returns: {stream.Readable} A Readable Stream containing the V8 heap snapshot</li>
</ul>
<p>Generates a snapshot of the current V8 heap and returns a Readable Stream that may be used to read the JSON serialized representation. This JSON stream format is intended to be used with tools such as Chrome DevTools. The JSON schema is undocumented and specific to the V8 engine. Therefore, the schema may change from one version of V8 to the next.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// Print heap snapshot to the console</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> v8 <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;v8&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">const</span> stream <span class="op">=</span> <span class="va">v8</span>.<span class="at">getHeapSnapshot</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="va">stream</span>.<span class="at">pipe</span>(<span class="va">process</span>.<span class="at">stdout</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="v8.getheapspacestatistics"><code>v8.getHeapSpaceStatistics()</code></h2>
<!-- YAML
added: v6.0.0
changes:
  - version: v7.5.0
    pr-url: https://github.com/nodejs/node/pull/10186
    description: Support values exceeding the 32-bit unsigned integer range.
-->
<ul>
<li>Returns: {Object[]}</li>
</ul>
<p>Returns statistics about the V8 heap spaces, i.e. the segments which make up the V8 heap. Neither the ordering of heap spaces, nor the availability of a heap space can be guaranteed as the statistics are provided via the V8 <a href="https://v8docs.nodesource.com/node-13.2/d5/dda/classv8_1_1_isolate.html#ac673576f24fdc7a33378f8f57e1d13a4"><code>GetHeapSpaceStatistics</code></a> function and may change from one V8 version to the next.</p>
<p>The value returned is an array of objects containing the following properties:</p>
<ul>
<li><code>space_name</code> {string}</li>
<li><code>space_size</code> {number}</li>
<li><code>space_used_size</code> {number}</li>
<li><code>space_available_size</code> {number}</li>
<li><code>physical_space_size</code> {number}</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb5-1" title="1"><span class="ot">[</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">&quot;space_name&quot;</span><span class="fu">:</span> <span class="st">&quot;new_space&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">&quot;space_size&quot;</span><span class="fu">:</span> <span class="dv">2063872</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">&quot;space_used_size&quot;</span><span class="fu">:</span> <span class="dv">951112</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">&quot;space_available_size&quot;</span><span class="fu">:</span> <span class="dv">80824</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">&quot;physical_space_size&quot;</span><span class="fu">:</span> <span class="dv">2063872</span></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="dt">&quot;space_name&quot;</span><span class="fu">:</span> <span class="st">&quot;old_space&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">&quot;space_size&quot;</span><span class="fu">:</span> <span class="dv">3090560</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="dt">&quot;space_used_size&quot;</span><span class="fu">:</span> <span class="dv">2493792</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="dt">&quot;space_available_size&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="dt">&quot;physical_space_size&quot;</span><span class="fu">:</span> <span class="dv">3090560</span></a>
<a class="sourceLine" id="cb5-15" title="15">  <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-16" title="16">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="dt">&quot;space_name&quot;</span><span class="fu">:</span> <span class="st">&quot;code_space&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="dt">&quot;space_size&quot;</span><span class="fu">:</span> <span class="dv">1260160</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-19" title="19">    <span class="dt">&quot;space_used_size&quot;</span><span class="fu">:</span> <span class="dv">644256</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-20" title="20">    <span class="dt">&quot;space_available_size&quot;</span><span class="fu">:</span> <span class="dv">960</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-21" title="21">    <span class="dt">&quot;physical_space_size&quot;</span><span class="fu">:</span> <span class="dv">1260160</span></a>
<a class="sourceLine" id="cb5-22" title="22">  <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-23" title="23">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-24" title="24">    <span class="dt">&quot;space_name&quot;</span><span class="fu">:</span> <span class="st">&quot;map_space&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-25" title="25">    <span class="dt">&quot;space_size&quot;</span><span class="fu">:</span> <span class="dv">1094160</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-26" title="26">    <span class="dt">&quot;space_used_size&quot;</span><span class="fu">:</span> <span class="dv">201608</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-27" title="27">    <span class="dt">&quot;space_available_size&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-28" title="28">    <span class="dt">&quot;physical_space_size&quot;</span><span class="fu">:</span> <span class="dv">1094160</span></a>
<a class="sourceLine" id="cb5-29" title="29">  <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-30" title="30">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-31" title="31">    <span class="dt">&quot;space_name&quot;</span><span class="fu">:</span> <span class="st">&quot;large_object_space&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-32" title="32">    <span class="dt">&quot;space_size&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-33" title="33">    <span class="dt">&quot;space_used_size&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-34" title="34">    <span class="dt">&quot;space_available_size&quot;</span><span class="fu">:</span> <span class="dv">1490980608</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-35" title="35">    <span class="dt">&quot;physical_space_size&quot;</span><span class="fu">:</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-36" title="36">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-37" title="37"><span class="ot">]</span></a></code></pre></div>
<h2 id="v8.getheapstatistics"><code>v8.getHeapStatistics()</code></h2>
<!-- YAML
added: v1.0.0
changes:
  - version: v7.5.0
    pr-url: https://github.com/nodejs/node/pull/10186
    description: Support values exceeding the 32-bit unsigned integer range.
  - version: v7.2.0
    pr-url: https://github.com/nodejs/node/pull/8610
    description: Added `malloced_memory`, `peak_malloced_memory`,
                 and `does_zap_garbage`.
-->
<ul>
<li>Returns: {Object}</li>
</ul>
<p>Returns an object with the following properties:</p>
<ul>
<li><code>total_heap_size</code> {number}</li>
<li><code>total_heap_size_executable</code> {number}</li>
<li><code>total_physical_size</code> {number}</li>
<li><code>total_available_size</code> {number}</li>
<li><code>used_heap_size</code> {number}</li>
<li><code>heap_size_limit</code> {number}</li>
<li><code>malloced_memory</code> {number}</li>
<li><code>peak_malloced_memory</code> {number}</li>
<li><code>does_zap_garbage</code> {number}</li>
<li><code>number_of_native_contexts</code> {number}</li>
<li><code>number_of_detached_contexts</code> {number}</li>
</ul>
<p><code>does_zap_garbage</code> is a 0/1 boolean, which signifies whether the <code>--zap_code_space</code> option is enabled or not. This makes V8 overwrite heap garbage with a bit pattern. The RSS footprint (resident set size) gets bigger because it continuously touches all heap pages and that makes them less likely to get swapped out by the operating system.</p>
<p><code>number_of_native_contexts</code> The value of native_context is the number of the top-level contexts currently active. Increase of this number over time indicates a memory leak.</p>
<p><code>number_of_detached_contexts</code> The value of detached_context is the number of contexts that were detached and not yet garbage collected. This number being non-zero indicates a potential memory leak.</p>
<!-- eslint-skip -->
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">total_heap_size</span><span class="op">:</span> <span class="dv">7326976</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="dt">total_heap_size_executable</span><span class="op">:</span> <span class="dv">4194304</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="dt">total_physical_size</span><span class="op">:</span> <span class="dv">7326976</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="dt">total_available_size</span><span class="op">:</span> <span class="dv">1152656</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="dt">used_heap_size</span><span class="op">:</span> <span class="dv">3476208</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="dt">heap_size_limit</span><span class="op">:</span> <span class="dv">1535115264</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="dt">malloced_memory</span><span class="op">:</span> <span class="dv">16384</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="dt">peak_malloced_memory</span><span class="op">:</span> <span class="dv">1127496</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="dt">does_zap_garbage</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="dt">number_of_native_contexts</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="dt">number_of_detached_contexts</span><span class="op">:</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="op">}</span></a></code></pre></div>
<h2 id="v8.setflagsfromstringflags"><code>v8.setFlagsFromString(flags)</code></h2>
<!-- YAML
added: v1.0.0
-->
<ul>
<li><code>flags</code> {string}</li>
</ul>
<p>The <code>v8.setFlagsFromString()</code> method can be used to programmatically set V8 command-line flags. This method should be used with care. Changing settings after the VM has started may result in unpredictable behavior, including crashes and data loss; or it may simply do nothing.</p>
<p>The V8 options available for a version of Node.js may be determined by running <code>node --v8-options</code>.</p>
<p>Usage:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// Print GC events to stdout for one minute.</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">const</span> v8 <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;v8&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="va">v8</span>.<span class="at">setFlagsFromString</span>(<span class="st">&#39;--trace_gc&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span> <span class="va">v8</span>.<span class="at">setFlagsFromString</span>(<span class="st">&#39;--notrace_gc&#39;</span>)<span class="op">;</span> <span class="op">},</span> <span class="fl">60e3</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="v8.stopcoverage"><code>v8.stopCoverage()</code></h2>
<!-- YAML
added:
  - v15.1.0
  - v12.22.0
-->
<p>The <code>v8.stopCoverage()</code> method allows the user to stop the coverage collection started by <a href="cli.md#cli_node_v8_coverage_dir"><code>NODE_V8_COVERAGE</code></a>, so that V8 can release the execution count records and optimize code. This can be used in conjunction with <a href="#v8_v8_takecoverage"><code>v8.takeCoverage()</code></a> if the user wants to collect the coverage on demand.</p>
<h2 id="v8.takecoverage"><code>v8.takeCoverage()</code></h2>
<!-- YAML
added:
  - v15.1.0
  - v12.22.0
-->
<p>The <code>v8.takeCoverage()</code> method allows the user to write the coverage started by <a href="cli.md#cli_node_v8_coverage_dir"><code>NODE_V8_COVERAGE</code></a> to disk on demand. This method can be invoked multiple times during the lifetime of the process. Each time the execution counter will be reset and a new coverage report will be written to the directory specified by <a href="cli.md#cli_node_v8_coverage_dir"><code>NODE_V8_COVERAGE</code></a>.</p>
<p>When the process is about to exit, one last coverage will still be written to disk unless <a href="#v8_v8_stopcoverage"><code>v8.stopCoverage()</code></a> is invoked before the process exits.</p>
<h2 id="v8.writeheapsnapshotfilename"><code>v8.writeHeapSnapshot([filename])</code></h2>
<!-- YAML
added: v11.13.0
-->
<ul>
<li><code>filename</code> {string} The file path where the V8 heap snapshot is to be saved. If not specified, a file name with the pattern <code>'Heap-${yyyymmdd}-${hhmmss}-${pid}-${thread_id}.heapsnapshot'</code> will be generated, where <code>{pid}</code> will be the PID of the Node.js process, <code>{thread_id}</code> will be <code>0</code> when <code>writeHeapSnapshot()</code> is called from the main Node.js thread or the id of a worker thread.</li>
<li>Returns: {string} The filename where the snapshot was saved.</li>
</ul>
<p>Generates a snapshot of the current V8 heap and writes it to a JSON file. This file is intended to be used with tools such as Chrome DevTools. The JSON schema is undocumented and specific to the V8 engine, and may change from one version of V8 to the next.</p>
<p>A heap snapshot is specific to a single V8 isolate. When using <a href="worker_threads.md">worker threads</a>, a heap snapshot generated from the main thread will not contain any information about the workers, and vice versa.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">const</span> <span class="op">{</span> writeHeapSnapshot <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;v8&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" title="3">  Worker<span class="op">,</span></a>
<a class="sourceLine" id="cb8-4" title="4">  isMainThread<span class="op">,</span></a>
<a class="sourceLine" id="cb8-5" title="5">  parentPort</a>
<a class="sourceLine" id="cb8-6" title="6"><span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;worker_threads&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="cf">if</span> (isMainThread) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-9" title="9">  <span class="kw">const</span> worker <span class="op">=</span> <span class="kw">new</span> <span class="at">Worker</span>(__filename)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-10" title="10"></a>
<a class="sourceLine" id="cb8-11" title="11">  <span class="va">worker</span>.<span class="at">once</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> (filename) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`worker heapdump: </span><span class="sc">${</span>filename<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="co">// Now get a heapdump for the main thread.</span></a>
<a class="sourceLine" id="cb8-14" title="14">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`main thread heapdump: </span><span class="sc">${</span><span class="at">writeHeapSnapshot</span>()<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-15" title="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-16" title="16"></a>
<a class="sourceLine" id="cb8-17" title="17">  <span class="co">// Tell the worker to create a heapdump.</span></a>
<a class="sourceLine" id="cb8-18" title="18">  <span class="va">worker</span>.<span class="at">postMessage</span>(<span class="st">&#39;heapdump&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-19" title="19"><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-20" title="20">  <span class="va">parentPort</span>.<span class="at">once</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> (message) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-21" title="21">    <span class="cf">if</span> (message <span class="op">===</span> <span class="st">&#39;heapdump&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-22" title="22">      <span class="co">// Generate a heapdump for the worker</span></a>
<a class="sourceLine" id="cb8-23" title="23">      <span class="co">// and return the filename to the parent.</span></a>
<a class="sourceLine" id="cb8-24" title="24">      <span class="va">parentPort</span>.<span class="at">postMessage</span>(<span class="at">writeHeapSnapshot</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb8-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-26" title="26">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="op">}</span></a></code></pre></div>
<h2 id="serialization-api">Serialization API</h2>
<p>The serialization API provides means of serializing JavaScript values in a way that is compatible with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">HTML structured clone algorithm</a>.</p>
<p>The format is backward-compatible (i.e. safe to store to disk). Equal JavaScript values may result in different serialized output.</p>
<h3 id="v8.serializevalue"><code>v8.serialize(value)</code></h3>
<!-- YAML
added: v8.0.0
-->
<ul>
<li><code>value</code> {any}</li>
<li>Returns: {Buffer}</li>
</ul>
<p>Uses a <a href="#v8_class_v8_defaultserializer"><code>DefaultSerializer</code></a> to serialize <code>value</code> into a buffer.</p>
<h3 id="v8.deserializebuffer"><code>v8.deserialize(buffer)</code></h3>
<!-- YAML
added: v8.0.0
-->
<ul>
<li><code>buffer</code> {Buffer|TypedArray|DataView} A buffer returned by <a href="#v8_v8_serialize_value"><code>serialize()</code></a>.</li>
</ul>
<p>Uses a <a href="#v8_class_v8_defaultdeserializer"><code>DefaultDeserializer</code></a> with default options to read a JS value from a buffer.</p>
<h3 id="class-v8.serializer">Class: <code>v8.Serializer</code></h3>
<!-- YAML
added: v8.0.0
-->
<h4 id="new-serializer"><code>new Serializer()</code></h4>
<p>Creates a new <code>Serializer</code> object.</p>
<h4 id="serializer.writeheader"><code>serializer.writeHeader()</code></h4>
<p>Writes out a header, which includes the serialization format version.</p>
<h4 id="serializer.writevaluevalue"><code>serializer.writeValue(value)</code></h4>
<ul>
<li><code>value</code> {any}</li>
</ul>
<p>Serializes a JavaScript value and adds the serialized representation to the internal buffer.</p>
<p>This throws an error if <code>value</code> cannot be serialized.</p>
<h4 id="serializer.releasebuffer"><code>serializer.releaseBuffer()</code></h4>
<ul>
<li>Returns: {Buffer}</li>
</ul>
<p>Returns the stored internal buffer. This serializer should not be used once the buffer is released. Calling this method results in undefined behavior if a previous write has failed.</p>
<h4 id="serializer.transferarraybufferid-arraybuffer"><code>serializer.transferArrayBuffer(id, arrayBuffer)</code></h4>
<ul>
<li><code>id</code> {integer} A 32-bit unsigned integer.</li>
<li><code>arrayBuffer</code> {ArrayBuffer} An <code>ArrayBuffer</code> instance.</li>
</ul>
<p>Marks an <code>ArrayBuffer</code> as having its contents transferred out of band. Pass the corresponding <code>ArrayBuffer</code> in the deserializing context to <a href="#v8_deserializer_transferarraybuffer_id_arraybuffer"><code>deserializer.transferArrayBuffer()</code></a>.</p>
<h4 id="serializer.writeuint32value"><code>serializer.writeUint32(value)</code></h4>
<ul>
<li><code>value</code> {integer}</li>
</ul>
<p>Write a raw 32-bit unsigned integer. For use inside of a custom <a href="#v8_serializer_writehostobject_object"><code>serializer._writeHostObject()</code></a>.</p>
<h4 id="serializer.writeuint64hi-lo"><code>serializer.writeUint64(hi, lo)</code></h4>
<ul>
<li><code>hi</code> {integer}</li>
<li><code>lo</code> {integer}</li>
</ul>
<p>Write a raw 64-bit unsigned integer, split into high and low 32-bit parts. For use inside of a custom <a href="#v8_serializer_writehostobject_object"><code>serializer._writeHostObject()</code></a>.</p>
<h4 id="serializer.writedoublevalue"><code>serializer.writeDouble(value)</code></h4>
<ul>
<li><code>value</code> {number}</li>
</ul>
<p>Write a JS <code>number</code> value. For use inside of a custom <a href="#v8_serializer_writehostobject_object"><code>serializer._writeHostObject()</code></a>.</p>
<h4 id="serializer.writerawbytesbuffer"><code>serializer.writeRawBytes(buffer)</code></h4>
<ul>
<li><code>buffer</code> {Buffer|TypedArray|DataView}</li>
</ul>
<p>Write raw bytes into the serializer’s internal buffer. The deserializer will require a way to compute the length of the buffer. For use inside of a custom <a href="#v8_serializer_writehostobject_object"><code>serializer._writeHostObject()</code></a>.</p>
<h4 id="serializer._writehostobjectobject"><code>serializer._writeHostObject(object)</code></h4>
<ul>
<li><code>object</code> {Object}</li>
</ul>
<p>This method is called to write some kind of host object, i.e. an object created by native C++ bindings. If it is not possible to serialize <code>object</code>, a suitable exception should be thrown.</p>
<p>This method is not present on the <code>Serializer</code> class itself but can be provided by subclasses.</p>
<h4 id="serializer._getdatacloneerrormessage"><code>serializer._getDataCloneError(message)</code></h4>
<ul>
<li><code>message</code> {string}</li>
</ul>
<p>This method is called to generate error objects that will be thrown when an object can not be cloned.</p>
<p>This method defaults to the <a href="errors.md#errors_class_error"><code>Error</code></a> constructor and can be overridden on subclasses.</p>
<h4 id="serializer._getsharedarraybufferidsharedarraybuffer"><code>serializer._getSharedArrayBufferId(sharedArrayBuffer)</code></h4>
<ul>
<li><code>sharedArrayBuffer</code> {SharedArrayBuffer}</li>
</ul>
<p>This method is called when the serializer is going to serialize a <code>SharedArrayBuffer</code> object. It must return an unsigned 32-bit integer ID for the object, using the same ID if this <code>SharedArrayBuffer</code> has already been serialized. When deserializing, this ID will be passed to <a href="#v8_deserializer_transferarraybuffer_id_arraybuffer"><code>deserializer.transferArrayBuffer()</code></a>.</p>
<p>If the object cannot be serialized, an exception should be thrown.</p>
<p>This method is not present on the <code>Serializer</code> class itself but can be provided by subclasses.</p>
<h4 id="serializer._settreatarraybufferviewsashostobjectsflag"><code>serializer._setTreatArrayBufferViewsAsHostObjects(flag)</code></h4>
<ul>
<li><code>flag</code> {boolean} <strong>Default:</strong> <code>false</code></li>
</ul>
<p>Indicate whether to treat <code>TypedArray</code> and <code>DataView</code> objects as host objects, i.e. pass them to <a href="#v8_serializer_writehostobject_object"><code>serializer._writeHostObject()</code></a>.</p>
<h3 id="class-v8.deserializer">Class: <code>v8.Deserializer</code></h3>
<!-- YAML
added: v8.0.0
-->
<h4 id="new-deserializerbuffer"><code>new Deserializer(buffer)</code></h4>
<ul>
<li><code>buffer</code> {Buffer|TypedArray|DataView} A buffer returned by <a href="#v8_serializer_releasebuffer"><code>serializer.releaseBuffer()</code></a>.</li>
</ul>
<p>Creates a new <code>Deserializer</code> object.</p>
<h4 id="deserializer.readheader"><code>deserializer.readHeader()</code></h4>
<p>Reads and validates a header (including the format version). May, for example, reject an invalid or unsupported wire format. In that case, an <code>Error</code> is thrown.</p>
<h4 id="deserializer.readvalue"><code>deserializer.readValue()</code></h4>
<p>Deserializes a JavaScript value from the buffer and returns it.</p>
<h4 id="deserializer.transferarraybufferid-arraybuffer"><code>deserializer.transferArrayBuffer(id, arrayBuffer)</code></h4>
<ul>
<li><code>id</code> {integer} A 32-bit unsigned integer.</li>
<li><code>arrayBuffer</code> {ArrayBuffer|SharedArrayBuffer} An <code>ArrayBuffer</code> instance.</li>
</ul>
<p>Marks an <code>ArrayBuffer</code> as having its contents transferred out of band. Pass the corresponding <code>ArrayBuffer</code> in the serializing context to <a href="#v8_serializer_transferarraybuffer_id_arraybuffer"><code>serializer.transferArrayBuffer()</code></a> (or return the <code>id</code> from <a href="#v8_serializer_getsharedarraybufferid_sharedarraybuffer"><code>serializer._getSharedArrayBufferId()</code></a> in the case of <code>SharedArrayBuffer</code>s).</p>
<h4 id="deserializer.getwireformatversion"><code>deserializer.getWireFormatVersion()</code></h4>
<ul>
<li>Returns: {integer}</li>
</ul>
<p>Reads the underlying wire format version. Likely mostly to be useful to legacy code reading old wire format versions. May not be called before <code>.readHeader()</code>.</p>
<h4 id="deserializer.readuint32"><code>deserializer.readUint32()</code></h4>
<ul>
<li>Returns: {integer}</li>
</ul>
<p>Read a raw 32-bit unsigned integer and return it. For use inside of a custom <a href="#v8_deserializer_readhostobject"><code>deserializer._readHostObject()</code></a>.</p>
<h4 id="deserializer.readuint64"><code>deserializer.readUint64()</code></h4>
<ul>
<li>Returns: {integer[]}</li>
</ul>
<p>Read a raw 64-bit unsigned integer and return it as an array <code>[hi, lo]</code> with two 32-bit unsigned integer entries. For use inside of a custom <a href="#v8_deserializer_readhostobject"><code>deserializer._readHostObject()</code></a>.</p>
<h4 id="deserializer.readdouble"><code>deserializer.readDouble()</code></h4>
<ul>
<li>Returns: {number}</li>
</ul>
<p>Read a JS <code>number</code> value. For use inside of a custom <a href="#v8_deserializer_readhostobject"><code>deserializer._readHostObject()</code></a>.</p>
<h4 id="deserializer.readrawbyteslength"><code>deserializer.readRawBytes(length)</code></h4>
<ul>
<li><code>length</code> {integer}</li>
<li>Returns: {Buffer}</li>
</ul>
<p>Read raw bytes from the deserializer’s internal buffer. The <code>length</code> parameter must correspond to the length of the buffer that was passed to <a href="#v8_serializer_writerawbytes_buffer"><code>serializer.writeRawBytes()</code></a>. For use inside of a custom <a href="#v8_deserializer_readhostobject"><code>deserializer._readHostObject()</code></a>.</p>
<h4 id="deserializer._readhostobject"><code>deserializer._readHostObject()</code></h4>
<p>This method is called to read some kind of host object, i.e. an object that is created by native C++ bindings. If it is not possible to deserialize the data, a suitable exception should be thrown.</p>
<p>This method is not present on the <code>Deserializer</code> class itself but can be provided by subclasses.</p>
<h3 id="class-v8.defaultserializer">Class: <code>v8.DefaultSerializer</code></h3>
<!-- YAML
added: v8.0.0
-->
<p>A subclass of <a href="#v8_class_v8_serializer"><code>Serializer</code></a> that serializes <code>TypedArray</code> (in particular <a href="buffer.md"><code>Buffer</code></a>) and <code>DataView</code> objects as host objects, and only stores the part of their underlying <code>ArrayBuffer</code>s that they are referring to.</p>
<h3 id="class-v8.defaultdeserializer">Class: <code>v8.DefaultDeserializer</code></h3>
<!-- YAML
added: v8.0.0
-->
<p>A subclass of <a href="#v8_class_v8_deserializer"><code>Deserializer</code></a> corresponding to the format written by <a href="#v8_class_v8_defaultserializer"><code>DefaultSerializer</code></a>.</p>
</body>
</html>
