<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Deploying to Amazon Elastic Container Service</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Deploying to Amazon Elastic Container Service</h1>
    </header>
    <p>
      {% data reusables.actions.enterprise-beta %} {% data
      reusables.actions.enterprise-github-hosted-runners %} {% data
      reusables.actions.ae-beta %}
    </p>
    <h2 id="introduction">Introduction</h2>
    <p>
      This guide explains how to use {% data variables.product.prodname_actions
      %} to build a containerized application, push it to
      <a href="https://aws.amazon.com/ecr/"
        >Amazon Elastic Container Registry (ECR)</a
      >, and deploy it to
      <a href="https://aws.amazon.com/ecs/"
        >Amazon Elastic Container Service (ECS)</a
      >.
    </p>
    <p>
      On every new release in your {% data variables.product.company_short %}
      repository, the {% data variables.product.prodname_actions %} workflow
      builds and pushes a new container image to Amazon ECR, and then deploys a
      new task definition to Amazon ECS.
    </p>
    <h2 id="prerequisites">Prerequisites</h2>
    <p>
      Before creating your {% data variables.product.prodname_actions %}
      workflow, you will first need to complete the following setup steps for
      Amazon ECR and ECS:
    </p>
    <ol type="1">
      <li>
        <p>Create an Amazon ECR repository to store your images.</p>
        <p>
          For example, using
          <a href="https://aws.amazon.com/cli/">the AWS CLI</a>:
        </p>
        <p>
          {% raw %}<code
            >bash{:copy} aws ecr create-repository \ --repository-name
            MY_ECR_REPOSITORY \ --region MY_AWS_REGION</code
          >{% endraw %}
        </p>
        <p>
          Ensure that you use the same Amazon ECR repository name (represented
          here by <code>MY_ECR_REPOSITORY</code>) for the
          <code>ECR_REPOSITORY</code> variable in the workflow below.
        </p>
        <p>
          Ensure that you use the same AWS region value for the
          <code>AWS_REGION</code> (represented here by
          <code>MY_AWS_REGION</code>) variable in the workflow below.
        </p>
      </li>
      <li>
        <p>Create an Amazon ECS task definition, cluster, and service.</p>
        <p>
          For details, follow the
          <a
            href="https://us-east-2.console.aws.amazon.com/ecs/home?region=us-east-2#/firstRun"
            >Getting started wizard on the Amazon ECS console</a
          >, or the
          <a
            href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/getting-started-fargate.html"
            >Getting started guide</a
          >
          in the Amazon ECS documentation.
        </p>
        <p>
          Ensure that you note the names you set for the Amazon ECS service and
          cluster, and use them for the <code>ECS_SERVICE</code> and
          <code>ECS_CLUSTER</code> variables in the workflow below.
        </p>
      </li>
      <li>
        <p>
          Store your Amazon ECS task definition as a JSON file in your {% data
          variables.product.company_short %} repository.
        </p>
        <p>
          The format of the file should be the same as the output generated by:
        </p>
        <p>
          {% raw %}<code
            >bash{:copy} aws ecs register-task-definition
            --generate-cli-skeleton</code
          >{% endraw %}
        </p>
        <p>
          Ensure that you set the <code>ECS_TASK_DEFINITION</code> variable in
          the workflow below as the path to the JSON file.
        </p>
        <p>
          Ensure that you set the <code>CONTAINER_NAME</code> variable in the
          workflow below as the container name in the
          <code>containerDefinitions</code> section of the task definition.
        </p>
      </li>
      <li>
        <p>
          Create {% data variables.product.prodname_actions %} secrets named
          <code>AWS_ACCESS_KEY_ID</code> and
          <code>AWS_SECRET_ACCESS_KEY</code> to store the values for your Amazon
          IAM access key.
        </p>
        <p>
          For more information on creating secrets for {% data
          variables.product.prodname_actions %}, see “<a
            href="/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository"
            >Encrypted secrets</a
          >.”
        </p>
        <p>
          See the documentation for each action used below for the recommended
          IAM policies for the IAM user, and methods for handling the access key
          credentials.
        </p>
      </li>
    </ol>
    <h2 id="creating-the-workflow">Creating the workflow</h2>
    <p>
      Once you’ve completed the prerequisites, you can proceed with creating the
      workflow.
    </p>
    <p>
      The following example workflow demonstrates how to build a container image
      and push it to Amazon ECR. It then updates the task definition with the
      new image ID, and deploys the task definition to Amazon ECS.
    </p>
    <p>
      Ensure that you provide your own values for all the variables in the
      <code>env</code> key of the workflow.
    </p>
    <pre
      class="yaml{:copy}"
    ><code>{% data reusables.actions.actions-not-certified-by-github-comment %}

name: Deploy to Amazon ECS

on:
  release:
    types: [ created ]

env:
  AWS_REGION: MY_AWS_REGION                   # set this to your preferred AWS region, e.g. us-west-1
  ECR_REPOSITORY: MY_ECR_REPOSITORY           # set this to your Amazon ECR repository name
  ECS_SERVICE: MY_ECS_SERVICE                 # set this to your Amazon ECS service name
  ECS_CLUSTER: MY_ECS_CLUSTER                 # set this to your Amazon ECS cluster name
  ECS_TASK_DEFINITION: MY_ECS_TASK_DEFINITION # set this to the path to your Amazon ECS task definition
                                               # file, e.g. .aws/task-definition.json
  CONTAINER_NAME: MY_CONTAINER_NAME           # set this to the name of the container in the
                                               # containerDefinitions section of your task definition

defaults:
  run:
    shell: bash

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest{% ifversion fpt or ghes &gt; 3.1 or ghae-next %}
    permissions:
      packages: write
      contents: read{% endif %}

    {% raw %}steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@13d241b293754004c80624b5567555c4a39ffbe3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@aaf69d68aa3fb14c1d5a6be9ac61fe15b48453a2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build a docker container and
          # push it to ECR so that it can
          # be deployed to ECS.
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo &quot;::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG&quot;

      - name: Fill in the new image ID in the Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@97587c9d45a4930bf0e3da8dd2feb2a463cf4a3a
        with:
          task-definition: ${{ env.ECS_TASK_DEFINITION }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@de0132cf8cdedb79975c6d42b77eb7ea193cf28e
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true{% endraw %}</code></pre>
    <h2 id="additional-resources">Additional resources</h2>
    <p>
      For more information on the services used in these examples, see the
      following documentation:
    </p>
    <ul>
      <li>
        “<a
          href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html"
          >Security best practices in IAM</a
        >” in the Amazon AWS documentation.
      </li>
      <li>
        Official AWS “<a
          href="https://github.com/aws-actions/configure-aws-credentials"
          >Configure AWS Credentials</a
        >” action.
      </li>
      <li>
        Official AWS
        <a href="https://github.com/aws-actions/amazon-ecr-login"
          >Amazon ECR “Login”</a
        >
        action.
      </li>
      <li>
        Official AWS
        <a
          href="https://github.com/aws-actions/amazon-ecs-render-task-definition"
          >Amazon ECS “Render Task Definition”</a
        >
        action.
      </li>
      <li>
        Official AWS
        <a
          href="https://github.com/aws-actions/amazon-ecs-deploy-task-definition"
          >Amazon ECS “Deploy Task Definition”</a
        >
        action.
      </li>
    </ul>
  </body>
</html>
