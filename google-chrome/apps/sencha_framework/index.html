<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2012-10-11" />
  <title>Build Apps with Sencha Ext JS</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Build Apps with Sencha Ext JS</h1>
<p class="date">2012-10-11</p>
</header>
<p>{% Aside ‘caution’ %}</p>
<p><strong>Important:</strong> Chrome will be removing support for Chrome Apps on all platforms. Chrome browser and the Chrome Web Store will continue to support extensions. <a href="https://blog.chromium.org/2020/08/changes-to-chrome-app-support-timeline.html"><strong>Read the announcement</strong></a> and learn more about <a href="/apps/migration"><strong>migrating your app</strong></a>.</p>
<p>{% endAside %}</p>
<p>The goal of this doc is to get you started on building Chrome Apps with the <a href="http://www.sencha.com/products/extjs">Sencha Ext JS</a> framework. To achieve this goal, we will dive into a media player app built by Sencha. The <a href="https://github.com/GoogleChrome/sencha-video-player-app">source code</a> and <a href="http://senchaprosvcs.github.com/GooglePlayer/docs/output/#!/api">API Documentation</a> are available on GitHub.</p>
<p>This app discovers a user’s available media servers, including media devices connected to the pc and software that manages media over the network. Users can browse media, play over the network, or save offline.</p>
<p>Here are the key things you must do to build a media player app using Sencha Ext JS:</p>
<ul>
<li>Create manifest, <code>manifest.json</code>.</li>
<li>Create <a href="app_lifecycle#eventpage">event page</a>, <code>background.js</code>.</li>
<li><a href="app_external#sandboxing">Sandbox</a> app’s logic.</li>
<li>Communicate between Chrome App and sandboxed files.</li>
<li>Discover media servers.</li>
<li>Explore and play media.</li>
<li>Save media offline.</li>
</ul>
<h2 id="create-manifest-first">Create manifest {: #first }</h2>
<p>All Chrome Apps require a <a href="manifest">manifest file</a> which contains the information Chrome needs to launch apps. As indicated in the manifest, the media player app is “offline_enabled”; media assets can be saved locally, accessed and played regardless of connectivity.</p>
<p>The “sandbox” field is used to sandbox the app’s main logic in a unique origin. All sandboxed content is exempt from the Chrome App <a href="contentSecurityPolicy">Content Security Policy</a>, but cannot directly access the Chrome App APIs. The manifest also includes the “socket” permission; the media player app uses the <a href="socket">socket API</a> to connect to a media server over the network.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Video Player&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Features network media discovery and playlist management&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="dt">&quot;manifest_version&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="dt">&quot;offline_enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="dt">&quot;app&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="dt">&quot;background&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">            <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb1-10" title="10">                <span class="st">&quot;background.js&quot;</span></a>
<a class="sourceLine" id="cb1-11" title="11">            <span class="ot">]</span></a>
<a class="sourceLine" id="cb1-12" title="12">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="fu">},</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="er">...</span></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="dt">&quot;sandbox&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="dt">&quot;pages&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;sandbox.html&quot;</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="fu">},</span></a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="dt">&quot;permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb1-20" title="20">        <span class="st">&quot;experimental&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="st">&quot;http://*/*&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-22" title="22">        <span class="st">&quot;unlimitedStorage&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-23" title="23">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-24" title="24">            <span class="dt">&quot;socket&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb1-25" title="25">                <span class="st">&quot;tcp-connect&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-26" title="26">                <span class="st">&quot;udp-send-to&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-27" title="27">                <span class="st">&quot;udp-bind&quot;</span></a>
<a class="sourceLine" id="cb1-28" title="28">            <span class="ot">]</span></a>
<a class="sourceLine" id="cb1-29" title="29">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb1-30" title="30">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="fu">}</span></a></code></pre></div>
<h2 id="create-event-page-second">Create event page {: #second }</h2>
<p>All Chrome Apps require <code>background.js</code> to launch the application. The media player’s main page, <code>index.html</code>, opens in a window with the specified dimensions:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">chrome</span>.<span class="va">app</span>.<span class="va">runtime</span>.<span class="va">onLaunched</span>.<span class="at">addListener</span>(<span class="kw">function</span>(launchData) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="kw">var</span> opt <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">        <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-4" title="4">        <span class="dt">height</span><span class="op">:</span> <span class="dv">700</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="op">};</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="va">chrome</span>.<span class="va">app</span>.<span class="va">window</span>.<span class="at">create</span>(<span class="st">&#39;index.html&#39;</span><span class="op">,</span> opt<span class="op">,</span> <span class="kw">function</span> (win) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">        <span class="va">win</span>.<span class="at">launchData</span> <span class="op">=</span> launchData<span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="sandbox-apps-logic-three">Sandbox app’s logic {: #three }</h2>
<p>Chrome Apps run in a controlled environment that enforces a strict <a href="contentSecurityPolicy">Content Security Policy (CSP)</a>. The media player app needs some higher privileges to render the Ext JS components. To comply with CSP and execute the app logic, the app’s main page, <code>index.html</code>, creates an iframe that acts as a sandbox environment:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">&lt;iframe</span><span class="ot"> id=</span><span class="st">&quot;sandbox-frame&quot;</span><span class="ot"> sandbox=</span><span class="st">&quot;allow-scripts&quot;</span><span class="ot"> src=</span><span class="st">&quot;sandbox.html&quot;</span><span class="kw">&gt;&lt;/iframe&gt;</span></a></code></pre></div>
<p>The iframe points to <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/sandbox.html">sandbox.html</a> which includes the files required for the Ext JS application:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;html&gt;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> type=</span><span class="st">&quot;text/css&quot;</span><span class="ot"> href=</span><span class="st">&quot;resources/css/app.css&quot;</span> <span class="kw">/&gt;</span>&#39;</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;sdk/ext-all-dev.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>&#39;</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;lib/ext/data/PostMessage.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>&#39;</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;lib/ChromeProxy.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>&#39;</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;app.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw">&lt;body&gt;&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>The <a href="http://senchaprosvcs.github.com/GooglePlayer/docs/output/source/app.html#VP-Application">app.js</a> script executes all the Ext JS code and renders the media player views. Since this script is sandboxed, it cannot directly access the Chrome App APIs. Communication between <code>app.js</code> and non-sandboxed files is done using the <a href="https://developer.mozilla.org/en-US/docs/DOM/window.postMessage">HTML5 Post Message API</a>.</p>
<h2 id="communicate-between-files-four">Communicate between files {: #four }</h2>
<p>In order for the media player app to access Chrome App APIs, like query the network for media servers, <code>app.js</code> posts messages to <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/index.js">index.js</a>. Unlike the sandboxed <code>app.js</code>, <code>index.js</code> can directly access the Chrome App APIs.</p>
<p><code>index.js</code> creates the iframe:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">var</span> iframe <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;sandbox-frame&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">iframeWindow <span class="op">=</span> <span class="va">iframe</span>.<span class="at">contentWindow</span><span class="op">;</span></a></code></pre></div>
<p>And listens for messages from the sandboxed files:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="kw">var</span> data<span class="op">=</span> <span class="va">e</span>.<span class="at">data</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-3" title="3">        key <span class="op">=</span> <span class="va">data</span>.<span class="at">key</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;[index.js] Post Message received with key &#39;</span> <span class="op">+</span> key)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="cf">switch</span> (key) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-8" title="8">        <span class="cf">case</span> <span class="st">&#39;extension-baseurl&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-9" title="9">            <span class="at">extensionBaseUrl</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-10" title="10">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12">        <span class="cf">case</span> <span class="st">&#39;upnp-discover&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-13" title="13">            <span class="at">upnpDiscover</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-14" title="14">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-15" title="15"></a>
<a class="sourceLine" id="cb6-16" title="16">        <span class="cf">case</span> <span class="st">&#39;upnp-browse&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-17" title="17">            <span class="at">upnpBrowse</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-18" title="18">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-19" title="19"></a>
<a class="sourceLine" id="cb6-20" title="20">        <span class="cf">case</span> <span class="st">&#39;play-media&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-21" title="21">            <span class="at">playMedia</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-22" title="22">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-23" title="23"></a>
<a class="sourceLine" id="cb6-24" title="24">        <span class="cf">case</span> <span class="st">&#39;download-media&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-25" title="25">            <span class="at">downloadMedia</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-26" title="26">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-27" title="27"></a>
<a class="sourceLine" id="cb6-28" title="28">        <span class="cf">case</span> <span class="st">&#39;cancel-download&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-29" title="29">            <span class="at">cancelDownload</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-30" title="30">            <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-31" title="31"></a>
<a class="sourceLine" id="cb6-32" title="32">        <span class="cf">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-33" title="33">            <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;[index.js] unidentified key for Post Message: &quot;&#39;</span> <span class="op">+</span> key <span class="op">+</span> <span class="st">&#39;&quot;&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-35" title="35"><span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></a></code></pre></div>
<p>In the following example, <code>app.js</code> sends a message to <code>index.js</code> requesting the key ‘extension-baseurl’:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="va">Ext</span>.<span class="va">data</span>.<span class="va">PostMessage</span>.<span class="at">request</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;extension-baseurl&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="dt">success</span><span class="op">:</span> <span class="kw">function</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">        <span class="co">//...</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p><code>index.js</code> receives the request, assigns the result, and replies by sending the Base URL back:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">function</span> <span class="at">extensionBaseUrl</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="va">data</span>.<span class="at">result</span> <span class="op">=</span> <span class="va">chrome</span>.<span class="va">extension</span>.<span class="at">getURL</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="va">iframeWindow</span>.<span class="at">postMessage</span>(data<span class="op">,</span> <span class="st">&#39;*&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="op">}</span></a></code></pre></div>
<h2 id="discover-media-servers-five">Discover media servers {: #five }</h2>
<p>There’s a lot that goes into discovering media servers. At a high level, the discovery workflow is initiated by a user action to search for available media servers. The <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/app/controller/MediaServers.js">MediaServer controller</a> posts a message to <code>index.js</code>; <code>index.js</code> listens for this message and when received, calls <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/lib/Upnp.js">Upnp.js</a>.</p>
<p>The <code>Upnp library</code> uses the Chrome App <a href="app_network">socket API</a> to connect the media player app with any discovered media servers and receive media data from the media server. <code>Upnp.js</code> also uses <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/lib/soapclient.js">soapclient.js</a> to parse the media server data. The remainder of this section describes this workflow in more detail.</p>
<h3 id="post-message-post">Post message {: #post }</h3>
<p>When a user clicks the Media Servers button in the center of the media player app, <code>MediaServers.js</code> calls <code>discoverServers()</code>. This function first checks for any outstanding discovery requests, and if true, aborts them so the new request can be initiated. Next, the controller posts a message to <code>index.js</code> with a key upnp-discovery, and two callback listeners:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="va">me</span>.<span class="at">activeDiscoverRequest</span> <span class="op">=</span> <span class="va">Ext</span>.<span class="va">data</span>.<span class="va">PostMessage</span>.<span class="at">request</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;upnp-discover&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="dt">success</span><span class="op">:</span> <span class="kw">function</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">        <span class="kw">var</span> items <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="kw">delete</span> <span class="va">me</span>.<span class="at">activeDiscoverRequest</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7">        <span class="cf">if</span> (<span class="va">serversGraph</span>.<span class="at">isDestroyed</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-8" title="8">            <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-9" title="9">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11">        <span class="va">mainBtn</span>.<span class="at">isLoading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-12" title="12">        <span class="va">mainBtn</span>.<span class="at">removeCls</span>(<span class="st">&#39;pop-in&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-13" title="13">        <span class="va">mainBtn</span>.<span class="at">setIconCls</span>(<span class="st">&#39;ico-server&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-14" title="14">        <span class="va">mainBtn</span>.<span class="at">setText</span>(<span class="st">&#39;Media Servers&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-15" title="15"></a>
<a class="sourceLine" id="cb9-16" title="16">        <span class="co">//add servers</span></a>
<a class="sourceLine" id="cb9-17" title="17">        <span class="va">Ext</span>.<span class="at">each</span>(data<span class="op">,</span> <span class="kw">function</span>(server) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-18" title="18">            <span class="kw">var</span> icon<span class="op">,</span></a>
<a class="sourceLine" id="cb9-19" title="19">                urlBase <span class="op">=</span> <span class="va">server</span>.<span class="at">urlBase</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-20" title="20"></a>
<a class="sourceLine" id="cb9-21" title="21">            <span class="cf">if</span> (urlBase) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-22" title="22">                <span class="cf">if</span> (<span class="va">urlBase</span>.<span class="at">substr</span>(<span class="va">urlBase</span>.<span class="at">length</span><span class="dv">-1</span><span class="op">,</span> <span class="dv">1</span>) <span class="op">===</span> <span class="st">&#39;/&#39;</span>)<span class="op">{</span></a>
<a class="sourceLine" id="cb9-23" title="23">                        urlBase <span class="op">=</span> <span class="va">urlBase</span>.<span class="at">substr</span>(<span class="dv">0</span><span class="op">,</span> <span class="va">urlBase</span>.<span class="at">length</span><span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-24" title="24">                <span class="op">}</span></a>
<a class="sourceLine" id="cb9-25" title="25">            <span class="op">}</span></a>
<a class="sourceLine" id="cb9-26" title="26"></a>
<a class="sourceLine" id="cb9-27" title="27">            <span class="cf">if</span> (<span class="va">server</span>.<span class="at">icons</span> <span class="op">&amp;&amp;</span> <span class="va">server</span>.<span class="va">icons</span>.<span class="at">length</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-28" title="28">                <span class="cf">if</span> (<span class="va">server</span>.<span class="at">icons</span>[<span class="dv">1</span>]) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-29" title="29">                    icon <span class="op">=</span> <span class="va">server</span>.<span class="at">icons</span>[<span class="dv">1</span>].<span class="at">url</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-30" title="30">                <span class="op">}</span></a>
<a class="sourceLine" id="cb9-31" title="31">                <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-32" title="32">                    icon <span class="op">=</span> <span class="va">server</span>.<span class="at">icons</span>[<span class="dv">0</span>].<span class="at">url</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-33" title="33">                <span class="op">}</span></a>
<a class="sourceLine" id="cb9-34" title="34"></a>
<a class="sourceLine" id="cb9-35" title="35">                icon <span class="op">=</span> urlBase <span class="op">+</span> icon<span class="op">;</span></a>
<a class="sourceLine" id="cb9-36" title="36">            <span class="op">}</span></a>
<a class="sourceLine" id="cb9-37" title="37"></a>
<a class="sourceLine" id="cb9-38" title="38">            <span class="va">items</span>.<span class="at">push</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb9-39" title="39">                <span class="dt">itemId</span><span class="op">:</span> <span class="va">server</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-40" title="40">                <span class="dt">text</span><span class="op">:</span> <span class="va">server</span>.<span class="at">friendlyName</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-41" title="41">                <span class="dt">icon</span><span class="op">:</span> icon<span class="op">,</span></a>
<a class="sourceLine" id="cb9-42" title="42">                <span class="dt">data</span><span class="op">:</span> server</a>
<a class="sourceLine" id="cb9-43" title="43">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-44" title="44">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-45" title="45"></a>
<a class="sourceLine" id="cb9-46" title="46">        ...</a>
<a class="sourceLine" id="cb9-47" title="47">    <span class="op">},</span></a>
<a class="sourceLine" id="cb9-48" title="48">    <span class="dt">failure</span><span class="op">:</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-49" title="49">        <span class="kw">delete</span> <span class="va">me</span>.<span class="at">activeDiscoverRequest</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-50" title="50"></a>
<a class="sourceLine" id="cb9-51" title="51">        <span class="cf">if</span> (<span class="va">serversGraph</span>.<span class="at">isDestroyed</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-52" title="52">            <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-53" title="53">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-54" title="54"></a>
<a class="sourceLine" id="cb9-55" title="55">        <span class="va">mainBtn</span>.<span class="at">isLoading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-56" title="56">        <span class="va">mainBtn</span>.<span class="at">removeCls</span>(<span class="st">&#39;pop-in&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-57" title="57">        <span class="va">mainBtn</span>.<span class="at">setIconCls</span>(<span class="st">&#39;ico-error&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-58" title="58">        <span class="va">mainBtn</span>.<span class="at">setText</span>(<span class="st">&#39;Error...click to retry&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-59" title="59">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-60" title="60"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="call-upnpdiscover-call">Call upnpDiscover() {: #call }</h3>
<p><code>index.js</code> listens for the ‘upnp-discover’ message from <code>app.js</code> and responds by calling <code>upnpDiscover()</code>. When a media server is discovered, <code>index.js</code> extracts the media server domain from the parameters, saves the server locally, formats the media server data, and pushes the data to the <code>MediaServer</code> controller.</p>
<h3 id="parse-media-server-data-parse">Parse media server data {: #parse }</h3>
<p>When <code>Upnp.js</code> discovers a new media server, it then retrieves a description of the device and sends a Soaprequest to browse and parse the media server data; <code>soapclient.js</code> parses the media elements by tag name into a document.</p>
<h3 id="connect-to-media-server-connect">Connect to media server {: #connect }</h3>
<p><code>Upnp.js</code> connects to discovered media servers and receives media data using the Chrome App socket API:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">socket</span>.<span class="at">create</span>(<span class="st">&quot;udp&quot;</span><span class="op">,</span> <span class="op">{},</span> <span class="kw">function</span>(info) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">    <span class="kw">var</span> socketId <span class="op">=</span> <span class="va">info</span>.<span class="at">socketId</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="co">//bind locally</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="va">socket</span>.<span class="at">bind</span>(socketId<span class="op">,</span> <span class="st">&quot;0.0.0.0&quot;</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">function</span>(info) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">        <span class="co">//pack upnp message</span></a>
<a class="sourceLine" id="cb10-8" title="8">        <span class="kw">var</span> message <span class="op">=</span> <span class="va">String</span>.<span class="at">toBuffer</span>(UPNP_MESSAGE)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-9" title="9"></a>
<a class="sourceLine" id="cb10-10" title="10">        <span class="co">//broadcast to upnp</span></a>
<a class="sourceLine" id="cb10-11" title="11">        <span class="va">socket</span>.<span class="at">sendTo</span>(socketId<span class="op">,</span> message<span class="op">,</span> UPNP_ADDRESS<span class="op">,</span> UPNP_PORT<span class="op">,</span> <span class="kw">function</span>(info) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13">            <span class="co">// Wait 1 second</span></a>
<a class="sourceLine" id="cb10-14" title="14">            <span class="at">setTimeout</span>(<span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-15" title="15"></a>
<a class="sourceLine" id="cb10-16" title="16">                <span class="co">//receive</span></a>
<a class="sourceLine" id="cb10-17" title="17">                <span class="va">socket</span>.<span class="at">recvFrom</span>(socketId<span class="op">,</span> <span class="kw">function</span>(info) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-18" title="18"></a>
<a class="sourceLine" id="cb10-19" title="19">                    <span class="co">//unpack message</span></a>
<a class="sourceLine" id="cb10-20" title="20">                    <span class="kw">var</span> data        <span class="op">=</span> <span class="va">String</span>.<span class="at">fromBuffer</span>(<span class="va">info</span>.<span class="at">data</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb10-21" title="21">                        servers     <span class="op">=</span> []<span class="op">,</span></a>
<a class="sourceLine" id="cb10-22" title="22">                        locationReg <span class="op">=</span> <span class="ss">/</span><span class="sc">^</span><span class="ss">location:/i</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-23" title="23"></a>
<a class="sourceLine" id="cb10-24" title="24">                    <span class="co">//extract location info</span></a>
<a class="sourceLine" id="cb10-25" title="25">                    <span class="cf">if</span> (data) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-26" title="26">                        data <span class="op">=</span> <span class="va">data</span>.<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\r\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-27" title="27"></a>
<a class="sourceLine" id="cb10-28" title="28">                        <span class="va">data</span>.<span class="at">forEach</span>(<span class="kw">function</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-29" title="29">                            <span class="cf">if</span> (<span class="va">locationReg</span>.<span class="at">test</span>(value))<span class="op">{</span></a>
<a class="sourceLine" id="cb10-30" title="30">                                <span class="va">servers</span>.<span class="at">push</span>(<span class="va">value</span>.<span class="at">replace</span>(locationReg<span class="op">,</span> <span class="st">&quot;&quot;</span>).<span class="at">trim</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb10-31" title="31">                            <span class="op">}</span></a>
<a class="sourceLine" id="cb10-32" title="32">                        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-33" title="33">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-34" title="34"></a>
<a class="sourceLine" id="cb10-35" title="35">                    <span class="co">//success</span></a>
<a class="sourceLine" id="cb10-36" title="36">                    <span class="at">callback</span>(servers)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-37" title="37">                <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-38" title="38"></a>
<a class="sourceLine" id="cb10-39" title="39">            <span class="op">},</span> <span class="dv">1000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-40" title="40">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-41" title="41">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-42" title="42"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="explore-and-play-media-six">Explore and play media {: #six }</h2>
<p>The <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/app/controller/MediaExplorer.js">MediaExplorer controller</a> lists all the media files inside a media server folder and is responsible for updating the breadcrumb navigation in the media player app window. When a user selects a media file, the controller posts a message to <code>index.js</code> with the ‘play-media’ key:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1">onFileDblClick<span class="op">:</span> <span class="kw">function</span>(explorer<span class="op">,</span> record) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">    <span class="kw">var</span> serverPanel<span class="op">,</span> node<span class="op">,</span></a>
<a class="sourceLine" id="cb11-3" title="3">        type    <span class="op">=</span> <span class="va">record</span>.<span class="at">get</span>(<span class="st">&#39;type&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-4" title="4">        url     <span class="op">=</span> <span class="va">record</span>.<span class="at">get</span>(<span class="st">&#39;url&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-5" title="5">        name    <span class="op">=</span> <span class="va">record</span>.<span class="at">get</span>(<span class="st">&#39;name&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-6" title="6">        serverId<span class="op">=</span> <span class="va">record</span>.<span class="at">get</span>(<span class="st">&#39;serverId&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="cf">if</span> (type <span class="op">===</span> <span class="st">&#39;audio&#39;</span> <span class="op">||</span> type <span class="op">===</span> <span class="st">&#39;video&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" title="9">        <span class="va">Ext</span>.<span class="va">data</span>.<span class="va">PostMessage</span>.<span class="at">request</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb11-10" title="10">            <span class="dt">key     </span><span class="op">:</span> <span class="st">&#39;play-media&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-11" title="11">            <span class="dt">params  </span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-12" title="12">                <span class="dt">url</span><span class="op">:</span> url<span class="op">,</span></a>
<a class="sourceLine" id="cb11-13" title="13">                <span class="dt">name</span><span class="op">:</span> name<span class="op">,</span></a>
<a class="sourceLine" id="cb11-14" title="14">                <span class="dt">type</span><span class="op">:</span> type</a>
<a class="sourceLine" id="cb11-15" title="15">            <span class="op">}</span></a>
<a class="sourceLine" id="cb11-16" title="16">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-17" title="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="op">},</span></a></code></pre></div>
<p><code>index.js</code> listens for this post message and responds by calling <code>playMedia()</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">function</span> <span class="at">playMedia</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">    <span class="kw">var</span> type        <span class="op">=</span> <span class="va">data</span>.<span class="va">params</span>.<span class="at">type</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-3" title="3">        url         <span class="op">=</span> <span class="va">data</span>.<span class="va">params</span>.<span class="at">url</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-4" title="4">        playerCt    <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;player-ct&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-5" title="5">        audioBody   <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;audio-body&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-6" title="6">        videoBody   <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;video-body&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-7" title="7">        mediaEl     <span class="op">=</span> <span class="va">playerCt</span>.<span class="at">getElementsByTagName</span>(type)[<span class="dv">0</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb12-8" title="8">        mediaBody   <span class="op">=</span> type <span class="op">===</span> <span class="st">&#39;video&#39;</span> <span class="op">?</span> videoBody : audioBody<span class="op">,</span></a>
<a class="sourceLine" id="cb12-9" title="9">        isLocal     <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11">    <span class="co">//save data</span></a>
<a class="sourceLine" id="cb12-12" title="12">    filePlaying <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-13" title="13">        <span class="dt">url </span><span class="op">:</span> url<span class="op">,</span></a>
<a class="sourceLine" id="cb12-14" title="14">        <span class="dt">type</span><span class="op">:</span> type<span class="op">,</span></a>
<a class="sourceLine" id="cb12-15" title="15">        <span class="dt">name</span><span class="op">:</span> <span class="va">data</span>.<span class="va">params</span>.<span class="at">name</span></a>
<a class="sourceLine" id="cb12-16" title="16">    <span class="op">};</span></a>
<a class="sourceLine" id="cb12-17" title="17"></a>
<a class="sourceLine" id="cb12-18" title="18">    <span class="co">//hide body els</span></a>
<a class="sourceLine" id="cb12-19" title="19">    <span class="va">audioBody</span>.<span class="va">style</span>.<span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-20" title="20">    <span class="va">videoBody</span>.<span class="va">style</span>.<span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-21" title="21"></a>
<a class="sourceLine" id="cb12-22" title="22">    <span class="kw">var</span> animEnd <span class="op">=</span> <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-23" title="23"></a>
<a class="sourceLine" id="cb12-24" title="24">        <span class="co">//show body el</span></a>
<a class="sourceLine" id="cb12-25" title="25">        <span class="va">mediaBody</span>.<span class="va">style</span>.<span class="at">display</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-26" title="26"></a>
<a class="sourceLine" id="cb12-27" title="27">        <span class="co">//play media</span></a>
<a class="sourceLine" id="cb12-28" title="28">        <span class="va">mediaEl</span>.<span class="at">play</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb12-29" title="29"></a>
<a class="sourceLine" id="cb12-30" title="30">        <span class="co">//clear listeners</span></a>
<a class="sourceLine" id="cb12-31" title="31">        <span class="va">playerCt</span>.<span class="at">removeEventListener</span>( <span class="st">&#39;transitionend&#39;</span><span class="op">,</span> animEnd<span class="op">,</span> <span class="kw">false</span> )<span class="op">;</span></a>
<a class="sourceLine" id="cb12-32" title="32">        animEnd <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-33" title="33">    <span class="op">};</span></a>
<a class="sourceLine" id="cb12-34" title="34"></a>
<a class="sourceLine" id="cb12-35" title="35">    <span class="co">//load media</span></a>
<a class="sourceLine" id="cb12-36" title="36">    <span class="va">mediaEl</span>.<span class="at">src</span> <span class="op">=</span> url<span class="op">;</span></a>
<a class="sourceLine" id="cb12-37" title="37">    <span class="va">mediaEl</span>.<span class="at">load</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb12-38" title="38"></a>
<a class="sourceLine" id="cb12-39" title="39">    <span class="co">//animate in player</span></a>
<a class="sourceLine" id="cb12-40" title="40">    <span class="va">playerCt</span>.<span class="at">addEventListener</span>( <span class="st">&#39;transitionend&#39;</span><span class="op">,</span> animEnd<span class="op">,</span> <span class="kw">false</span> )<span class="op">;</span></a>
<a class="sourceLine" id="cb12-41" title="41">    <span class="va">playerCt</span>.<span class="va">style</span>.<span class="at">transform</span> <span class="op">=</span> <span class="st">&quot;translateY(0)&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-42" title="42"></a>
<a class="sourceLine" id="cb12-43" title="43">    <span class="co">//reply postmessage</span></a>
<a class="sourceLine" id="cb12-44" title="44">    <span class="va">data</span>.<span class="at">result</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-45" title="45">    <span class="at">sendMessage</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-46" title="46"><span class="op">}</span></a></code></pre></div>
<h2 id="save-media-offline-seven">Save media offline {: #seven }</h2>
<p>Most of the hard work to save media offline is done by the <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/lib/filer.js">filer.js library</a>. You can read more this library in <a href="http://ericbidelman.tumblr.com/post/14866798359/introducing-filer-js">Introducing filer.js</a>.</p>
<p>The process kicks off when a user selects one or more files and initiates the ‘Take offline’ action. The <a href="https://github.com/GoogleChrome/sencha-video-player-app/blob/master/app/controller/MediaExplorer.js">MediaExplorer controller</a> posts a message to <code>index.js</code> with a key ‘download-media’; <code>index.js</code> listens for this message and calls the <code>downloadMedia()</code> function to initiate the download process:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">function</span> <span class="at">downloadMedia</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">        <span class="va">DownloadProcess</span>.<span class="at">run</span>(<span class="va">data</span>.<span class="va">params</span>.<span class="at">files</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">            <span class="va">data</span>.<span class="at">result</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-4" title="4">            <span class="at">sendMessage</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-5" title="5">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="op">}</span></a></code></pre></div>
<p>The <code>DownloadProcess</code> utility method creates an xhr request to get data from the media server and waits for completion status. This initiates the onload callback which checks the received content and saves the data locally using the <code>filer.js</code> function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">filer</span>.<span class="at">write</span>(</a>
<a class="sourceLine" id="cb14-2" title="2">    saveUrl<span class="op">,</span></a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="op">{</span></a>
<a class="sourceLine" id="cb14-4" title="4">        <span class="dt">data</span><span class="op">:</span> <span class="va">Util</span>.<span class="at">arrayBufferToBlob</span>(fileArrayBuf)<span class="op">,</span></a>
<a class="sourceLine" id="cb14-5" title="5">        <span class="dt">type</span><span class="op">:</span> contentType</a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="op">},</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="kw">function</span>(fileEntry<span class="op">,</span> fileWriter) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9">        <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;file saved!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-10" title="10"></a>
<a class="sourceLine" id="cb14-11" title="11">        <span class="co">//increment downloaded</span></a>
<a class="sourceLine" id="cb14-12" title="12">        <span class="va">me</span>.<span class="at">completedFiles</span><span class="op">++;</span></a>
<a class="sourceLine" id="cb14-13" title="13"></a>
<a class="sourceLine" id="cb14-14" title="14">        <span class="co">//if reached the end, finalize the process</span></a>
<a class="sourceLine" id="cb14-15" title="15">        <span class="cf">if</span> (<span class="va">me</span>.<span class="at">completedFiles</span> <span class="op">===</span> <span class="va">me</span>.<span class="at">totalFiles</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-16" title="16"></a>
<a class="sourceLine" id="cb14-17" title="17">            <span class="at">sendMessage</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb14-18" title="18">                <span class="dt">key             </span><span class="op">:</span> <span class="st">&#39;download-progresss&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-19" title="19">                <span class="dt">totalFiles      </span><span class="op">:</span> <span class="va">me</span>.<span class="at">totalFiles</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-20" title="20">                <span class="dt">completedFiles  </span><span class="op">:</span> <span class="va">me</span>.<span class="at">completedFiles</span></a>
<a class="sourceLine" id="cb14-21" title="21">            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-22" title="22"></a>
<a class="sourceLine" id="cb14-23" title="23">            <span class="va">me</span>.<span class="at">completedFiles</span> <span class="op">=</span> <span class="va">me</span>.<span class="at">totalFiles</span> <span class="op">=</span> <span class="va">me</span>.<span class="at">percentage</span> <span class="op">=</span> <span class="va">me</span>.<span class="at">downloadedFiles</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-24" title="24">            <span class="kw">delete</span> <span class="va">me</span>.<span class="at">percentages</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-25" title="25"></a>
<a class="sourceLine" id="cb14-26" title="26">            <span class="co">//reload local</span></a>
<a class="sourceLine" id="cb14-27" title="27">            <span class="at">loadLocalFiles</span>(callback)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-28" title="28">        <span class="op">}</span></a>
<a class="sourceLine" id="cb14-29" title="29">    <span class="op">},</span></a>
<a class="sourceLine" id="cb14-30" title="30">    <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-31" title="31">        <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb14-33" title="33">)<span class="op">;</span></a></code></pre></div>
<p>When the download process is finished, <code>MediaExplorer</code> updates the media file list and the media player tree panel.</p>
</body>
</html>
