<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="dcterms.date" content="2014-10-17" />
    <title>Step 2: Import an Existing Web App</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Step 2: Import an Existing Web App</h1>
      <p class="date">2014-10-17</p>
    </header>
    <p>{% Aside ‘caution’ %}</p>
    <p>
      <strong>Important:</strong> Chrome will be removing support for Chrome
      Apps on all platforms. Chrome browser and the Chrome Web Store will
      continue to support extensions.
      <a
        href="https://blog.chromium.org/2020/08/changes-to-chrome-app-support-timeline.html"
        ><strong>Read the announcement</strong></a
      >
      and learn more about
      <a href="/apps/migration"><strong>migrating your app</strong></a
      >.
    </p>
    <p>{% endAside %}</p>
    <p>{% Aside %}</p>
    <p>
      <strong>Want to start fresh from here?</strong> Find the previous step’s
      code in the
      <a href="https://github.com/mangini/io13-codelab/archive/master.zip"
        >reference code zip</a
      >
      under <strong><em>cheat_code &gt; solution_for_step1</em></strong
      >.
    </p>
    <p>{% endAside %}</p>
    <p>In this step, you will learn:</p>
    <ul>
      <li>
        How to adapt an existing web application for the Chrome Apps platform.
      </li>
      <li>
        How to make your app scripts Content Security Policy (CSP) compliant.
      </li>
      <li>
        How to implement local storage using the
        <a
          href="/docs/extensions/reference/storage"
          title="Read &#39;chrome.storage.local&#39; in the Chrome developer docs"
          >chrome.storage.local</a
        >.
      </li>
    </ul>
    <p>
      <em>Estimated time to complete this step: 20 minutes.</em><br />
      To preview what you will complete in this step,
      <a href="#launch">jump down to the bottom of this page ↓</a>.
    </p>
    <h2 id="import-an-existing-todo-app-todomvc">
      Import an existing Todo app {: #todomvc }
    </h2>
    <p>
      As a starting point, import the
      <a href="http://todomvc.com/vanilla-examples/vanillajs/"
        >vanilla JavaScript version</a
      >
      of <a href="http://todomvc.com/">TodoMVC</a>, a common benchmark app, into
      your project.
    </p>
    <p>
      We’ve included a version of the TodoMVC app in the
      <a href="https://github.com/mangini/io13-codelab/archive/master.zip"
        >reference code zip</a
      >
      in the <strong><em>todomvc</em></strong> folder. Copy all files (including
      folders) from <em>todomvc</em> into your project folder.
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/Yfv4O1dCRrqr6XNtTBta.png”,
      alt=“Copy todomvc folder into codelab folder”, height=“515”, width=“800”
      %}
    </p>
    <p>
      You will be asked to replace <em>index.html</em>. Go ahead and accept.
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/EhTkBXH06XN95xjOreut.png”,
      alt=“Replace index.html”, height=“124”, width=“420” %}
    </p>
    <p>
      You should now have the following file structure in your application
      folder:
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/vSqNPowp4gvcBThfKYE0.png”,
      alt=“New project folder”, height=“144”, width=“593” %}
    </p>
    <p>The files highlighted in blue are from the <em>todomvc</em> folder.</p>
    <p>
      Reload your app now (<strong>right-click &gt; Reload App</strong>). You
      should see the basic UI but you won’t be able to add todos.
    </p>
    <h2 id="make-scripts-content-security-policy-csp-compliant-csp-compliance">
      Make scripts Content Security Policy (CSP) compliant {: #csp-compliance }
    </h2>
    <p>
      Open the DevTools Console (<strong
        >right-click &gt; Inspect Element</strong
      >, then select the <strong>Console</strong> tab). You will see an error
      about refusing to execute an inline script:
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/eM7GRjvPtb2BJPDVfTLF.png”,
      alt=“Todo app with CSP console log error”, height=“574”, width=“724” %}
    </p>
    <p>
      Let’s fix this error by making the app
      <a href="/apps/contentSecurityPolicy">Content Security Policy</a>
      compliant. One of the most common CSP non-compliances is caused by inline
      JavaScript. Examples of inline JavaScript include event handlers as DOM
      attributes (e.g. <code>&lt;button onclick=''&gt;</code>) and
      <code>&lt;script&gt;</code> tags with content inside the HTML.
    </p>
    <p>The solution is simple: move the inline content to a new file.</p>
    <p>
      1. Near the bottom of <strong><em>index.html</em></strong
      >, remove the inline JavaScript and instead include
      <em>js/bootstrap.js</em>:
    </p>
    <pre
      class="js/5/1-4"
    ><code>&lt;script src=&quot;bower_components/director/build/director.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  // Bootstrap app data
  window.app = {};
&lt;/script&gt;
&lt;script src=&quot;js/bootstrap.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/helpers.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/store.js&quot;&gt;&lt;/script&gt;</code></pre>
    <p>
      2. Create a file in the <strong><em>js</em></strong> folder named
      <strong><em>bootstrap.js</em></strong
      >. Move the previously inline code to be in this file:
    </p>
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// Bootstrap app data</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="va">window</span>.<span class="at">app</span> <span class="op">=</span> <span class="op">{};</span></a></code></pre>
    </div>
    <p>
      You’ll still have a non-working Todo app if you reload the app now but
      you’re getting closer.
    </p>
    <h2 id="convert-localstorage-to-chrome.storage.local-convert-storage">
      Convert localStorage to chrome.storage.local {: #convert-storage }
    </h2>
    <p>
      If you open the DevTools Console now, the previous error should be gone.
      There is a new error, however, about <code>window.localStorage</code> not
      being available:
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/TLhaB5KDe0e80De4kC88.png”,
      alt=“Todo app with localStorage console log error”, height=“589”,
      width=“723” %}
    </p>
    <p>
      Chrome Apps do not support
      <a href="http://dev.w3.org/html5/webstorage/#the-localstorage-attribute"
        ><code>localStorage</code></a
      >
      as <code>localStorage</code> is synchronous. Synchronous access to
      blocking resources (I/O) in a single-threaded runtime could make your app
      unresponsive.
    </p>
    <p>
      Chrome Apps have an equivalent API that can store objects asynchronously.
      This will help avoid the sometimes costly object-&gt;string-&gt;object
      serialization process.
    </p>
    <p>
      To address the error message in our app, you need to convert
      <code>localStorage</code> to
      <a
        href="/docs/extensions/reference/storage"
        title="Read &#39;chrome.storage.local&#39; in the Chrome developer docs"
        >chrome.storage.local</a
      >.
    </p>
    <h3 id="update-app-permissions-update-permissions">
      Update app permissions {: #update-permissions }
    </h3>
    <p>
      In order to use <code>chrome.storage.local</code>, you need to request the
      <code>storage</code> permission. In <strong><em>manifest.json</em></strong
      >, add <code>"storage"</code> to the <code>permissions</code> array:
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode json"
      ><code class="sourceCode json"><a class="sourceLine" id="cb3-1" title="1"><span class="er">&quot;permissions&quot;:</span> <span class="ot">[</span><span class="st">&quot;storage&quot;</span><span class="ot">]</span><span class="er">,</span></a></code></pre>
    </div>
    <h3 id="learn-about-local.storage.set-and-local.storage.get-get-and-set">
      Learn about local.storage.set() and local.storage.get() {: #get-and-set }
    </h3>
    <p>
      To save and retrieve todo items, you need to know about the
      <code>set()</code> and <code>get()</code> methods of the
      <code>chrome.storage</code> API.
    </p>
    <p>
      The
      <a
        href="/docs/extensions/reference/storage#method-StorageArea-set"
        title="Read &#39;chrome.storage.local.set()&#39; in the Chrome developer docs"
        >set()</a
      >
      method accepts an object of key-value pairs as its first parameter. An
      optional callback function is the second parameter. For example:
    </p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">set</span>(<span class="op">{</span><span class="dt">secretMessage</span><span class="op">:</span><span class="st">&#39;Psst!&#39;</span><span class="op">,</span><span class="dt">timeSet</span><span class="op">:</span><span class="va">Date</span>.<span class="at">now</span>()<span class="op">},</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Secret message saved&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      The
      <a
        href="/docs/extensions/reference/storage#method-StorageArea-get"
        title="Read &#39;chrome.storage.local.get()&#39; in the Chrome developer docs"
        >get()</a
      >
      method accepts an optional first parameter for the datastore keys you wish
      to retreive. A single key can be passed as a string; multiple keys can be
      arranged into an array of strings or a dictionary object.
    </p>
    <p>
      The second parameter, which is required, is a callback function. In the
      returned object, use the keys requested in the first parameter to access
      the stored values. For example:
    </p>
    <div class="sourceCode" id="cb5">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">get</span>([<span class="st">&#39;secretMessage&#39;</span><span class="op">,</span><span class="st">&#39;timeSet&#39;</span>]<span class="op">,</span> <span class="kw">function</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;The secret message:&quot;</span><span class="op">,</span> <span class="va">data</span>.<span class="at">secretMessage</span><span class="op">,</span> <span class="st">&quot;saved at:&quot;</span><span class="op">,</span> <span class="va">data</span>.<span class="at">timeSet</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      If you want to <code>get()</code> everything that is currently in
      <code>chrome.storage.local</code>, omit the first parameter:
    </p>
    <div class="sourceCode" id="cb6">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">get</span>(<span class="kw">function</span>(data) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      Unlike <code>localStorage</code>, you won’t be able to inspect locally
      stored items using the DevTools Resources panel. You can, however,
      interact with <code>chrome.storage</code> from the JavaScript Console like
      so:
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/rHYyJEoDVKnSbjAegQ4g.png”,
      alt=“Use the Console to debug chrome.storage”, height=“410”, width=“658”
      %}
    </p>
    <h3 id="preview-required-api-changes-preview-changes">
      Preview required API changes {: #preview-changes }
    </h3>
    <p>
      Most of the remaining steps in converting the Todo app are small changes
      to the API calls. Changing all the places where
      <code>localStorage</code> is currently being used, though time-consuming
      and error-prone, is required.
    </p>
    <p>{% Aside %}</p>
    <p>
      To maximize your fun with this codelab, it’ll be best if you overwrite
      your <strong><em>store.js</em></strong
      >, <strong><em>controller.js</em></strong
      >, and <strong><em>model.js</em></strong> with the ones from
      <strong><em>cheat_code/solution_for_step_2</em></strong> in the reference
      code zip.
    </p>
    <p>
      Once you’ve done that, continue reading as we’ll go over each of the
      changes individually.
    </p>
    <p>{% endAside %}</p>
    <p>
      The key differences between <code>localStorage</code> and
      <code>chrome.storage</code> come from the async nature of
      <code>chrome.storage</code>:
    </p>
    <ul>
      <li>
        <p>
          Instead of writing to <code>localStorage</code> using simple
          assignment, you need to use
          <code>chrome.storage.local.set()</code> with optional callbacks.
        </p>
        <div class="sourceCode" id="cb7">
          <pre
            class="sourceCode js"
          ><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">var</span> data <span class="op">=</span> <span class="op">{</span> <span class="dt">todos</span><span class="op">:</span> [] <span class="op">};</span></a>
<a class="sourceLine" id="cb7-2" title="2">localStorage[dbName] <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(data)<span class="op">;</span></a></code></pre>
        </div>
        <p>versus</p>
        <div class="sourceCode" id="cb8">
          <pre
            class="sourceCode js"
          ><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">var</span> storage <span class="op">=</span> <span class="op">{};</span></a>
<a class="sourceLine" id="cb8-2" title="2">storage[dbName] <span class="op">=</span> <span class="op">{</span> <span class="dt">todos</span><span class="op">:</span> [] <span class="op">};</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">set</span>( storage<span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="co">// optional callback</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
        </div>
      </li>
      <li>
        <p>
          Instead of accessing
          <code>localStorage[myStorageName]</code> directly, you need to use
          <code
            >chrome.storage.local.get(myStorageName,function(storage){...})</code
          >
          and then parse the returned <code>storage</code> object in the
          callback function.
        </p>
        <div class="sourceCode" id="cb9">
          <pre
            class="sourceCode js"
          ><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">var</span> todos <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(localStorage[dbName]).<span class="at">todos</span><span class="op">;</span></a></code></pre>
        </div>
        <p>versus</p>
        <div class="sourceCode" id="cb10">
          <pre
            class="sourceCode js"
          ><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">get</span>(dbName<span class="op">,</span> <span class="kw">function</span>(storage) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw">var</span> todos <span class="op">=</span> storage[dbName].<span class="at">todos</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
        </div>
      </li>
      <li>
        <p>
          The function <code>.bind(this)</code> is used on all callbacks to
          ensure <code>this</code> refers to the <code>this</code> of the
          <code>Store</code> prototype. (More info on bound functions can be
          found on the MDN docs:
          <a
            href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind"
            >Function.prototype.bind()</a
          >.)
        </p>
        <div class="sourceCode" id="cb11">
          <pre
            class="sourceCode js"
          ><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">function</span> <span class="at">Store</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="kw">this</span>.<span class="at">scope</span> <span class="op">=</span> <span class="st">&#39;inside Store&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">set</span>( <span class="op">{},</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="va">console</span>.<span class="at">log</span>(<span class="kw">this</span>.<span class="at">scope</span>)<span class="op">;</span> <span class="co">// outputs: &#39;undefined&#39;</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="kw">new</span> <span class="at">Store</span>()<span class="op">;</span></a></code></pre>
        </div>
        <p>versus</p>
        <pre class="js/4"><code>function Store() {
  this.scope = &#39;inside Store&#39;;
  chrome.storage.local.set( {}, function() {
    console.log(this.scope); // outputs: &#39;inside Store&#39;
  }.bind(this));
}
new Store();</code></pre>
      </li>
    </ul>
    <p>
      Keep these key differences in mind as we cover retrieving, saving, and
      removing todo items in the following sections.
    </p>
    <h3 id="retrieve-todo-items-retrieve-items">
      Retrieve todo items {: #retrieve-items }
    </h3>
    <p>Let’s update the Todo app in order to retrieve todo items:</p>
    <p>
      1. The <code>Store</code> constructor method takes care of initializing
      the Todo app with all the existing todo items from the datastore. The
      method first checks if the datastore exists. If it doesn’t, it’ll create
      an empty array of <code>todos</code> and save it to the datastore so there
      are no runtime read errors.
    </p>
    <p>
      In <strong><em>js/store.js</em></strong
      >, convert the use of <code>localStorage</code> in the constructor method
      to instead use <code>chrome.storage.local</code>:
    </p>
    <pre class="js/15-26/8-14"><code>function Store(name, callback) {
  var data;
  var dbName;

  callback = callback || function () {};

  dbName = this._dbName = name;

  if (!localStorage[dbName]) {
    data = {
      todos: []
    };
    localStorage[dbName] = JSON.stringify(data);
  }
  callback.call(this, JSON.parse(localStorage[dbName]));

  chrome.storage.local.get(dbName, function(storage) {
    if ( dbName in storage ) {
      callback.call(this, storage[dbName].todos);
    } else {
      storage = {};
      storage[dbName] = { todos: [] };
      chrome.storage.local.set( storage, function() {
        callback.call(this, storage[dbName].todos);
      }.bind(this));
    }
  }.bind(this));
}</code></pre>
    <p>
      2. The <code>find()</code> method is used when reading todos from the
      Model. The returned results change based on whether you are filtering by
      “All”, “Active”, or “Completed”.
    </p>
    <p>Convert <code>find()</code> to use <code>chrome.storage.local</code>:</p>
    <pre
      class="js/8-15/5,7,16"
    ><code>Store.prototype.find = function (query, callback) {
  if (!callback) {
    return;
  }

  var todos = JSON.parse(localStorage[this._dbName]).todos;

  callback.call(this, todos.filter(function (todo) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var todos = storage[this._dbName].todos.filter(function (todo) {
      for (var q in query) {
         return query[q] === todo[q];
      }
      });
    callback.call(this, todos);
  }.bind(this));
  }));
};</code></pre>
    <p>
      3. Similiar to <code>find()</code>, <code>findAll()</code> gets all todos
      from the Model. Convert <code>findAll()</code> to use
      <code>chrome.storage.local</code>:
    </p>
    <pre class="js/3-6/2"><code>Store.prototype.findAll = function (callback) {
  callback = callback || function () {};
  callback.call(this, JSON.parse(localStorage[this._dbName]).todos);
  chrome.storage.local.get(this._dbName, function(storage) {
    var todos = storage[this._dbName] &amp;&amp; storage[this._dbName].todos || [];
    callback.call(this, todos);
  }.bind(this));
};</code></pre>
    <h3 id="save-todos-items-save-items">Save todos items {: #save-items }</h3>
    <p>
      The current <code>save()</code> method presents a challenge. It depends on
      two async operations (get and set) that operate on the whole monolithic
      JSON storage every time. Any batch updates on more than one todo item,
      like “mark all todos as completed”, will result in a data hazard known as
      <a
        href="http://en.wikipedia.org/wiki/Hazard_(computer_architecture)#Read_After_Write_.28RAW.29"
        >Read-After-Write</a
      >. This issue wouldn’t happen if we were using a more appropriate data
      storage, like IndexedDB, but we are trying to minimize the conversion
      effort for this codelab.
    </p>
    <p>
      There are several ways to fix it so we will use this opportunity to
      slightly refactor <code>save()</code> by taking an array of todo IDs to be
      updated all at once:
    </p>
    <p>
      1. To start off, wrap everything already inside <code>save()</code> with a
      <code>chrome.storage.local.get()</code> callback:
    </p>
    <pre
      class="js/1-9"
    ><code>Store.prototype.save = function (id, updateData, callback) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var data = JSON.parse(localStorage[this._dbName]);
    // ...
    if (typeof id !== &#39;object&#39;) {
      // ...
    }else {
      // ...
    }
  }.bind(this));
};</code></pre>
    <p>
      2. Convert all the <code>localStorage</code> instances with
      <code>chrome.storage.local</code>:
    </p>
    <pre
      class="js/3,14-18,29-31/2,12-13,27-28"
    ><code>Store.prototype.save = function (id, updateData, callback) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var data = JSON.parse(localStorage[this._dbName]);
    var data = storage[this._dbName];
    var todos = data.todos;

    callback = callback || function () {};

    // If an ID was actually given, find the item and update each property
    if ( typeof id !== &#39;object&#39; ) {
      // ...

      localStorage[this._dbName] = JSON.stringify(data);
      callback.call(this, JSON.parse(localStorage[this._dbName]).todos);
      chrome.storage.local.set(storage, function() {
        chrome.storage.local.get(this._dbName, function(storage) {
          callback.call(this, storage[this._dbName].todos);
        }.bind(this));
      }.bind(this));
    } else {
      callback = updateData;

      updateData = id;

      // Generate an ID
      updateData.id = new Date().getTime();

      localStorage[this._dbName] = JSON.stringify(data);
      callback.call(this, [updateData]);
      chrome.storage.local.set(storage, function() {
        callback.call(this, [updateData]);
      }.bind(this));
    }
  }.bind(this));
};</code></pre>
    <p>
      3. Then update the logic to operate on an array instead of a single item:
    </p>
    <pre
      class="js/8-18,33"
    ><code>Store.prototype.save = function (id, updateData, callback) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var data = storage[this._dbName];
    var todos = data.todos;

    callback = callback || function () {};

    // If an ID was actually given, find the item and update each property
    if ( typeof id !== &#39;object&#39; || Array.isArray(id) ) {
      var ids = [].concat( id );
      ids.forEach(function(id) {
        for (var i = 0; i &lt; todos.length; i++) {
          if (todos[i].id == id) {
            for (var x in updateData) {
              todos[i][x] = updateData[x];
            }
          }
        }
      });

      chrome.storage.local.set(storage, function() {
        chrome.storage.local.get(this._dbName, function(storage) {
          callback.call(this, storage[this._dbName].todos);
        }.bind(this));
      }.bind(this));
    } else {
      callback = updateData;

      updateData = id;

      // Generate an ID
      updateData.id = new Date().getTime();

      todos.push(updateData);
      chrome.storage.local.set(storage, function() {
        callback.call(this, [updateData]);
      }.bind(this));
    }
  }.bind(this));
};</code></pre>
    <h3 id="mark-todo-items-as-complete-complete-items">
      Mark todo items as complete {: #complete-items }
    </h3>
    <p>
      Now that app is operating on arrays, you need to change how the app
      handles a user clicking on the
      <strong>Clear completed (#)</strong> button:
    </p>
    <p>
      1. In <strong><em>controller.js</em></strong
      >, update <code>toggleAll()</code> to call
      <code>toggleComplete()</code> only once with an array of todos instead of
      marking a todo as completed one by one. Also delete the call to
      <code>_filter()</code> since you’ll be adjusting the
      <code>toggleComplete</code> <code>_filter()</code>.
    </p>
    <pre
      class="js/7,10,12/9,15"
    ><code>Controller.prototype.toggleAll = function (e) {
  var completed = e.target.checked ? 1 : 0;
  var query = 0;
  if (completed === 0) {
    query = 1;
  }
  this.model.read({ completed: query }, function (data) {
    var ids = [];
    data.forEach(function (item) {
      this.toggleComplete(item.id, e.target, true);
      ids.push(item.id);
    }.bind(this));
    this.toggleComplete(ids, e.target, false);
  }.bind(this));

  this._filter();
};</code></pre>
    <p>
      2. Now update <code>toggleComplete()</code> to accept both a single todo
      or an array of todos. This includes moving <code>filter()</code> to be
      inside the <code>update()</code>, instead of outside.
    </p>
    <div class="sourceCode" id="cb20">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="va">Controller</span>.<span class="va">prototype</span>.<span class="at">toggleComplete</span> <span class="op">=</span> <span class="kw">function</span> (ids<span class="op">,</span> checkbox<span class="op">,</span> silent) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="kw">var</span> completed <span class="op">=</span> <span class="va">checkbox</span>.<span class="at">checked</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb20-3" title="3">  <span class="kw">this</span>.<span class="va">model</span>.<span class="at">update</span>(ids<span class="op">,</span> <span class="op">{</span> <span class="dt">completed</span><span class="op">:</span> completed <span class="op">},</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb20-4" title="4">    <span class="cf">if</span> ( <span class="va">ids</span>.<span class="at">constructor</span> <span class="op">!=</span> Array ) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-5" title="5">      ids <span class="op">=</span> [ ids ]<span class="op">;</span></a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="op">}</span></a>
<a class="sourceLine" id="cb20-7" title="7">    <span class="va">ids</span>.<span class="at">forEach</span>( <span class="kw">function</span>(id) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-8" title="8">      <span class="kw">var</span> listItem <span class="op">=</span> <span class="at">$$</span>(<span class="st">&#39;[data-id=&quot;&#39;</span> <span class="op">+</span> id <span class="op">+</span> <span class="st">&#39;&quot;]&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-9" title="9">      </a>
<a class="sourceLine" id="cb20-10" title="10">      <span class="cf">if</span> (<span class="op">!</span>listItem) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-11" title="11">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb20-12" title="12">      <span class="op">}</span></a>
<a class="sourceLine" id="cb20-13" title="13">      </a>
<a class="sourceLine" id="cb20-14" title="14">      <span class="va">listItem</span>.<span class="at">className</span> <span class="op">=</span> completed <span class="op">?</span> <span class="st">&#39;completed&#39;</span> : <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb20-15" title="15">      </a>
<a class="sourceLine" id="cb20-16" title="16">      <span class="co">// In case it was toggled from an event and not by clicking the checkbox</span></a>
<a class="sourceLine" id="cb20-17" title="17">      <span class="va">listItem</span>.<span class="at">querySelector</span>(<span class="st">&#39;input&#39;</span>).<span class="at">checked</span> <span class="op">=</span> completed<span class="op">;</span></a>
<a class="sourceLine" id="cb20-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-19" title="19"></a>
<a class="sourceLine" id="cb20-20" title="20">    <span class="cf">if</span> (<span class="op">!</span>silent) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-21" title="21">      <span class="kw">this</span>.<span class="at">_filter</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb20-22" title="22">    <span class="op">}</span></a>
<a class="sourceLine" id="cb20-23" title="23"></a>
<a class="sourceLine" id="cb20-24" title="24">  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb20-25" title="25"><span class="op">};</span></a></code></pre>
    </div>
    <h3 id="count-todo-items-count-items">
      Count todo items {: #count-items }
    </h3>
    <p>
      After switching to async storage, there is a minor bug that shows up when
      getting the number of todos. You’ll need to wrap the count operation in a
      callback function:
    </p>
    <p>
      1. In <strong><em>model.js</em></strong
      >, update <code>getCount()</code> to accept a callback:
    </p>
    <pre
      class="js/0,15/17"
    ><code>  Model.prototype.getCount = function (callback) {
  var todos = {
    active: 0,
    completed: 0,
    total: 0
  };
  this.storage.findAll(function (data) {
    data.each(function (todo) {
      if (todo.completed === 1) {
        todos.completed++;
      } else {
        todos.active++;
      }
      todos.total++;
    });
    if (callback) callback(todos);
  });
  return todos;
};</code></pre>
    <p>
      2. Back in <strong><em>controller.js</em></strong
      >, update <code>_updateCount()</code> to use the async
      <code>getCount()</code> you edited in the previous step:
    </p>
    <pre
      class="js/2-11/1"
    ><code>Controller.prototype._updateCount = function () {
  var todos = this.model.getCount();
  this.model.getCount(function(todos) {
    this.$todoItemCounter.innerHTML = this.view.itemCounter(todos.active);

    this.$clearCompleted.innerHTML = this.view.clearCompletedButton(todos.completed);
    this.$clearCompleted.style.display = todos.completed &gt; 0 ? &#39;block&#39; : &#39;none&#39;;

    this.$toggleAll.checked = todos.completed === todos.total;

    this._toggleFrame(todos);
  }.bind(this));

};</code></pre>
    <p>
      You are almost there! If you reload the app now, you will be able to
      insert new todos without any console errors.
    </p>
    <h3 id="remove-todos-items-remove-items">
      Remove todos items {: #remove-items }
    </h3>
    <p>
      Now that the app can save todo items, you’re close to being done! You
      still get errors when you attempt to <em>remove</em> todo items:
    </p>
    <p>
      {% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/PryPGnyoZVeKoHrtGT9x.png”,
      alt=“Todo app with localStorage console log error”, height=“726”,
      width=“678” %}
    </p>
    <p>
      1. In <strong><em>store.js</em></strong
      >, convert all the <code>localStorage</code> instances to use
      <code>chrome.storage.local</code>:
    </p>
    <ol type="a">
      <li>
        To start off, wrap everything already inside <code>remove()</code> with
        a <code>get()</code> callback:
      </li>
    </ol>
    <div class="sourceCode" id="cb23">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="va">Store</span>.<span class="va">prototype</span>.<span class="at">remove</span> <span class="op">=</span> <span class="kw">function</span> (id<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">get</span>(<span class="kw">this</span>.<span class="at">_dbName</span><span class="op">,</span> <span class="kw">function</span>(storage) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="kw">var</span> data <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(localStorage[<span class="kw">this</span>.<span class="at">_dbName</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb23-4" title="4">    <span class="kw">var</span> todos <span class="op">=</span> <span class="va">data</span>.<span class="at">todos</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-5" title="5"></a>
<a class="sourceLine" id="cb23-6" title="6">    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">todos</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-7" title="7">      <span class="cf">if</span> (todos[i].<span class="at">id</span> <span class="op">==</span> id) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-8" title="8">        <span class="va">todos</span>.<span class="at">splice</span>(i<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-9" title="9">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-10" title="10">      <span class="op">}</span></a>
<a class="sourceLine" id="cb23-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb23-12" title="12"></a>
<a class="sourceLine" id="cb23-13" title="13">    localStorage[<span class="kw">this</span>.<span class="at">_dbName</span>] <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-14" title="14">    <span class="va">callback</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="va">JSON</span>.<span class="at">parse</span>(localStorage[<span class="kw">this</span>.<span class="at">_dbName</span>]).<span class="at">todos</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-15" title="15">  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb23-16" title="16"><span class="op">};</span></a></code></pre>
    </div>
    <ol start="2" type="a">
      <li>Then convert the contents within the <code>get()</code> callback:</li>
    </ol>
    <pre
      class="js/3,15-17/2,13-14"
    ><code>Store.prototype.remove = function (id, callback) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var data = JSON.parse(localStorage[this._dbName]);
    var data = storage[this._dbName];
    var todos = data.todos;

    for (var i = 0; i &lt; todos.length; i++) {
      if (todos[i].id == id) {
        todos.splice(i, 1);
        break;
      }
    }

    localStorage[this._dbName] = JSON.stringify(data);
    callback.call(this, JSON.parse(localStorage[this._dbName]).todos);
    chrome.storage.local.set(storage, function() {
      callback.call(this, todos);
    }.bind(this));
  }.bind(this));
};</code></pre>
    <p>
      2. The same Read-After-Write data hazard issue previously present in the
      <code>save()</code> method is also present when removing items so you will
      need to update a few more places to allow for batch operations on a list
      of todo IDs.
    </p>
    <ol type="a">
      <li>Still in <em>store.js</em>, update <code>remove()</code>:</li>
    </ol>
    <pre
      class="js/5-13"
    ><code>Store.prototype.remove = function (id, callback) {
  chrome.storage.local.get(this._dbName, function(storage) {
    var data = storage[this._dbName];
    var todos = data.todos;

    var ids = [].concat(id);
    ids.forEach( function(id) {
      for (var i = 0; i &lt; todos.length; i++) {
        if (todos[i].id == id) {
          todos.splice(i, 1);
          break;
        }
      }
    });

    chrome.storage.local.set(storage, function() {
      callback.call(this, todos);
    }.bind(this));
  }.bind(this));
};</code></pre>
    <ol start="2" type="a">
      <li>
        In <strong><em>controller.js</em></strong
        >, change <code>removeCompletedItems()</code> to make it call
        <code>removeItem()</code> on all IDs at once:
      </li>
    </ol>
    <pre
      class="js/2,5,7/4"
    ><code>Controller.prototype.removeCompletedItems = function () {
  this.model.read({ completed: 1 }, function (data) {
    var ids = [];
    data.forEach(function (item) {
      this.removeItem(item.id);
      ids.push(item.id);
    }.bind(this));
    this.removeItem(ids);
  }.bind(this));

  this._filter();
};</code></pre>
    <ol start="3" type="a">
      <li>
        Finally, still in <em>controller.js</em>, change the
        <code>removeItem()</code> to support removing multiple items from the
        DOM at once, and move the <code>_filter()</code> call to be inside the
        callback:
      </li>
    </ol>
    <pre
      class="js/2-6/8"
    ><code>Controller.prototype.removeItem = function (id) {
  this.model.remove(id, function () {
    var ids = [].concat(id);
    ids.forEach( function(id) {
      this.$todoList.removeChild($$(&#39;[data-id=&quot;&#39; + id + &#39;&quot;]&#39;));
    }.bind(this));
    this._filter();
  }.bind(this));
  this._filter();
};</code></pre>
    <h3 id="drop-all-todo-items-drop-items">
      Drop all todo items {: #drop-items }
    </h3>
    <p>
      There is one more method in <em>store.js</em> using
      <code>localStorage</code>:
    </p>
    <div class="sourceCode" id="cb28">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="va">Store</span>.<span class="va">prototype</span>.<span class="at">drop</span> <span class="op">=</span> <span class="kw">function</span> (callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb28-2" title="2">  localStorage[<span class="kw">this</span>.<span class="at">_dbName</span>] <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(<span class="op">{</span><span class="dt">todos</span><span class="op">:</span> []<span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="va">callback</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="va">JSON</span>.<span class="at">parse</span>(localStorage[<span class="kw">this</span>.<span class="at">_dbName</span>]).<span class="at">todos</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="op">};</span></a></code></pre>
    </div>
    <p>
      This method is not being called in the current app so, if you want an
      extra challenge, try implementing it on your own. Hint: Have a look at
      <a href="/docs/extensions/reference/storage#method-StorageArea-remove"
        ><code>chrome.storage.local.clear()</code></a
      >.
    </p>
    <h2 id="launch-your-finished-todo-app-launch">
      Launch your finished Todo app {: #launch }
    </h2>
    <p>
      You are done Step 2! Reload your app and you should now have a fully
      working Chrome packaged version of TodoMVC.
    </p>
    <p>{% Aside %}</p>
    <p>
      <strong>Troubleshooting</strong><br />
      Remember to always check the DevTools Console to see if there are any
      error messages.
    </p>
    <p>{% endAside %}</p>
    <h2 id="for-more-information-recap">For more information {: #recap }</h2>
    <p>
      For more detailed information about some of the APIs introduced in this
      step, refer to:
    </p>
    <ul>
      <li>
        <a
          href="/apps/contentSecurityPolicy"
          title="Read &#39;Content Security Policy&#39; in the Chrome developer docs"
          >Content Security Policy</a
        >
        <a
          href="#csp-compliance"
          title="This feature mentioned in &#39;Make scripts Content Security Policy (CSP) compliant&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/apps/declare_permissions"
          title="Read &#39;Declare Permissions&#39; in the Chrome developer docs"
          >Declare Permissions</a
        >
        <a
          href="#update-permissions"
          title="This feature mentioned in &#39;Update app permissions&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/docs/extensions/reference/storage"
          title="Read &#39;chrome.storage&#39; in the Chrome developer docs"
          >chrome.storage</a
        >
        <a
          href="#get-and-set"
          title="This feature mentioned in &#39;Learn about local.storage.set() and local.storage.get()&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/docs/extensions/reference/storage#method-StorageArea-get"
          title="Read &#39;chrome.storage.local.get()&#39; in the Chrome developer docs"
          >chrome.storage.local.get()</a
        >
        <a
          href="#retrieve-items"
          title="This feature mentioned in &#39;Retrieve todos items&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/docs/extensions/reference/storage#method-StorageArea-set"
          title="Read &#39;chrome.storage.local.set()&#39; in the Chrome developer docs"
          >chrome.storage.local.set()</a
        >
        <a
          href="#save-items"
          title="This feature mentioned in &#39;Save todos items&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/docs/extensions/reference/storage#method-StorageArea-remove"
          title="Read &#39;chrome.storage.local.remove()&#39; in the Chrome developer docs"
          >chrome.storage.local.remove()</a
        >
        <a
          href="#remove-items"
          title="This feature mentioned in &#39;Remove todos items&#39;"
          >↑</a
        >
      </li>
      <li>
        <a
          href="/docs/extensions/reference/storage#method-StorageArea-remove"
          title="Read &#39;chrome.storage.local.clear()&#39; in the Chrome developer docs"
          >chrome.storage.local.clear()</a
        >
        <a
          href="#remove-items"
          title="This feature mentioned in &#39;Drop all todo items&#39;"
          >↑</a
        >
      </li>
    </ul>
    <p>
      Ready to continue onto the next step? Go to
      <a href="../app_codelab_alarms"
        >Step 3 - Add alarms and notifications »</a
      >
    </p>
  </body>
</html>
