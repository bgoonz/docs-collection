<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2012-11-16" />
  <title>Build Apps with AngularJS</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Build Apps with AngularJS</h1>
<p class="date">2012-11-16</p>
</header>
<p>{% Aside ‘caution’ %}</p>
<p><strong>Important:</strong> Chrome will be removing support for Chrome Apps on all platforms. Chrome browser and the Chrome Web Store will continue to support extensions. <a href="https://blog.chromium.org/2020/08/changes-to-chrome-app-support-timeline.html"><strong>Read the announcement</strong></a> and learn more about <a href="/apps/migration"><strong>migrating your app</strong></a>.</p>
<p>{% endAside %}</p>
<p>This guide gets you started building Chrome Apps with the <a href="https://angularjs.org/">AngularJS</a> MVC framework. To illustrate Angular in action, we’ll be referencing an actual app built using the framework, the Google Drive Uploader. The <a href="https://github.com/GoogleChrome/chrome-app-samples/tree/master/samples/gdrive">source code</a> is available on GitHub.</p>
<h2 id="about-the-app-first">About the app {: #first }</h2>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/UbxLa9XoyBXX4BgqNqeJ.png”, alt=“Google Drive Uploader”, height=“680”, width=“580” %}</p>
<p>The Google Drive Uploader allows users to quickly view and interact with files stored in their Google Drive account as well as upload new files using the <a href="https://www.html5rocks.com/en/tutorials/dnd/basics/">HTML Drag and Drop APIs</a>. It’s a great example of building an app which talks to one of <a href="https://developers.google.com/apis-explorer/#p/">Google’s APIs</a>; in this case, the Google Drive API.</p>
<p>{% Aside %}</p>
<p><strong>Note:</strong> You can also build apps which talk to 3rd party APIs/services that are OAuth2-enabled. See <a href="/docs/extensions/reference/app_identity#non">non-Google Account authentication</a>.</p>
<p>{% endAside %}</p>
<p>The Uploader uses OAuth2 to access the user’s data. The <a href="/docs/extensions/reference/identity">chrome.identity API</a> handles fetching an OAuth token for the logged-in user, so the hard work is done for us! Once we have a long-lived access token, the apps uses the <a href="https://developers.google.com/drive/get-started">Google Drive API</a> to access the user’s data.</p>
<p>Key features this app uses:</p>
<ul>
<li>AngularJS’s autodetection for <a href="/docs/extensions/reference/contentSecurityPolicy">CSP</a></li>
<li>Render a list of files fetched from the <a href="https://developers.google.com/drive/get-started">Google Drive API</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/file/filesystem/">HTML5 Filesystem API</a> to store file icons offline</li>
<li><a href="http://www.html5rocks.com/en/tutorials/dnd/basics/">HTML5 Drag and Drop</a> for importing/uploading new files from the desktop</li>
<li>XHR2 to load images, cross-domain</li>
<li><a href="/docs/extensions/reference/app_identity">chrome.identity API</a> for OAuth authorization</li>
<li>Chromeless frames to define the app’s own navbar look and feel</li>
</ul>
<h2 id="creating-the-manifest-second">Creating the manifest {: #second }</h2>
<p>All Chrome Apps require a <code>manifest.json</code> file which contains the information Chrome needs to launch the app. The manifest contains relevant metadata and lists any special permissions the app needs to run.</p>
<p>A stripped down version of the Uploader’s manifest looks like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Google Drive Uploader&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="dt">&quot;manifest_version&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="dt">&quot;oauth2&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="dt">&quot;client_id&quot;</span><span class="fu">:</span> <span class="st">&quot;665859454684.apps.googleusercontent.com&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="dt">&quot;scopes&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb1-8" title="8">      <span class="st">&quot;https://www.googleapis.com/auth/drive&quot;</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb1-11" title="11"> <span class="er">...</span></a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="dt">&quot;permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="st">&quot;https://docs.google.com/feeds/&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="st">&quot;https://docs.googleusercontent.com/&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="st">&quot;https://spreadsheets.google.com/feeds/&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="st">&quot;https://ssl.gstatic.com/&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="st">&quot;https://www.googleapis.com/&quot;</span></a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="ot">]</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="fu">}</span></a></code></pre></div>
<p>The most important parts of this manifest are the “oauth2” and “permissions” sections.</p>
<p>The “oauth2” section defines the required parameters by OAuth2 to do its magic. To create a “client_id”, follow the instructions in <a href="/docs/extensions/reference/app_identity#client_id">Get your client id</a>. The “scopes” list the authorization scopes that the OAuth token will be valid for (for example, the APIs the app wants to access).</p>
<p>The “permissions” section includes URLs that the app will access via XHR2. The URL prefixes are required in order for Chrome to know which cross-domain requests to allow.</p>
<h2 id="creating-the-event-page-three">Creating the event page {: #three }</h2>
<p>All Chrome Apps require a background script/page to launch the app and respond to system events.</p>
<p>In its <a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/js/background.js">background.js</a> script, Drive Uploader opens a 500x600px window to the main page. It also specifies a minimum height and width for the window so the content doesn’t become too crunched:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">chrome</span>.<span class="va">app</span>.<span class="va">runtime</span>.<span class="va">onLaunched</span>.<span class="at">addListener</span>(<span class="kw">function</span>(launchData) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="va">chrome</span>.<span class="va">app</span>.<span class="va">window</span>.<span class="at">create</span>(<span class="st">&#39;../main.html&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="dt">id</span><span class="op">:</span> <span class="st">&quot;GDriveExample&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="dt">bounds</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">      <span class="dt">width</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-6" title="6">      <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="dt">minWidth</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="dt">minHeight</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="dt">frame</span><span class="op">:</span> <span class="st">&#39;none&#39;</span></a>
<a class="sourceLine" id="cb2-11" title="11">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The window is created as a chromeless window (frame: ‘none’). By default, windows render with the OS’s default close/expand/minimize bar:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/ZCIALlecZwMUv7LW77hO.png”, alt=“Google Drive Uploader with no frame”, height=“75”, width=“508” %}</p>
<p>The Uploader uses <code>frame: 'none'</code> to render the window as a “blank slate” and creates a custom close button in <code>main.html</code>:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/IDJ8RCDPcatsI60AQEni.png”, alt=“Google Drive Uploader with custom frame”, height=“50”, width=“504” %}</p>
<p>The entire navigational area is wrapped in a <nav> (see next section). To declutter the app a bit, the custom close button is hidden until the user interacts with this the area:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">&lt;style&gt;</span></a>
<a class="sourceLine" id="cb3-2" title="2">nav<span class="in">:hover</span> <span class="pp">#close-button</span> {</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="kw">opacity</span>: <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" title="4">}</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="pp">#close-button</span> {</a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="kw">float</span>: <span class="dv">right</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="kw">padding</span>: <span class="dv">0</span> <span class="dv">5</span><span class="dt">px</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">5</span><span class="dt">px</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="kw">font-weight</span>: <span class="dv">bold</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="kw">opacity</span>: <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-11" title="11">  <span class="kw">transition</span>: <span class="dv">all</span> <span class="dv">0.3</span><span class="dt">s</span> <span class="dv">ease-in-out</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" title="12">}</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">&lt;/style&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;btn&quot;</span><span class="ot"> id=</span><span class="st">&quot;close-button&quot;</span><span class="ot"> title=</span><span class="st">&quot;Close&quot;</span><span class="kw">&gt;</span>x<span class="kw">&lt;/button&gt;</span></a></code></pre></div>
<p>In <a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/js/app.js">app.js</a>, this button is hooked up to <code>window.close()</code>.</p>
<h2 id="designing-the-app-the-angular-way-four">Designing the app the Angular way {: #four }</h2>
<p>Angular is an MVC framework, so we need to define the app in such a way that a model, view, and controller logically fall out of it. Luckily, this is trivial when using Angular.</p>
<p>The View is the easiest, so let’s start there.</p>
<h3 id="creating-the-view-view">Creating the view {: #view }</h3>
<p><a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/main.html">main.html</a> is the “V” in MVC; where we define HTML templates to render data into. In Angular, templates are simple blocks of HTML with some special sauce.</p>
Ultimately we want to display the user’s list of files. For that, a simple
<ul>
<p>list makes sense. The Angular bits are highlighted in bold:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="kw">&lt;li</span><span class="ot"> data-ng-repeat=</span><span class="st">&quot;doc in docs&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="kw">&lt;img</span><span class="ot"> data-ng-src=</span><span class="st">&quot;{{doc.icon}}&quot;</span><span class="kw">&gt;</span> <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{doc.alternateLink}}&quot;</span><span class="kw">&gt;</span>{{doc.title}}<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb5-4" title="4">{{doc.size}}</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;date&quot;</span><span class="kw">&gt;</span>{{doc.updatedDate}}<span class="kw">&lt;/span&gt;</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">&lt;/ul&gt;</span></a></code></pre></div>
This reads exactly as it looks: stamp out an
<li>
<p>for every doc in our data model “docs”. Each item contains a file icon, link to open the file on the web, and last updatedDate.</p>
<p>{% Aside %}</p>
<p><strong>Note:</strong> To make the template valid HTML, we’re using <code>data-*</code> attributes for Angular’s <a href="https://docs.angularjs.org/api/ng.directive:ngRepeat">ngRepeat</a> iterator, but you don’t have to. You could easily write the repeater as <code>&lt;li ng-repeat="doc in docs"&gt;</code>.</p>
<p>{% endAside %}</p>
Next, we need to tell Angular which controller will oversee this template’s rendering. For that, we use the <a href="https://docs.angularjs.org/api/ng.directive:ngController">ngController</a> directive to tell the <code>DocsController</code> to have reign over the template
<body>
<p>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">&lt;body</span><span class="ot"> data-ng-controller=</span><span class="st">&quot;DocsController&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">&lt;section</span><span class="ot"> id=</span><span class="st">&quot;main&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">&lt;li</span><span class="ot"> data-ng-repeat=</span><span class="st">&quot;doc in docs&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb6-5" title="5">      <span class="kw">&lt;img</span><span class="ot"> data-ng-src=</span><span class="st">&quot;{{doc.icon}}&quot;</span><span class="kw">&gt;</span> <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{doc.alternateLink}}&quot;</span><span class="kw">&gt;</span>{{doc.title}}<span class="kw">&lt;/a&gt;</span> {{doc.size}}</a>
<a class="sourceLine" id="cb6-6" title="6">      <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;date&quot;</span><span class="kw">&gt;</span>{{doc.updatedDate}}<span class="kw">&lt;/span&gt;</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="kw">&lt;/ul&gt;</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="kw">&lt;/section&gt;</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="kw">&lt;/body&gt;</span></a></code></pre></div>
<p>Keep in mind, what you don’t see here is us hooking up event listeners or properties for data binding. Angular is doing that heavy lifting for us!</p>
The last step is to make Angular light up our templates. The typical way to do that is include the <a href="https://docs.angularjs.org/api/ng.directive:ngApp">ngApp</a> directive all the way up on
<html>
<p>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">&lt;html</span><span class="ot"> data-ng-app=</span><span class="st">&quot;gDriveApp&quot;</span><span class="kw">&gt;</span></a></code></pre></div>
<p>You could also scope the app down to a smaller portion of the page if you wanted to. We only have one controller in this app, but if we were to add more later, putting <a href="https://docs.angularjs.org/api/ng.directive:ngApp">ngApp</a> on the topmost element makes the entire page Angular-ready.</p>
<p>The final product for <code>main.html</code> looks something like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">&lt;html</span><span class="ot"> data-ng-app=</span><span class="st">&quot;gDriveApp&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb8-3" title="3">  …</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="kw">&lt;base</span><span class="ot"> target=</span><span class="st">&quot;_blank&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="kw">&lt;body</span><span class="ot"> data-ng-controller=</span><span class="st">&quot;DocsController&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="kw">&lt;section</span><span class="ot"> id=</span><span class="st">&quot;main&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-9" title="9">  <span class="kw">&lt;nav&gt;</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="kw">&lt;h2&gt;</span>Google Drive Uploader<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;btn&quot;</span><span class="ot"> data-ng-click=</span><span class="st">&quot;fetchDocs()&quot;</span><span class="kw">&gt;</span>Refresh<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;btn&quot;</span><span class="ot"> id=</span><span class="st">&quot;close-button&quot;</span><span class="ot"> title=</span><span class="st">&quot;Close&quot;</span><span class="kw">&gt;&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb8-13" title="13">  <span class="kw">&lt;/nav&gt;</span></a>
<a class="sourceLine" id="cb8-14" title="14">  <span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb8-15" title="15">    <span class="kw">&lt;li</span><span class="ot"> data-ng-repeat=</span><span class="st">&quot;doc in docs&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-16" title="16">      <span class="kw">&lt;img</span><span class="ot"> data-ng-src=</span><span class="st">&quot;{{doc.icon}}&quot;</span><span class="kw">&gt;</span> <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;{{doc.alternateLink}}&quot;</span><span class="kw">&gt;</span>{{doc.title}}<span class="kw">&lt;/a&gt;</span>  {{doc.size}}</a>
<a class="sourceLine" id="cb8-17" title="17">      <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;date&quot;</span><span class="kw">&gt;</span>{{doc.updatedDate}}<span class="kw">&lt;/span&gt;</span></a>
<a class="sourceLine" id="cb8-18" title="18">    <span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb8-19" title="19">  <span class="kw">&lt;/ul&gt;</span></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="kw">&lt;/section&gt;</span></a></code></pre></div>
<h3 id="a-word-on-content-security-policy-csp">A word on Content Security Policy {: #csp }</h3>
<p>Unlike many other JS MVC frameworks, Angular v1.1.0+ requires no tweaks to work within a strict <a href="/docs/extensions/reference/contentSecurityPolicy">CSP</a>. It just works, out of the box!</p>
<p>However, if you’re using an older version of Angular between v1.0.1 and v1.1.0, you’ll need tell Angular to run in a “content security mode”. This is done by including the <a href="http://docs.angularjs.org/api/ng.directive:ngCsp">ngCsp</a> directive alongside <a href="http://docs.angularjs.org/api/ng.directive:ngApp">ngApp</a>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">&lt;html</span><span class="ot"> data-ng-app data-ng-csp</span><span class="kw">&gt;</span></a></code></pre></div>
<h3 id="handling-authorization-authorization">Handling authorization {: #authorization }</h3>
<p>The data model isn’t generated by the app itself. Instead, it’s populated from an external API (the Google Drive API). Thus, there’s a bit of work necessary in order to populate the app’s data.</p>
<p>Before we can make an API request, we need to fetch an OAuth token for the user’s Google Account. For that, we’ve created a method to wrap the call to <code>chrome.identity.getAuthToken()</code> and store the <code>accessToken</code>, which we can reuse for future calls to the Drive API.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">GDocs</span>.<span class="va">prototype</span>.<span class="at">auth</span> <span class="op">=</span> <span class="kw">function</span>(opt_callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="va">chrome</span>.<span class="va">identity</span>.<span class="at">getAuthToken</span>(<span class="op">{</span><span class="dt">interactive</span><span class="op">:</span> <span class="kw">false</span><span class="op">},</span> <span class="kw">function</span>(token) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-4" title="4">      <span class="cf">if</span> (token) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">        <span class="kw">this</span>.<span class="at">accessToken</span> <span class="op">=</span> token<span class="op">;</span></a>
<a class="sourceLine" id="cb10-6" title="6">        opt_callback <span class="op">&amp;&amp;</span> <span class="at">opt_callback</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-7" title="7">      <span class="op">}</span></a>
<a class="sourceLine" id="cb10-8" title="8">    <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb10-9" title="9">  <span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>{% Aside %}</p>
<p><strong>Note:</strong> Passing the optional callback gives us the flexibility of knowing when the OAuth token is ready.</p>
<p>{% endAside %}</p>
<p>{% Aside %}</p>
<p><strong>Note:</strong> To simplify things a bit, we’ve created a library, <a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/js/gdocs.js">gdocs.js</a> to handle API tasks.</p>
<p>{% endAside %}</p>
<p>Once we have the token, it’s time to make requests against the Drive API and populate the model.</p>
<h3 id="skeleton-controller-skeleton">Skeleton controller {: #skeleton }</h3>
The “model” for the Uploader is a simple array (called docs) of objects that will get rendered as those
<li>
<p>s in the template:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">var</span> gDriveApp <span class="op">=</span> <span class="va">angular</span>.<span class="at">module</span>(<span class="st">&#39;gDriveApp&#39;</span><span class="op">,</span> [])<span class="op">;</span></a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="va">gDriveApp</span>.<span class="at">factory</span>(<span class="st">&#39;gdocs&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="kw">var</span> gdocs <span class="op">=</span> <span class="kw">new</span> <span class="at">GDocs</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="cf">return</span> gdocs<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="kw">function</span> <span class="at">DocsController</span>($scope<span class="op">,</span> $http<span class="op">,</span> gdocs) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="va">$scope</span>.<span class="at">docs</span> <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="va">$scope</span>.<span class="at">fetchDocs</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-12" title="12">     ...</a>
<a class="sourceLine" id="cb11-13" title="13">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-14" title="14"></a>
<a class="sourceLine" id="cb11-15" title="15">  <span class="co">// Invoke on ctor call. Fetch docs after we have the oauth token.</span></a>
<a class="sourceLine" id="cb11-16" title="16">  <span class="va">gdocs</span>.<span class="at">auth</span>(<span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-17" title="17">    <span class="va">$scope</span>.<span class="at">fetchDocs</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-18" title="18">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-19" title="19"></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="op">}</span></a></code></pre></div>
<p>Notice that <code>gdocs.auth()</code> is called as part of the DocsController constructor. When Angular’s internals create the controller, we’re insured to have a fresh OAuth token waiting for the user.</p>
<h2 id="fetching-data-five">Fetching data {: #five }</h2>
<p>Template laid out. Controller scaffolded. OAuth token in hand. Now what?</p>
<p>It’s time to define the main controller method, <code>fetchDocs()</code>. It’s the workhorse of the controller, responsible for requesting the user’s files and filing the docs array with data from API responses.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="va">$scope</span>.<span class="at">fetchDocs</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="va">$scope</span>.<span class="at">docs</span> <span class="op">=</span> []<span class="op">;</span> <span class="co">// First, clear out any old results</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="co">// Response handler that doesn&#39;t cache file icons.</span></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="kw">var</span> successCallback <span class="op">=</span> <span class="kw">function</span>(resp<span class="op">,</span> status<span class="op">,</span> headers<span class="op">,</span> config) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="kw">var</span> docs <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">var</span> totalEntries <span class="op">=</span> <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">length</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-8" title="8"></a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">forEach</span>(<span class="kw">function</span>(entry<span class="op">,</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-10" title="10">      <span class="kw">var</span> doc <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-11" title="11">        <span class="dt">title</span><span class="op">:</span> <span class="va">entry</span>.<span class="va">title</span>.<span class="at">$t</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-12" title="12">        <span class="dt">updatedDate</span><span class="op">:</span> <span class="va">Util</span>.<span class="at">formatDate</span>(<span class="va">entry</span>.<span class="va">updated</span>.<span class="at">$t</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-13" title="13">        <span class="dt">updatedDateFull</span><span class="op">:</span> <span class="va">entry</span>.<span class="va">updated</span>.<span class="at">$t</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-14" title="14">        <span class="dt">icon</span><span class="op">:</span> <span class="va">gdocs</span>.<span class="at">getLink</span>(<span class="va">entry</span>.<span class="at">link</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-15" title="15">                            <span class="st">&#39;http://schemas.google.com/docs/2007#icon&#39;</span>).<span class="at">href</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-16" title="16">        <span class="dt">alternateLink</span><span class="op">:</span> <span class="va">gdocs</span>.<span class="at">getLink</span>(<span class="va">entry</span>.<span class="at">link</span><span class="op">,</span> <span class="st">&#39;alternate&#39;</span>).<span class="at">href</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-17" title="17">        <span class="dt">size</span><span class="op">:</span> <span class="va">entry</span>.<span class="at">docs$size</span> <span class="op">?</span> <span class="st">&#39;( &#39;</span> <span class="op">+</span> <span class="va">entry</span>.<span class="va">docs$size</span>.<span class="at">$t</span> <span class="op">+</span> <span class="st">&#39; bytes)&#39;</span> : <span class="kw">null</span></a>
<a class="sourceLine" id="cb12-18" title="18">      <span class="op">};</span></a>
<a class="sourceLine" id="cb12-19" title="19"></a>
<a class="sourceLine" id="cb12-20" title="20">      <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">push</span>(doc)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-21" title="21"></a>
<a class="sourceLine" id="cb12-22" title="22">      <span class="co">// Only sort when last entry is seen.</span></a>
<a class="sourceLine" id="cb12-23" title="23">      <span class="cf">if</span> (totalEntries <span class="op">-</span> <span class="dv">1</span> <span class="op">==</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-24" title="24">        <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">sort</span>(<span class="va">Util</span>.<span class="at">sortByDate</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-25" title="25">      <span class="op">}</span></a>
<a class="sourceLine" id="cb12-26" title="26">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-27" title="27">  <span class="op">};</span></a>
<a class="sourceLine" id="cb12-28" title="28"></a>
<a class="sourceLine" id="cb12-29" title="29">  <span class="kw">var</span> config <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-30" title="30">    <span class="dt">params</span><span class="op">:</span> <span class="op">{</span><span class="st">&#39;alt&#39;</span><span class="op">:</span> <span class="st">&#39;json&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb12-31" title="31">    <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-32" title="32">      <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="st">&#39;Bearer &#39;</span> <span class="op">+</span> <span class="va">gdocs</span>.<span class="at">accessToken</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-33" title="33">      <span class="st">&#39;GData-Version&#39;</span><span class="op">:</span> <span class="st">&#39;3.0&#39;</span></a>
<a class="sourceLine" id="cb12-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-35" title="35">  <span class="op">};</span></a>
<a class="sourceLine" id="cb12-36" title="36"></a>
<a class="sourceLine" id="cb12-37" title="37">  <span class="va">$http</span>.<span class="at">get</span>(<span class="va">gdocs</span>.<span class="at">DOCLIST_FEED</span><span class="op">,</span> config).<span class="at">success</span>(successCallback)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-38" title="38"><span class="op">};</span></a></code></pre></div>
<p><code>fetchDocs()</code> uses Angular’s <code>$http</code> service to retrieve the main feed over XHR. The oauth access token is included in the <code>Authorization</code> header along with other custom headers and parameters.</p>
<p>The <code>successCallback</code> processes the API response and creates a new doc object for each entry in the feed.</p>
<p>If you run <code>fetchDocs()</code> right now, everything works and the list of files shows up:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/qF2CspUxWPlHgeukJOkp.png”, alt=“Fetched list of files in Google Drive Uploader”, height=“680”, width=“580” %}</p>
<p>Woot!</p>
<p>Wait,…we’re missing those neat file icons. What gives? A quick check of the console shows a bunch of CSP-related errors:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/F7b9iaRTKc8cTHN9OEOE.png”, alt=“CSP errors in developer console”, height=“71”, width=“800” %}</p>
<p>The reason is that we’re trying to set the icons <code>img.src</code> to external URLs. This violates CSP. For example: <code>https://ssl.gstatic.com/docs/doclist/images/icon_10_document_list.png</code>. To fix this, we need to pull in these remote assets locally to the app.</p>
<h3 id="importing-remote-image-assets-import">Importing remote image assets {: #import }</h3>
<p>For CSP to stop yelling at us, we use XHR2 to “import” the file icons as Blobs, then set the <code>img.src</code> to a <code>blob: URL</code> created by the app.</p>
<p>Here’s the updated <code>successCallback</code> with the added XHR code:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">var</span> successCallback <span class="op">=</span> <span class="kw">function</span>(resp<span class="op">,</span> status<span class="op">,</span> headers<span class="op">,</span> config) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="kw">var</span> docs <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="kw">var</span> totalEntries <span class="op">=</span> <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">length</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">forEach</span>(<span class="kw">function</span>(entry<span class="op">,</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="kw">var</span> doc <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-7" title="7">      ...</a>
<a class="sourceLine" id="cb13-8" title="8">    <span class="op">};</span></a>
<a class="sourceLine" id="cb13-9" title="9"></a>
<a class="sourceLine" id="cb13-10" title="10">    <span class="va">$http</span>.<span class="at">get</span>(<span class="va">doc</span>.<span class="at">icon</span><span class="op">,</span> <span class="op">{</span><span class="dt">responseType</span><span class="op">:</span> <span class="st">&#39;blob&#39;</span><span class="op">}</span>).<span class="at">success</span>(<span class="kw">function</span>(blob) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-11" title="11">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Fetched icon via XHR&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-12" title="12"></a>
<a class="sourceLine" id="cb13-13" title="13">      <span class="va">blob</span>.<span class="at">name</span> <span class="op">=</span> <span class="va">doc</span>.<span class="at">iconFilename</span><span class="op">;</span> <span class="co">// Add icon filename to blob.</span></a>
<a class="sourceLine" id="cb13-14" title="14"></a>
<a class="sourceLine" id="cb13-15" title="15">      <span class="at">writeFile</span>(blob)<span class="op">;</span> <span class="co">// Write is async, but that&#39;s ok.</span></a>
<a class="sourceLine" id="cb13-16" title="16"></a>
<a class="sourceLine" id="cb13-17" title="17">      <span class="va">doc</span>.<span class="at">icon</span> <span class="op">=</span> <span class="va">window</span>.<span class="va">URL</span>.<span class="at">createObjectURL</span>(blob)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-18" title="18"></a>
<a class="sourceLine" id="cb13-19" title="19">      <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">push</span>(doc)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-20" title="20"></a>
<a class="sourceLine" id="cb13-21" title="21">      <span class="co">// Only sort when last entry is seen.</span></a>
<a class="sourceLine" id="cb13-22" title="22">      <span class="cf">if</span> (totalEntries <span class="op">-</span> <span class="dv">1</span> <span class="op">==</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-23" title="23">        <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">sort</span>(<span class="va">Util</span>.<span class="at">sortByDate</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-24" title="24">      <span class="op">}</span></a>
<a class="sourceLine" id="cb13-25" title="25">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-26" title="26">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-27" title="27"><span class="op">};</span></a></code></pre></div>
<p>Now that CSP is happy with us again, we get nice file icons:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/GP49lYVzl4rPNt868wtn.png”, alt=“Google Drive Uploader with file icons”, height=“680”, width=“580” %}</p>
<h2 id="going-offline-caching-external-resources-six">Going offline: caching external resources {: #six }</h2>
<p>The obvious optimization that needs to be made: not make 100s of XHR requests for each file icon on every call to <code>fetchDocs()</code>. Verify this in the Developer Tools console by pressing the “Refresh” button several times. Every time, n images are fetched:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/YJgMcn00xGOFjNvWz9K1.png”, alt=“Console log 65: Fetched icon via XHR”, height=“19”, width=“180” %}</p>
<p>Let’s modify <code>successCallback</code> to add a caching layer. The additions are highlighted in bold:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">$scope</span>.<span class="at">fetchDocs</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  ...</a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="co">// Response handler that caches file icons in the filesystem API.</span></a>
<a class="sourceLine" id="cb14-5" title="5">  <span class="kw">var</span> successCallbackWithFsCaching <span class="op">=</span> <span class="kw">function</span>(resp<span class="op">,</span> status<span class="op">,</span> headers<span class="op">,</span> config) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="kw">var</span> docs <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="kw">var</span> totalEntries <span class="op">=</span> <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">length</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="va">resp</span>.<span class="va">feed</span>.<span class="va">entry</span>.<span class="at">forEach</span>(<span class="kw">function</span>(entry<span class="op">,</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-10" title="10">      <span class="kw">var</span> doc <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-11" title="11">        ...</a>
<a class="sourceLine" id="cb14-12" title="12">      <span class="op">};</span></a>
<a class="sourceLine" id="cb14-13" title="13"></a>
<a class="sourceLine" id="cb14-14" title="14">      <span class="co">// &#39;https://ssl.gstatic.com/doc_icon_128.png&#39; -&gt; &#39;doc_icon_128.png&#39;</span></a>
<a class="sourceLine" id="cb14-15" title="15">      <span class="va">doc</span>.<span class="at">iconFilename</span> <span class="op">=</span> <span class="va">doc</span>.<span class="va">icon</span>.<span class="at">substring</span>(<span class="va">doc</span>.<span class="va">icon</span>.<span class="at">lastIndexOf</span>(<span class="st">&#39;/&#39;</span>) <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-16" title="16"></a>
<a class="sourceLine" id="cb14-17" title="17">      <span class="co">// If file exists, it we&#39;ll get back a FileEntry for the filesystem URL.</span></a>
<a class="sourceLine" id="cb14-18" title="18">      <span class="co">// Otherwise, the error callback will fire and we need to XHR it in and</span></a>
<a class="sourceLine" id="cb14-19" title="19">      <span class="co">// write it to the FS.</span></a>
<a class="sourceLine" id="cb14-20" title="20">      <span class="kw">var</span> fsURL <span class="op">=</span> <span class="va">fs</span>.<span class="va">root</span>.<span class="at">toURL</span>() <span class="op">+</span> FOLDERNAME <span class="op">+</span> <span class="st">&#39;/&#39;</span> <span class="op">+</span> <span class="va">doc</span>.<span class="at">iconFilename</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-21" title="21">      <span class="va">window</span>.<span class="at">webkitResolveLocalFileSystemURL</span>(fsURL<span class="op">,</span> <span class="kw">function</span>(entry) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-22" title="22">        <span class="va">doc</span>.<span class="at">icon</span> <span class="op">=</span> <span class="va">entry</span>.<span class="at">toURL</span>()<span class="op">;</span> <span class="co">// should be === to fsURL, but whatevs.</span></a>
<a class="sourceLine" id="cb14-23" title="23"></a>
<a class="sourceLine" id="cb14-24" title="24">        <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">push</span>(doc)<span class="op">;</span> <span class="co">// add doc to model.</span></a>
<a class="sourceLine" id="cb14-25" title="25"></a>
<a class="sourceLine" id="cb14-26" title="26">        <span class="co">// Only want to sort and call $apply() when we have all entries.</span></a>
<a class="sourceLine" id="cb14-27" title="27">        <span class="cf">if</span> (totalEntries <span class="op">-</span> <span class="dv">1</span> <span class="op">==</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-28" title="28">          <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">sort</span>(<span class="va">Util</span>.<span class="at">sortByDate</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-29" title="29">          <span class="va">$scope</span>.<span class="at">$apply</span>(<span class="kw">function</span>($scope) <span class="op">{}</span>)<span class="op">;</span> <span class="co">// Inform angular that we made changes.</span></a>
<a class="sourceLine" id="cb14-30" title="30">        <span class="op">}</span></a>
<a class="sourceLine" id="cb14-31" title="31"></a>
<a class="sourceLine" id="cb14-32" title="32">      <span class="op">},</span> <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-33" title="33">        <span class="co">// Error: file doesn&#39;t exist yet. XHR it in and write it to the FS.</span></a>
<a class="sourceLine" id="cb14-34" title="34"></a>
<a class="sourceLine" id="cb14-35" title="35">        <span class="va">$http</span>.<span class="at">get</span>(<span class="va">doc</span>.<span class="at">icon</span><span class="op">,</span> <span class="op">{</span><span class="dt">responseType</span><span class="op">:</span> <span class="st">&#39;blob&#39;</span><span class="op">}</span>).<span class="at">success</span>(<span class="kw">function</span>(blob) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-36" title="36">          <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Fetched icon via XHR&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-37" title="37"></a>
<a class="sourceLine" id="cb14-38" title="38">          <span class="va">blob</span>.<span class="at">name</span> <span class="op">=</span> <span class="va">doc</span>.<span class="at">iconFilename</span><span class="op">;</span> <span class="co">// Add icon filename to blob.</span></a>
<a class="sourceLine" id="cb14-39" title="39"></a>
<a class="sourceLine" id="cb14-40" title="40">          <span class="at">writeFile</span>(blob)<span class="op">;</span> <span class="co">// Write is async, but that&#39;s ok.</span></a>
<a class="sourceLine" id="cb14-41" title="41"></a>
<a class="sourceLine" id="cb14-42" title="42">          <span class="va">doc</span>.<span class="at">icon</span> <span class="op">=</span> <span class="va">window</span>.<span class="va">URL</span>.<span class="at">createObjectURL</span>(blob)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-43" title="43"></a>
<a class="sourceLine" id="cb14-44" title="44">          <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">push</span>(doc)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-45" title="45"></a>
<a class="sourceLine" id="cb14-46" title="46">          <span class="co">// Only sort when last entry is seen.</span></a>
<a class="sourceLine" id="cb14-47" title="47">          <span class="cf">if</span> (totalEntries <span class="op">-</span> <span class="dv">1</span> <span class="op">==</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-48" title="48">            <span class="va">$scope</span>.<span class="va">docs</span>.<span class="at">sort</span>(<span class="va">Util</span>.<span class="at">sortByDate</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-49" title="49">          <span class="op">}</span></a>
<a class="sourceLine" id="cb14-50" title="50">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-51" title="51"></a>
<a class="sourceLine" id="cb14-52" title="52">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-53" title="53">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-54" title="54">  <span class="op">};</span></a>
<a class="sourceLine" id="cb14-55" title="55"></a>
<a class="sourceLine" id="cb14-56" title="56">  <span class="kw">var</span> config <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-57" title="57">    ...</a>
<a class="sourceLine" id="cb14-58" title="58">  <span class="op">};</span></a>
<a class="sourceLine" id="cb14-59" title="59"></a>
<a class="sourceLine" id="cb14-60" title="60">  <span class="va">$http</span>.<span class="at">get</span>(<span class="va">gdocs</span>.<span class="at">DOCLIST_FEED</span><span class="op">,</span> config).<span class="at">success</span>(successCallbackWithFsCaching)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-61" title="61"><span class="op">};</span></a></code></pre></div>
<p>Notice that in the <code>webkitResolveLocalFileSystemURL()</code> callback we’re calling <code>$scope.$apply()</code> when the last entry is seen. Normally calling <code>$apply()</code> isn’t necessary. Angular detects changes to data models automagically. However in our case, we have an addition layer of asynchronous callback that Angular isn’t aware of. We must explicitly tell Angular when our model has been updated.</p>
<p>On first run, the icons won’t be in the HTML5 Filesystem and the calls to <code>window.webkitResolveLocalFileSystemURL()</code> will result in its error callback being invoked. For that case, we can reuse the technique from before and fetch the images. The only difference this time is that each blob is written to the filesystem (see <a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/js/app.js#L27">writeFile()</a>). The console verifies this behavior:</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/tS8fAphl6h2v9706ndyV.png”, alt=“Console log 100: Write completed”, height=“42”, width=“800” %}</p>
<p>Upon next run (or press of the “Refresh” button), the URL passed to <code>webkitResolveLocalFileSystemURL()</code> exists because the file has been previously cached. The app sets the <code>doc.icon</code> to the file’s <code>filesystem: URL</code> and avoids making the costly XHR for the icon.</p>
<h2 id="drag-and-drop-uploading-seven">Drag and drop uploading {: #seven }</h2>
<p>An uploader app is false advertising if it can’t upload files!</p>
<p><a href="https://github.com/GoogleChrome/chrome-app-samples/blob/master/samples/gdrive/js/app.js#L52">app.js</a> handles this feature by implementing a small library around HTML5 Drag and Drop called <code>DnDFileController</code>. It gives the ability to drag in files from the desktop and have them uploaded to Google Drive.</p>
<p>Simply adding this to the gdocs service does the job:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="va">gDriveApp</span>.<span class="at">factory</span>(<span class="st">&#39;gdocs&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="kw">var</span> gdocs <span class="op">=</span> <span class="kw">new</span> <span class="at">GDocs</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="kw">var</span> dnd <span class="op">=</span> <span class="kw">new</span> <span class="at">DnDFileController</span>(<span class="st">&#39;body&#39;</span><span class="op">,</span> <span class="kw">function</span>(files) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-5" title="5">    <span class="kw">var</span> $scope <span class="op">=</span> <span class="va">angular</span>.<span class="at">element</span>(<span class="kw">this</span>).<span class="at">scope</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="va">Util</span>.<span class="at">toArray</span>(files).<span class="at">forEach</span>(<span class="kw">function</span>(file<span class="op">,</span> i) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-7" title="7">      <span class="va">gdocs</span>.<span class="at">upload</span>(file<span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb15-8" title="8">        <span class="va">$scope</span>.<span class="at">fetchDocs</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb15-9" title="9">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-10" title="10">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-11" title="11">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-12" title="12"></a>
<a class="sourceLine" id="cb15-13" title="13">  <span class="cf">return</span> gdocs<span class="op">;</span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
</body>
</html>
