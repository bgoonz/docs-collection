<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2014-10-17" />
  <title>Step 5: Add Images From the Web</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Step 5: Add Images From the Web</h1>
<p class="date">2014-10-17</p>
</header>
<p>{% Aside ‘caution’ %}</p>
<p><strong>Important:</strong> Chrome will be removing support for Chrome Apps on all platforms. Chrome browser and the Chrome Web Store will continue to support extensions. <a href="https://blog.chromium.org/2020/08/changes-to-chrome-app-support-timeline.html"><strong>Read the announcement</strong></a> and learn more about <a href="/apps/migration"><strong>migrating your app</strong></a>.</p>
<p>{% endAside %}</p>
<p>{% Aside %}</p>
<p><strong>Want to start fresh from here?</strong> Find the previous step’s code in the <a href="https://github.com/mangini/io13-codelab/archive/master.zip">reference code zip</a> under <strong><em>cheat_code &gt; solution_for_step4</em></strong>.</p>
<p>{% endAside %}</p>
<p>In this step, you will learn:</p>
<ul>
<li>How to load resources from outside your app and add them to the DOM through XHR and ObjectURLs.</li>
</ul>
<p><em>Estimated time to complete this step: 20 minutes.</em><br />
To preview what you will complete in this step, <a href="#launch">jump down to the bottom of this page ↓</a>.</p>
<h2 id="how-csp-affects-the-use-of-external-resources-csp-compliance">How CSP affects the use of external resources {: #csp-compliance }</h2>
<p>The Chrome Apps platform forces your app to be fully compliant with Content Security Policies (CSP). You can’t directly load DOM resources like images, fonts, and CSS from outside of your Chrome App package.</p>
<p>If you want to show an external image in your app, you need to request it via <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a>, transform it into a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a>, and create an <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL.createObjectURL">ObjectURL</a>. This <code>ObjectURL</code> can be added to the DOM because it refers to an in-memory item in the context of the app.</p>
<h2 id="show-thumbnail-images-for-todo-items-show-images">Show thumbnail images for todo items {: #show-images }</h2>
<p>Let’s change our app to look for image URLs in a todo item. If the URL looks like an image (for example, ends with .png, .jpg, .svg, or .gif), apply the process mentioned above in order to show an image thumbnail next to the URL.</p>
<h3 id="update-permissions-update-permissions">Update permissions {: #update-permissions }</h3>
<p>In a Chrome App, you can make XMLHttpRequest calls to any URL as long as you specify its domain in the manifest. Since you won’t know beforehand what image URL the user will type, ask permission to make requests to <code>"&lt;all_urls&gt;"</code>.</p>
<p>In <strong><em>manifest.json</em></strong>, request the “<all_urls>” permission:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="er">&quot;permissions&quot;:</span> <span class="ot">[</span><span class="st">&quot;storage&quot;</span><span class="ot">,</span> <span class="st">&quot;alarms&quot;</span><span class="ot">,</span> <span class="st">&quot;notifications&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-2" title="2">                <span class="st">&quot;webview&quot;</span><span class="ot">,</span> <span class="st">&quot;&lt;all_urls&gt;&quot;</span><span class="ot">]</span><span class="er">,</span></a></code></pre></div>
<h3 id="create-and-clear-objecturls-object-urls">Create and clear ObjectURLs {: #object-urls }</h3>
<p>In <strong><em>controller.js</em></strong>, add a <code>_createObjectURL()</code> method to create ObjectURLs from a Blob:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">Controller</span>.<span class="va">prototype</span>.<span class="at">_createObjectURL</span> <span class="op">=</span> <span class="kw">function</span>(blob) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="kw">var</span> objURL <span class="op">=</span> <span class="va">URL</span>.<span class="at">createObjectURL</span>(blob)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="kw">this</span>.<span class="at">objectURLs</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">objectURLs</span> <span class="op">||</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="kw">this</span>.<span class="va">objectURLs</span>.<span class="at">push</span>(objURL)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="cf">return</span> objURL<span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="op">};</span></a></code></pre></div>
<p>ObjectURLs hold memory, so when you no longer need the ObjectURL, you should revoke them. Add this <code>_clearObjectURL()</code> method to <em>controller.js</em> to handle that:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">Controller</span>.<span class="va">prototype</span>.<span class="at">_clearObjectURL</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">objectURLs</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="kw">this</span>.<span class="va">objectURLs</span>.<span class="at">forEach</span>(<span class="kw">function</span>(objURL) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">      <span class="va">URL</span>.<span class="at">revokeObjectURL</span>(objURL)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="kw">this</span>.<span class="at">objectURLs</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="op">};</span></a></code></pre></div>
<h3 id="make-a-xhr-request-xhr">Make a XHR request {: #xhr }</h3>
<p>Add a <code>_requestRemoteImageAndAppend()</code> method to execute a XMLHttpRequest on a given image URL:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">Controller</span>.<span class="va">prototype</span>.<span class="at">_requestRemoteImageAndAppend</span> <span class="op">=</span> <span class="kw">function</span>(imageUrl<span class="op">,</span> element) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="kw">var</span> xhr <span class="op">=</span> <span class="kw">new</span> <span class="at">XMLHttpRequest</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="va">xhr</span>.<span class="at">open</span>(<span class="st">&#39;GET&#39;</span><span class="op">,</span> imageUrl)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="va">xhr</span>.<span class="at">responseType</span> <span class="op">=</span> <span class="st">&#39;blob&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="va">xhr</span>.<span class="at">onload</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">var</span> img <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&#39;img&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="va">img</span>.<span class="at">setAttribute</span>(<span class="st">&#39;data-src&#39;</span><span class="op">,</span> imageUrl)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="va">img</span>.<span class="at">className</span> <span class="op">=</span> <span class="st">&#39;icon&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="kw">var</span> objURL <span class="op">=</span> <span class="kw">this</span>.<span class="at">_createObjectURL</span>(<span class="va">xhr</span>.<span class="at">response</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="va">img</span>.<span class="at">setAttribute</span>(<span class="st">&#39;src&#39;</span><span class="op">,</span> objURL)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="va">element</span>.<span class="at">appendChild</span>(img)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="op">}</span>.<span class="at">bind</span>(<span class="kw">this</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="va">xhr</span>.<span class="at">send</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="op">};</span></a></code></pre></div>
<p>On XHR load, this method creates an <code>ObjectURL</code> from the XHR’s response, and adds an <code>&lt;img&gt;</code> element with this <code>ObjectURL</code> to the DOM.</p>
<h3 id="parse-for-image-urls-in-todo-items-parse-urls">Parse for image URLs in todo items {: #parse-urls }</h3>
<p>Now add a <code>_parseForImageURLs()</code> method that finds all links not yet processed and checks them for images. For each URL that looks like an image, execute <code>_requestRemoteImageAndAppend()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="va">Controller</span>.<span class="va">prototype</span>.<span class="at">_parseForImageURLs</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="co">// remove old blobs to avoid memory leak:</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="kw">this</span>.<span class="at">_clearObjectURL</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="kw">var</span> links <span class="op">=</span> <span class="kw">this</span>.<span class="va">$todoList</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;a[data-src]:not(.thumbnail)&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="kw">var</span> re <span class="op">=</span> <span class="ss">/</span><span class="sc">\.(</span><span class="ss">png</span><span class="sc">|</span><span class="ss">jpg</span><span class="sc">|</span><span class="ss">jpeg</span><span class="sc">|</span><span class="ss">svg</span><span class="sc">|</span><span class="ss">gif</span><span class="sc">)$</span><span class="ss">/</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span><span class="va">links</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">var</span> url <span class="op">=</span> links[i].<span class="at">getAttribute</span>(<span class="st">&#39;data-src&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="cf">if</span> (<span class="va">re</span>.<span class="at">test</span>(url)) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-9" title="9">      links[i].<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;thumbnail&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-10" title="10">      <span class="kw">this</span>.<span class="at">_requestRemoteImageAndAppend</span>(url<span class="op">,</span> links[i])<span class="op">;</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="op">};</span></a></code></pre></div>
<h3 id="render-thumbnails-in-the-todo-list-render-thumbnails">Render thumbnails in the todo list {: #render-thumbnails }</h3>
<p>Now call <code>_parseForImageURLs()</code> from <code>showAll()</code>, <code>showActive()</code>, and <code>showCompleted()</code>:</p>
<pre class="js/7,17,27"><code>/**
 * An event to fire on load. Will get all items and display them in the
 * todo-list
 */
Controller.prototype.showAll = function () {
  this.model.read(function (data) {
    this.$todoList.innerHTML = this._parseForURLs(this.view.show(data));
    this._parseForImageURLs();
  }.bind(this));
};

/**
 * Renders all active tasks
 */
Controller.prototype.showActive = function () {
  this.model.read({ completed: 0 }, function (data) {
    this.$todoList.innerHTML = this._parseForURLs(this.view.show(data));
    this._parseForImageURLs();
  }.bind(this));
};

/**
 * Renders all completed tasks
 */
Controller.prototype.showCompleted = function () {
  this.model.read({ completed: 1 }, function (data) {
    this.$todoList.innerHTML = this._parseForURLs(this.view.show(data));
    this._parseForImageURLs();
  }.bind(this));
};</code></pre>
<p>Do the same for <code>editItem()</code>:</p>
<pre class="js/7"><code>Controller.prototype.editItem = function (id, label) {
  ...
  var onSaveHandler = function () {
    ...
    if (value.length &amp;&amp; !discarding) {
      ...
      label.innerHTML = this._parseForURLs(value);
      this._parseForImageURLs();
    } else if (value.length === 0) {
  ...
}</code></pre>
<h3 id="constrain-the-displayed-image-dimensions-css">Constrain the displayed image dimensions {: #css }</h3>
<p>Finally, in <strong><em>bower_components/todomvc-common/base.css</em></strong>, add a CSS rule to limit the size of the image:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode css"><code class="sourceCode css"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">.thumbnail</span> img<span class="ex">[data-src]</span> {</a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="kw">max-width</span>: <span class="dv">100</span><span class="dt">px</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="kw">max-height</span>: <span class="dv">28</span><span class="dt">px</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-4" title="4">}</a></code></pre></div>
<h2 id="launch-your-finished-todo-app-launch">Launch your finished Todo app {: #launch }</h2>
<p>You are done Step 5! Reload your app and add a todo item with a URL to an image hosted online. Some URLs you could use: <strong>http://goo.gl/nqHMF#.jpg</strong> or <strong>http://goo.gl/HPBGR#.png</strong>.</p>
<p>{% Aside %}</p>
<p><strong>Tip</strong>: For real-world situations, when you need to control offline cache and dozens of simultaneous resource downloads, we have created <a href="https://github.com/GoogleChrome/apps-resource-loader#readme">a helper library</a> to handle some common use cases.</p>
<p>{% endAside %}</p>
<h2 id="for-more-information-recap">For more information {: #recap }</h2>
<p>For more detailed information about some of the APIs introduced in this step, refer to:</p>
<ul>
<li><a href="/apps/contentSecurityPolicy" title="Read &#39;Content Security Policy&#39; in the Chrome developer docs">Content Security Policy</a> <a href="#csp-compliance" title="This feature mentioned in &#39;Learn how CSP affects the use of external web resources&#39;">↑</a></li>
<li><a href="/apps/declare_permissions" title="Read &#39;Declare Permissions&#39; in the Chrome developer docs">Declare Permissions</a> <a href="#update-permissions" title="This feature mentioned in &#39;Update permissions&#39;">↑</a></li>
</ul>
<p>Ready to continue onto the next step? Go to <a href="../app_codelab_filesystem">Step 6 - Export todos to the filesystem »</a></p>
</body>
</html>
