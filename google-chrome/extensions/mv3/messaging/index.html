<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2012-09-18" />
  <title>Message passing</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Message passing</h1>
<p class="date">2012-09-18</p>
</header>
<p>Since content scripts run in the context of a web page and not the extension, they often need some way of communicating with the rest of the extension. For example, an RSS reader extension might use content scripts to detect the presence of an RSS feed on a page, then notify the background page in order to display a page action icon for that page.</p>
<p>Communication between extensions and their content scripts works by using message passing. Either side can listen for messages sent from the other end, and respond on the same channel. A message can contain any valid JSON object (null, boolean, number, string, array, or object). There is a simple API for <a href="#simple">one-time requests</a> and a more complex API that allows you to have <a href="#connect">long-lived connections</a> for exchanging multiple messages with a shared context. It is also possible to send a message to another extension if you know its ID, which is covered in the <a href="#external">cross-extension messages</a> section.</p>
<h2 id="simple-one-time-requests-simple">Simple one-time requests {: #simple }</h2>
<p>If you only need to send a single message to another part of your extension (and optionally get a response back), you should use the simplified <a href="/docs/extensions/reference/runtime#method-sendMessage">runtime.sendMessage</a> or <a href="/docs/extensions/reference/tabs#method-sendMessage">tabs.sendMessage</a>. This lets you send a one-time JSON-serializable message from a content script to extension, or vice versa, respectively. An optional callback parameter allows you to handle the response from the other side, if there is one.</p>
<p>Sending a request from a content script looks like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(<span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">response</span>.<span class="at">farewell</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Sending a request from the extension to a content script looks very similar, except that you need to specify which tab to send it to. This example demonstrates sending a message to the content script in the selected tab.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">query</span>(<span class="op">{</span><span class="dt">active</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">currentWindow</span><span class="op">:</span> <span class="kw">true</span><span class="op">},</span> <span class="kw">function</span>(tabs) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">sendMessage</span>(tabs[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span> <span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">response</span>.<span class="at">farewell</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>On the receiving end, you need to set up an <a href="/docs/extensions/reference/runtime#event-onMessage">runtime.onMessage</a> event listener to handle the message. This looks the same from a content script or extension page.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>(</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw">function</span>(request<span class="op">,</span> sender<span class="op">,</span> sendResponse) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">sender</span>.<span class="at">tab</span> <span class="op">?</span></a>
<a class="sourceLine" id="cb3-4" title="4">                <span class="st">&quot;from a content script:&quot;</span> <span class="op">+</span> <span class="va">sender</span>.<span class="va">tab</span>.<span class="at">url</span> :</a>
<a class="sourceLine" id="cb3-5" title="5">                <span class="st">&quot;from the extension&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="cf">if</span> (<span class="va">request</span>.<span class="at">greeting</span> <span class="op">===</span> <span class="st">&quot;hello&quot;</span>)</a>
<a class="sourceLine" id="cb3-7" title="7">      <span class="at">sendResponse</span>(<span class="op">{</span><span class="dt">farewell</span><span class="op">:</span> <span class="st">&quot;goodbye&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-9" title="9">)<span class="op">;</span></a></code></pre></div>
<p>In the above example, <code>sendResponse</code> was called synchronously. If you want to asynchronously use <code>sendResponse</code>, add <code>return true;</code> to the <code>onMessage</code> event handler.</p>
<div class="aside aside--note">
<b>Note:</b> If multiple pages are listening for onMessage events, only the first to call sendResponse() for a particular event will succeed in sending the response. All other responses to that event will be ignored.
</div>
<div class="aside aside--note">
<b>Note:</b> The <code>sendResponse</code> callback is only valid if used synchronously, or if the event handler returns <code>true</code> to indicate that it will respond asynchronously. The <code>sendMessage</code> function’s callback will be invoked automatically if no handlers return true or if the <code>sendResponse</code> callback is garbage-collected.
</div>
<h2 id="long-lived-connections-connect">Long-lived connections {: #connect }</h2>
<p>Sometimes it’s useful to have a conversation that lasts longer than a single request and response. In this case, you can open a long-lived channel from your content script to an extension page, or vice versa, using <a href="/docs/extensions/reference/runtime#method-connect">runtime.connect</a> or <a href="/docs/extensions/reference/tabs#method-connect">tabs.connect</a>, respectively. The channel can optionally have a name, allowing you to distinguish between different types of connections.</p>
<p>One use case might be an automatic form fill extension. The content script could open a channel to the extension page for a particular login, and send a message to the extension for each input element on the page to request the form data to fill in. The shared connection allows the extension to keep shared state linking the several messages coming from the content script.</p>
<p>When establishing a connection, each end is given a <a href="/docs/extensions/reference/runtime#type-Port">runtime.Port</a> object which is used for sending and receiving messages through that connection.</p>
<p>Here is how you open a channel from a content script, and send and listen for messages:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">var</span> port <span class="op">=</span> <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">connect</span>(<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">&quot;knockknock&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">joke</span><span class="op">:</span> <span class="st">&quot;Knock knock&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="va">port</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>(<span class="kw">function</span>(msg) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">question</span> <span class="op">===</span> <span class="st">&quot;Who&#39;s there?&quot;</span>)</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">answer</span><span class="op">:</span> <span class="st">&quot;Madame&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="cf">else</span> <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">question</span> <span class="op">===</span> <span class="st">&quot;Madame who?&quot;</span>)</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">answer</span><span class="op">:</span> <span class="st">&quot;Madame... Bovary&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Sending a request from the extension to a content script looks very similar, except that you need to specify which tab to connect to. Simply replace the call to connect in the above example with <a href="/docs/extensions/reference/tabs#method-connect">tabs.connect</a>.</p>
<p>In order to handle incoming connections, you need to set up a <a href="/docs/extensions/reference/runtime#event-onConnect">runtime.onConnect</a> event listener. This looks the same from a content script or an extension page. When another part of your extension calls “connect()”, this event is fired, along with the <a href="/docs/extensions/reference/runtime#type-Port">runtime.Port</a> object you can use to send and receive messages through the connection. Here’s what it looks like to respond to incoming connections:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onConnect</span>.<span class="at">addListener</span>(<span class="kw">function</span>(port) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="va">console</span>.<span class="at">assert</span>(<span class="va">port</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&quot;knockknock&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="va">port</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>(<span class="kw">function</span>(msg) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">joke</span> <span class="op">===</span> <span class="st">&quot;Knock knock&quot;</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">      <span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">question</span><span class="op">:</span> <span class="st">&quot;Who&#39;s there?&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="cf">else</span> <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">answer</span> <span class="op">===</span> <span class="st">&quot;Madame&quot;</span>)</a>
<a class="sourceLine" id="cb5-7" title="7">      <span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">question</span><span class="op">:</span> <span class="st">&quot;Madame who?&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="cf">else</span> <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">answer</span> <span class="op">===</span> <span class="st">&quot;Madame... Bovary&quot;</span>)</a>
<a class="sourceLine" id="cb5-9" title="9">      <span class="va">port</span>.<span class="at">postMessage</span>(<span class="op">{</span><span class="dt">question</span><span class="op">:</span> <span class="st">&quot;I don&#39;t get it.&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="port-lifetime-port-lifetime">Port lifetime {: #port-lifetime }</h3>
<p>Ports are designed as a two-way communication method between different parts of the extension, where a (top-level) frame is viewed as the smallest part. Upon calling <a href="/docs/extensions/reference/tabs#method-connect">tabs.connect</a>, <a href="/docs/extensions/reference/runtime#method-connect">runtime.connect</a> or <a href="/docs/extensions/reference/runtime#method-connectNative">runtime.connectNative</a>, a <a href="/docs/extensions/reference/runtime#type-Port">Port</a> is created. This port can immediately be used for sending messages to the other end via <a href="/docs/extensions/reference/runtime#property-Port-postMessage">postMessage</a>.</p>
<p>If there are multiple frames in a tab, calling <a href="/docs/extensions/reference/tabs#method-connect">tabs.connect</a> results in multiple invocations of the <a href="/docs/extensions/reference/runtime#event-onConnect">runtime.onConnect</a> event (once for each frame in the tab). Similarly, if <a href="/docs/extensions/reference/runtime#method-connect">runtime.connect</a> is used, then the onConnect event may be fired multiple times (once for every frame in the extension process).</p>
<p>You may want to find out when a connection is closed, for example if you are maintaining separate state for each open port. For this you can listen to the <a href="/docs/extensions/reference/runtime#property-Port-onDisconnect">runtime.Port.onDisconnect</a> event. This event is fired when there are no valid ports at the other side of the channel. This happens in the following situations:</p>
<ul>
<li>There are no listeners for <a href="/docs/extensions/reference/runtime#event-onConnect">runtime.onConnect</a> at the other end.</li>
<li>The tab containing the port is unloaded (e.g. if the tab is navigated).</li>
<li>The frame from where <code>connect</code> was called has unloaded.</li>
<li>All frames that received the port (via <a href="/docs/extensions/reference/runtime#event-onConnect">runtime.onConnect</a>) have unloaded.</li>
<li><a href="/docs/extensions/reference/runtime#property-Port-disconnect">runtime.Port.disconnect</a> is called by <em>the other end</em>. Note that if a <code>connect</code> call results in multiple ports at the receiver’s end, and <code>disconnect()</code> is called on any of these ports, then the <code>onDisconnect</code> event is only fired at the port of the sender, and not at the other ports.</li>
</ul>
<h2 id="cross-extension-messaging-external">Cross-extension messaging {: #external }</h2>
<p>In addition to sending messages between different components in your extension, you can use the messaging API to communicate with other extensions. This lets you expose a public API that other extensions can take advantage of.</p>
<p>Listening for incoming requests and connections is similar to the internal case, except you use the <a href="/docs/extensions/reference/runtime#event-onMessageExternal">runtime.onMessageExternal</a> or <a href="/docs/extensions/reference/runtime#event-onConnectExternal">runtime.onConnectExternal</a> methods. Here’s an example of each:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// For simple requests:</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessageExternal</span>.<span class="at">addListener</span>(</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="kw">function</span>(request<span class="op">,</span> sender<span class="op">,</span> sendResponse) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="cf">if</span> (<span class="va">sender</span>.<span class="at">id</span> <span class="op">===</span> blocklistedExtension)</a>
<a class="sourceLine" id="cb6-5" title="5">      <span class="cf">return</span><span class="op">;</span>  <span class="co">// don&#39;t allow this extension access</span></a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="cf">else</span> <span class="cf">if</span> (<span class="va">request</span>.<span class="at">getTargetData</span>)</a>
<a class="sourceLine" id="cb6-7" title="7">      <span class="at">sendResponse</span>(<span class="op">{</span><span class="dt">targetData</span><span class="op">:</span> targetData<span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="cf">else</span> <span class="cf">if</span> (<span class="va">request</span>.<span class="at">activateLasers</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-9" title="9">      <span class="kw">var</span> success <span class="op">=</span> <span class="at">activateLasers</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb6-10" title="10">      <span class="at">sendResponse</span>(<span class="op">{</span><span class="dt">activateLasers</span><span class="op">:</span> success<span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-13" title="13"></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">// For long-lived connections:</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onConnectExternal</span>.<span class="at">addListener</span>(<span class="kw">function</span>(port) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-16" title="16">  <span class="va">port</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>(<span class="kw">function</span>(msg) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-17" title="17">    <span class="co">// See other examples for sample onMessage handlers.</span></a>
<a class="sourceLine" id="cb6-18" title="18">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Likewise, sending a message to another extension is similar to sending one within your extension. The only difference is that you must pass the ID of the extension you want to communicate with. For example:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// The ID of the extension we want to talk to.</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">var</span> laserExtensionId <span class="op">=</span> <span class="st">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">// Make a simple request:</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(laserExtensionId<span class="op">,</span> <span class="op">{</span><span class="dt">getTargetData</span><span class="op">:</span> <span class="kw">true</span><span class="op">},</span></a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="cf">if</span> (<span class="at">targetInRange</span>(<span class="va">response</span>.<span class="at">targetData</span>))</a>
<a class="sourceLine" id="cb7-8" title="8">      <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(laserExtensionId<span class="op">,</span> <span class="op">{</span><span class="dt">activateLasers</span><span class="op">:</span> <span class="kw">true</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-10" title="10">)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-11" title="11"></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">// Start a long-running conversation:</span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="kw">var</span> port <span class="op">=</span> <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">connect</span>(laserExtensionId)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="va">port</span>.<span class="at">postMessage</span>(...)<span class="op">;</span></a></code></pre></div>
<h2 id="sending-messages-from-web-pages-external-webpage">Sending messages from web pages {: #external-webpage }</h2>
<p>Similar to <a href="#external">cross-extension messaging</a>, your extension can receive and respond to messages from regular web pages. To use this feature, you must first specify in your manifest.json which websites you want to communicate with. For example:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb8-1" title="1"><span class="er">&quot;externally_connectable&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="dt">&quot;matches&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;https://*.example.com/*&quot;</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>This will expose the messaging API to any page which matches the URL patterns you specify. The URL pattern must contain at least a <a href="https://en.wikipedia.org/wiki/Second-level_domain">second-level domain</a> - that is, hostname patterns like “*”, “*.com”, “*.co.uk”, and “*.appspot.com” are prohibited. From the web page, use the <a href="/docs/extensions/reference/runtime#method-sendMessage">runtime.sendMessage</a> or <a href="/docs/extensions/reference/runtime#method-connect">runtime.connect</a> APIs to send a message to a specific app or extension. For example:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// The ID of the extension we want to talk to.</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">var</span> editorExtensionId <span class="op">=</span> <span class="st">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">// Make a simple request:</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(editorExtensionId<span class="op">,</span> <span class="op">{</span><span class="dt">openUrlInEditor</span><span class="op">:</span> url<span class="op">},</span></a>
<a class="sourceLine" id="cb9-6" title="6">  <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="cf">if</span> (<span class="op">!</span><span class="va">response</span>.<span class="at">success</span>)</a>
<a class="sourceLine" id="cb9-8" title="8">      <span class="at">handleError</span>(url)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>From your extension, you may listen to messages from web pages via the <a href="/docs/extensions/reference/runtime#event-onMessageExternal">runtime.onMessageExternal</a> or <a href="/docs/extensions/reference/runtime#event-onConnectExternal">runtime.onConnectExternal</a> APIs, similar to <a href="#external">cross-extension messaging</a>. Only the web page can initiate a connection. Here is an example:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessageExternal</span>.<span class="at">addListener</span>(</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw">function</span>(request<span class="op">,</span> sender<span class="op">,</span> sendResponse) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="cf">if</span> (<span class="va">sender</span>.<span class="at">url</span> <span class="op">===</span> blocklistedWebsite)</a>
<a class="sourceLine" id="cb10-4" title="4">      <span class="cf">return</span><span class="op">;</span>  <span class="co">// don&#39;t allow this web page access</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="cf">if</span> (<span class="va">request</span>.<span class="at">openUrlInEditor</span>)</a>
<a class="sourceLine" id="cb10-6" title="6">      <span class="at">openUrl</span>(<span class="va">request</span>.<span class="at">openUrlInEditor</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="native-messaging-native-messaging">Native messaging {: #native-messaging }</h2>
<p>Extensions <a href="/docs/apps/nativeMessaging/#native-messaging-client">can exchange messages</a> with native applications that are registered as a <a href="/docs/apps/nativeMessaging/#native-messaging-host">native messaging host</a>. To learn more about this feature, see <a href="/docs/apps/nativeMessaging/">Native messaging</a>.</p>
<h2 id="security-considerations-security-considerations">Security considerations {: #security-considerations }</h2>
<h3 id="content-scripts-are-less-trustworthy-content-scripts-are-less-trustworthy">Content scripts are less trustworthy {: #content-scripts-are-less-trustworthy }</h3>
<p><a href="/docs/extensions/mv3/security#content_scripts">Content scripts are less trustworthy</a> than the extension background page (e.g., a malicious web page might be able to compromise the renderer process where the content scripts run). Assume that messages from a content script might have been crafted by an attacker and make sure to <a href="/docs/extensions/mv3/security#sanitize">validate and sanitize all input</a>. Assume any data sent to the content script might leak to the web page. Limit the scope of privileged actions that can be triggered by messages received from content scripts.</p>
<h3 id="cross-site-scripting-cross-site-scripting">Cross-site scripting {: #cross-site-scripting }</h3>
<p>When receiving a message from a content script or another extension, your scripts should be careful not to fall victim to <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a>. This advice applies to scripts running inside the extension background page as well as to content scripts running inside other web origins. Specifically, avoid using dangerous APIs such as the ones below:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">sendMessage</span>(<span class="va">tab</span>.<span class="at">id</span><span class="op">,</span> <span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="co">// </span><span class="al">WARNING</span><span class="co">! Might be evaluating an evil script!</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="kw">var</span> resp <span class="op">=</span> <span class="at">eval</span>(<span class="st">&quot;(&quot;</span> <span class="op">+</span> <span class="va">response</span>.<span class="at">farewell</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">sendMessage</span>(<span class="va">tab</span>.<span class="at">id</span><span class="op">,</span> <span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="co">// </span><span class="al">WARNING</span><span class="co">! Might be injecting a malicious script!</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;resp&quot;</span>).<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">response</span>.<span class="at">farewell</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Instead, prefer safer APIs that do not run scripts:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">sendMessage</span>(<span class="va">tab</span>.<span class="at">id</span><span class="op">,</span> <span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="co">// JSON.parse does not evaluate the attacker&#39;s scripts.</span></a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="kw">var</span> resp <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">response</span>.<span class="at">farewell</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">sendMessage</span>(<span class="va">tab</span>.<span class="at">id</span><span class="op">,</span> <span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">},</span> <span class="kw">function</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="co">// innerText does not let the attacker inject HTML elements.</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;resp&quot;</span>).<span class="at">innerText</span> <span class="op">=</span> <span class="va">response</span>.<span class="at">farewell</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="examples-examples">Examples {: #examples }</h2>
<p>You can find simple examples of communication via messages in the <a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/master/mv2-archive/api/messaging">examples/api/messaging</a> directory.</p>
</body>
</html>
