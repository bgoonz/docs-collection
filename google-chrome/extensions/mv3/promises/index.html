<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-03-26" />
  <title>Using promises</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Using promises</h1>
<p class="date">2021-03-26</p>
</header>
<p>Many extension API methods support promises. This document explains how to use promises when calling these methods.</p>
<p>{% Aside “key-term” %} A <em>promise</em> is a JavaScript object that represents the eventual outcome of an asynchronous operation. For more about promises and their use, see the MDN documentation on <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">using promises</a>. {% endAside %}</p>
<h2 id="introduction">Introduction</h2>
<p>Promises were introduced into Chrome not long after they were included in the ES6 specification. They are an important feature of modern JavaScript, providing benefits such as:</p>
<ul>
<li>Streamlined error handling</li>
<li>Coding in a synchronous style for invoking asynchronous functions</li>
<li>A simple “fork and join” syntax for invoking concurrent functions</li>
</ul>
<p>Extensions can use promises beginning with Manifest V3. Many API methods support promises, and we are progressively adding promise support to additional API methods.</p>
<p>{% Aside ‘gotchas’ %} Promises are not available for extensions using Manifest V2, and are not available on all API methods. {% endAside %}</p>
<p>Promises can and should be used in many circumstances. However, there are times (for example, event listeners) when a promise won’t work and a callback is more appropriate. Methods that support promises also support callbacks to provide backwards compatibility.</p>
<h2 id="can-i-use-promises">Can I use promises?</h2>
<p>You can and should use promises in your extension code, where a promise is available and appropriate to the use case.</p>
<p>Not all methods in extensions APIs support promises. Sometimes that’s because we haven’t added promise support on the method yet; in many cases it’s because using a promise isn’t feasible for the method.</p>
<p>You see if an API method support promises by checking its API reference page:</p>
<p>{% Img src=“image/SHhb2PDKzXTggPGAYpv8JgR81pX2/AYQVtnh19vNMHoXzxZB1.png”, alt=“Screenshot showing a method that supports promises”, width=“800”, height=“280” %}</p>
<p>The screenshot above shows a method from the <a href="/docs/extensions/reference/tabs/#methods"><code>chrome.tabs</code></a> API. You can see that this method supports promises because one of the method’s signatures returns a promise. To make this easier to see at a glance, the reference docs also display a <code>Promise</code> pill below the signatures.</p>
<h2 id="how-to-use-promises">How to use promises</h2>
<p>There are many places where using promises will result in cleaner, easier-to-maintain code. You should consider using promises in situations such as the following:</p>
<ul>
<li>Any time that you want to clean up your code by using a more “synchronous” invocation style.</li>
<li>Where error handling would be too difficult using callbacks.</li>
<li>When you want a simpler way to invoke a number of concurrent methods and gather the results into a single thread of code.</li>
</ul>
<h3 id="converting-a-callback-to-a-promise-compare-to-callback">Converting a callback to a promise {: #compare-to-callback}</h3>
<p>One way to understand how you can use promises in extensions APIs is to compare two equivalent code fragments, one using a callback and one using a promise. The following example shows this comparison:</p>
<!--
// --- Standard callback implementation ---
// --- Promise implementation ---
-->
<h4 id="standard-callback-implementation">Standard callback implementation</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">function</span> <span class="at">openTabOnRight</span>(onComplete) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">query</span>(queryOptions<span class="op">,</span> <span class="kw">function</span>(tabs) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="cf">if</span> (<span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">lastError</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">      <span class="at">onComplete</span>(<span class="op">{</span><span class="dt">error</span><span class="op">:</span> <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">lastError</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-6" title="6">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="cf">if</span> (<span class="op">!</span><span class="va">tabs</span>.<span class="at">length</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">      <span class="at">onComplete</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-11" title="11">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="op">};</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-15" title="15">      <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-16" title="16">      <span class="dt">index</span><span class="op">:</span> tab[<span class="dv">0</span>].<span class="at">index</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="op">},</span> <span class="kw">function</span>(tab) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-18" title="18">      <span class="cf">if</span> (<span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">lastError</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="at">onComplete</span>(<span class="op">{</span><span class="dt">error</span><span class="op">:</span> <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">lastError</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-20" title="20">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;tab created&#39;</span><span class="op">,</span> tab)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-23" title="23">      <span class="at">onComplete</span>(tab)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-25" title="25">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="op">}</span></a></code></pre></div>
<h4 id="promise-implementation">Promise implementation</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">function</span> <span class="at">openTabOnRight</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="co">// Errors are automatically propagated down the promise chain</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="cf">return</span> <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">query</span>(queryOptions)</a>
<a class="sourceLine" id="cb2-4" title="4">    .<span class="at">then</span>((tabs) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">      <span class="cf">if</span> (<span class="op">!</span><span class="va">tabs</span>.<span class="at">length</span>) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7">      <span class="cf">return</span> <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">        <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-9" title="9">        <span class="dt">index</span><span class="op">:</span> tab[<span class="dv">0</span>].<span class="at">index</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-10" title="10">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-12" title="12">    .<span class="at">then</span>(tab <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-13" title="13">      <span class="cf">if</span> (<span class="op">!</span>tab) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-14" title="14"></a>
<a class="sourceLine" id="cb2-15" title="15">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;tab created&#39;</span><span class="op">,</span> tab)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-16" title="16">      <span class="cf">return</span> tab<span class="op">;</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="op">}</span></a></code></pre></div>
<h3 id="error-handling">Error handling</h3>
<p>Returning errors works differently depending on whether the extension is using a callback or a promise.</p>
<h4 id="error-handling-with-callbacks">Error handling with callbacks</h4>
<p>If using a callback, then <code>chrome.runtime.lastError</code> is set for the duration of the execution of the callback. It is not thrown as a JS Error (which would interrupt JS execution), and is not set outside the duration of the callback run (which would result in it being “randomly” set during other execution). The extension would look at the last error like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">create</span>(<span class="op">{</span>...<span class="op">},</span> (result) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="cf">if</span> (<span class="va">chrome</span>.<span class="va">runtime</span>.<span class="at">lastError</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="co">// Handle last error</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="error-handling-with-promises">Error handling with promises</h4>
<p>Promises are designed to deliver asynchronous results, both success and failure. A failure in a promise (a promise rejection) is handled differently. It might look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">create</span>(<span class="op">{</span>...<span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-2" title="2">  .<span class="at">then</span>((result) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="co">// success case</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-5" title="5">  .<span class="at">catch</span>((error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="co">// failure case</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Extensions APIs don’t set <code>chrome.runtime.lastError</code> when you use a promise; instead they provide the error as an argument to the function in the <code>.catch()</code>.</p>
<p>{% Aside %} In simpler cases with a single promise, you can instead supply your error handler as the second parameter to <code>.then()</code> instead of chaining to a <code>.catch()</code>. For more about this topic, see this <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise#chained_promises">MDN article on chained promises</a>. {% endAside %}</p>
<p>Whether you receive the error using <code>.catch()</code> or the optional second parameter of <code>.then()</code>, this form of error handling helps you write async logic in a more synchronous style.</p>
<h3 id="using-asyncawait">Using async/await</h3>
<p>JavaScript also provides async/await as syntactic sugar on top of promises, letting you code in a more imperative style. The following example shows how to implement the <a href="#compare-to-callback">example shown earlier</a> using async/await:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// Async/await implementation</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">openTabOnRight</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="co">// When not wrapped in try/catch, errors thrown in an async</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="co">// function will propagate down the promise chain</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="kw">let</span> tabs <span class="op">=</span> <span class="cf">await</span> <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">query</span>(queryOptions)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="cf">if</span> (<span class="op">!</span><span class="va">tabs</span>.<span class="at">length</span>) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="kw">let</span> tab <span class="op">=</span> <span class="cf">await</span> <span class="va">chrome</span>.<span class="va">tabs</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">index</span><span class="op">:</span> tab[<span class="dv">0</span>].<span class="at">index</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14">  <span class="cf">if</span> (<span class="op">!</span>tab) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-15" title="15">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;tab created&#39;</span><span class="op">,</span> tab)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-16" title="16">  <span class="cf">return</span> tab<span class="op">;</span></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="op">}</span></a></code></pre></div>
<p>{% Aside %} Note that <code>await</code> is only valid in async functions and the top-level bodies of modules. {% endAside %}</p>
</body>
</html>
