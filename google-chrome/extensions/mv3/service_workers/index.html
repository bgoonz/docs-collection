<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2012-09-17" />
  <title>Manage events with service workers</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Manage events with service workers</h1>
<p class="date">2012-09-17</p>
</header>
<p>Extensions are event-based programs used to modify or enhance the Chrome browsing experience. Events are browser triggers, such as navigating to a new page, removing a bookmark, or closing a tab. Extensions monitor these events using scripts in their background <a href="/docs/extensions/mv3/migrating_to_service_workers">service worker</a>, which then react with specified instructions.</p>
<p>A background service worker is loaded when it is needed, and unloaded when it goes idle. Some examples of events include:</p>
<ul>
<li>The extension is first installed or updated to a new version.</li>
<li>The background page was listening for an event, and the event is dispatched.</li>
<li>A content script or other extension <a href="/docs/extensions/mv3/messaging">sends a message.</a></li>
<li>Another view in the extension, such as a popup, calls <a href="/docs/extensions/runtime#method-getBackgroundPage"><code>runtime.getBackgroundPage</code></a>.</li>
</ul>
<p>Once it has been loaded, a service worker keeps running as long as it is performing an action, such as calling a Chrome API or issuing a network request. Additionally, the service worker won’t unload until all visible views and all message ports are closed.</p>
<p>{% Aside %} Opening a view doesn’t cause the service worker to load, but only prevents it from closing once loaded. {% endAside %}</p>
<p>Effective background scripts stay dormant until an event they are listening for fires, react with specified instructions, then unload.</p>
<h2 id="register-background-scripts-manifest">Register background scripts {: #manifest }</h2>
<p>Extensions register their background service workers in the <a href="/docs/extensions/mv3/manifest/">manifest</a> under the <code>"background"</code> field. This field uses the <code>"service_worker"</code> key, which specifies a single JavaScript file.</p>
<pre class="json/3-6"><code>{
  &quot;name&quot;: &quot;Awesome Test Extension&quot;,
  ...
  &quot;background&quot;: {
    &quot;service_worker&quot;: &quot;background.js&quot;
  },
  ...
}</code></pre>
<p>{% Aside %} The script used for <code>"service_worker"</code> must be located in your extension’s root directory. {% endAside %}</p>
<p>You can optionally specify an extra field of <code>"type": "module"</code> to include the service worker as an ES Module, which allows you to <code>import</code> further code. See <a href="https://web.dev/es-modules-in-sw/">ES modules in service workers</a> for more information. For example:</p>
<pre class="json/2-2"><code>  &quot;background&quot;: {
    &quot;service_worker&quot;: &quot;background.js&quot;,
    &quot;type&quot;: &quot;module&quot;
  }</code></pre>
<h2 id="initialize-the-extension-initialization">Initialize the extension {: #initialization }</h2>
<p>Listen to the <a href="/docs/extensions/reference/runtime#event-onInstalled"><code>runtime.onInstalled</code></a> event to initialize an extension on installation. Use this event to set a state or for one-time initialization, such as a <a href="/docs/extensions/reference/contextMenus">context menu</a>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onInstalled</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="va">chrome</span>.<span class="va">contextMenus</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="st">&quot;id&quot;</span><span class="op">:</span> <span class="st">&quot;sampleContextMenu&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="st">&quot;title&quot;</span><span class="op">:</span> <span class="st">&quot;Sample Context Menu&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="st">&quot;contexts&quot;</span><span class="op">:</span> [<span class="st">&quot;selection&quot;</span>]</a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="set-up-listeners-listeners">Set up listeners {: #listeners }</h2>
<p>Structure background scripts around events the extension depends on. Defining functionally relevant events allows background scripts to lie dormant until those events are fired and prevents the extension from missing important triggers.</p>
<p>Listeners must be registered synchronously from the start of the page.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onInstalled</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="va">chrome</span>.<span class="va">contextMenus</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="st">&quot;id&quot;</span><span class="op">:</span> <span class="st">&quot;sampleContextMenu&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="st">&quot;title&quot;</span><span class="op">:</span> <span class="st">&quot;Sample Context Menu&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="st">&quot;contexts&quot;</span><span class="op">:</span> [<span class="st">&quot;selection&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">// This will run when a bookmark is created.</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="va">chrome</span>.<span class="va">bookmarks</span>.<span class="va">onCreated</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="co">// do something</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Do not register listeners asynchronously, as they will not be properly triggered.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onInstalled</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="co">// ERROR! Events must be registered synchronously from the start of</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="co">// the page.</span></a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="va">chrome</span>.<span class="va">bookmarks</span>.<span class="va">onCreated</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="co">// do something</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Extensions can remove listeners from their background scripts by calling <code>removeListener</code>. If all listeners for an event are removed, Chrome will no longer load the extension’s background script for that event.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>((message<span class="op">,</span> sender<span class="op">,</span> reply) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2"> <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">removeListener</span>(event)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="filter-events-filters">Filter events {: #filters }</h2>
<p>Use APIs that support <a href="/docs/extensions/reference/events#filtered">event filters</a> to restrict listeners to the cases the extension cares about. If an extension is listening for the <a href="/docs/extensions/reference/extensions/tabs#event-onUpdated"><code>tabs.onUpdated</code></a> event, try using the <a href="/docs/extensions/reference/webNavigation#event-onCompleted"><code>webNavigation.onCompleted</code></a> event with filters instead, as the tabs API does not support filters.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">const</span> filter <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="dt">url</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">      <span class="dt">urlMatches</span><span class="op">:</span> <span class="st">&#39;https://www.google.com/&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="op">},</span></a>
<a class="sourceLine" id="cb7-6" title="6">  ]<span class="op">,</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="op">};</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="va">chrome</span>.<span class="va">webNavigation</span>.<span class="va">onCompleted</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="va">console</span>.<span class="at">info</span>(<span class="st">&quot;The user has loaded my favorite website!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="op">},</span> filter)<span class="op">;</span></a></code></pre></div>
<h2 id="react-to-listeners-react">React to listeners {: #react }</h2>
<p>Listeners exist to trigger functionality once an event has fired. To react to an event, structure the desired reaction inside of the listener event.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>((message<span class="op">,</span> callback) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="kw">const</span> tabId <span class="op">=</span> <span class="at">getForegroundTabId</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="cf">if</span> (<span class="va">message</span>.<span class="at">data</span> <span class="op">===</span> <span class="st">&quot;setAlarm&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="va">chrome</span>.<span class="va">alarms</span>.<span class="at">create</span>(<span class="op">{</span><span class="dt">delayInMinutes</span><span class="op">:</span> <span class="dv">5</span><span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">message</span>.<span class="at">data</span> <span class="op">===</span> <span class="st">&quot;runLogic&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="va">chrome</span>.<span class="va">scripting</span>.<span class="at">executeScript</span>(<span class="op">{</span><span class="dt">file</span><span class="op">:</span> <span class="st">&#39;logic.js&#39;</span><span class="op">,</span> tabId<span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-7" title="7">  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">message</span>.<span class="at">data</span> <span class="op">===</span> <span class="st">&quot;changeColor&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="va">chrome</span>.<span class="va">scripting</span>.<span class="at">executeScript</span>(</a>
<a class="sourceLine" id="cb8-9" title="9">        <span class="op">{</span><span class="dt">func</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="va">document</span>.<span class="va">body</span>.<span class="va">style</span>.<span class="at">backgroundColor</span><span class="op">=</span><span class="st">&quot;orange&quot;</span><span class="op">,</span> tabId<span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-10" title="10">  <span class="op">};</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="unload-background-scripts-unloading">Unload background scripts {: #unloading }</h2>
<p>Data should be persisted periodically so that important information is not lost if an extension crashes without receiving <code>onSuspend</code>. Use the <a href="/docs/extensions/reference/storage">storage</a> API to assist with this.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="va">chrome</span>.<span class="va">storage</span>.<span class="va">local</span>.<span class="at">set</span>(<span class="op">{</span><span class="dt">variable</span><span class="op">:</span> variableInformation<span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>If an extension uses <a href="/docs/extensions/mv3/messaging">message passing</a>, ensure all ports are closed. The background script will not unload until all message ports have shut. Listening to the <a href="/docs/extensions/reference/runtime#property-Port-onDisconnect"><code>runtime.Port.onDisconnect</code></a> event will give insight to when open ports are closing. Manually close them with <a href="/docs/extensions/reference/runtime#property-Port-disconnect"><code>runtime.Port.disconnect</code></a>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>((message<span class="op">,</span> callback) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="cf">if</span> (message <span class="op">===</span> <span class="st">&#39;hello&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="at">sendResponse</span>(<span class="op">{</span><span class="dt">greeting</span><span class="op">:</span> <span class="st">&#39;welcome!&#39;</span><span class="op">}</span>)</a>
<a class="sourceLine" id="cb10-4" title="4">  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (message <span class="op">===</span> <span class="st">&#39;goodbye&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">Port</span>.<span class="at">disconnect</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The lifetime of a background service worker is observable by monitoring when an entry for the extension appears and disappears from Chrome’s task manager.</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/occ8HD81vNq2zboXIbiu.png”, alt=“Chrome with an extension’s popup open.”, height=“623”, width=“730” %}</p>
<p>Open the task manager by clicking the Chrome Menu, hovering over more tools and selecting “Task Manager”.</p>
<p>Service workers unload on their own after a few seconds of inactivity. If any last minute cleanup is required, listen to the <a href="/docs/extensions/reference/runtime#event-onSuspend"><code>runtime.onSuspend</code></a> event.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="va">chrome</span>.<span class="va">runtime</span>.<span class="va">onSuspend</span>.<span class="at">addListener</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Unloading.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="va">chrome</span>.<span class="va">browserAction</span>.<span class="at">setBadgeText</span>(<span class="op">{</span><span class="dt">text</span><span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>However, persisting data in the storage API should be prefered over relying on <a href="/docs/extensions/reference/runtime#event-onSuspend"><code>runtime.onSuspend</code></a>. It doesn’t allow for as much cleanup as may be needed and will not help in case of a crash.</p>
</body>
</html>
