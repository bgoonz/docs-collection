<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2018-10-01" />
  <title>User controls for host permissions: transition guide</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">User controls for host permissions: transition guide</h1>
<p class="date">2018-10-01</p>
</header>
<p>{% include ‘partials/extensions/mv2-legacy-page.md’ %}</p>
<h2 id="summary-summary">Summary {: #summary }</h2>
<h3 id="whats-changing-changes">What’s changing? {: #changes }</h3>
<p>Beginning in Chrome 70, users have the ability to restrict extension host access to a custom list of sites, or to configure extensions to require a click to gain access to the current page.</p>
<h3 id="which-apis-are-affected-affected-apis">Which APIs are affected? {: #affected-apis }</h3>
<p>This change affects any APIs that are affected by the host permissions specified in your extension’s manifest, as well as content scripts. APIs that require host permissions include <a href="/webRequest">webRequest</a>, <a href="/cookies">cookies</a>, <a href="/tabs#method-executeScript">tabs.executeScript()</a> and <a href="/tabs#method-insertCSS">tabs.insertCSS()</a>, and performing cross-origin requests, such as through an <code>XMLHTTPRequest</code> or the <code>fetch()</code> API.</p>
<h2 id="restricting-access-restricting-access">Restricting access {: #restricting-access }</h2>
<h3 id="how-can-the-user-restrict-access-user-restricting-access">How can the user restrict access? {: #user-restricting-access }</h3>
<p>Users can choose to allow your extension to run on click, on a specific set of sites, or on all requested sites. These options are presented to users on the <code>chrome://extensions</code> page as well as in the extension context menu.</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/JSg4nkfMPMfNHum95Otu.png”, alt=“A screenshot of the context menu controls for runtime host permissions, including options to run the extension on click, on a specific site, or on all sites.”, height=“346”, width=“800” %}</p>
<h3 id="what-happens-if-a-user-chooses-to-run-my-extension-on-click-access-on-click">What happens if a user chooses to run my extension “on click”? {: #access-on-click }</h3>
<p>The extension essentially behaves as though it used the <a href="/activeTab">activeTab</a> permission. The extension is granted temporary access to any host the user clicks the extension on, if that host was requested by the extension (and isn’t a restricted site, like chrome://settings). When set to run on click, Chrome badges your extension with a circle and drop shadow (see below) to indicate that is requesting access on a particular site.</p>
<p>{% Img src=“image/BrQidfK9jaQyIHwdw91aVpkPiib2/FsV4PT4vR8SXb96CLrNc.png”, alt=“A screenshot of the badging Chrome adds to the extension icon in the toolbar”, height=“174”, width=“484” %}</p>
<h3 id="what-happens-if-a-user-chooses-to-run-my-extension-on-specific-sites-access-on-specific-sites">What happens if a user chooses to run my extension on specific sites? {: #access-on-specific-sites }</h3>
<p>Your extension is allowed to run automatically on any sites the user has chosen, and can access the site without further user action. On other sites that your extension requested, but the user did not grant permission to, the behavior is the same as if the user had set the extension to run on click.</p>
<h3 id="what-happens-if-a-user-chooses-to-run-my-extension-on-all-sites-access-on-all-sites">What happens if a user chooses to run my extension on all sites? {: #access-on-all-sites }</h3>
<p>The extension can automatically access any sites requested in the manifest.</p>
<h2 id="api-behaviors-api-behaviors">API behaviors {: #api-behaviors }</h2>
<h3 id="web-request-api-web-request-behavior">Web request API {: #web-request-behavior }</h3>
<p>The extension can still intercept, modify, and block any requests from sites it has access to. For sites the extension does not have access to, Chrome badges the extension to indicate that the extension requests access to the page. The user can then grant access to the extension; Chrome then prompts the user to refresh the page to allow your extension to intercept the network requests.</p>
<h3 id="content-scripts-tabs.executescript-tabs.insertcss-scripts-behavior">Content scripts, tabs.executeScript(), tabs.insertCSS() {: #scripts-behavior }</h3>
<p>The extension can still inject scripts and style sheets automatically for any sites it has access to. For sites the extension does not have access to, Chrome badges the extension to indicate that the extension requests access to the page. The user can then grant access to the extension. If the content script was set to inject at document_idle, the script will inject immediately. Otherwise, Chrome prompts the user to refresh the page to allow your extension to inject scripts earlier in page load (at document_start or document_end). The callbacks for the <a href="/tabs#method-executeScript">tabs.executeScript()</a> and <a href="/tabs#method-insertCSS">tabs.insertCSS()</a> methods are only invoked if the user grants access to the site.</p>
<h3 id="cookies-and-background-page-xhr-background-behavior">Cookies and background page XHR {: #background-behavior }</h3>
<p>The extension can still read and modify any cookies from and perform a cross-origin XHR to sites it has access to. Because there is no tab associated with an extension page accessing another origin’s cookies or XHRing to another host, Chrome does not badge the extension to indicate to the user that the extension is requesting to access a site. Trying to access a cookie for another site or make a cross-origin XHR will fail with an error as if the extension’s manifest did not include the host permission. For these cases, we encourage you to use optional permissions in order to allow the user to grant runtime access to different sites.</p>
<p>The example below illustrates how this may work for the cookies API.</p>
<p>Before:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="er">...</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="dt">&quot;permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;cookies&quot;</span><span class="ot">,</span> <span class="st">&quot;https://example.com&quot;</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="fu">}</span></a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">chrome</span>.<span class="va">cookies</span>.<span class="at">get</span>(<span class="op">{</span><span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;mycookie&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb2-2" title="2">                    <span class="kw">function</span>(cookie) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">                      <span class="co">// Use the cookie.</span></a>
<a class="sourceLine" id="cb2-4" title="4">                    <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="er">...</span></a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="dt">&quot;permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;cookies&quot;</span><span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">&quot;optional_permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;https://example.com&quot;</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="fu">}</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// Note: permissions.request() requires a user gesture, so this</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">// may only be done in response to a user action.</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="va">chrome</span>.<span class="va">permissions</span>.<span class="at">request</span>(</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="op">{</span><span class="dt">origins</span><span class="op">:</span> [<span class="st">&#39;https://example.com&#39;</span>]<span class="op">},</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">function</span>(granted) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">      <span class="cf">if</span> (granted) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="va">chrome</span>.<span class="va">cookies</span>.<span class="at">get</span>(<span class="op">{</span><span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;mycookie&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb4-8" title="8">                            <span class="kw">function</span>(cookie) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">                              <span class="co">// Use the cookie.</span></a>
<a class="sourceLine" id="cb4-10" title="10">                            <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-11" title="11">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">        <span class="co">// Handle grant failure</span></a>
<a class="sourceLine" id="cb4-13" title="13">      <span class="op">}</span></a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="migration-migration">Migration {: #migration }</h2>
<h3 id="what-are-best-practices-to-avoid-being-negatively-impacted-best-practices">What are best practices to avoid being negatively impacted? {: #best-practices }</h3>
<p>Extensions can use the <a href="/permissions">optional permissions</a>, <a href="/activeTab">activeTab</a>, and <a href="/declarativeContent">declarativeContent</a> APIs to follow best practices. Optional permissions are granted at runtime, and allow the extension to request specific access to a site. The <a href="/activeTab">activeTab</a> permission is not affected, and extensions using it continue to work normally. The <a href="/declarativeContent">declarativeContent</a> API is a substitute for many needs to inject scripts into every page.</p>
<h3 id="what-happens-to-my-current-users-settings-current-settings">What happens to my current users’ settings? {: #current-settings }</h3>
<p>This change will not immediately affect any current permissions granted to your extension. That is, it will continue to operate as before unless the user takes action to restrict the sites it is allowed to access. In future releases, Chrome will provide more controls to users to adjust settings.</p>
<h3 id="how-can-i-check-if-my-extension-has-permission-to-run-on-a-site-checking-access">How can I check if my extension has permission to run on a site? {: #checking-access }</h3>
<p>You can use the <a href="/permissions/#method-contains">permissions.contains()</a> API in order to check whether your extension has been granted access to a given origin.</p>
</body>
</html>
