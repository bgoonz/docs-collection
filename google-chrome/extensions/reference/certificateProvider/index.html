<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>index</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h2 id="usage">Usage</h2>
<p>Typical usage of this API to expose client certificates to Chrome OS follows these steps:</p>
<ul>
<li>The Extension registers for the events <a href="#event-onCertificatesUpdateRequested">onCertificatesUpdateRequested</a> and <a href="#event-onSignatureRequested">onSignatureRequested</a>.</li>
<li>The Extension calls <a href="#method-setCertificates">setCertificates</a> to provide the initial list of certificates after the initialization.</li>
<li>The Extension monitors the changes in the list of available certificates and calls <a href="#method-setCertificates">setCertificates</a> to notify the browser about every such change.</li>
<li>During a TLS handshake, the browser receives a client certificate request. With an <a href="#event-onCertificatesUpdateRequested">onCertificatesUpdateRequested</a> event, the browser asks the Extension to report all certificates that it currently provides.</li>
<li>The Extension reports back with the currently available certificates, using the <a href="#method-setCertificates">setCertificates</a> method.</li>
<li>The browser matches all available certificates with the client certificate request from the remote host. The matches are presented to the user in a selection dialog.</li>
<li>The user can select a certificate and thereby approve the authentication or abort the authentication.</li>
</ul>
<figure>
<img src="certificate_provider_selection_dialog.png" alt="Certificate selection dialog" /><figcaption>Certificate selection dialog</figcaption>
</figure>
<ul>
<li>If the user aborts the authentication or no certificate matched the request, the TLS client authentication is aborted.</li>
<li>Otherwise, if the user approves the authentication with a certificate provided by this Extension, the browser requests the Extension to sign the data to continue the TLS handshake. The request is sent as a <a href="#event-onSignatureRequested">onSignatureRequested</a> event.</li>
<li>This event contains input data, declares which algorithm has to be used to generate the signature, and refers to one of the certificates that were reported by this Extension. The Extension must create a signature for the given data using the private key associated with the referenced certificate. Creating the signature might require prepending a DigestInfo and padding the result before the actual signing.</li>
<li>The Extension sends back the signature to the browser using the <a href="#method-reportSignature">reportSignature</a> method. If the signature couldnâ€™t be calculated, the method has to be called without signature.</li>
<li>If the signature was provided, the browser completes the TLS handshake.</li>
</ul>
<p>The actual sequence of steps can be different. For example, the user will not be asked to select a certificate if the enterprise policy to automatically select a certificate is used (see <a href="https://cloud.google.com/docs/chrome-enterprise/policies/?policy=AutoSelectCertificateForUrls">AutoSelectCertificateForUrls</a> and <a href="https://support.google.com/chrome/a/answer/2657289?hl=en#AutoSelectCertificateForUrls">Chrome policies for users</a>).</p>
<p>In the Extension, this can look similar to the following snippet:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">function</span> <span class="at">collectAvailableCertificates</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="co">// Return all certificates that this Extension can currently provide.</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="co">// For example:</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="cf">return</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="dt">certificateChain</span><span class="op">:</span> [<span class="kw">new</span> <span class="at">Uint8Array</span>(...)]<span class="op">,</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="dt">supportedAlgorithms</span><span class="op">:</span> [<span class="st">&#39;RSASSA_PKCS1_v1_5_SHA256&#39;</span>]</a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="op">}</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">// The Extension calls this function every time the currently available list of</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">// certificates changes, and also once after the Extension&#39;s initialization.</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">function</span> <span class="at">onAvailableCertificatesChanged</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-13" title="13">  <span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="at">setCertificates</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="dt">clientCertificates</span><span class="op">:</span> <span class="at">collectAvailableCertificates</span>()</a>
<a class="sourceLine" id="cb1-15" title="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw">function</span> <span class="at">handleCertificatesUpdateRequest</span>(request) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-19" title="19">  <span class="co">// Report the currently available certificates as a response to the request</span></a>
<a class="sourceLine" id="cb1-20" title="20">  <span class="co">// event. This is important for supporting the case when the Extension is</span></a>
<a class="sourceLine" id="cb1-21" title="21">  <span class="co">// unable to detect the changes proactively.</span></a>
<a class="sourceLine" id="cb1-22" title="22">  <span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="at">setCertificates</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="dt">certificatesRequestId</span><span class="op">:</span> <span class="va">request</span>.<span class="at">certificatesRequestId</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="dt">clientCertificates</span><span class="op">:</span> <span class="at">collectAvailableCertificates</span>()</a>
<a class="sourceLine" id="cb1-25" title="25">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-27" title="27"></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="co">// Returns a private key handle for the given DER-encoded certificate.</span></a>
<a class="sourceLine" id="cb1-29" title="29"><span class="co">// |certificate| is an ArrayBuffer.</span></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="kw">function</span> <span class="at">getPrivateKeyHandle</span>(certificate) <span class="op">{</span>...<span class="op">}</span></a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="co">// Digests and signs |input| with the given private key. |input| is an</span></a>
<a class="sourceLine" id="cb1-33" title="33"><span class="co">// ArrayBuffer. |algorithm| is an Algorithm.</span></a>
<a class="sourceLine" id="cb1-34" title="34"><span class="co">// Returns the signature as ArrayBuffer.</span></a>
<a class="sourceLine" id="cb1-35" title="35"><span class="kw">function</span> <span class="at">signUnhashedData</span>(privateKey<span class="op">,</span> input<span class="op">,</span> algorithm) <span class="op">{</span>...<span class="op">}</span></a>
<a class="sourceLine" id="cb1-36" title="36"></a>
<a class="sourceLine" id="cb1-37" title="37"><span class="kw">function</span> <span class="at">handleSignatureRequest</span>(request) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-38" title="38">  <span class="co">// Look up the handle to the private key of |request.certificate|.</span></a>
<a class="sourceLine" id="cb1-39" title="39">  <span class="kw">const</span> key <span class="op">=</span> <span class="at">getPrivateKeyHandle</span>(<span class="va">request</span>.<span class="at">certificate</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-40" title="40">  <span class="cf">if</span> (<span class="op">!</span>key) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-41" title="41">    <span class="co">// Handle if the key isn&#39;t available.</span></a>
<a class="sourceLine" id="cb1-42" title="42">    <span class="va">console</span>.<span class="at">error</span>(<span class="st">&#39;Key for requested certificate no available.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-43" title="43"></a>
<a class="sourceLine" id="cb1-44" title="44">    <span class="co">// Abort the request by reporting the error to the API.</span></a>
<a class="sourceLine" id="cb1-45" title="45">    <span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="at">reportSignature</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-46" title="46">      <span class="dt">signRequestId</span><span class="op">:</span> <span class="va">request</span>.<span class="at">signRequestId</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-47" title="47">      <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;GENERAL_ERROR&#39;</span></a>
<a class="sourceLine" id="cb1-48" title="48">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-49" title="49">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-50" title="50">  <span class="op">}</span></a>
<a class="sourceLine" id="cb1-51" title="51"></a>
<a class="sourceLine" id="cb1-52" title="52">  <span class="kw">const</span> signature <span class="op">=</span> <span class="at">signUnhashedData</span>(key<span class="op">,</span> <span class="va">request</span>.<span class="at">input</span><span class="op">,</span> <span class="va">request</span>.<span class="at">algorithm</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-53" title="53">  <span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="at">reportSignature</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-54" title="54">    <span class="dt">signRequestId</span><span class="op">:</span> <span class="va">request</span>.<span class="at">signRequestId</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-55" title="55">    <span class="dt">signature</span><span class="op">:</span> signature</a>
<a class="sourceLine" id="cb1-56" title="56">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-57" title="57"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-58" title="58"></a>
<a class="sourceLine" id="cb1-59" title="59"><span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="va">onCertificatesUpdateRequested</span>.<span class="at">addListener</span>(</a>
<a class="sourceLine" id="cb1-60" title="60">    handleCertificatesUpdateRequest)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-61" title="61"><span class="va">chrome</span>.<span class="va">certificateProvider</span>.<span class="va">onSignatureRequested</span>.<span class="at">addListener</span>(</a>
<a class="sourceLine" id="cb1-62" title="62">    handleSignatureRequest)<span class="op">;</span></a></code></pre></div>
</body>
</html>
