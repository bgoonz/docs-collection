<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-08-12" />
  <title>How to add extra HTTP Request Headers to Custom Tab Intents</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">How to add extra HTTP Request Headers to Custom Tab Intents</h1>
<p class="date">2020-08-12</p>
</header>
<p>HTTP requests contain headers such as User-Agent or Content-Type. Apart from headers attached by browsers, Android apps may add extra headers, like Cookie or Referrer through the <a href="https://developer.android.com/reference/android/provider/Browser#EXTRA_HEADERS"><code>EXTRA_HEADERS</code></a> Intent extra. For security reasons, Chrome filters some of the extra headers depending on how and where an intent is launched.</p>
<p><a href="https://docs.google.com/document/d/1sN6Y31giDbdGj6R4p3QJ20gD1ggBIosae7yrsSZ3Ins/edit#heading=h.ey2vxjsxytw6">Cross-origin</a> requests require an additional layer of security as the client and server are not owned by the same party. This guide discusses launching such requests through Chrome <a href="/docs/android/custom-tabs/">custom tabs</a>, i.e. intents launched from apps that open a URL in the browser tab. Until Chrome 83, developers could add any headers when launching a Custom Tab. From version 83 onward, Chrome started filtering all except <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">whitelisted</a> cross-origin headers, since non-whitelisted headers posed a security risk. Starting with Chrome 86, it is possible to attach non-whitelisted headers to cross-origin requests, when the server and client are related using a <a href="https://developers.google.com/digital-asset-links/v1/getting-started">digital asset link</a>. This behaviour is summarised in the following table:</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Chrome version</strong></th>
<th><strong>CORS headers allowed</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>before Chrome 83</td>
<td>whitelisted, non-whitelisted</td>
</tr>
<tr class="even">
<td>Chrome 83 to Chrome 85</td>
<td>whitelisted</td>
</tr>
<tr class="odd">
<td>from Chrome 86 onwards</td>
<td>whitelisted, non-whitelisted when a digital asset link is set up</td>
</tr>
</tbody>
</table>
<p><strong>Table 1.:</strong> Filtering of non-whitelisted CORS headers.</p>
<p>This article shows how to set up a verified connection between the server and client and use that to send whitelisted as well as non-whitelisted http headers. You can skip to <a href="#adding-extra-headers">Adding Extra Headers to CustomTab Intents</a> for the code.</p>
<h2 id="background">Background</h2>
<h3 id="whitelisted-vs.-non-whitelisted-cors-request-headers">Whitelisted vs. Non-whitelisted CORS Request Headers</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing (CORS)</a> allows a web application from one origin to request resources of a different origin. The list of <strong>CORS-whitelisted</strong> headers is maintained in the <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">HTML Standard</a>. Example whitelisted headers are shown in the next table:</p>
<table>
<thead>
<tr class="header">
<th><strong>Header</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>accept-language</td>
<td>advertises natural languages the client understands</td>
</tr>
<tr class="even">
<td>content-language</td>
<td>describes language intended for the current audience</td>
</tr>
<tr class="odd">
<td>content-type</td>
<td>indicates the media type of the resource</td>
</tr>
</tbody>
</table>
<p><strong>Table 2.:</strong> Example whitelisted CORS headers.</p>
<p>The whitelisted headers are considered safe because they don’t contain sensitive user information and are unlikely to cause the server to perform potentially damaging operations.</p>
<p>Examples of non-whitelisted headers are shown in the following table:</p>
<table>
<thead>
<tr class="header">
<th><strong>Header</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>bearer-token</td>
<td>authenticates client at a server</td>
</tr>
<tr class="even">
<td>origin</td>
<td>indicates origin of request</td>
</tr>
<tr class="odd">
<td>cookie</td>
<td>contains cookies set by server</td>
</tr>
</tbody>
</table>
<p><strong>Table 3.:</strong> Example non-whitelisted CORS headers.</p>
<p>Attaching non-whitelisted headers to CORS requests is discouraged by the HTML standard and servers assume that cross-origin requests contain only whitelisted headers. Sending non-whitelisted headers from cross-origin domains would allow malicious third-party apps to craft headers that misuse user cookies that Chrome (or another browser) stores and attaches to requests. The cookies could authenticate malicious server transactions that would otherwise not be possible.</p>
<h3 id="attaching-cors-whitelisted-headers-to-custom-tabs-requests">Attaching CORS whitelisted headers to Custom Tabs requests</h3>
<p><a href="/docs/android/custom-tabs/">Custom Tabs</a> are a special way of launching web pages in a customised browser tab. Custom Tab intents can be created using <code>CustomTabsIntent.Builder()</code>. You can also attach headers to these intents using a <code>Bundle</code> with the <a href="https://developer.android.com/reference/android/provider/Browser#EXTRA_HEADERS"><code>Borwser.EXTRA_HEADERS</code> flag</a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1">CustomTabsIntent intent = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>(session).<span class="fu">build</span>();</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">Bundle headers = <span class="kw">new</span> <span class="fu">Bundle</span>();</a>
<a class="sourceLine" id="cb1-4" title="4">headers.<span class="fu">putString</span>(<span class="st">&quot;bearer-token&quot;</span>, <span class="st">&quot;Some token&quot;</span>);</a>
<a class="sourceLine" id="cb1-5" title="5">headers.<span class="fu">putString</span>(<span class="st">&quot;redirect-url&quot;</span>, <span class="st">&quot;Some redirect url&quot;</span>);   </a>
<a class="sourceLine" id="cb1-6" title="6">intent.<span class="fu">intent</span>.<span class="fu">putExtra</span>(Browser.<span class="fu">EXTRA_HEADERS</span>, headers);</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">intent.<span class="fu">launchUrl</span>(Activity.<span class="fu">this</span>, Uri.<span class="fu">parse</span>(<span class="st">&quot;http://www.google.com&quot;</span>));</a></code></pre></div>
<p>We can always attach whitelisted headers to custom tabs CORS requests. However, Chrome filters non-whitelisted headers by default. Although other browsers may have different behaviour, developers should expect non-whitelisted headers to be blocked in general.</p>
<p>The supported way of including non-whitelisted headers in custom tabs is to first verify the cross-origin connection using a digital access link. The next section shows how to set these up and launch a Custom Tabs intent with the required headers.</p>
<h2 id="adding-extra-headers-to-customtab-intents-adding-extra-headers">Adding Extra Headers to CustomTab Intents {: #adding-extra-headers }</h2>
<h3 id="set-up-digital-asset-links">Set up digital asset links</h3>
<p>To allow non-whitelisted headers to be passed through custom tab intents, it is necessary to set up a digital asset link between the android and web application that verifies that the author owns both applications.</p>
<p>Follow the <a href="https://developers.google.com/digital-asset-links/v1/getting-started">official guide</a> to set up a digital asset link. For the link relation use “delegate_permission/common.use_as_origin”` which indicates that both apps belong to the same origin once the link is verified.</p>
<h3 id="create-custom-tab-intent-with-extra-headers">Create Custom Tab Intent with Extra Headers</h3>
<p>There are multiple ways for creating a <a href="/docs/android/custom-tabs/">custom tabs intent</a>. You can use the builder available in androidX by adding the library to the build dependencies:</p>
<pre class="groovy"><code>implementation &#39;androidx.browser:browser:1.2.0&#39;</code></pre>
<p>Build the intent and add extra headers:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" title="1">CustomTabsIntent <span class="fu">constructExtraHeadersIntent</span>(CustomTabsSession session) {</a>
<a class="sourceLine" id="cb3-2" title="2">    CustomTabsIntent intent = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>(session).<span class="fu">build</span>();</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="co">// Example non-cors-whitelisted headers.</span></a>
<a class="sourceLine" id="cb3-5" title="5">    Bundle headers = <span class="kw">new</span> <span class="fu">Bundle</span>();</a>
<a class="sourceLine" id="cb3-6" title="6">    headers.<span class="fu">putString</span>(<span class="st">&quot;bearer-token&quot;</span>, <span class="st">&quot;Some token&quot;</span>);</a>
<a class="sourceLine" id="cb3-7" title="7">    headers.<span class="fu">putString</span>(<span class="st">&quot;redirect-url&quot;</span>, <span class="st">&quot;Some redirect url&quot;</span>);</a>
<a class="sourceLine" id="cb3-8" title="8">    intent.<span class="fu">intent</span>.<span class="fu">putExtra</span>(Browser.<span class="fu">EXTRA_HEADERS</span>, headers);</a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="kw">return</span> intent;</a>
<a class="sourceLine" id="cb3-10" title="10">}</a></code></pre></div>
<h3 id="set-up-a-custom-tabs-connection-to-validate-the-asset-link">Set up a Custom Tabs Connection to Validate the Asset Link</h3>
<p>A Custom Tabs connection is used for setting up a <code>CustomTabsSession</code> between the app and the Chrome tab. We need the session to verify that the app and web app belong to the same origin. The verification only passes if the digital asset links were set up correctly.</p>
<p>It is encouraged to call <code>CustomTabsClient.warmup()</code>. It allows the browser application to pre-initialize in the background and speed up the URL opening process.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// Set up a connection that warms up and validates a session.</span></a>
<a class="sourceLine" id="cb4-2" title="2">CustomTabsServiceConnection connection = <span class="kw">new</span> <span class="fu">CustomTabsServiceConnection</span>() {</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onCustomTabsServiceConnected</span>(<span class="at">@NonNull</span> ComponentName name, </a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="at">@NonNull</span> CustomTabsClient client) {</a>
<a class="sourceLine" id="cb4-6" title="6">        <span class="co">// Create session after service connected.</span></a>
<a class="sourceLine" id="cb4-7" title="7">        mSession = client.<span class="fu">newSession</span>(callback);</a>
<a class="sourceLine" id="cb4-8" title="8">        client.<span class="fu">warmup</span>(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb4-9" title="9">        <span class="co">// Validate the session as the same origin to allow cross origin headers.</span></a>
<a class="sourceLine" id="cb4-10" title="10">        mSession.<span class="fu">validateRelationship</span>(CustomTabsService.<span class="fu">RELATION_USE_AS_ORIGIN</span>, </a>
<a class="sourceLine" id="cb4-11" title="11">            Uri.<span class="fu">parse</span>(url), <span class="kw">null</span>);</a>
<a class="sourceLine" id="cb4-12" title="12">    }</a>
<a class="sourceLine" id="cb4-13" title="13">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onServiceDisconnected</span>(ComponentName componentName) { }</a>
<a class="sourceLine" id="cb4-15" title="15">};</a></code></pre></div>
<h3 id="set-up-a-callback-that-launches-the-intent-after-validation">Set up a Callback that Launches the Intent after Validation</h3>
<p>The <code>CustomTabsCallback</code> was passed into the session. We set up its <code>onRelationshipValidationResult()</code> to launch the previously created <code>CustomTabsIntent</code> once the origin verification succeeds.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// Set up a callback that launches the intent after session validated.</span></a>
<a class="sourceLine" id="cb5-2" title="2">CustomTabsCallback callback = <span class="kw">new</span> <span class="fu">CustomTabsCallback</span>() {</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onRelationshipValidationResult</span>(<span class="dt">int</span> relation, <span class="at">@NonNull</span> Uri requestedOrigin, </a>
<a class="sourceLine" id="cb5-5" title="5">        <span class="dt">boolean</span> result, <span class="at">@Nullable</span> Bundle extras) {</a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="co">// Launch custom tabs intent after session was validated as the same origin.</span></a>
<a class="sourceLine" id="cb5-7" title="7">        CustomTabsIntent intent = <span class="fu">constructExtraHeadersIntent</span>(mSession);</a>
<a class="sourceLine" id="cb5-8" title="8">        intent.<span class="fu">launchUrl</span>(MainActivity.<span class="fu">this</span>, Uri.<span class="fu">parse</span>(url));</a>
<a class="sourceLine" id="cb5-9" title="9">    }</a>
<a class="sourceLine" id="cb5-10" title="10">};</a></code></pre></div>
<h3 id="bind-the-custom-tabs-service-connection">Bind the custom tabs service connection</h3>
<p>Binding the service launches the service and the connection’s <code>onCustomTabsServiceConnected()</code> will be called eventually. Don’t forget to unbind the service appropriately. Binding and unbinding is commonly done in the <code>onStart()</code> and <code>onStop()</code> activity lifecycle methods.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// Bind the custom tabs service connection.</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">// Call this in onStart()</span></a>
<a class="sourceLine" id="cb6-3" title="3">CustomTabsClient.<span class="fu">bindCustomTabsService</span>(<span class="kw">this</span>,</a>
<a class="sourceLine" id="cb6-4" title="4">    CustomTabsClient.<span class="fu">getPackageName</span>(MainActivity.<span class="fu">this</span>, <span class="kw">null</span>), connection);</a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">// …</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">// Unbind the custom tabs service.</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">// Call this in onStop().</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="fu">unbindService</span>(connection);</a></code></pre></div>
<h3 id="demo-application-code">Demo application code</h3>
<p>You can find more details about Custom Tabs Service <a href="/docs/android/custom-tabs/integration-guide#connect_to_the_custom_tabs_service">here</a>. See the <a href="https://github.com/GoogleChrome/android-browser-helper/tree/master/demos">android-browser-helper</a> GitHub repository for a working example app.</p>
<h2 id="summary">Summary</h2>
<p>This guide demonstated how to add arbitrary headers to custom tabs CORS requests. Whitelisted headers can be attached to every custom tabs CORS request. Non-whitelisted headers are generally considered unsafe in CORS requests and chrome filters them by default. Attaching them is allowed only for clients and servers of the same origin, verified by a digital asset link.</p>
</body>
</html>
