<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-07-02" />
  <title>Best Practices</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Best Practices</h1>
<p class="date">2020-07-02</p>
</header>
<p>Since Custom Tabs was launched, we’ve seen various implementations with different levels of quality. This section describes a set of best practices we’ve found to create a good integration.</p>
<h2 id="connect-to-the-custom-tabs-service-and-call-warmup">Connect to the Custom Tabs service and call <code>warmup()</code></h2>
<p>You can <strong>save up to 700 ms</strong> when opening a link with the Custom Tabs by connecting to the service and pre-loading the browser.</p>
<p>Connect to the Custom Tabs service on the <a href="https://developer.android.com/reference/android/app/Activity.html#onStart()"><code>onStart()</code></a> method of the Activities you plan to launch a Custom Tab from. Upon connection, call <a href="https://developer.android.com/reference/androidx/browser/customtabs/CustomTabsClient#warmup(long)"><code>warmup()</code></a>.</p>
<p>The loading happens as a low priority process, meaning that <strong>it won’t have any negative performance impact on your application</strong>, but will give a big performance boost when loading a link.</p>
<h2 id="pre-render-content">Pre-render content</h2>
<p>Pre-rendering will make external content open instantly. So, as if your user has <strong>at least a 50%</strong> likelihood of clicking on the link, call the <a href="https://developer.android.com/reference/androidx/browser/customtabs/CustomTabsSession#mayLaunchUrl(android.net.Uri,%20android.os.Bundle,%20java.util.List%3Candroid.os.Bundle%3E)"><code>mayLaunchUrl()</code></a> method.</p>
<p>Calling <a href="https://developer.android.com/reference/androidx/browser/customtabs/CustomTabsSession#mayLaunchUrl(android.net.Uri,%20android.os.Bundle,%20java.util.List%3Candroid.os.Bundle%3E)"><code>mayLaunchUrl()</code></a> will make Custom Tabs pre-fetch the main page with the supporting content and pre-render. This will give the maximum speed up to the page loading process, but <strong>comes with a network and battery cost</strong>.</p>
<p>Custom Tabs is smart and knows if the user is using the phone on a metered network or if it’s a low end device and pre-rendering will have a negative effect on the overall performance of the device and won’t pre-fetch or pre-render on those scenarios. So, there’s no need to optimize your application for those cases.</p>
<h2 id="provide-a-fallback-for-when-custom-tabs-is-not-installed">Provide a fallback for when Custom Tabs is not installed</h2>
<p>Although Custom Tabs is available for the great majority of users, there are some scenarios where a browser that supports Custom Tabs is not installed on the device or the device does not support a browser version that has Custom Tabs enabled.</p>
<p><strong>Make sure to provide a fallback that provides a good user experience</strong> by either opening the default browser or using your own <a href="https://developer.android.com/reference/android/webkit/WebView.html">WebView</a> implementation.</p>
<h2 id="add-your-app-as-the-referrer">Add your app as the referrer</h2>
<p>It’s usually very important for websites to track where their traffic is coming from. Make sure you let them know you are sending them users by setting the referrer when launching your Custom Tab:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1">intent.<span class="fu">putExtra</span>(Intent.<span class="fu">EXTRA_REFERRER</span>, </a>
<a class="sourceLine" id="cb1-2" title="2">        Uri.<span class="fu">parse</span>(<span class="st">&quot;android-app://&quot;</span> + context.<span class="fu">getPackageName</span>()));</a></code></pre></div>
<h2 id="add-custom-animations">Add custom animations</h2>
<p>Custom animations will make the transition from your application to the web content smoother. Make sure the finish animation is the reverse of the start animation, as it will help the user understand them returning to the content where the navigation started.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" title="1"><span class="co">//Setting custom enter/exit animations</span></a>
<a class="sourceLine" id="cb2-2" title="2">CustomTabsIntent.<span class="fu">Builder</span> intentBuilder = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>();</a>
<a class="sourceLine" id="cb2-3" title="3">intentBuilder.<span class="fu">setStartAnimations</span>(<span class="kw">this</span>, R.<span class="fu">anim</span>.<span class="fu">slide_in_right</span>, R.<span class="fu">anim</span>.<span class="fu">slide_out_left</span>);</a>
<a class="sourceLine" id="cb2-4" title="4">intentBuilder.<span class="fu">setExitAnimations</span>(<span class="kw">this</span>, android.<span class="fu">R</span>.<span class="fu">anim</span>.<span class="fu">slide_in_left</span>,</a>
<a class="sourceLine" id="cb2-5" title="5">    android.<span class="fu">R</span>.<span class="fu">anim</span>.<span class="fu">slide_out_right</span>);</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">//Open the Custom Tab        </span></a>
<a class="sourceLine" id="cb2-8" title="8">intentBuilder.<span class="fu">build</span>().<span class="fu">launchUrl</span>(context, Uri.<span class="fu">parse</span>(<span class="st">&quot;https://developer.chrome.com/&quot;</span>));        </a></code></pre></div>
<h2 id="choosing-an-icon-for-the-action-button">Choosing an icon for the Action Button</h2>
<p>Adding an Action Button will make users engage more with your app features. But, if there isn’t a good icon to represent the action your Action Button will perform, create a bitmap with a text describing the action.</p>
<p>Remember the maximum size for the bitmap is 24dp height x 48dp width.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" title="1"><span class="bu">String</span> shareLabel = <span class="fu">getString</span>(R.<span class="fu">string</span>.<span class="fu">label_action_share</span>);</a>
<a class="sourceLine" id="cb3-2" title="2">Bitmap icon = BitmapFactory.<span class="fu">decodeResource</span>(<span class="fu">getResources</span>(),</a>
<a class="sourceLine" id="cb3-3" title="3">        android.<span class="fu">R</span>.<span class="fu">drawable</span>.<span class="fu">ic_menu_share</span>);</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">//Create a PendingIntent to your BroadCastReceiver implementation</span></a>
<a class="sourceLine" id="cb3-6" title="6">Intent actionIntent = <span class="kw">new</span> <span class="fu">Intent</span>(</a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="kw">this</span>.<span class="fu">getApplicationContext</span>(), ShareBroadcastReceiver.<span class="fu">class</span>);</a>
<a class="sourceLine" id="cb3-8" title="8">PendingIntent pendingIntent = </a>
<a class="sourceLine" id="cb3-9" title="9">        PendingIntent.<span class="fu">getBroadcast</span>(<span class="fu">getApplicationContext</span>(), <span class="dv">0</span>, actionIntent, <span class="dv">0</span>);            </a>
<a class="sourceLine" id="cb3-10" title="10"></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">//Set the pendingIntent as the action to be performed when the button is clicked.            </span></a>
<a class="sourceLine" id="cb3-12" title="12">intentBuilder.<span class="fu">setActionButton</span>(icon, shareLabel, pendingIntent);</a></code></pre></div>
<h2 id="preparing-for-other-browsers">Preparing for other browsers</h2>
<p>Remember the user may have more than one browser installed that supports Custom Tabs. If there’s more than one browser that supports Custom Tabs and none if them is the preferred browser, ask the user how they want to open the link:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="co">*</span> Returns a list of packages that support Custom Tabs<span class="co">.</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="co">*/</span>    </a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">public</span> <span class="dt">static</span> <span class="bu">ArrayList</span>&lt;ResolveInfo&gt; <span class="fu">getCustomTabsPackages</span>(<span class="bu">Context</span> context) {</a>
<a class="sourceLine" id="cb4-5" title="5">    PackageManager pm = context.<span class="fu">getPackageManager</span>();</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="co">// Get default VIEW intent handler.</span></a>
<a class="sourceLine" id="cb4-7" title="7">    Intent activityIntent = <span class="kw">new</span> <span class="fu">Intent</span>()</a>
<a class="sourceLine" id="cb4-8" title="8">        .<span class="fu">setAction</span>(Intent.<span class="fu">ACTION_VIEW</span>)</a>
<a class="sourceLine" id="cb4-9" title="9">        .<span class="fu">addCategory</span>(Intent.<span class="fu">CATEGORY_BROWSABLE</span>)</a>
<a class="sourceLine" id="cb4-10" title="10">        .<span class="fu">setData</span>(Uri.<span class="fu">fromParts</span>(<span class="st">&quot;http&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">null</span>));</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">    <span class="co">// Get all apps that can handle VIEW intents.</span></a>
<a class="sourceLine" id="cb4-13" title="13">    <span class="bu">List</span>&lt;ResolveInfo&gt; resolvedActivityList = pm.<span class="fu">queryIntentActivities</span>(activityIntent, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="bu">ArrayList</span>&lt;ResolveInfo&gt; packagesSupportingCustomTabs = <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;&gt;();</a>
<a class="sourceLine" id="cb4-15" title="15">    <span class="kw">for</span> (ResolveInfo info : resolvedActivityList) {</a>
<a class="sourceLine" id="cb4-16" title="16">        Intent serviceIntent = <span class="kw">new</span> <span class="fu">Intent</span>();</a>
<a class="sourceLine" id="cb4-17" title="17">        serviceIntent.<span class="fu">setAction</span>(ACTION_CUSTOM_TABS_CONNECTION);</a>
<a class="sourceLine" id="cb4-18" title="18">        serviceIntent.<span class="fu">setPackage</span>(info.<span class="fu">activityInfo</span>.<span class="fu">packageName</span>);</a>
<a class="sourceLine" id="cb4-19" title="19">        <span class="co">// Check if this package also resolves the Custom Tabs service.</span></a>
<a class="sourceLine" id="cb4-20" title="20">        <span class="kw">if</span> (pm.<span class="fu">resolveService</span>(serviceIntent, <span class="dv">0</span>) != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb4-21" title="21">            packagesSupportingCustomTabs.<span class="fu">add</span>(info);</a>
<a class="sourceLine" id="cb4-22" title="22">        }</a>
<a class="sourceLine" id="cb4-23" title="23">    }</a>
<a class="sourceLine" id="cb4-24" title="24">    <span class="kw">return</span> packagesSupportingCustomTabs;</a>
<a class="sourceLine" id="cb4-25" title="25">}</a></code></pre></div>
<h3 id="applications-targeting-android-11-api-level-30-or-above">Applications targeting Android 11 (API level 30) or above</h3>
<p>Android 11 has introduced <a href="https://developer.android.com/preview/privacy/package-visibility">package visibility changes</a>. If your Android app is targeting API level 30 or above, adding a <code>queries</code> section to <code>AndroidManifest.xml</code> is needed, otherwise the code snippet above won’t return results:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&lt;queries&gt;</span></a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="kw">&lt;intent&gt;</span></a>
<a class="sourceLine" id="cb5-3" title="3">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span></a>
<a class="sourceLine" id="cb5-4" title="4">            <span class="st">&quot;android.support.customtabs.action.CustomTabsService&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">&lt;/intent&gt;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">&lt;/queries&gt;</span></a></code></pre></div>
<h2 id="allow-the-user-to-opt-out-of-custom-tabs">Allow the user to opt out of Custom Tabs</h2>
<p>Add an option into the application for the user to open links in the default browser instead of using a Custom Tab. This is specially important if the application opened the link using the browser before adding support for Custom Tabs.</p>
<h2 id="let-native-applications-handle-the-content">Let native applications handle the content</h2>
<p>Some URLs can be handled by native applications. If the user has the Twitter app installed and clicks on a link to a tweet. They expect that the Twitter application will handle it.</p>
<p>Before opening an url from your application, check if a native alternative is available and use it.</p>
<h3 id="on-android-11-and-above">On Android 11 and above</h3>
<p>Android 11 introduces a new Intent flag, <a href="https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_REQUIRE_NON_BROWSER"><code>FLAG_ACTIVITY_REQUIRE_NON_BROWSER</code></a>, which is the recommended way to try opening a native app, as it doesn’t require the app to declare any package manager queries.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1"><span class="dt">static</span> <span class="dt">boolean</span> <span class="fu">launchNativeApi30</span>(<span class="bu">Context</span> context, Uri uri) {</a>
<a class="sourceLine" id="cb6-2" title="2">    Intent nativeAppIntent = <span class="kw">new</span> <span class="fu">Intent</span>(Intent.<span class="fu">ACTION_VIEW</span>, uri)</a>
<a class="sourceLine" id="cb6-3" title="3">            .<span class="fu">addCategory</span>(Intent.<span class="fu">CATEGORY_BROWSABLE</span>)</a>
<a class="sourceLine" id="cb6-4" title="4">            .<span class="fu">addFlags</span>(Intent.<span class="fu">FLAG_ACTIVITY_NEW_TASK</span> |</a>
<a class="sourceLine" id="cb6-5" title="5">                    Intent.<span class="fu">FLAG_ACTIVITY_REQUIRE_NON_BROWSER</span>);</a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb6-7" title="7">        context.<span class="fu">startActivity</span>(nativeAppIntent);</a>
<a class="sourceLine" id="cb6-8" title="8">        <span class="kw">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb6-9" title="9">    } <span class="kw">catch</span> (ActivityNotFoundException ex) {</a>
<a class="sourceLine" id="cb6-10" title="10">        <span class="kw">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb6-11" title="11">    }</a>
<a class="sourceLine" id="cb6-12" title="12">}</a></code></pre></div>
<p>The solution is to try to launch the Intent and use <code>FLAG_ACTIVITY_REQUIRE_NON_BROWSER</code> to ask Android to avoid browsers when launching.</p>
<p>If a native app that is capable of handling this Intent is not found, an <code>ActivityNotFoundException</code> will be thrown.</p>
<h3 id="before-android-11">Before Android 11</h3>
<p>Even though the application may target Android 11, or API level 30, previous Android versions will not understand the <code>FLAG_ACTIVITY_REQUIRE_NON_BROWSER</code> flag, so we need to resort to querying the Package Manager in those cases:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">private</span> <span class="dt">static</span> <span class="dt">boolean</span> <span class="fu">launchNativeBeforeApi30</span>(<span class="bu">Context</span> context, Uri uri) {</a>
<a class="sourceLine" id="cb7-2" title="2">    PackageManager pm = context.<span class="fu">getPackageManager</span>();</a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="co">// Get all Apps that resolve a generic url</span></a>
<a class="sourceLine" id="cb7-5" title="5">    Intent browserActivityIntent = <span class="kw">new</span> <span class="fu">Intent</span>()</a>
<a class="sourceLine" id="cb7-6" title="6">            .<span class="fu">setAction</span>(Intent.<span class="fu">ACTION_VIEW</span>)</a>
<a class="sourceLine" id="cb7-7" title="7">            .<span class="fu">addCategory</span>(Intent.<span class="fu">CATEGORY_BROWSABLE</span>)</a>
<a class="sourceLine" id="cb7-8" title="8">            .<span class="fu">setData</span>(Uri.<span class="fu">fromParts</span>(<span class="st">&quot;http&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">null</span>));</a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="bu">Set</span>&lt;<span class="bu">String</span>&gt; genericResolvedList = <span class="fu">extractPackageNames</span>(</a>
<a class="sourceLine" id="cb7-10" title="10">            pm.<span class="fu">queryIntentActivities</span>(browserActivityIntent, <span class="dv">0</span>));</a>
<a class="sourceLine" id="cb7-11" title="11"></a>
<a class="sourceLine" id="cb7-12" title="12">    <span class="co">// Get all apps that resolve the specific Url</span></a>
<a class="sourceLine" id="cb7-13" title="13">    Intent specializedActivityIntent = <span class="kw">new</span> <span class="fu">Intent</span>(Intent.<span class="fu">ACTION_VIEW</span>, uri)</a>
<a class="sourceLine" id="cb7-14" title="14">            .<span class="fu">addCategory</span>(Intent.<span class="fu">CATEGORY_BROWSABLE</span>);</a>
<a class="sourceLine" id="cb7-15" title="15">    <span class="bu">Set</span>&lt;<span class="bu">String</span>&gt; resolvedSpecializedList = <span class="fu">extractPackageNames</span>(</a>
<a class="sourceLine" id="cb7-16" title="16">            pm.<span class="fu">queryIntentActivities</span>(specializedActivityIntent, <span class="dv">0</span>));</a>
<a class="sourceLine" id="cb7-17" title="17"></a>
<a class="sourceLine" id="cb7-18" title="18">    <span class="co">// Keep only the Urls that resolve the specific, but not the generic</span></a>
<a class="sourceLine" id="cb7-19" title="19">    <span class="co">// urls.</span></a>
<a class="sourceLine" id="cb7-20" title="20">    resolvedSpecializedList.<span class="fu">removeAll</span>(genericResolvedList);</a>
<a class="sourceLine" id="cb7-21" title="21"></a>
<a class="sourceLine" id="cb7-22" title="22">    <span class="co">// If the list is empty, no native app handlers were found.</span></a>
<a class="sourceLine" id="cb7-23" title="23">    <span class="kw">if</span> (resolvedSpecializedList.<span class="fu">isEmpty</span>()) {</a>
<a class="sourceLine" id="cb7-24" title="24">        <span class="kw">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb7-25" title="25">    }</a>
<a class="sourceLine" id="cb7-26" title="26"></a>
<a class="sourceLine" id="cb7-27" title="27">    <span class="co">// We found native handlers. Launch the Intent.</span></a>
<a class="sourceLine" id="cb7-28" title="28">    specializedActivityIntent.<span class="fu">addFlags</span>(Intent.<span class="fu">FLAG_ACTIVITY_NEW_TASK</span>);</a>
<a class="sourceLine" id="cb7-29" title="29">    context.<span class="fu">startActivity</span>(specializedActivityIntent);</a>
<a class="sourceLine" id="cb7-30" title="30">    <span class="kw">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb7-31" title="31">}</a></code></pre></div>
<p>The approach used here is to query the Package Manager for applications that support a generic “http” intent. Those applications are likely browsers.</p>
<p>Then, query for applications that handle itents for the specific URL we want to launch. This will return both browsers and native applications setup to handle that URL.</p>
<p>Now, remove all browsers found on the first list from the second list, and we’ll be left only with native apps.</p>
<p>If the list is empty, we know there are no native handlers and return false. Otherwise, we launch the intent for the native handler.</p>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>We need to ensure using the right method for each occasion:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">static</span> <span class="dt">void</span> <span class="fu">launchUri</span>(<span class="bu">Context</span> context, Uri uri) {</a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="dt">boolean</span> launched = Build.<span class="fu">VERSION</span>.<span class="fu">SDK_INT</span> &gt;= <span class="dv">30</span> ?</a>
<a class="sourceLine" id="cb8-3" title="3">            <span class="fu">launchNativeApi30</span>(context, uri) :</a>
<a class="sourceLine" id="cb8-4" title="4">            <span class="fu">launchNativeBeforeApi30</span>(context, uri);</a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">if</span> (!launched) {</a>
<a class="sourceLine" id="cb8-7" title="7">        <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>()</a>
<a class="sourceLine" id="cb8-8" title="8">                .<span class="fu">build</span>()</a>
<a class="sourceLine" id="cb8-9" title="9">                .<span class="fu">launchUrl</span>(context, uri);</a>
<a class="sourceLine" id="cb8-10" title="10">    }</a>
<a class="sourceLine" id="cb8-11" title="11">}</a></code></pre></div>
<p><code>Build.VERSION.SDK_INT</code> provides the information we need. If it’s equal or larger than 30, Android knows the <code>FLAG_ACTIVITY_REQUIRE_NON_BROWSER</code> and we can try launching a nativa app with the new approach. Otherwise, we try launching with the old approach.</p>
<p>If launching a native app fails, we then launch a Custom Tabs.</p>
<h2 id="customize-the-toolbar-color">Customize the toolbar color</h2>
<p>Customize with your application’s primary color if you want the user to feel that the content is a part of your application.</p>
<p>If you want to make it clear for the user that they have left your application, don’t customize the color at all.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb9-1" title="1"><span class="co">//Setting a custom toolbar color</span></a>
<a class="sourceLine" id="cb9-2" title="2">CustomTabsIntent.<span class="fu">Builder</span> intentBuilder = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>();</a>
<a class="sourceLine" id="cb9-3" title="3">intentBuilder.<span class="fu">setToolbarColor</span>(<span class="bu">Color</span>.<span class="fu">BLUE</span>);</a></code></pre></div>
<h2 id="enable-the-default-share-action-or-add-your-own">Enable the default Share Action or add your own</h2>
<p>Make sure you enable the Share Action to the overflow menu, as users expect to be able to share the link to the content they are seeing in most use cases:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb10-1" title="1">    CustomTabsIntent.<span class="fu">Builder</span> intentBuilder = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>();</a>
<a class="sourceLine" id="cb10-2" title="2">    intentBuilder.<span class="fu">setShareState</span>(CustomTabsIntent.<span class="fu">SHARE_STATE_ON</span>);</a></code></pre></div>
<h2 id="customize-the-close-button">Customize the close button</h2>
<p>Customize the close button to make the Custom Tab feel it is part of your application.</p>
<p>If you want the user to feel like Custom Tabs is a modal dialog, use the default <code>“X”</code> button. If you want the user to feel the Custom Tab is part of the application flow, use the back arrow.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb11-1" title="1">    <span class="co">//Setting a custom back button</span></a>
<a class="sourceLine" id="cb11-2" title="2">    CustomTabsIntent.<span class="fu">Builder</span> intentBuilder = <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>();</a>
<a class="sourceLine" id="cb11-3" title="3">    intentBuilder.<span class="fu">setCloseButtonIcon</span>(BitmapFactory.<span class="fu">decodeResource</span>(</a>
<a class="sourceLine" id="cb11-4" title="4">        <span class="fu">getResources</span>(), R.<span class="fu">drawable</span>.<span class="fu">ic_arrow_back</span>));</a></code></pre></div>
<h2 id="handle-internal-links">Handle internal links</h2>
<p>When intercepting clicks on links generated by <a href="https://developer.android.com/reference/android/widget/TextView.html#attr_android:autoLink">android:autoLink</a> or overriding clicks on links on WebViews, make sure that your application handles the internal links and let’s Custom Tabs handle the external ones.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb12-1" title="1">WebView webView = (WebView)<span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">webview</span>);</a>
<a class="sourceLine" id="cb12-2" title="2">webView.<span class="fu">setWebViewClient</span>(<span class="kw">new</span> <span class="fu">WebViewClient</span>() {</a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">shouldOverrideUrlLoading</span>(WebView view, <span class="bu">String</span> url) {</a>
<a class="sourceLine" id="cb12-5" title="5">        <span class="kw">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb12-6" title="6">    }</a>
<a class="sourceLine" id="cb12-7" title="7"></a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onLoadResource</span>(WebView view, <span class="bu">String</span> url) {</a>
<a class="sourceLine" id="cb12-10" title="10">        <span class="kw">if</span> (url.<span class="fu">startsWith</span>(<span class="st">&quot;http://www.example.com&quot;</span>)) {</a>
<a class="sourceLine" id="cb12-11" title="11">            <span class="co">//Handle Internal Link...</span></a>
<a class="sourceLine" id="cb12-12" title="12">        } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb12-13" title="13">            <span class="co">//Open Link in a Custom Tab</span></a>
<a class="sourceLine" id="cb12-14" title="14">            Uri uri = Uri.<span class="fu">parse</span>(url);</a>
<a class="sourceLine" id="cb12-15" title="15">            CustomTabsIntent.<span class="fu">Builder</span> intentBuilder =</a>
<a class="sourceLine" id="cb12-16" title="16">                    <span class="kw">new</span> CustomTabsIntent.<span class="fu">Builder</span>(mCustomTabActivityHelper.<span class="fu">getSession</span>());</a>
<a class="sourceLine" id="cb12-17" title="17">           <span class="co">//Open the Custom Tab        </span></a>
<a class="sourceLine" id="cb12-18" title="18">            intentBuilder.<span class="fu">build</span>().<span class="fu">launchUrl</span>(context, url));                            </a>
<a class="sourceLine" id="cb12-19" title="19">        }</a>
<a class="sourceLine" id="cb12-20" title="20">    }</a>
<a class="sourceLine" id="cb12-21" title="21">});</a></code></pre></div>
<h2 id="handle-multiple-clicks">Handle multiple clicks</h2>
<p>If you need to do any processing between the user clicking on a link and opening the Custom Tab, make sure it runs in under 100ms. Otherwise users will see the unresponsiveness and may try to click multiple times on the link.</p>
<p>If it’s not possible to avoid the delay, make sure you application is prepared for when a user clicks multiple times on the same link and does not open a Custom Tab multiple times.</p>
</body>
</html>
