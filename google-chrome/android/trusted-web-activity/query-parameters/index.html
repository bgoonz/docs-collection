<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-01-17" />
  <title>Passing Information to a Trusted Web Activity using Query Parameters</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Passing Information to a Trusted Web Activity using Query Parameters</h1>
<p class="date">2020-01-17</p>
</header>
<p>When using Trusted Web Activity in their applications, developers may need to pass information from the native part of the application into the Progressive Web App (PWA).</p>
<p>A common use-case for this is implementing custom analytics segmentations to measure installations and sessions started from the Trusted Web Activity. Query parameters can be added to the launch URL to implement this.</p>
<h2 id="modifying-the-start-url">Modifying the start URL</h2>
<p>If the parameter being passed to the PWA will remain the same across users and launches, the parameter can be appended directly to the launch URL. An example of this usage is when developers want to measure the number of navigation sessions created from a Trusted Web Activity.</p>
<h3 id="using-bubblewrap">Using Bubblewrap</h3>
<p><a href="https://github.com/GoogleChromeLabs/bubblewrap">Bubblewrap</a> is a tool created to help developers to creating a Project for an Android application that launches an existing PWAs using a Trusted Web Activity. It contains both a <a href="https://www.npmjs.com/package/@bubblewrap/core">library</a> and a <a href="https://www.npmjs.com/package/@bubblewrap/cli">Command Line Interface (CLI)</a>.</p>
<h4 id="creating-a-new-project">Creating a new project</h4>
<p>When using the <a href="https://www.npmjs.com/package/@bubblewrap/cli">Bubblewrap CLI</a>, a project is initialized with the <code>init</code> command, and creates default values from a Web Manifest, provided as a parameter:</p>
<pre class="shell"><code>bubblewrap init --manifest https://material.money/manifest.json</code></pre>
<p>The wizard will use the start_url from the Web Manifest as default and will ask users to confirm the value, giving developers the chance to add extra parameters to the url used to start the Progressive Web App.</p>
<p>{% Img src=“image/Vww75TFpThOgTNuASFM6UYfBAp53/7JihrLf0VHfAI3P7GP79.png”, alt=“Showing the Bubblewrap CLI output”, width=“704”, height=“281” %}</p>
<h4 id="modifying-an-existing-project">Modifying an existing project</h4>
<p>When Bubblewrap generates a project, information for that particular project is stored in a file called <code>twa-manifest.json</code>, in the project folder. To modify the start url for existing project, developers need to modify the file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="er">...</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">&quot;startUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;/?utm_source=trusted-web-activity&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="er">...</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>Then, re-generate the project files and apply the new start URL</p>
<pre class="shell"><code>bubblewrap update</code></pre>
<h3 id="using-android-studio">Using Android Studio</h3>
<p>When using Android Studio and the default LauncherActivity, the startUrl is defined as a meta tag inside AndroidManifest.xml, and we can change the URL used to launch the Trusted Web Activity by modifying it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;com.google.androidbrowserhelper.trusted.LauncherActivity&quot;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">    android:label=</span><span class="st">&quot;@string/app_name&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3">    ...</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="kw">&lt;meta-data</span><span class="ot"> android:name=</span><span class="st">&quot;android.support.customtabs.trusted.DEFAULT_URL&quot;</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ot">        android:value=</span><span class="st">&quot;https://svgomg.firebaseapp.com/?utm_source=trusted-web-activity&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb4-6" title="6">    ...</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">&lt;/activity&gt;</span></a></code></pre></div>
<p>Note: Bubblewrap takes care of ensuring the URLs across the application match the same origin and, therefore, uses a relative for start URL. When modifying AndroidManifest.xml, the entire URL, including schema and domain must be used.</p>
<h2 id="modifying-the-start-url-dynamically">Modifying the start URL dynamically</h2>
<p>In other cases, developers may want to create parameters that change across users or sessions, for instance. In most cases, this will involve collecting details from the Android side of the application to pass it to the Progressive Web App.</p>
<h3 id="step-1-create-a-custom-launcheractivity">Step 1: Create a custom LauncherActivity</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">public</span> <span class="kw">class</span> CustomQueryStringLauncherActivity <span class="kw">extends</span> LauncherActivity {</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">getDynamicParameterValue</span>() {</a>
<a class="sourceLine" id="cb5-3" title="3">        <span class="kw">return</span> <span class="bu">String</span>.<span class="fu">valueOf</span>((<span class="dt">int</span>)(<span class="bu">Math</span>.<span class="fu">random</span>() * <span class="dv">1000</span>));</a>
<a class="sourceLine" id="cb5-4" title="4">    }</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">protected</span> Uri <span class="fu">getLaunchingUrl</span>() {</a>
<a class="sourceLine" id="cb5-8" title="8">        <span class="co">// Get the original launch Url.</span></a>
<a class="sourceLine" id="cb5-9" title="9">        Uri uri = <span class="kw">super</span>.<span class="fu">getLaunchingUrl</span>();</a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">        <span class="co">// Get the value we want to use for the parameter value</span></a>
<a class="sourceLine" id="cb5-12" title="12">        <span class="bu">String</span> customParameterValue = <span class="fu">getDynamicParameterValue</span>();</a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14">        <span class="co">// Append the extra parameter to the launch Url</span></a>
<a class="sourceLine" id="cb5-15" title="15">        <span class="kw">return</span> uri</a>
<a class="sourceLine" id="cb5-16" title="16">                .<span class="fu">buildUpon</span>()</a>
<a class="sourceLine" id="cb5-17" title="17">                .<span class="fu">appendQueryParameter</span>(<span class="st">&quot;my_parameter&quot;</span>, customParameterValue)</a>
<a class="sourceLine" id="cb5-18" title="18">                .<span class="fu">build</span>();</a>
<a class="sourceLine" id="cb5-19" title="19">    }</a>
<a class="sourceLine" id="cb5-20" title="20">}</a></code></pre></div>
<h3 id="step-2-modify-the-androidmanifest.xml-to-use-the-custom-launcheractivity">Step 2: Modify the <code>AndroidManifest.xml</code> to use the custom LauncherActivity</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;com.myapp.CustomQueryStringLauncherActivity&quot;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ot">    android:label=</span><span class="st">&quot;@string/app_name&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb6-3" title="3">    ...</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">&lt;meta-data</span><span class="ot"> android:name=</span><span class="st">&quot;android.support.customtabs.trusted.DEFAULT_URL&quot;</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="ot">        android:value=</span><span class="st">&quot;https://squoosh.app/?utm_source=trusted-web-activity&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb6-6" title="6">    ...</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="kw">&lt;/activity&gt;</span></a></code></pre></div>
<p>Note: Bubblewrap doesn’t support dynamically generating query parameters at this moment. We’re interested in hearing from developers who have the need for this feature. Check out the Bubblewrap <a href="https://github.com/GoogleChromeLabs/bubblewrap/issues">issue tracker</a> and tell us about your use-case.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Passing information from the native part to the web part of an application can be achieved by using query parameters. When a parameter is added to the query string, it will be accessible to scripts running on the page and may also be part of the referral when users navigate to a different page or the developer implements a share action.</p>
<p>Developers must be aware of those implications, and can mitigate them using <a href="https://developers.google.com/web/tools/lighthouse/audits/noopener">link rel=noreferrer</a> or cleaning-up the URL using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Location">page location API</a>.</p>
<p>The Trusted Web Activity protocol doesn’t currently provide a mechanism to exchange messages with the native part of the application after the web part is invoked.</p>
<p>We believe existing or upcoming Web Platform APIs enable most use cases needed by developers. If you are looking for new or upcoming Web APIs, check out the <a href="https://web.dev/fugu-status/">New Capabilities status page</a>.</p>
</body>
</html>
