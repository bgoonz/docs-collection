<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-01-17" />
  <title>Multi-Origin Trusted Web Activities</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Multi-Origin Trusted Web Activities</h1>
<p class="date">2020-01-17</p>
</header>
<p>{% Aside %} If you are new to Trusted Web Activities, you may want to read the <a href="/docs/android/trusted-web-activity/quick-start">Trusted Web Activity Quick Start Guide</a> or the <a href="/docs/android/trusted-web-activity">Introduction to Trusted Web Activities</a> before reading this documentation. {% endAside%}</p>
<p><strong>Trusted Web Activities</strong> are a new way to integrate your web-app content such as your PWA with your Android app using a protocol based on Custom Tabs.</p>
<p>{% Img src=“image/Vww75TFpThOgTNuASFM6UYfBAp53/UezlUQRyJ17S0S1KPGO0.gif”, alt=“ff-origin navigation”, width=“200”, height=“411” %}</p>
<p>A Trusted Web Activity needs the origins being opened to be validated using <a href="https://developers.google.com/digital-asset-links">Digital Asset Links</a>, in order to show the content in full-screen.</p>
<p>When a user navigates off the validated origin, Custom Tab UI is shown. The URL bar in the Custom Tab tells the users they are now navigating in a domain outside the application, while also providing the user with an X button that allows them to quickly return to the validated origin.</p>
<p>But it is also common for Web Apps to create experiences that span multiple origins - An example would be a shopping application with the main experience at <em>www.example.com</em>, while the checkout flow is hosted at <em>checkout.example.com</em>.</p>
<p>In cases like that, showing the Custom Tabs is undesirable, not only because the user is in the same application, but also because the top bar could make the user think they left the application and abandon the checkout.</p>
<p>Trusted Web Activities allow developers to validate multiple origins, and the user will remain in full-screen when navigating across those origins. As with the main domain, the developer must be able to control each validated origin.</p>
<h2 id="setting-up-validation-for-multiple-origins">Setting up validation for multiple origins</h2>
<p>As in the main origin, the validation is achieved via Digital Asset Links and each domain to be validated needs to have its own assetlinks.json file.</p>
<h3 id="add-an-assetlinks-file-to-each-origin">Add an assetlinks file to each origin</h3>
<p>In our example with <em>www.example.com</em> and <em>checkout.example.com</em>, we would have:</p>
<ul>
<li><code>https://www.example.com/.well-known/assetlinks.json</code></li>
<li><code>https://checkout.example.com/.well-known/assetlinks.json</code></li>
</ul>
<p>Since each domain is getting connected to the same Android application, the <code>assetlinks.json</code> files look exactly the same.</p>
<p>Assuming the package name for the Android application is <code>com.example.twa</code>, both <code>assetlink.json</code> files would contain something similar to the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">[</span><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="dt">&quot;relation&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;delegate_permission/common.handle_all_urls&quot;</span><span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="dt">&quot;target&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="dt">&quot;namespace&quot;</span><span class="fu">:</span> <span class="st">&quot;android_app&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="dt">&quot;package_name&quot;</span><span class="fu">:</span> <span class="st">&quot;com.example&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-6" title="6">   <span class="dt">&quot;sha256_cert_fingerprints&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;...&quot;</span><span class="ot">]</span><span class="fu">}</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="fu">}</span><span class="ot">]</span></a></code></pre></div>
<p>Note: An application using Trusted Web Activities can have any number of validated domains, as long as Digital Asset Links are implemented for all of them.</p>
<h3 id="add-multiple-origins-to-the-android-application">Add multiple origins to the Android Application</h3>
<p>On the Android application, the <code>asset_statements</code> declaration needs to be updated to contain all origins that need to be validated:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">&lt;string</span><span class="ot"> name=</span><span class="st">&quot;asset_statements&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb2-2" title="2">[{</a>
<a class="sourceLine" id="cb2-3" title="3">    \&quot;relation\&quot;: [\&quot;delegate_permission/common.handle_all_urls\&quot;],</a>
<a class="sourceLine" id="cb2-4" title="4">    \&quot;target\&quot;: {</a>
<a class="sourceLine" id="cb2-5" title="5">        \&quot;namespace\&quot;: \&quot;web\&quot;,</a>
<a class="sourceLine" id="cb2-6" title="6">        \&quot;site\&quot;: \&quot;https://www.example.com\&quot;</a>
<a class="sourceLine" id="cb2-7" title="7">    }</a>
<a class="sourceLine" id="cb2-8" title="8">}],</a>
<a class="sourceLine" id="cb2-9" title="9">[{</a>
<a class="sourceLine" id="cb2-10" title="10">    \&quot;relation\&quot;: [\&quot;delegate_permission/common.handle_all_urls\&quot;],</a>
<a class="sourceLine" id="cb2-11" title="11">    \&quot;target\&quot;: {</a>
<a class="sourceLine" id="cb2-12" title="12">        \&quot;namespace\&quot;: \&quot;web\&quot;,</a>
<a class="sourceLine" id="cb2-13" title="13">        \&quot;site\&quot;: \&quot;https://checkout.example.com\&quot;</a>
<a class="sourceLine" id="cb2-14" title="14">    }</a>
<a class="sourceLine" id="cb2-15" title="15">}],</a>
<a class="sourceLine" id="cb2-16" title="16"><span class="kw">&lt;/string&gt;</span></a></code></pre></div>
<p>Note: Applications based on the <a href="https://github.com/GoogleChromeLabs/svgomg-twa">svgomg-twa demo</a> application or <a href="https://github.com/GoogleChromeLabs/bubblewrap">bubblewrap</a> have the <code>asset_statements</code> declaration inside <code>app/build.gradle</code>. Even though the location of the declaration is different, the JSON content is the same.</p>
<h2 id="add-extra-origins-to-the-launcheractivity">Add extra origins to the LauncherActivity</h2>
<h3 id="using-the-default-launcheractivity">Using the default LauncherActivity</h3>
<p>The <a href="https://github.com/GoogleChrome/android-browser-helper/blob/master/androidbrowserhelper/src/main/java/com/google/androidbrowserhelper/trusted/LauncherActivity.java"><code>LauncherActivity</code></a> that is part of the <a href="https://github.com/GoogleChrome/android-browser-helper/"><code>android-browser-helper</code></a> support library provides a way to add multiple origins to be validated by configuring the Android project.</p>
<p>First, add a <code>string-array</code> element to the <code>res/values/strings.xml</code> file. Each extra URL to be validated will be inside an <code>item</code> sub-element:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb3-1" title="1">...</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">&lt;string-array</span><span class="ot"> name=</span><span class="st">&quot;additional_trusted_origins&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="kw">&lt;item&gt;</span>https://www.google.com<span class="kw">&lt;/item&gt;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">&lt;/string-array&gt;</span></a>
<a class="sourceLine" id="cb3-5" title="5">...</a></code></pre></div>
<p>Next, add a new <code>meta-data</code> tag inside the existing activity element that references the <code>LauncherActivity</code>, inside <code>AndroidManifest.xml</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb4-1" title="1">...</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;com.google.androidbrowserhelper.trusted.LauncherActivity&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ot">    android:label=</span><span class="st">&quot;@string/app_name&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">&lt;meta-data</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="ot">        android:name=</span><span class="st">&quot;android.support.customtabs.trusted.ADDITIONAL_TRUSTED_ORIGINS&quot;</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="ot">        android:resource=</span><span class="st">&quot;@array/additional_trusted_origins&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11">    ...</a>
<a class="sourceLine" id="cb4-12" title="12"><span class="kw">&lt;/activity&gt;</span></a>
<a class="sourceLine" id="cb4-13" title="13">...</a></code></pre></div>
<h2 id="using-a-custom-launcheractivity">Using a custom LauncherActivity</h2>
<p>When using custom code to launch a Trusted Web Activity, adding extra origins can be achieved by calling <code>setAdditionalTrustedOrigins</code> when building the Intent to launch the Trusted Web Activity:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">launcherWithMultipleOrigins</span>(<span class="bu">View</span> view) {</a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; origins = <span class="bu">Arrays</span>.<span class="fu">asList</span>(</a>
<a class="sourceLine" id="cb5-3" title="3">      <span class="st">&quot;https://checkout.example.com/&quot;</span></a>
<a class="sourceLine" id="cb5-4" title="4">  );</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">  TrustedWebActivityIntentBuilder builder = <span class="kw">new</span> <span class="fu">TrustedWebActivityIntentBuilder</span>(LAUNCH_URI)</a>
<a class="sourceLine" id="cb5-8" title="8">      .<span class="fu">setAdditionalTrustedOrigins</span>(origins);</a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="kw">new</span> <span class="fu">TwaLauncher</span>(<span class="kw">this</span>).<span class="fu">launch</span>(builder, <span class="kw">null</span>, <span class="kw">null</span>);</a>
<a class="sourceLine" id="cb5-12" title="12">}</a></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>With those steps, the Trusted Web Activity is now ready to support multiple origins. android-browser-helper has a <a href="https://github.com/GoogleChrome/android-browser-helper/tree/master/demos/twa-multi-domain">sample application</a> for multi origin Trusted Web Activities. Make sure to check it.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Setting up Digital Asset Links has a few moving parts. If the application is still showing the Custom Tabs bar on the top, it’s likely that something is wrong with the configuration.</p>
<p>The <a href="/docs/android/trusted-web-activity/quick-start">Trusted Web Activity Quick Start Guide</a> has a great <a href="/docs/android/trusted-web-activity/quick-start#troubleshooting">troubleshooting section</a> on how to debug Digital Asset Link issues.</p>
<p>There’s also the amazing <a href="https://play.google.com/store/apps/details?id=dev.conn.assetlinkstool">Peter’s Asset Link Tool</a>, which helps debuggint Digital Asset Links on applications installed on the device..</p>
</body>
</html>
