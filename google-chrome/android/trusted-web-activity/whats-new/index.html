<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="dcterms.date" content="2020-12-02" />
    <title>What’s new for Web In Play</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">What’s new for Web In Play</h1>
      <p class="date">2020-12-02</p>
    </header>
    <p>
      Since
      <a href="/docs/android/trusted-web-activity/">Trusted Web Activity</a> was
      introduced last year, the Chrome team continues to work on the product,
      making it easier to use with Bubblewrap, adding new features like the
      upcoming Google Play Billing integration, and enabling it to work on more
      platforms, like Chrome OS. This article will summarize the latest and
      upcoming updates for Trusted Web Activity.
    </p>
    <h2 id="new-bubblewrap-and-trusted-web-activity-features">
      New Bubblewrap and Trusted Web Activity features
    </h2>
    <p>
      <a href="https://www.npmjs.com/package/@bubblewrap/cli">Bubblewrap</a>
      helps you create apps that launch your PWAs inside a Trusted Web Activity,
      without requiring knowledge of platform-specific tooling.
    </p>
    <h3 id="simplified-setup-flow">Simplified setup flow</h3>
    <p>
      Previously, using Bubblewrap required manually setting up the Java
      Development Kit and the Android SDK, both of which are error prone. The
      tool now offers to automatically download the external dependencies when
      run for the first time.
    </p>
    <p>
      You can still choose to use an existing installation of the dependencies,
      if you prefer to do so, and the new <code>doctor</code> command helps find
      issues and recommends fixes to the configuration, which can now be updated
      from the command line using the <code>updateConfig</code> command.
    </p>
    <h3 id="improved-wizard">Improved wizard</h3>
    <p>
      When creating a project with <code>init</code>, Bubblewrap needs
      information to generate the Android app. The tool extracts values from the
      Web App Manifest and provides defaults where possible.
    </p>
    <p>
      You can change those values when creating a new project, but previously
      the meaning of each field was not clear. The initialization dialogs were
      rebuilt with better descriptions and validation for each input field.
    </p>
    <h3 id="display-fullscreen-and-orientation-support">
      display: fullscreen and orientation support
    </h3>
    <p>
      In some cases, you may want your application to use as much of the screen
      as possible and, when building PWAs, this is implemented by setting the
      <code>display</code> field from the Web App Manifest to
      <code>fullscreen</code>.
    </p>
    <p>
      When Bubblewrap detects the fullscreen option in the Web App Manifest, it
      will configure the Android application to also launch in full screen, or
      <a href="https://developer.android.com/training/system-ui/immersive"
        >immersive mode</a
      >, in Android specific terms.
    </p>
    <p>
      The <code>orientation</code> field from the Web App Manifest defines
      whether the application should be started in portrait mode, landscape
      mode, or in the orientation the device is currently using. Bubblewrap now
      reads the Web App Manifest field and uses it as a default when creating
      the Android app.
    </p>
    <p>
      You can customize both configurations can be customized as part of the
      <code>bubblewrap init</code> flow.
    </p>
    <h3 id="appbundles-output">AppBundles Output</h3>
    <p>
      <a href="https://developer.android.com/guide/app-bundle">App Bundles</a>
      is a publishing format for apps that delegates the final APK generation
      and signing to Play. In practice, this enables smaller files to be served
      to users when downloading the app from the store.
    </p>
    <p>
      Bubblewrap now packages the application as an App Bundle, in a file called
      <code>app-release-bundle.aab</code>. You should prefer this format when
      publishing apps to the Play Store as it will be
      <a
        href="https://android-developers.googleblog.com/2020/08/recent-android-app-bundle-improvements.html"
        >required by the store starting in the second half of 2021</a
      >.
    </p>
    <h3 id="geolocation-delegation">Geolocation delegation</h3>
    <p>
      Users expect applications installed on their devices to behave
      consistently, regardless of technology. When used inside a Trusted Web
      Activity, the
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API"
        >GeoLocation</a
      >
      permission can now be delegated to the Operating System and, when enabled,
      users will see the same dialogs as apps built with Kotlin or Java, and
      find controls to manage the permission in the same place.
    </p>
    <p>
      The feature can be added via Bubblewrap and, since it adds extra
      dependencies to the Android project, you should only enable it when the
      web app is using the Geolocation permission.
    </p>
    <h3 id="optimized-binaries">Optimized binaries</h3>
    <p>
      Devices with limited storage are common in certain areas of the world, and
      owners of those devices frequently prefer smaller applications.
      Applications using Trusted Web Activity produce small binaries, which
      removes some of the anxiety from those users.
    </p>
    <p>
      Bubblewrap has been optimized by reducing the list of needed Android
      libraries, resulting in generated binaries that are 800k smaller. In
      practice, that’s less than half the average size generated by previous
      versions. To take advantage of the smaller binaries, you only need to
      update your app using the latest version of Bubblewrap.
    </p>
    <h3 id="how-to-update-an-existing-app">How to update an existing app</h3>
    <p>
      An application generated by Bubblewrap is composed of a web application
      and a lightweight Android wrapper that opens the PWA. Even though the PWA
      opened inside a Trusted Web Activity follows the same update cycles as any
      web app, the native wrapper can and should be updated.
    </p>
    <p>
      You should update your app to ensure it is using the latest version of the
      wrapper, with the latest bug fixes and features. With the latest version
      of Bubblewrap installed, the <code>update</code> command will apply the
      latest version of the wrapper to an existing project:
    </p>
    <pre class="shell"><code>npm update -g @bubblewrap/cli
bubblewrap update
bubblewrap build</code></pre>
    <p>
      Another reason to update those applications is ensuring that changes to
      the Web Manifest are applied to the application. Use the new
      <code>merge</code> command for that:
    </p>
    <pre class="shell"><code>bubblewrap merge
bubblewrap update
bubblewrap build</code></pre>
    <h2 id="updates-to-the-quality-criteria">
      Updates to the Quality Criteria
    </h2>
    <p>
      Chrome 86 introduced changes to the Trusted Web Activity Quality Criteria,
      which are explained in full in
      <a
        href="https://blog.chromium.org/2020/06/changes-to-quality-criteria-for-pwas.html"
        >Changes to quality criteria for PWAs using Trusted Web Activity</a
      >.
    </p>
    <p>
      A quick summary is that you should ensure your applications handle the
      following scenarios to prevent them from crashing:
    </p>
    <ul>
      <li>Failure to verify digital asset links at application launch</li>
      <li>
        Failure to return HTTP 200 for an offline network resource request
      </li>
      <li>Return of an HTTP 404 or 5xx error in the application.</li>
    </ul>
    <p>
      Besides ensuring that the application passes the
      <a
        href="/docs/android/trusted-web-activity/integration-guide#link-site-to-app"
        >Digital Asset Links validation</a
      >, the remaining scenarios can be handled by a service worker:
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">&#39;fetch&#39;</span><span class="op">,</span> event <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="va">event</span>.<span class="at">respondWith</span>((<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">      <span class="cf">return</span> <span class="cf">await</span> <span class="at">fetchAndHandleError</span>(<span class="va">event</span>.<span class="at">request</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-6" title="6">      <span class="co">// Failed to load from the network. User is offline or the response</span></a>
<a class="sourceLine" id="cb3-7" title="7">      <span class="co">// has a status code that triggers the Quality Criteria.</span></a>
<a class="sourceLine" id="cb3-8" title="8">      <span class="co">// Try loading from cache.</span></a>
<a class="sourceLine" id="cb3-9" title="9">      <span class="kw">const</span> cachedResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">match</span>(<span class="va">event</span>.<span class="at">request</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-10" title="10">      <span class="cf">if</span> (cachedResponse) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-11" title="11">        <span class="cf">return</span> cachedResponse<span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" title="12">      <span class="op">}</span></a>
<a class="sourceLine" id="cb3-13" title="13">      <span class="co">// Response was not found on the cache. Send the error / offline</span></a>
<a class="sourceLine" id="cb3-14" title="14">      <span class="co">// page. OFFLINE_PAGE should be pre-cached when the service worker</span></a>
<a class="sourceLine" id="cb3-15" title="15">      <span class="co">// is activated.</span></a>
<a class="sourceLine" id="cb3-16" title="16">      <span class="cf">return</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">match</span>(OFFLINE_PAGE)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-18" title="18">  <span class="op">}</span>)())<span class="op">;</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-20" title="20"></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="kw">async</span> <span class="kw">function</span> <span class="at">fetchAndHandleError</span>(request) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-22" title="22">  <span class="kw">const</span> cache <span class="op">=</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">open</span>(RUNTIME_CACHE)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-23" title="23">  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(request)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-24" title="24"></a>
<a class="sourceLine" id="cb3-25" title="25">  <span class="co">// Throw an error if the response returns one of the status</span></a>
<a class="sourceLine" id="cb3-26" title="26">  <span class="co">// that trigger the Quality Criteria.</span></a>
<a class="sourceLine" id="cb3-27" title="27">  <span class="cf">if</span> (<span class="va">response</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span> <span class="op">||</span></a>
<a class="sourceLine" id="cb3-28" title="28">      <span class="va">response</span>.<span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">500</span> <span class="op">&amp;&amp;</span> <span class="va">response</span>.<span class="at">status</span> <span class="op">&lt;</span> <span class="dv">600</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-29" title="29">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="vs">`Server responded with status: </span><span class="sc">${</span><span class="va">response</span>.<span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-30" title="30">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-31" title="31"></a>
<a class="sourceLine" id="cb3-32" title="32">  <span class="co">// Cache the response if the request is successful.</span></a>
<a class="sourceLine" id="cb3-33" title="33">  <span class="va">cache</span>.<span class="at">put</span>(request<span class="op">,</span> <span class="va">response</span>.<span class="at">clone</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb3-34" title="34">  <span class="cf">return</span> response<span class="op">;</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="op">}</span></a></code></pre>
    </div>
    <p>
      <a href="https://developers.google.com/web/tools/workbox">Workbox</a>
      bakes in best practices and removes boilerplate when using service
      workers. Alternatively, consider using a Workbox plugin to handle those
      scenarios:
    </p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="im">export</span> <span class="kw">class</span> FallbackOnErrorPlugin <span class="op">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="at">constructor</span>(offlineFallbackUrl<span class="op">,</span> notFoundFallbackUrl<span class="op">,</span> serverErrorFallbackUrl) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">this</span>.<span class="at">notFoundFallbackUrl</span> <span class="op">=</span> notFoundFallbackUrl<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="kw">this</span>.<span class="at">offlineFallbackUrl</span> <span class="op">=</span> offlineFallbackUrl<span class="op">;</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">this</span>.<span class="at">serverErrorFallbackUrl</span> <span class="op">=</span> serverErrorFallbackUrl<span class="op">;</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-7" title="7"></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="at">checkTrustedWebActivityCrash</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="cf">if</span> (<span class="va">response</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span> <span class="op">||</span> <span class="va">response</span>.<span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">500</span> <span class="op">&amp;&amp;</span> <span class="va">response</span>.<span class="at">status</span> <span class="op">&lt;=</span> <span class="dv">600</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-10" title="10">      <span class="kw">const</span> type <span class="op">=</span> <span class="va">response</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span> <span class="op">?</span> <span class="st">&#39;E_NOT_FOUND&#39;</span> : <span class="st">&#39;E_SERVER_ERROR&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-11" title="11">      <span class="kw">const</span> error <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="vs">`Invalid response status (</span><span class="sc">${</span><span class="va">response</span>.<span class="at">status</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-12" title="12">      <span class="va">error</span>.<span class="at">type</span> <span class="op">=</span> type<span class="op">;</span></a>
<a class="sourceLine" id="cb4-13" title="13">      <span class="cf">throw</span> error<span class="op">;</span></a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="co">// This is called whenever there&#39;s a network response,</span></a>
<a class="sourceLine" id="cb4-18" title="18">  <span class="co">// but we want special behavior for 404 and 5**.</span></a>
<a class="sourceLine" id="cb4-19" title="19">  <span class="at">fetchDidSucceed</span>(<span class="op">{</span>response<span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-20" title="20">    <span class="co">// Cause a crash if this is a Trusted Web Activity crash.</span></a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="kw">this</span>.<span class="at">checkTrustedWebActivityCrash</span>(response)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-22" title="22"></a>
<a class="sourceLine" id="cb4-23" title="23">    <span class="co">// If it&#39;s a good response, it can be used as-is.</span></a>
<a class="sourceLine" id="cb4-24" title="24">    <span class="cf">return</span> response<span class="op">;</span></a>
<a class="sourceLine" id="cb4-25" title="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-26" title="26"></a>
<a class="sourceLine" id="cb4-27" title="27">  <span class="co">// This callback is new in Workbox v6, and is triggered whenever</span></a>
<a class="sourceLine" id="cb4-28" title="28">  <span class="co">// an error (including a NetworkError) is thrown when a handler runs.</span></a>
<a class="sourceLine" id="cb4-29" title="29">  <span class="at">handlerDidError</span>(details) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="kw">let</span> fallbackURL<span class="op">;</span></a>
<a class="sourceLine" id="cb4-31" title="31">    <span class="cf">switch</span> (<span class="va">details</span>.<span class="va">error</span>.<span class="va">details</span>.<span class="va">error</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-32" title="32">      <span class="cf">case</span> <span class="st">&#39;E_NOT_FOUND&#39;</span><span class="op">:</span> fallbackURL <span class="op">=</span> <span class="kw">this</span>.<span class="at">notFoundFallbackUrl</span><span class="op">;</span> <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-33" title="33">      <span class="cf">case</span> <span class="st">&#39;E_SERVER_ERROR&#39;</span><span class="op">:</span> fallbackURL <span class="op">=</span> <span class="kw">this</span>.<span class="at">serverErrorFallbackUrl</span><span class="op">;</span> <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-34" title="34">      <span class="cf">default</span><span class="op">:</span> fallbackURL <span class="op">=</span> <span class="kw">this</span>.<span class="at">offlineFallbackUrl</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-35" title="35">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-36" title="36"></a>
<a class="sourceLine" id="cb4-37" title="37">    <span class="cf">return</span> <span class="va">caches</span>.<span class="at">match</span>(fallbackURL<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-38" title="38">      <span class="co">// Use ignoreSearch as a shortcut to work with precached URLs</span></a>
<a class="sourceLine" id="cb4-39" title="39">      <span class="co">// that have _WB_REVISION parameters.</span></a>
<a class="sourceLine" id="cb4-40" title="40">      <span class="dt">ignoreSearch</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-41" title="41">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-43" title="43"><span class="op">}</span></a></code></pre>
    </div>
    <h2 id="google-play-billing">Google Play Billing</h2>
    <p>
      Besides allowing your app to sell digital goods and subscriptions on the
      Play Store,
      <a href="https://developer.android.com/google/play/billing"
        >Google Play Billing</a
      >
      offers tools for managing your catalog, prices and subscriptions, useful
      reports, and a checkout flow powered by the Play Store that is already
      familiar to your users. It is also a requirement for applications
      published on the Play Store that sell digital goods.
    </p>
    <p>
      Chrome 88 will launch with an origin trial on Android that enables the
      integration of
      <a href="/docs/android/trusted-web-activity/">Trusted Web Activities</a>,
      the
      <a href="https://www.w3.org/TR/payment-request/">Payment Request API</a>
      and the
      <a href="https://github.com/WICG/digital-goods">Digital Goods API</a> to
      implement purchase flows via Google Play Billing. We expect this Origin
      Trial to also be available for Chrome OS on version 89.
    </p>
    <p>
      <strong>Important:</strong> The Google Play Billing API has its own
      <a href="https://developer.android.com/google/play/billing/terminology"
        >terminology</a
      >
      and includes client and backend components. This section covers only a
      small part of the API that is specific to using the Digital Goods API and
      Trusted Web Activity. Make sure to read the
      <a href="https://developer.android.com/google/play/billing"
        >Google Play Billing documentation</a
      >
      and understand its concepts before integrating it into a production
      application.
    </p>
    <h3 id="the-basic-flow">The basic flow</h3>
    <p>
      {% Img src=“image/Vww75TFpThOgTNuASFM6UYfBAp53/j3FGosxlC0IC4KBLJDnE.jpg”,
      alt=“Play Console menu”, width=“800”, height=“640” %}
    </p>
    <p>
      To provide digital goods via the Play Store you’ll need to configure your
      catalog on the Play Store, as well as connect the Play Store as a payment
      method from your PWA.
    </p>
    <p>
      When you are ready to configure your catalog, start by finding the
      Products section in the left hand side menu on the Play Console:
    </p>
    <p>
      Here you’ll find the option to view your existing in-app products and
      subscriptions and you’ll also find the create button for adding new ones.
    </p>
    <p>
      {% Img src=“image/Vww75TFpThOgTNuASFM6UYfBAp53/Qpe1BgDNVWlEyWuvfLLv.jpg”,
      alt=“In-app Products”, width=“800”, height=“316” %}
    </p>
    <p>
      {% Img src=“image/Vww75TFpThOgTNuASFM6UYfBAp53/9LdD9NuXmCV1X70FuCQ4.jpg”,
      alt=“Product Details”, width=“800”, height=“1522” %}
    </p>
    <p>
      To create a new in-app product you will need a product ID, name,
      description, and a price. It’s important to create meaningful and easy to
      remember product IDs, you’ll need them later and the IDs can’t be changed
      once created.
    </p>
    <p>
      When creating subscriptions you will also have to specify a billing
      period. You have the option to list your subscription benefits and add
      features like whether you have a free trial, an introductory price, a
      grace period, and a resubscribe option.
    </p>
    <p>
      After creating each product, make them available from your app by
      activating them.
    </p>
    <p>
      If you prefer you can add your products via the
      <a href="https://developers.google.com/android-publisher"
        >Play Developers API</a
      >.
    </p>
    <p>
      Once your catalog is configured, the next step is to configure the
      checkout flow from the PWA. You will use a combination of the
      <a href="https://github.com/WICG/digital-goods">Digital Goods API</a> and
      the
      <a href="https://www.w3.org/TR/payment-request/">Payment Request API</a>
      to achieve this.
    </p>
    <h4 id="fetch-a-product-price-with-the-digital-goods-api">
      Fetch a product price with the Digital Goods API
    </h4>
    <p>
      When using Google Play Billing, you will want to ensure that the price
      displayed to users matches the price from the store listing. Manually
      keeping those prices in sync would be impossible, so the Digital Goods API
      provides a way for the web application to query the underlying payment
      provider for prices:
    </p>
    <div class="sourceCode" id="cb5">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// The SKU for the product, as defined in the Play Store interface</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">async</span> <span class="kw">function</span> <span class="at">populatePrice</span>(sku) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="co">// Check if the Digital Goods API is supported by the browser.</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="cf">if</span> (<span class="va">window</span>.<span class="at">getDigitalGoodsService</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6">      <span class="co">// The Digital Goods API can be supported by other Payments provider.</span></a>
<a class="sourceLine" id="cb5-7" title="7">      <span class="co">// In this case, we&#39;re retrieving the Google Play Billing provider.</span></a>
<a class="sourceLine" id="cb5-8" title="8">      <span class="kw">const</span> service <span class="op">=</span></a>
<a class="sourceLine" id="cb5-9" title="9">          <span class="cf">await</span> <span class="va">window</span>.<span class="at">getDigitalGoodsService</span>(<span class="st">&quot;https://play.google.com/billing&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">      <span class="co">// Fetch product details using the `getDetails()` method.</span></a>
<a class="sourceLine" id="cb5-12" title="12">      <span class="kw">const</span> details <span class="op">=</span> <span class="cf">await</span> <span class="va">service</span>.<span class="at">getDetails</span>([sku])<span class="op">;</span></a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14">      <span class="cf">if</span> (<span class="va">details</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-15" title="15">        <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Could not get SKU: &quot;</span><span class="sc">${</span>sku<span class="sc">}</span><span class="vs">&quot;.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-16" title="16">        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-17" title="17">      <span class="op">}</span></a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19">      <span class="co">// The details will contain both the price and the currenncy.</span></a>
<a class="sourceLine" id="cb5-20" title="20">      item <span class="op">=</span> details[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb5-21" title="21">      <span class="kw">const</span> value <span class="op">=</span> <span class="va">item</span>.<span class="va">price</span>.<span class="at">value</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-22" title="22">      <span class="kw">const</span> currency <span class="op">=</span> <span class="va">item</span>.<span class="va">price</span>.<span class="at">currency</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-23" title="23"></a>
<a class="sourceLine" id="cb5-24" title="24">      <span class="kw">const</span> formattedPrice <span class="op">=</span> <span class="kw">new</span> <span class="va">Intl</span>.<span class="at">NumberFormat</span>(<span class="va">navigator</span>.<span class="at">language</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="dt">style</span><span class="op">:</span> <span class="st">&#39;currency&#39;</span><span class="op">,</span> <span class="dt">currency</span><span class="op">:</span> currency <span class="op">}</span>).<span class="at">format</span>(value)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-26" title="26"></a>
<a class="sourceLine" id="cb5-27" title="27">      <span class="co">// Display the price to the user.</span></a>
<a class="sourceLine" id="cb5-28" title="28">      <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;price&quot;</span>).<span class="at">innerHTML</span> <span class="op">=</span> formattedPrice<span class="op">;</span></a>
<a class="sourceLine" id="cb5-29" title="29">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-30" title="30">      <span class="va">console</span>.<span class="at">error</span>(<span class="st">&quot;Could not get price for SKU </span><span class="sc">\&quot;</span><span class="st">&quot;</span> <span class="op">+</span> sku <span class="op">+</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-32" title="32">  <span class="op">}</span> <span class="cf">catch</span> (error) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-33" title="33">    <span class="va">console</span>.<span class="at">log</span>(error)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-34" title="34">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-35" title="35">  <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-36" title="36"><span class="op">}</span></a></code></pre>
    </div>
    <p>
      You can detect support for the Digital Goods API by checking if
      <code>getDigitalGoodsService()</code> is available on the
      <code>window</code> object.
    </p>
    <p>
      Then call <code>window.getDigitalGoodsService()</code> with the Google
      Play Billing identifier as a parameter. This will return a service
      instance for Google Play Billing and other vendors can implement support
      for the Digital Goods API and will have different identifiers.
    </p>
    <p>
      Finally, call <code>getDetails()</code> on the reference to the Google
      Play Billing object passing the SKU for the item as a parameter. The
      method will return a detail object containing both the price and the
      currency for the item that can be displayed to the user.
    </p>
    <h4 id="start-the-purchase-flow">Start the purchase flow</h4>
    <p>
      The Payment Request API enables purchase flows on the web and is also used
      for the Google Play Billing integration. Check out this
      <a
        href="https://developers.google.com/web/fundamentals/payments/basics/how-payment-request-api-works"
        >How Payment Request API Works</a
      >
      to learn more if you are new to the Payment Request API.
    </p>
    <p>
      In order to use the API with Google Play Billing you will need to add a
      payment instrument which has a supported metod called
      <code>https://play.google.com/billing</code> and add the SKU as part of
      the data for the instrument:
    </p>
    <div class="sourceCode" id="cb6">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">const</span> supportedInstruments <span class="op">=</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">supportedMethods</span><span class="op">:</span> <span class="st">&quot;https://play.google.com/billing&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="dt">data</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="dt">sku</span><span class="op">:</span> sku</a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="op">}</span>]<span class="op">;</span></a></code></pre>
    </div>
    <p>
      Then, build a <code>PaymentRequest</code> object as usual and use the API
      as usual
    </p>
    <div class="sourceCode" id="cb7">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">const</span> request <span class="op">=</span> <span class="kw">new</span> <span class="at">PaymentRequest</span>(supportedInstruments<span class="op">,</span> details)<span class="op">;</span></a></code></pre>
    </div>
    <h4 id="acknowledge-the-purchase">Acknowledge the purchase</h4>
    <p>
      Once the transaction is complete, you will need to use the Digital Goods
      API to acknowledge the payment. The response object from the
      <code>PaymentRequest</code> will contain a token you will use to
      acknowledge the transaction:
    </p>
    <div class="sourceCode" id="cb8">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="va">request</span>.<span class="at">show</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">const</span> token <span class="op">=</span> <span class="va">response</span>.<span class="va">details</span>.<span class="at">token</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">const</span> service <span class="op">=</span></a>
<a class="sourceLine" id="cb8-4" title="4">          <span class="cf">await</span> <span class="va">window</span>.<span class="at">getDigitalGoodsService</span>(<span class="st">&quot;https://play.google.com/billing&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="cf">await</span> <span class="va">service</span>.<span class="at">acknowledge</span>(token<span class="op">,</span> <span class="st">&#39;onetime&#39;</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      The Digital Goods API and the Payment Request API don’t have knowledge on
      the user’s identity. As a result, it’s up to you to associate the purchase
      to the user in your backend and ensure they have access to the purchased
      items. When associating the purchase to a user, remember to save the
      purchase token, as you may need it to verify if the purchase has been
      cancelled or refunded, or if a subscription is still active. Check out the
      <a href="https://developer.android.com/google/play/billing/rtdn-reference"
        >Real Time Developer Notifications API</a
      >
      and the
      <a href="https://developers.google.com/android-publisher"
        >Google Play Developer API</a
      >
      as they provide endpoints for handling those cases in your backend.
    </p>
    <h4 id="check-for-existing-entitlements">
      Check for existing entitlements
    </h4>
    <p>
      A user may have redeemed a promo code or may have an existing subscription
      to your product. In order to validate that the user has the appropriate
      entitlements, you can call the <code>listPurchases()</code> command on the
      digital goods service. This will return all purchases that your customer
      has made in your app. This would also be the place to acknowledge any
      unacknowledged purchases to ensure that the user correctly redeems their
      entitlements.
    </p>
    <div class="sourceCode" id="cb9">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">const</span> purchases <span class="op">=</span> <span class="cf">await</span> <span class="va">itemService</span>.<span class="at">listPurchases</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="cf">for</span> (p <span class="kw">of</span> purchases) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="cf">if</span> (<span class="op">!</span><span class="va">p</span>.<span class="at">acknowledged</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="cf">await</span> <span class="va">itemService</span>.<span class="at">acknowledge</span>(<span class="va">p</span>.<span class="at">purchaseToken</span><span class="op">,</span> <span class="st">&#39;onetime&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="op">}</span></a></code></pre>
    </div>
    <h2 id="upload-to-the-chrome-os-play-store">
      Upload to the Chrome OS Play Store
    </h2>
    <p>
      Trusted Web Activities are also available since Chrome 85 in the Chrome OS
      Play Store. The process to list your app in the store is the same for
      Chrome OS as it is for Android.
    </p>
    <p>
      Once you’ve created your app bundle, the
      <a href="https://play.google.com/console/about/">Play Console</a> will
      guide you through the required steps to list the app on the Play Store. In
      the Play Console documentation you can find help to
      <a
        href="https://support.google.com/googleplay/android-developer/answer/9859152"
        >create your app listing</a
      >, manage your apk files and other settings, as well as instructions for
      testing and
      <a
        href="https://support.google.com/googleplay/android-developer/answer/9859348"
        >safely releasing your app</a
      >.
    </p>
    <p>
      To restrict your application to Chromebooks only, add the
      <code>--chromeosonly</code> flag when initializing the application in
      Bubblewrap:
    </p>
    <pre
      class="shell"
    ><code>bubblewrap init --manifest=&quot;https://example.com/manifest.json&quot; --chromeosonly</code></pre>
    <p>
      When building your application manually, without Bubblewrap, add a
      <code>uses-feature</code> flag to your Android manifest:
    </p>
    <div class="sourceCode" id="cb11">
      <pre
        class="sourceCode xml"
      ><code class="sourceCode xml"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">&lt;uses-feature</span><span class="ot">  android:name=</span><span class="st">&quot;org.chromium.arc&quot;</span><span class="ot"> android:required=</span><span class="st">&quot;true&quot;</span><span class="kw">/&gt;</span></a></code></pre>
    </div>
    <p>
      If your listing is shared with an Android app, the Chrome OS only package
      version will always have to be higher than the Android app package
      version. You can set up the Chrome OS bundle version to a way higher
      number than the Android version, so you don’t have to update both versions
      with each release.
    </p>
  </body>
</html>
