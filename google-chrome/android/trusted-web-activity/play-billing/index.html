<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-11-25" />
  <title>Use Play Billing in your Trusted Web Activity</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Use Play Billing in your Trusted Web Activity</h1>
<p class="date">2020-11-25</p>
</header>
<p>Besides allowing your app to sell digital goods and subscriptions on the Play Store, <a href="https://developer.android.com/google/play/billing">Google Play Billing</a> offers tools for managing your catalog, prices and subscriptions, useful reports, and a checkout flow powered by the Play Store that is already familiar to your users. It is also a requirement for applications published on the Play Store that sell digital goods.</p>
<p>Chrome 88 is launching with an <a href="https://web.dev/origin-trials/">Origin Trial</a> on Android that enables the integration of <a href="/docs/android/trusted-web-activity/">Trusted Web Activities</a> with the <a href="https://www.w3.org/TR/payment-request/">Payment Request API</a> and the <a href="https://github.com/WICG/digital-goods">Digital Goods API</a> to implement purchase flows via Google Play Billing. We expect this Origin Trial to also be available for Chrome OS on version 89.</p>
<p>In order to ease the integration to the Android app, the Trusted Web Activity team is introducing an extension library to <a href="https://github.com/GoogleChrome/android-browser-helper">android-browser-helper</a>. This guide will show you the changes required to integrate this library into an existing application.</p>
<p><strong>Note:</strong> This articles covers the integration for the Android app. If you are using <a href="https://github.com/GoogleChromeLabs/bubblewrap">Bubblewrap</a> to build your application you will be able to use the tool to update your app. The implementation on Bubblewrap is being tracked in <a href="https://github.com/GoogleChromeLabs/bubblewrap/issues/376">this issue</a>. This guide is meant for those who are <strong>not</strong> using Bubblewrap to update their app.</p>
<h2 id="build.gradle">build.gradle</h2>
<p>The billing extension library itself depends on version <code>2.1.0</code> of <code>android-browser-helper</code>. Ensure your application is using a version that is equal or greater than that.</p>
<p>You will also need to add an implementation declaration for the billing extension library:</p>
<pre class="groovy"><code>dependencies {
    ...
    implementation &#39;com.google.androidbrowserhelper:androidbrowserhelper:2.1.0&#39;
    implementation &#39;com.google.androidbrowserhelper:billing:1.0.0-alpha05&#39;
}</code></pre>
<h2 id="delegationservice.java">DelegationService.java</h2>
<p>android-browser-helper ships with a default <code>DelegationService</code> that can be used directly by apps. When using the billing extension, you need a slightly customized version of the <code>DelegationService</code>.</p>
<p>In order to do that, you will need to create your own <code>DelegationService</code> class that extends the original one and overrides <code>onCreate()</code>. Inside <code>onCreate()</code>, you will need to add a single method call that registers the application as a handler for the Digital Goods API:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">package</span><span class="im"> com.example.yourapp;</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">import</span><span class="im"> com.google.androidbrowserhelper.playbilling.digitalgoods.DigitalGoodsRequestHandler;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">import</span><span class="im"> com.google.androidbrowserhelper.trusted.DelegationService;</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw">public</span> <span class="kw">class</span> DelegationService</a>
<a class="sourceLine" id="cb2-7" title="7">        <span class="kw">extends</span> com.<span class="fu">google</span>.<span class="fu">androidbrowserhelper</span>.<span class="fu">trusted</span>.<span class="fu">DelegationService</span> {</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="at">@Override</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onCreate</span>() {</a>
<a class="sourceLine" id="cb2-10" title="10">        <span class="kw">super</span>.<span class="fu">onCreate</span>();</a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="fu">registerExtraCommandHandler</span>(<span class="kw">new</span> <span class="fu">DigitalGoodsRequestHandler</span>(<span class="fu">getApplicationContext</span>()));</a>
<a class="sourceLine" id="cb2-12" title="12">    }</a>
<a class="sourceLine" id="cb2-13" title="13">}</a></code></pre></div>
<h2 id="androidmanifest.xml">AndroidManifest.xml</h2>
<p>On the Android Manifest, you will need to change the reference to the Delegation Library your own implementation. In the corresponding <code>service</code> declaration, replace <code>com.google.androidbrowserhelper.trusted.DelegationService</code> with your newly created class.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">&lt;service</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ot">    android:name=</span><span class="st">&quot;.DelegationService&quot;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">    android:exported=</span><span class="st">&quot;true&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="kw">&lt;intent-filter&gt;</span></a>
<a class="sourceLine" id="cb3-6" title="6">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;android.support.customtabs.trusted.TRUSTED_WEB_ACTIVITY_SERVICE&quot;</span><span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.DEFAULT&quot;</span><span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="kw">&lt;/intent-filter&gt;</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="kw">&lt;/service&gt;</span></a></code></pre></div>
<p>The billing library also introduces two new components that will need to be added to your Android Manifest: a <a href="https://developer.android.com/guide/components/services">Service</a> that the browser can connect to and check if the application supports the payment, and an <a href="https://developer.android.com/reference/android/app/Activity">Activity</a> that handles the payment flow itself:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;activity</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">    android:name=</span><span class="st">&quot;com.google.androidbrowserhelper.playbilling.provider.PaymentActivity&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ot">    android:theme=</span><span class="st">&quot;@android:style/Theme.Translucent.NoTitleBar&quot;</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="ot">    android:configChanges=</span><span class="st">&quot;keyboardHidden|keyboard|orientation|screenLayout|screenSize&quot;</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ot">    android:exported=</span><span class="st">&quot;true&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">&lt;intent-filter&gt;</span></a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;org.chromium.intent.action.PAY&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="kw">&lt;/intent-filter&gt;</span></a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="kw">&lt;meta-data</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="ot">        android:name=</span><span class="st">&quot;org.chromium.default_payment_method_name&quot;</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="ot">        android:value=</span><span class="st">&quot;https://play.google.com/billing&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="kw">&lt;/activity&gt;</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">&lt;!-- This service checks who calls it at runtime. --&gt;</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="kw">&lt;service</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="ot">    android:name=</span><span class="st">&quot;com.google.androidbrowserhelper.playbilling.provider.PaymentService&quot;</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="ot">    android:exported=</span><span class="st">&quot;true&quot;</span> <span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-17" title="17">    <span class="kw">&lt;intent-filter&gt;</span></a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;org.chromium.intent.action.IS_READY_TO_PAY&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb4-19" title="19">    <span class="kw">&lt;/intent-filter&gt;</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="kw">&lt;/service&gt;</span></a></code></pre></div>
<h2 id="learn-more-about-the-digital-goods-api-and-google-play-billing">Learn more about the Digital Goods API and Google Play Billing</h2>
<p>This article covered the steps needed specifically on the Android application that uses Trusted Web Activity, but the Google Play Billing API has its own terminology and includes client and backend components. We strongly recommend reading the <a href="https://developer.android.com/google/play/billing">Google Play Billing</a> and the <a href="https://github.com/WICG/digital-goods">Digital Goods API</a> documentation and understanding its concepts before integrating it into an application in production.</p>
</body>
</html>
