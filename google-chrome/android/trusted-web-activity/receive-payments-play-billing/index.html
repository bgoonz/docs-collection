<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-01-26" />
  <title>Receive Payments via Google Play Billing with the Digital Goods API and the Payment Request API</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Receive Payments via Google Play Billing with the Digital Goods API and the Payment Request API</h1>
<p class="date">2021-01-26</p>
</header>
<p>If your app is distributed through Google Play, and you want to sell digital goods or offer subscriptions, you must use <a href="https://developer.android.com/google/play/billing">Google Play Billing</a>. Google Play Billing offers tools for managing your catalog, prices and subscriptions, useful reports, and a checkout flow powered by the Play Store that is already familiar to your users.</p>
<p>For apps built using <a href="/docs/android/trusted-web-activity/">Trusted Web Activities</a>, and delivered through the Google Play Store, you can now use the <a href="https://developers.google.com/web/fundamentals/payments">Payment Request API</a> and the new <a href="https://github.com/WICG/digital-goods/blob/master/explainer.md">Digital Goods API</a> to integrate with Google Play Billing. It’s available as an <a href="https://web.dev/origin-trials/">origin trial</a> in Chrome 88 for Android, and we expect it to expand the origin trial to Chrome OS in version 89.</p>
<p>In this guide, you will learn how to add Google Play Billing support to your PWA and package it for distribution on the Google Play Store for both Chrome OS and Play Store.</p>
<p>You will use two web platform APIs to add Play Billing support to your PWA. The <a href="https://github.com/WICG/digital-goods/blob/master/explainer.md">Digital Goods API</a> is used to gather SKU information and check for purchases and entitlements from the Play Store. The <a href="https://developers.google.com/web/fundamentals/payments">Payment Request API</a> is used to configure the Google Play Store as the payment method and to complete the purchase flow.</p>
<p>Note: While the Payment Request API is stable, the Digital Goods API is currently on Origin Trial. This means that the Digital Goods API may change during this period and the final API may be different. This also means it is a great time to test the API yourself, and <a href="https://github.com/WICG/digital-goods/issues">give feedback on the specification</a>.</p>
<h2 id="how-to-monetize-applications-on-the-play-store">How to monetize applications on the Play Store</h2>
<p>There are two ways your application can monetize with Google Play Billing on the Play Store:</p>
<ul>
<li><a href="https://developer.android.com/distribute/best-practices/earn/in-app-purchases">In-app purchases</a> allow selling both durable and consumable virtual goods, like additional features, or removing ads.</li>
<li><a href="https://developer.android.com/distribute/best-practices/earn/subscriptions">Subscriptions</a>, offer your users ongoing access to content or services for a recurring fee, like news subscriptions or memberships.</li>
</ul>
<p>Note: The Play Store allows selling applications on the store and users can only download the application after purchasing it. We don’t recommend this for PWAs as the web application needs to be freely accessible to the open web and it is not possible to limit access in the same way platform-specific applications would do. A better alternative is to provide the application for free on the store and enable features via in-app purchases.</p>
<h2 id="requirements">Requirements</h2>
<p>In order to setup Google Play Billing, you will need:</p>
<ul>
<li>A <a href="https://support.google.com/googleplay/android-developer/answer/6112435">Google Play Developer account</a> and a <a href="https://support.google.com/paymentscenter/answer/7161426">Google Payment merchant account</a> that are <a href="https://support.google.com/googleplay/android-developer/answer/3092739">linked to each other</a>.</li>
<li>A <a href="https://support.google.com/googleplay/android-developer/answer/9859152">Play Store listing</a> with a <a href="https://support.google.com/googleplay/android-developer/answer/9845334">release on the public, closed testing or internal testing track</a>.</li>
<li>To <a href="https://developer.android.com/google/play/billing/getting-ready#products">create and configure</a> your app’s products and subscriptions on the Play Store.</li>
<li>A <a href="/docs/android/trusted-web-activity/quick-start">Bubblewrap generated project</a> with a working <a href="/docs/android/trusted-web-activity/quick-start#creating-your-asset-link-file">Digital Asset Links configuration</a>.</li>
</ul>
<h2 id="request-access-to-the-origin-trial">Request access to the Origin Trial</h2>
<p>An <a href="https://web.dev/origin-trials/">origin trial</a> is a way to test a new or experimental web platform feature, and give feedback to the web standards community on the feature’s usability, practicality, and effectiveness, before the feature is made available to all users. You can sign-up for the Digital Goods API origin trial <a href="https://developers.chrome.com/origintrials/#/view_trial/-5451607348931985407">here</a>.</p>
<h2 id="update-the-bubblewrap-project">Update the Bubblewrap project</h2>
<p>If you don’t have Bubblewrap installed, you will need to install it. See the <a href="/docs/android/trusted-web-activity/quick-start">Quick Start Guide</a> for details on how to get started. If you already have Bubblewrap, make sure to update to version 1.8.2 or above.</p>
<p>Since the Digital Goods API is in Origin Trial, Bubblewrap also has the feature behind a flag. In order to enable it, you will need to modify the project configuration in the <code>twa-manifest.json</code>, located at the root of the project and enable both <code>alphaDependencies</code> and the <code>playBilling</code> feature:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" title="1">  <span class="er">...,</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="er">&quot;enableNotifications&quot;:</span> <span class="er">true,</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="er">&quot;features&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="dt">&quot;playBilling&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">      <span class="dt">&quot;enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="fu">}</span>   </a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="fu">}</span><span class="er">,</span>  </a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="er">&quot;alphaDependencies&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="dt">&quot;enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="fu">}</span><span class="er">,</span></a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="er">...</span></a></code></pre></div>
<p>With the configuration file updated, run <code>bubblewrap update</code> to apply the configuration to the project, followed by <code>bubblewrap build</code>, to generate a new Android package and upload this package to the Play Store.</p>
<p>Note: If you are building the Trusted Web Activity using Android Studio, <a href="/docs/android/trusted-web-activity/play-billing">check out the documentation</a> on how to modify your Android application and enable Trusted Web Activity.</p>
<h2 id="feature-detecting-the-digital-goods-api-and-google-play-billing-availability">Feature detecting the Digital Goods API and Google Play Billing availability</h2>
<p>The Digital Goods API is currently only supported by Chrome when the PWA is being executed inside a Trusted Web Activity, and it is possible to detect if it is available by checking for <code>getDigitalGoodsService</code> on the <code>window</code> object:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="cf">if</span> (<span class="st">&#39;getDigitalGoodsService&#39;</span> <span class="kw">in</span> window) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2"> <span class="co">// Digital Goods API is supported!</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="op">}</span></a></code></pre></div>
<p>The Digital Goods API may be available in any browser and support different stores. In order to check if a particular store backend is supported, you will need to invoke <code>getDigitalGoodsService()</code> passing the store ID as a parameter. The Google Play Store is identified by the string <code>https://play.google.com/billing</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="cf">if</span> (<span class="st">&#39;getDigitalGoodsService&#39;</span> <span class="kw">in</span> window) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2"> <span class="co">// Digital Goods API is supported!</span></a>
<a class="sourceLine" id="cb3-3" title="3"> <span class="kw">const</span> service <span class="op">=</span></a>
<a class="sourceLine" id="cb3-4" title="4">     <span class="cf">await</span> <span class="va">window</span>.<span class="at">getDigitalGoodsService</span>(<span class="st">&#39;https://play.google.com/billing&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" title="5"> <span class="cf">if</span> (service) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-6" title="6">   <span class="co">// Google Play Billing is supported!</span></a>
<a class="sourceLine" id="cb3-7" title="7"> <span class="op">}</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="op">}</span></a></code></pre></div>
<h2 id="retrieve-details-for-a-sku">Retrieve details for a SKU</h2>
<p>The Digital Goods API provides <code>getDetails()</code>, which allows retrieving the information like the product title, description, and most importantly, the price, from the payments backend.</p>
<p>You can then use this information in your use interface and provide more details to the user:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">const</span> skuDetails <span class="op">=</span> <span class="cf">await</span> <span class="va">itemService</span>.<span class="at">getDetails</span>([<span class="st">&#39;shiny_sword&#39;</span><span class="op">,</span> <span class="st">&#39;gem&#39;</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="cf">for</span> (item <span class="kw">of</span> skuDetails) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="co">// Format the price according to the user locale.</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="kw">const</span> localizedPrice <span class="op">=</span> <span class="kw">new</span> <span class="va">Intl</span>.<span class="at">NumberFormat</span>(</a>
<a class="sourceLine" id="cb4-5" title="5">      <span class="va">navigator</span>.<span class="at">language</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-6" title="6">      <span class="op">{</span><span class="dt">style</span><span class="op">:</span> <span class="st">&#39;currency&#39;</span><span class="op">,</span> <span class="dt">currency</span><span class="op">:</span> <span class="va">item</span>.<span class="va">price</span>.<span class="at">currency</span><span class="op">}</span></a>
<a class="sourceLine" id="cb4-7" title="7">    ).<span class="at">format</span>(<span class="va">item</span>.<span class="va">price</span>.<span class="at">value</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="co">// Render the price to the UI.</span></a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="at">renderProductDetails</span>(</a>
<a class="sourceLine" id="cb4-11" title="11">        <span class="va">item</span>.<span class="at">itemId</span><span class="op">,</span> <span class="va">item</span>.<span class="at">title</span><span class="op">,</span> localizedPrice<span class="op">,</span> <span class="va">item</span>.<span class="at">description</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="op">}</span></a></code></pre></div>
<p>Note: The product SKUs are defined by you, when <a href="https://developer.android.com/google/play/billing/getting-ready#products">creating your products and subscriptions on the Play Store interface</a>. The Digital Goods API doesn’t have methods to query SKUs, but the Play Store does provide <a href="https://developers.google.com/android-publisher/api-ref/rest/v3/inappproducts/list">an API that can be used to query SKUs from a backend</a>.</p>
<h2 id="build-the-purchase-flow">Build the purchase flow</h2>
<p>The constructor for a PaymentRequest takes two parameters: a list of payment methods and a list of payment details.</p>
<p>When inside the Trusted Web Activity, you must use the Google Play billing payment method, by setting <code>https://play.google.com/billing</code> as the identifier, and adding the product SKU in as a data member:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">makePurchase</span>(service<span class="op">,</span> sku) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">   <span class="co">// Define the preferred payment method and item ID</span></a>
<a class="sourceLine" id="cb5-3" title="3">   <span class="kw">const</span> paymentMethods <span class="op">=</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">       <span class="dt">supportedMethods</span><span class="op">:</span> <span class="st">&quot;https://play.google.com/billing&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-5" title="5">       <span class="dt">data</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6">           <span class="dt">sku</span><span class="op">:</span> sku<span class="op">,</span></a>
<a class="sourceLine" id="cb5-7" title="7">       <span class="op">}</span></a>
<a class="sourceLine" id="cb5-8" title="8">   <span class="op">}</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10">   ...</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="op">}</span></a></code></pre></div>
<p>Even though the payment details are required, the Play Billing will ignore those values and use the values set when creating the SKU in the Play Console, so they can be filled with bogus values:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">const</span> paymentDetails <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="dt">total</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">        <span class="dt">label</span><span class="op">:</span> <span class="vs">`Total`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-4" title="4">        <span class="dt">amount</span><span class="op">:</span> <span class="op">{</span><span class="dt">currency</span><span class="op">:</span> <span class="vs">`USD`</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="vs">`0`</span><span class="op">}</span></a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="op">};</span></a>
<a class="sourceLine" id="cb6-7" title="7"></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="kw">const</span> request <span class="op">=</span> <span class="kw">new</span> <span class="at">PaymentRequest</span>(paymentMethods<span class="op">,</span> paymentDetails)<span class="op">;</span></a></code></pre></div>
<p>Call the <code>show()</code> on the payment request object to start the payment flow. If the Promise succeeds that will may be payment was successful. If it fails, the user likely aborted the payment.</p>
<p>If the promise succeeds, you will need to verify the purchase in order to protect against fraud. Due to the sensitivity of the data, this step must be implemented using your backend. Check out the <a href="https://developer.android.com/google/play/billing/security#verify">Play Billing documentation to learn how to implement the verification in your backend</a>.</p>
<p>When the validation passes in your backend, you will then use the Digital Goods API to acknowledge the purchase, otherwise, <a href="https://developer.android.com/google/play/billing/integrate#process">after three days, the user will receive a refund and Google Play will revoke the purchase</a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1">...</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">const</span> request <span class="op">=</span> <span class="kw">new</span> <span class="at">PaymentRequest</span>(paymentMethods<span class="op">,</span> paymentDetails)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="kw">const</span> paymentResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">request</span>.<span class="at">show</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="kw">const</span> <span class="op">{</span>purchaseToken<span class="op">}</span> <span class="op">=</span> <span class="va">paymentResponse</span>.<span class="at">details</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="co">// Call backend to validate the purchase.</span></a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="cf">if</span> (<span class="at">validatePurchaseOnBackend</span>(purchaseToken)) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-9" title="9">        <span class="co">// Acknowledge using the Digital Goods API. Use &#39;onetime&#39; for items</span></a>
<a class="sourceLine" id="cb7-10" title="10">        <span class="co">// that can only be purchased once and &#39;repeatable&#39; for items</span></a>
<a class="sourceLine" id="cb7-11" title="11">        <span class="co">// that can be purchased multiple times.</span></a>
<a class="sourceLine" id="cb7-12" title="12">        <span class="cf">await</span> <span class="va">service</span>.<span class="at">acknowledge</span>(purchaseToken<span class="op">,</span> <span class="st">&#39;onetime&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-13" title="13"></a>
<a class="sourceLine" id="cb7-14" title="14">        <span class="co">// Optional: tell the PaymentRequest API the validation was</span></a>
<a class="sourceLine" id="cb7-15" title="15">        <span class="co">// successful. The user-agent may show a &quot;payment successful&quot;</span></a>
<a class="sourceLine" id="cb7-16" title="16">        <span class="co">// message to the user.</span></a>
<a class="sourceLine" id="cb7-17" title="17">        <span class="kw">const</span> paymentComplete <span class="op">=</span> <span class="cf">await</span> <span class="va">paymentResponse</span>.<span class="at">complete</span>(<span class="st">&#39;success&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-18" title="18">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-19" title="19">        <span class="co">// Optional: tell the PaymentRequest API the validation failed. The</span></a>
<a class="sourceLine" id="cb7-20" title="20">        <span class="co">// user agent may show a message to the user.</span></a>
<a class="sourceLine" id="cb7-21" title="21">        <span class="kw">const</span> paymentComplete <span class="op">=</span> <span class="cf">await</span> <span class="va">paymentResponse</span>.<span class="at">complete</span>(<span class="st">&#39;fail&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-22" title="22">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-23" title="23"><span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-24" title="24">    <span class="co">// The purchase failed, and we can handle the failure here. AbortError</span></a>
<a class="sourceLine" id="cb7-25" title="25">    <span class="co">// usually means a user cancellation</span></a>
<a class="sourceLine" id="cb7-26" title="26"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-27" title="27">...</a></code></pre></div>
<p>The second parameter of the acknowledge call is a purchase type. Use <code>onetime</code> for items that can only be purchased once and <code>repeatable</code> for items that can be purchased multiple times.</p>
<p>Putting everything together, a purchase method looks like the following:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">makePurchase</span>(service<span class="op">,</span> sku) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="co">// Define the preferred payment method and item ID</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">const</span> paymentMethods <span class="op">=</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" title="4">        <span class="dt">supportedMethods</span><span class="op">:</span> <span class="st">&quot;https://play.google.com/billing&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-5" title="5">        <span class="dt">data</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-6" title="6">            <span class="dt">sku</span><span class="op">:</span> sku<span class="op">,</span></a>
<a class="sourceLine" id="cb8-7" title="7">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="op">}</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-9" title="9"></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="co">// The &quot;total&quot; member of the paymentDetails is required by the Payment</span></a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="co">// Request API, but is not used when using Google Play Billing. We can</span></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="co">// set it up with bogus details.</span></a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="kw">const</span> paymentDetails <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-14" title="14">        <span class="dt">total</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-15" title="15">            <span class="dt">label</span><span class="op">:</span> <span class="vs">`Total`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-16" title="16">            <span class="dt">amount</span><span class="op">:</span> <span class="op">{</span><span class="dt">currency</span><span class="op">:</span> <span class="vs">`USD`</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="vs">`0`</span><span class="op">}</span></a>
<a class="sourceLine" id="cb8-17" title="17">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-18" title="18">    <span class="op">};</span></a>
<a class="sourceLine" id="cb8-19" title="19"></a>
<a class="sourceLine" id="cb8-20" title="20">    <span class="kw">const</span> request <span class="op">=</span> <span class="kw">new</span> <span class="at">PaymentRequest</span>(paymentMethods<span class="op">,</span> paymentDetails)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-21" title="21">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-22" title="22">        <span class="kw">const</span> paymentResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">request</span>.<span class="at">show</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-23" title="23">        <span class="kw">const</span> <span class="op">{</span>purchaseToken<span class="op">}</span> <span class="op">=</span> <span class="va">paymentResponse</span>.<span class="at">details</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-24" title="24"></a>
<a class="sourceLine" id="cb8-25" title="25">        <span class="co">// Call backend to validate the purchase.</span></a>
<a class="sourceLine" id="cb8-26" title="26">        <span class="cf">if</span> (<span class="at">validatePurchaseOnBackend</span>(purchaseToken)) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-27" title="27">            <span class="co">// Acknowledge using the Digital Goods API. Use ‘onetime&#39; for</span></a>
<a class="sourceLine" id="cb8-28" title="28">            <span class="co">// items that can only be purchased once and ‘repeatable for</span></a>
<a class="sourceLine" id="cb8-29" title="29">            <span class="co">// items that can be purchased multiple times.</span></a>
<a class="sourceLine" id="cb8-30" title="30">            <span class="cf">await</span> <span class="va">service</span>.<span class="at">acknowledge</span>(purchaseToken<span class="op">,</span> <span class="st">&#39;onetime&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-31" title="31"></a>
<a class="sourceLine" id="cb8-32" title="32">            <span class="co">// Optional: tell the PaymentRequest API the validation was</span></a>
<a class="sourceLine" id="cb8-33" title="33">            <span class="co">// successful. The user-agent may show a &quot;payment successful&quot;</span></a>
<a class="sourceLine" id="cb8-34" title="34">            <span class="co">// message to the user.</span></a>
<a class="sourceLine" id="cb8-35" title="35">            <span class="kw">const</span> paymentComplete <span class="op">=</span></a>
<a class="sourceLine" id="cb8-36" title="36">                    <span class="cf">await</span> <span class="va">paymentResponse</span>.<span class="at">complete</span>(<span class="st">&#39;success&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-37" title="37">        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-38" title="38">            <span class="co">// Optional: tell the PaymentRequest API the validation failed.</span></a>
<a class="sourceLine" id="cb8-39" title="39">            <span class="co">// The user agent may show a message to the user.</span></a>
<a class="sourceLine" id="cb8-40" title="40">            <span class="kw">const</span> paymentComplete <span class="op">=</span> <span class="cf">await</span> <span class="va">paymentResponse</span>.<span class="at">complete</span>(<span class="st">&#39;fail&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-41" title="41">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-42" title="42">    <span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-43" title="43">        <span class="co">// The purchase failed, and we can handle the failure here.</span></a>
<a class="sourceLine" id="cb8-44" title="44">        <span class="co">// AbortError usually means a user cancellation</span></a>
<a class="sourceLine" id="cb8-45" title="45">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-46" title="46"><span class="op">}</span></a></code></pre></div>
<h2 id="check-the-status-of-existing-purchases">Check the status of existing purchases</h2>
<p>The Digital Goods API allows you to check if the user has any existing entitlements (in-app purchases that haven’t been consumed yet or on-going subscriptions) from previous purchases they’ve already made, whether on another device, from a previous install, redeemed from a promo code, or just the last time they opened the app.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">const</span> service <span class="op">=</span></a>
<a class="sourceLine" id="cb9-3" title="3">     <span class="cf">await</span> <span class="va">window</span>.<span class="at">getDigitalGoodsService</span>(<span class="st">&#39;https://play.google.com/billing&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-4" title="4">...</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="kw">const</span> existingPurchases <span class="op">=</span> <span class="cf">await</span> <span class="va">service</span>.<span class="at">listPurchases</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="cf">for</span> (<span class="kw">const</span> p <span class="kw">of</span> existingPurchases) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="co">// Update the UI with items the user is already entitled to.</span></a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Users has entitlement for </span><span class="sc">${</span><span class="va">p</span>.<span class="at">itemId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>This is also a good time to check for purchases that were previously made but weren’t acknowledged. It is recommended to acknowledge purchases as soon as possible to ensure your users’ entitlements are properly reflected in your app.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">const</span> service <span class="op">=</span></a>
<a class="sourceLine" id="cb10-2" title="2">     <span class="cf">await</span> <span class="va">window</span>.<span class="at">getDigitalGoodsService</span>(<span class="st">&quot;https://play.google.com/billing&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-3" title="3">...</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">const</span> existingPurchases <span class="op">=</span> <span class="cf">await</span> <span class="va">service</span>.<span class="at">listPurchases</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="cf">for</span> (<span class="kw">const</span> p <span class="kw">of</span> existingPurchases) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="cf">if</span> (<span class="op">!</span><span class="va">p</span>.<span class="at">acknowledged</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-7" title="7">       <span class="cf">await</span> <span class="va">service</span>.<span class="at">acknowledge</span>(<span class="va">p</span>.<span class="at">purchaseToken</span><span class="op">,</span> <span class="st">&#39;onetime&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-8" title="8">       <span class="co">// Do something to record successful acknowledgement of a purchase</span></a>
<a class="sourceLine" id="cb10-9" title="9">       <span class="co">// e.g. update backend server</span></a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-11" title="11">    <span class="co">// Update the UI with items the user is already entitled to.</span></a>
<a class="sourceLine" id="cb10-12" title="12">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Users has entitlement for </span><span class="sc">${</span><span class="va">p</span>.<span class="at">itemId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="op">}</span></a></code></pre></div>
<h2 id="test-your-integration">Test your integration</h2>
<h3 id="on-a-development-android-device">On a Development Android device</h3>
<p>It is possible to enable the Digital Goods API on an development Android device for testing, even without enabling the Origin Trial:</p>
<ul>
<li>Ensure you are on Android 9 or greater with <a href="https://developer.android.com/studio/debug/dev-options">developer mode enabled</a>.</li>
<li>Install Chrome 88 or above.</li>
<li>Enable the following flags in Chrome by navigating to <code>chrome://flags</code> and searching for the flag by name:
<ul>
<li><code>#enable-experimental-web-platform-features</code></li>
<li><code>#enable-web-payments-experimental-features</code></li>
<li><code>#enable-debug-for-store-billing</code></li>
</ul></li>
<li>Ensure that the site is hosted using a https protocol. Using http will cause the API to be <code>undefined</code></li>
</ul>
<p>Note: The <code>#enable-debug-for-store-billing</code> flag is not required when the application is downloaded from the Play Store.</p>
<h3 id="on-a-chrome-os-device">On a Chrome OS device</h3>
<p>The Digital Goods API will be available on Chrome OS stable starting with version 89. In the meantime, it is possible to test the Digital Goods API:</p>
<ul>
<li>Enable the <a href="https://support.google.com/chromebook/answer/1086915">Chrome OS dev channel</a>,</li>
<li>Enable the following flags in Chrome by navigating to <code>chrome://flags</code> and searching for the flag by name:
<ul>
<li><code>#enable-experimental-web-platform-features</code></li>
<li><code>#enable-web-payments-experimental-features</code></li>
</ul></li>
<li>Install your app from the Play Store on the device.</li>
<li>Ensure that the site is hosted using a https protocol. Using http will cause the API to be <code>undefined</code></li>
</ul>
<h2 id="with-test-users-and-qa-teams">With test users and QA teams</h2>
<p>In order to test with a broader audience, you will need to sign-up for the Origin Trial, as asking every user to enable the Chrome flags is not practical.</p>
<p>The Play Store also provides affordances for testing, including user test accounts and test SKUs. Checkout the <a href="https://developer.android.com/google/play/billing/test">Google Play Billing test documentation</a> for more information.</p>
<h2 id="where-to-go-next">Where to go next?</h2>
<p>As discussed in this document, the Play Billing API has client-side components, which are managed by the Digital Goods API, and server-side components.</p>
<ul>
<li>Take a look at Peter Conn’s sample at <a href="https://github.com/PEConn/beer">https://github.com/PEConn/beer</a></li>
<li>Check out the Play documentation on <a href="https://developer.android.com/google/play/billing/security#verify">purchase verification</a>.</li>
<li>Consider using one of the <a href="https://developers.google.com/android-publisher/libraries">Google Play Developer API client libraries</a>, which are available in <a href="https://developers.google.com/api-client-library">multiple languages</a>.</li>
<li>If implementing a subscriptions model in your application, check out the <a href="https://developer.android.com/google/play/billing/billing_subscriptions#Allow-upgrade">Play Billing subscriptions documentation</a>.</li>
<li>Implement <a href="https://developer.android.com/google/play/billing/getting-ready#configure-rtdn">Real-Time developer notifications</a> (RTDN) and subscribe for notifications so your backend is notified when the state of a subscription changes instead of polling their status on Play.</li>
<li>Implement <code>linkedPurchaseToken</code> to prevent duplicate subscriptions. Read <a href="https://medium.com/androiddevelopers/implementing-linkedpurchasetoken-correctly-to-prevent-duplicate-subscriptions-82dfbf7167da">this blogpost</a> on how to implement it correctly.</li>
</ul>
</body>
</html>
