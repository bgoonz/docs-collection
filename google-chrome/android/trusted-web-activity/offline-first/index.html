<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-05-11" />
  <title>Offline-First Trusted Web Activities</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Offline-First Trusted Web Activities</h1>
<p class="date">2021-05-11</p>
</header>
<p>The first time a user launches a Progressive Web App (PWA) via Trusted Web Activity, the service worker won’t yet be available since <a href="https://developers.google.com/web/fundamentals/primers/service-workers/registration">the registration process</a> hasn’t taken place yet. Aditionally, if the user doesn’t have connectivity during the first app launch, instead of the custom offline experience, the network error page is shown.</p>
<p>An example of this scenario might take place after the user downloads the PWA from the Play Store. If the user doesn’t have connectivity when trying to open the app for the first time, the service worker won’t yet be available to show the offline fallback page, therefore. The standard error page will be shown, leading to a bad experience.</p>
<p>{% Img src=“image/26V1DWN36MZr3mUo8ChSBlCpzp43/SixNJuHH01eY6u96Owo1.png”, alt=“TWA offline: the standard offline page”, width=“533”, height=“372” %}</p>
<p>This guide explains how to display your own activity in this situation by checking the status of the network before launching the Trusted Web Activity.</p>
<p>{% Aside %} A prerequisite of this guide is to have a Trusted Web Activity app running. Follow the steps in the <a href="/docs/android/trusted-web-activity/integration-guide/">Integration Guide</a> to create a basic Trusted Web Activity project. {% endAside%}</p>
<h2 id="create-a-custom-launcheractivity">Create a custom LauncherActivity</h2>
<p>The first step is to create a custom launcher activity. This <code>Activity</code> that will contain the offline screen to show if there’s no connectivity the first time a user opens the app.</p>
<p>Call the Activity <code>OfflineFirstTWALauncherActivity</code>, and make it extend: <code>com.google.androidbrowserhelper.trusted.LauncherActivity</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">import</span><span class="im"> com.google.androidbrowserhelper.trusted.LauncherActivity;</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">public</span> <span class="kw">class</span> OfflineFirstTWALauncherActivity <span class="kw">extends</span> LauncherActivity {</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">}</a></code></pre></div>
<p>Next, register the Activity in <code>AndroidManifest.xml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;.OfflineFirstTWALauncherActivity&quot;</span><span class="ot"> android:theme=</span><span class="st">&quot;@style/Theme.Design.NoActionBar&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="kw">&lt;intent-filter&gt;</span></a>
<a class="sourceLine" id="cb2-3" title="3">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.action.MAIN&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-4" title="4">        <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="kw">&lt;/intent-filter&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="co">&lt;!-- Edit android:value to change the url opened by the Trusted Web Activity --&gt;</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">&lt;meta-data</span><span class="ot"> android:name=</span><span class="st">&quot;android.support.customtabs.trusted.DEFAULT_URL&quot;</span><span class="ot"> android:value=</span><span class="st">&quot;https://airhorner.com&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="co">&lt;!-- This intent-filter adds the Trusted Web Activity to the Android Launcher --&gt;</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">&lt;intent-filter&gt;</span></a>
<a class="sourceLine" id="cb2-10" title="10">        <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.action.VIEW&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.DEFAULT&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-12" title="12">        <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.BROWSABLE&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-13" title="13">        <span class="co">&lt;!-- Edit android:host to handle links to the target URL --&gt;</span></a>
<a class="sourceLine" id="cb2-14" title="14">        <span class="kw">&lt;data</span><span class="ot"> android:host=</span><span class="st">&quot;airhorner.com&quot;</span><span class="ot"> android:scheme=</span><span class="st">&quot;https&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="kw">&lt;/intent-filter&gt;</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="kw">&lt;/activity&gt;</span></a></code></pre></div>
<p>The previous code registers <code>OfflineFirstTWALauncherActivity</code> as a launcher activity and defines <a href="https://airhorner.com">https://airhorner.com</a> as the URL to open when the TWA launches.</p>
<h2 id="handle-offline-scenarios">Handle offline scenarios</h2>
<p>First, inside the Activity, override the <code>shouldLaunchImmediately()</code> method and make it return <code>false</code>, so that the Trusted Web Activity won’t launch immediately. You can also add extra checks before the initial launch:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" title="1"><span class="at">@Override</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">shouldLaunchImmediately</span>() {</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="co">// launchImmediately() returns `false` so we can check connection</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="co">// and then render a fallback page or launch the Trusted Web Activity with `launchTwa()`.</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="kw">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb3-6" title="6">}</a></code></pre></div>
<p>Override the <code>onCreate()</code> method to check the network status before the TWA launches. Add a call to <code>tryLaunchTwa()</code>, a helper method that will contain that logic:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1"><span class="at">@Override</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">protected</span> <span class="dt">void</span> <span class="fu">onCreate</span>(Bundle savedInstanceState) {</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">super</span>.<span class="fu">onCreate</span>(savedInstanceState);</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="fu">tryLaunchTwa</span>();</a>
<a class="sourceLine" id="cb4-5" title="5">}</a></code></pre></div>
<p>Next, implement <code>tryLaunchTwa()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">private</span> <span class="dt">void</span> <span class="fu">tryLaunchTwa</span>() {</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="co">// If TWA has already launched successfully, launch TWA immediately.</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="co">// Otherwise, check connection status. If online, launch the Trusted Web Activity with `launchTwa()`.</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="co">// Otherwise, if offline, render the offline fallback screen.</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">if</span> (<span class="fu">hasTwaLaunchedSuccessfully</span>()) {</a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="fu">launchTwa</span>();</a>
<a class="sourceLine" id="cb5-7" title="7">    } <span class="kw">else</span> <span class="kw">if</span> (<span class="fu">isOnline</span>()) {</a>
<a class="sourceLine" id="cb5-8" title="8">        <span class="fu">firstTimeLaunchTwa</span>();</a>
<a class="sourceLine" id="cb5-9" title="9">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb5-10" title="10">        <span class="fu">renderOfflineFallback</span>();</a>
<a class="sourceLine" id="cb5-11" title="11">    }</a>
<a class="sourceLine" id="cb5-12" title="12">}</a></code></pre></div>
<p>The previous code handles three scenarios:</p>
<ul>
<li>If the TWA has launched previously, the service worker has been registered, and the PWA will be able to respond offline. In that case, call <code>launchTwa()</code>, defined in the parent class, to launch the Trusted Web Activity directly.</li>
<li>If the TWA hasn’t launched previously and the user is online, launch the Trusted Web Activity for the first time using the <code>firstTimeLaunchTwa()</code> method that you’ll implement later.</li>
<li>If the TWA hasn’t already launched and the user is offline, render the native offline fallback screen.</li>
</ul>
<h2 id="implement-helper-methods">Implement helper methods</h2>
<p>The final step is to implement the helper methods called by the previous code. Here’s the code for checking offline state <code>isOnline()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">isOnline</span>() {</a>
<a class="sourceLine" id="cb6-2" title="2">    ConnectivityManager connectivityManager = (ConnectivityManager) <span class="fu">getSystemService</span>(<span class="bu">Context</span>.<span class="fu">CONNECTIVITY_SERVICE</span>);</a>
<a class="sourceLine" id="cb6-3" title="3">    NetworkInfo activeNetworkInfo = connectivityManager.<span class="fu">getActiveNetworkInfo</span>();</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">return</span> activeNetworkInfo != <span class="kw">null</span> &amp;&amp; activeNetworkInfo.<span class="fu">isConnected</span>();</a>
<a class="sourceLine" id="cb6-5" title="5">}</a></code></pre></div>
<p>Next, implement <code>hasTwaLaunchedSuccessfully()</code>, which checks if the TWA has launched at least once:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">hasTwaLaunchedSuccessfully</span>() {</a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="co">// Return `true` if the preference &quot;twa_launched_successfully&quot; has already been set.</span></a>
<a class="sourceLine" id="cb7-3" title="3">    SharedPreferences sharedPref = <span class="fu">getSharedPreferences</span>(<span class="fu">getString</span>(R.<span class="fu">string</span>.<span class="fu">twa_offline_first_preferences_file_key</span>), <span class="bu">Context</span>.<span class="fu">MODE_PRIVATE</span>);</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="kw">return</span> sharedPref.<span class="fu">getBoolean</span>(<span class="fu">getString</span>(R.<span class="fu">string</span>.<span class="fu">twa_launched_successfully</span>), <span class="kw">false</span>);</a>
<a class="sourceLine" id="cb7-5" title="5">}</a></code></pre></div>
<p>The previous code calls the <code>launchTWA()</code> from the parent class, and saves the <code>twa_launched_successfully</code> flag in shared preferences. This indeicates that the TWA has launched successfully, at least once.</p>
<p>The remaining helper method, <code>renderOfflineFallback()</code> renders an Android offline screen.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">private</span> <span class="dt">void</span> <span class="fu">renderOfflineFallback</span>() {</a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="fu">setContentView</span>(R.<span class="fu">layout</span>.<span class="fu">activity_offline_first_twa</span>);</a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="bu">Button</span> retryBtn = <span class="kw">this</span>.<span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">retry_btn</span>);</a>
<a class="sourceLine" id="cb8-5" title="5">    retryBtn.<span class="fu">setOnClickListener</span>(<span class="kw">new</span> <span class="bu">View</span>.<span class="fu">OnClickListener</span>() {</a>
<a class="sourceLine" id="cb8-6" title="6">        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onClick</span>(<span class="bu">View</span> v) {</a>
<a class="sourceLine" id="cb8-7" title="7">            <span class="co">// Check connection status. If online, launch the Trusted Web Activity for the first time.</span></a>
<a class="sourceLine" id="cb8-8" title="8">            <span class="kw">if</span> (<span class="fu">isOnline</span>()) <span class="fu">firstTimeLaunchTwa</span>();</a>
<a class="sourceLine" id="cb8-9" title="9">        }</a>
<a class="sourceLine" id="cb8-10" title="10">    });</a>
<a class="sourceLine" id="cb8-11" title="11">}</a></code></pre></div>
<p>Fort his demo, we have defined the <code>activity_offline_first_twa</code> layout, which contains a button to retry, which will, in time, to execute <code>firstTimeLaunchTwa()</code> after checking the connection.</p>
<p>{% Img src=“image/26V1DWN36MZr3mUo8ChSBlCpzp43/pzkHBtYxsTXIdsfjFfYF.png”, alt=“twa offline - custom offline screen”, width=“533”, height=“394” %}</p>
<h2 id="conclusion">Conclusion</h2>
<ul>
<li>The first time a user launches a Progressive Web App (PWA) via Trusted Web Activity, the service worker won’t yet be available.</li>
<li>To avoid showing the standard offline screen if the user has no connectivity, you can detect the offline condition and show a fallback offline screen instead.</li>
<li>In this guide you learned how to implement that strategy. If you are interested in checking the code we used throughout this guide, you can find the complete solution in the <a href="https://github.com/GoogleChrome/android-browser-helper/tree/main/demos/twa-offline-first">Offline First TWA Demo</a>.</li>
</ul>
</body>
</html>
